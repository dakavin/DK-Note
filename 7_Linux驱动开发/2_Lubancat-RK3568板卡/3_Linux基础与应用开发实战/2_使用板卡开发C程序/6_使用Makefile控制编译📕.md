
å…³äºMakefileçš„è¯¦ç»†ä½¿ç”¨å¯å‚è€ƒã€Šè·Ÿæˆ‘ä¸€èµ·å†™Makefileã€‹ä¸€ä¹¦æˆ–GNUå®˜æ–¹çš„makeè¯´ æ˜æ–‡æ¡£ï¼š[https://www.gnu.org/software/make/manual](https://www.gnu.org/software/make/manual)ï¼Œæœ¬ç« ä»…ä»¥ç¤ºä¾‹å¯¹Makefileçš„åŸºç¡€è¯­æ³•è¿›è¡Œè®²è§£ã€‚

LubanCat-RKç³»åˆ—æ¿å¡å‡ºå‚å¹¶æ²¡æœ‰è‡ªå¸¦Makefileå·¥å…·ï¼Œéœ€è¦æˆ‘ä»¬è‡ªè¡Œä¸‹è½½å®‰è£…
```shell
sudo apt install make
```

æœ¬ç« çš„ç¤ºä¾‹ä»£ç ç›®å½•ä¸ºï¼š`base_linux/makefile/`
## 1 Makefileå°å®éªŒ

**makefielçš„åŸºæœ¬æ ¼å¼**
```makefile
ç›®æ ‡:ä¾èµ–çš„æ–‡ä»¶æˆ–å…¶ä»–ç›®æ ‡
#æ³¨æ„:å‘½ä»¤å‰ç”¨tab
	å‘½ä»¤1
	å‘½ä»¤2
#ç¬¬ä¸€ä¸ªç›®æ ‡ï¼Œæ˜¯æœ€ç»ˆç›®æ ‡åŠmakeçš„é»˜è®¤ç›®æ ‡
```

é¦– å…ˆä½¿ç”¨ç¼–è¾‘å™¨åˆ›å»ºä¸€ä¸ªåä¸ºâ€œMakefileâ€çš„æ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹ä»£ç å¹¶ä¿å­˜ï¼Œå…¶ä¸­ä½¿ç”¨â€œ#â€å¼€å¤´çš„ è¡Œæ˜¯æ³¨é‡Šï¼Œè‡ªå·±åšå®éªŒæ—¶å¯ä»¥ä¸è¾“å…¥ï¼Œå¦å¤–è¦æ³¨æ„åœ¨â€œls -lhâ€ã€â€touch test.txtâ€ç­‰å‘½ä»¤å‰è¦ä½¿ç”¨Tabé”®ï¼Œä¸èƒ½ä½¿ç”¨ç©ºæ ¼ä»£æ›¿ã€‚
```makefile
#ç›®æ ‡aï¼Œä¾èµ–ä¸ç›®æ ‡targetcå’Œtargetb
#ç›®æ ‡è¦æ‰§è¡Œshellå‘½ä»¤ ls -lh
targeta:targetc targetb
	ls -lh

#ç›®æ ‡bï¼Œæ— ä¾èµ–
#ç›®æ ‡è¦æ‰§è¡Œshellå‘½ä»¤ touchåˆ›å»ºæ–‡ä»¶
targetb:
	touch test.txt

#ç›®æ ‡cï¼Œæ— ä¾èµ–
#ç›®æ ‡è¦æ‰§è¡Œshellå‘½ä»¤ï¼Œpwd
targetc:
	pwd

#ç›®æ ‡dï¼Œæ— ä¾èµ–
#ç”±äºabcç›®æ ‡ä¸ä¾èµ–äºç›®æ ‡dï¼Œæ‰€ä»¥ç›´æ¥makeæ—¶ï¼Œç›®æ ‡dä¸ä¼šè¢«æ‰§è¡Œ
#ä¸è¿‡å¯ä»¥ä½¿ç”¨make targetdå‘½ä»¤æ‰§è¡Œ
targetd:
	rm -f test.txt
```

è¿™ä¸ªMakefileæ–‡ä»¶ä¸»è¦æ˜¯å®šä¹‰äº†å››ä¸ªç›®æ ‡ æ“ä½œï¼Œå…ˆå¤§è‡´äº†è§£å®ƒä»¬çš„å…³ç³»ï¼š
- `targeta`ï¼šè¿™æ˜¯Makefileä¸­çš„ç¬¬ä¸€ä¸ªç›®æ ‡ä»£å·ï¼Œåœ¨ç¬¦å·â€œ:â€å é¢çš„å†…å®¹è¡¨ç¤ºå®ƒä¾èµ–äºtargetcå’Œtargetbç›®æ ‡ï¼Œå®ƒè‡ªèº«çš„å‘½ä»¤ä¸ºâ€œls -lhâ€ï¼Œåˆ—å‡ºå½“å‰ç›®å½•ä¸‹çš„å†…å®¹ã€‚
- `targetb`ï¼šè¿™ä¸ªç›®æ ‡æ²¡æœ‰ä¾èµ–å…¶å®ƒå†…å®¹ï¼Œå®ƒè¦æ‰§è¡Œçš„å‘½ä»¤ä¸ºâ€œtouch test.txtâ€ï¼Œå³åˆ›å»ºä¸€ä¸ªtest.txtæ–‡ä»¶ã€‚
- `targetc`ï¼šè¿™ä¸ªç›®æ ‡åŒæ ·ä¹Ÿæ²¡æœ‰ä¾èµ–å…¶å®ƒå†…å®¹ï¼Œå®ƒè¦æ‰§è¡Œçš„å‘½ä»¤ä¸ºâ€œpwdâ€ï¼Œå°±æ˜¯ç®€å•åœ°æ˜¾ç¤ºå½“å‰çš„è·¯å¾„ã€‚
- `targetd`ï¼šè¿™ä¸ªç›®æ ‡æ— ä¾èµ–å…¶å®ƒå†…å®¹ï¼Œå®ƒè¦æ‰§è¡Œçš„å‘½ä»¤ä¸ºâ€œrm -f test.txtâ€ï¼Œåˆ é™¤ ç›®å½•ä¸‹çš„test.txtæ–‡ä»¶ã€‚ä¸targetbã€cä¸åŒçš„æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•å…¶å®ƒç›®æ ‡ä¾èµ–äºtargetdï¼Œè€Œä¸” å®ƒä¸æ˜¯é»˜è®¤ç›®æ ‡ã€‚

ä¸‹é¢ä½¿ç”¨è¿™ä¸ªMakefileæ‰§è¡Œå„ç§makeå‘½ä»¤ï¼Œå¯¹æ¯”ä¸åŒmakeå‘½ä»¤çš„è¾“å‡ºï¼Œå¯ä»¥æ¸…æ¥šåœ°äº†è§£Makefileçš„æœºåˆ¶ã€‚ åœ¨ä¸»æœºMakefileæ‰€åœ¨çš„ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
```c
#åœ¨ä¸»æœºä¸ŠMakefileæ‰€åœ¨çš„ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
#æŸ¥çœ‹å½“å‰ç›®å½•çš„å†…å®¹
ls

#æ‰§è¡Œmakeå‘½ä»¤ï¼Œmakeä¼šåœ¨å½“å‰ç›®å½•ä¸‹æœç´¢â€œMakefileâ€æˆ–â€œmakefileâ€ï¼Œå¹¶æ‰§è¡Œ
make

#å¯çœ‹åˆ°makeå‘½ä»¤åçš„è¾“å‡ºï¼Œå®ƒæ‰§è¡Œäº†Makefileä¸­ç¼–å†™çš„å‘½ä»¤

#æŸ¥çœ‹æ‰§è¡Œmakeå‘½ä»¤åçš„ç›®å½•å†…å®¹ï¼Œå¤šäº†test.txtæ–‡ä»¶
ls

#æ‰§è¡ŒMakefileçš„targetdç›®æ ‡ï¼Œå¹¶æŸ¥çœ‹ï¼Œå°‘äº†test.txtæ–‡ä»¶
make targetd
ls

#æ‰§è¡ŒMakefileçš„targetbç›®æ ‡ï¼Œå¹¶æŸ¥çœ‹ï¼Œåˆç”Ÿæˆäº†test.txtæ–‡ä»¶
make targetb
ls

#æ‰§è¡ŒMakefileçš„targetcç›®æ ‡
make targetc
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/197bcefe3dceec9ff25a0348605d4f77.png)

**makeå‘½ä»¤ï¼š**
- åœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œmakeå‘½ä»¤æ—¶ï¼Œmakeä¼šåœ¨å½“å‰ç›®å½•ä¸‹æœç´¢åä¸ºâ€œMakefileâ€æˆ–â€œmakefileâ€çš„æ–‡ä»¶ï¼Œç„¶å æ ¹æ®è¯¥æ–‡ä»¶çš„è§„åˆ™è§£ææ‰§è¡Œã€‚å¦‚æœè¦æŒ‡å®šå…¶å®ƒæ–‡ä»¶ä½œä¸ºè¾“å…¥è§„åˆ™ï¼Œå¯ä»¥é€šè¿‡â€œ-fâ€å‚æ•°æŒ‡å®šè¾“ å…¥æ–‡ä»¶ï¼Œå¦‚â€œmake -f æ–‡ä»¶åâ€ã€‚
- æ­¤å¤„makeå‘½ä»¤è¯»å–æˆ‘ä»¬çš„Makefileæ–‡ä»¶åï¼Œå‘ç°targetaæ˜¯Makefileçš„ç¬¬ä¸€ä¸ªç›®æ ‡ï¼Œå®ƒä¼šè¢«å½“æˆé»˜è®¤ç›®æ ‡æ‰§è¡Œã€‚
- åˆç”±äºtargetaä¾èµ–äºtargetcå’Œtargetbç›®æ ‡ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œtargetaè‡ªèº«çš„å‘½ä»¤ä¹‹å‰ï¼Œä¼šå…ˆå»å®Œæˆtargetcå’Œtargetbã€‚
- targetcçš„å‘½ä»¤ä¸ºpwdï¼Œæ˜¾ç¤ºäº†å½“å‰çš„è·¯å¾„ã€‚
- targetbçš„å‘½ä»¤ä¸ºtouch test.txt ï¼Œåˆ›å»ºäº†test.txtæ–‡ä»¶ã€‚
- æœ€åæ‰§è¡Œtargetaè‡ªèº«çš„å‘½ä»¤ls -lh ï¼Œåˆ—å‡ºå½“å‰ç›®å½•çš„å†…å®¹ï¼Œå¯çœ‹åˆ°å¤šäº†ä¸€ä¸ªtest.txtæ–‡ä»¶

**make targetd ã€make targetbã€make targetcå‘½ä»¤ï¼š**
- ç”±äºtargetdä¸æ˜¯é»˜è®¤ç›®æ ‡ï¼Œä¸”ä¸è¢«å…¶å®ƒä»»ä½•ç›®æ ‡ä¾èµ–ï¼Œæ‰€ä»¥ç›´æ¥makeçš„æ—¶ å€™targetdå¹¶æ²¡æœ‰è¢«æ‰§è¡Œï¼Œæƒ³è¦å•ç‹¬æ‰§è¡ŒMakefileä¸­çš„æŸä¸ªç›®æ ‡ï¼Œå¯ä»¥ä½¿ç”¨â€make ç›®æ ‡ åâ€œçš„è¯­æ³•ï¼Œä¾‹å¦‚ä¸Šå›¾ä¸­åˆ†åˆ«æ‰§è¡Œäº†â€make targetdâ€œ ã€â€make targetbâ€œ å’Œâ€make targetcâ€œæŒ‡ä»¤ï¼Œåœ¨æ‰§è¡Œâ€make targetdâ€ç›®æ ‡æ—¶ï¼Œå¯çœ‹åˆ°å®ƒçš„å‘½ä»¤rm -f test.txtè¢«æ‰§è¡Œï¼Œtest.txtæ–‡ä»¶è¢«åˆ é™¤ã€‚

ä»è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯äº†è§£åˆ°makeç¨‹åºä¼šæ ¹æ®Makefileä¸­æè¿°çš„ç›®æ ‡ä¸ä¾èµ–å…³ç³»ï¼Œæ‰§è¡Œè¾¾æˆç›®æ ‡éœ€è¦çš„shellå‘½ä»¤ã€‚`ç®€å•æ¥è¯´ï¼ŒMakefileå°±æ˜¯ç”¨æ¥æŒ‡å¯¼makeç¨‹åºå¦‚ä½•å¹²æŸäº›äº‹æƒ…çš„æ¸…å•ã€‚`
## 2 ä½¿ç”¨Makefileç¼–è¯‘ç¨‹åº

### 2.1 ä½¿ç”¨GCCç¼–è¯‘å¤šä¸ªæ–‡ä»¶

æ¥ç€æˆ‘ä»¬ä½¿ç”¨Makefileæ¥æ§åˆ¶ç¨‹åºçš„ç¼–è¯‘ï¼Œä¸ºæ–¹ä¾¿è¯´æ˜ï¼Œå…ˆæŠŠå‰é¢ç« èŠ‚ çš„hello.cç¨‹åºåˆ†å¼€æˆä¸‰ä¸ªæ–‡ä»¶æ¥å†™ï¼Œåˆ†åˆ«ä¸ºhello_main.cä¸»æ–‡ä»¶ï¼Œhello_func.cå‡½æ•°æ–‡ ä»¶ï¼Œhello_func.hå¤´æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ä»£ç æ‰€ç¤º
```c
// base_linux/makefile/test2/hello_main.c
#include "hello_func.h"

int main()
{
    hello_func();
    return 0;
}

// base_linux/makefile/test2/hello_func.c
#include <stdio.h>
#include "hello_func.h"

void hello_func(void)
{
    printf("hello, world! This is a C program.\n");
    for (int i=0; i<10; i++ ) {
        printf("output i=%d\n",i);
    }
}

// base_linux/makefile/test2/hello_func.h
void hello_func(void);
```

ä¹Ÿå°±æ˜¯è¯´hello_main.cçš„mainä¸»å‡½æ•°è°ƒç”¨äº†hello_func.cæ–‡ä»¶çš„æ‰“ å°å‡½æ•°ï¼Œè€Œæ‰“å°å‡½æ•°åœ¨hello_func.hæ–‡ä»¶ä¸­å£°æ˜ï¼Œåœ¨å¤æ‚çš„å·¥ç¨‹ä¸­è¿™æ˜¯å¸¸è§çš„ç¨‹åºç»“æ„ã€‚

å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨GCCè¿›è¡Œç¼–è¯‘ï¼Œéœ€è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š
```shell
# -I .  ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨å¤´æ–‡ä»¶çš„è·¯å¾„æ˜¯åœ¨å½“å‰ç›®å½•ï¼ˆ.ï¼‰
gcc -I . hello_main.c hello_fun.c -o hello_main

#è¿è¡Œç”Ÿæˆçš„hello_mainç¨‹åº
./hello_main
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/289dc1eeb975f18c61e2512aa5a85cf5.png)

**æ–°å¢çš„â€œ-I .â€æ˜¯å‘Šè¯‰ç¼– è¯‘å™¨å¤´æ–‡ä»¶è·¯å¾„ï¼Œè®©å®ƒåœ¨ç¼–è¯‘æ—¶å¯ä»¥åœ¨â€œ.â€ï¼ˆå½“å‰ç›®å½•ï¼‰å¯»æ‰¾å¤´æ–‡ä»¶ï¼Œå…¶å®ä¸åŠ â€-I .â€é€‰é¡¹ä¹Ÿæ˜¯èƒ½æ­£å¸¸ç¼–è¯‘é€šè¿‡çš„ï¼Œæ­¤å¤„åªæ˜¯ä¸ºäº†åé¢æ¼”ç¤ºMakefileçš„ç›¸å…³å˜é‡ã€‚**
### 2.2 ä½¿ç”¨Makefileç¼–è¯‘

å¯ä»¥æƒ³åƒåˆ°ï¼Œåªè¦æŠŠgccçš„ç¼–è¯‘å‘½ä»¤æŒ‰æ ¼å¼å†™å…¥åˆ°Makefileï¼Œå°±èƒ½ç›´æ¥ ä½¿ç”¨makeç¼–è¯‘ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨ç›´æ¥æ•²gccç¼–è¯‘å‘½ä»¤ã€‚

æ“ä½œå¦‚ä¸‹ä½¿ç”¨ç¼–è¾‘å™¨åœ¨hello_main.cæ‰€åœ¨çš„ç›®å½•æ–°å»ºä¸€ä¸ªåä¸ºâ€œMakefileâ€çš„æ–‡ä»¶ï¼Œå¹¶ è¾“å…¥å¦‚ä¸‹å†…å®¹å¹¶ä¿å­˜ã€‚
```makefile
# é»˜è®¤ç›®æ ‡
# hello_mainä¾èµ–äºhello_main.cå’Œhello_func.cæ–‡ä»¶
hello_main: hello_main.c hello_func.c
	gcc -o hello_main hello_main.c hello_func.c -I .

#cleanç›®æ ‡ï¼Œç”¨æ¥åˆ é™¤ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
clean:
	rm -f *.o hello_main
```

è¯¥æ–‡ä»¶å®šä¹‰äº†**é»˜è®¤ç›®æ ‡hello_mainç”¨äºç¼–è¯‘ç¨‹åº**ï¼Œ**cleanç›®æ ‡ç”¨äºåˆ é™¤ ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶**ã€‚

ç‰¹åˆ«åœ°ï¼Œå…¶ä¸­hello_mainç›®æ ‡åä¸gccç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶åâ€gcc -o hello_mainâ€è®¾ç½®æˆä¸€è‡´äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤å¤„çš„ç›®æ ‡hello_mainåœ¨Makefileçœ‹æ¥ï¼Œå·²ç»æ˜¯ ä¸€ä¸ªç›®æ ‡æ–‡ä»¶hello_mainã€‚

è¿™æ ·çš„å¥½å¤„æ˜¯
- makeæ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼š`æ£€æŸ¥`hello_mainæ–‡ä»¶å’Œä¾èµ– æ–‡ä»¶hello_main.cã€hello_func.cçš„ä¿®æ”¹æ—¥æœŸ
- å¦‚æœä¾èµ–æ–‡ä»¶çš„`ä¿®æ”¹æ—¥æœŸ`æ¯”hello_mainæ–‡ä»¶çš„ æ—¥æœŸ`æ–°`ï¼Œé‚£ä¹ˆmakeä¼šæ‰§è¡Œç›®æ ‡å…¶ä¸‹çš„Shellå‘½ä»¤æ›´æ–°hello_mainæ–‡ä»¶
- å¦åˆ™ä¸ä¼šæ‰§è¡Œã€‚

è¯·è¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®éªŒï¼š
```shell
#åœ¨ä¸»æœºä¸ŠMakefileæ‰€åœ¨çš„ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
#è‹¥ä¹‹å‰æœ‰ç¼–è¯‘ç”Ÿæˆhello_mainç¨‹åºï¼Œå…ˆåˆ é™¤

rm hello_main
ls

#ä½¿ç”¨makeæ ¹æ®Makefileç¼–è¯‘ç¨‹åº
make
ls

#æ‰§è¡Œç”Ÿæˆçš„hello_mainç¨‹åº
./hello_main

#å†æ¬¡makeï¼Œä¼šæç¤ºhello_mainæ–‡ä»¶å·²æ˜¯æœ€æ–°
make

#ä½¿ç”¨touchå‘½ä»¤æ›´æ–°ä¸€ä¸‹hello_func.cçš„æ—¶é—´
touch hello_func.c

#å†æ¬¡makeï¼Œç”±äºhello_func.cæ¯”hello_mainæ–°ï¼Œæ‰€ä»¥ä¼šå†ç¼–è¯‘
make
ls
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/11abfe1989bbf07116599fcf608d81d2.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæœ‰äº†Makefileåï¼Œæˆ‘ä»¬å®é™…ä¸Šåªéœ€è¦æ‰§è¡Œä¸€ä¸‹makeå‘½ä»¤å°±å¯ä»¥å®Œæˆ æ•´ä¸ªç¼–è¯‘æµç¨‹ã€‚

å›¾ä¸­è¿˜æ¼”ç¤ºäº†makeä¼šå¯¹ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–è¿›è¡Œæ›´æ–°æ£€æŸ¥ï¼Œå½“ä¾èµ–æ–‡ä»¶ æœ‰æ”¹åŠ¨æ—¶ï¼Œæ‰ä¼šå† æ¬¡æ‰§è¡Œå‘½ä»¤æ›´æ–°ç›®æ ‡æ–‡ä»¶ã€‚
## 3 ç›®æ ‡ã€ä¾èµ–å’Œå‘½ä»¤

ä¸‹é¢æˆ‘ä»¬å†æ€»ç»“ä¸€ä¸‹Makefileä¸­è·Ÿç›®æ ‡ç›¸å…³çš„è¯­æ³•ï¼š
```makefile
[ç›®æ ‡1]ï¼š[ä¾èµ–]
	[å‘½ä»¤1]
	[å‘½ä»¤2]

[ç›®æ ‡2]ï¼š[ä¾èµ–]
	[å‘½ä»¤1]
	[å‘½ä»¤2]
```

**ç›®æ ‡ï¼š**
- makeè¦åšçš„äº‹æƒ…ï¼Œå¯ä»¥æ˜¯ç®€å•çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›®æ ‡æ–‡ä»¶
- éœ€è¦é¡¶æ ¼ä¹¦å†™ï¼Œä¸èƒ½æœ‰ç©ºæ ¼æˆ–Tab
- ä¸€ä¸ªMakefileå¯ä»¥æœ‰å¤šä¸ªç›®æ ‡ï¼Œå†™åœ¨æœ€å‰é¢çš„ç›®æ ‡ä¼šè¢«Makeç¨‹åºä½œä¸º `é»˜è®¤ç›®æ ‡`

**ä¾èµ–ï¼š**
- è¾¾æˆç›®æ ‡ä¾èµ–çš„æŸäº›æ–‡ä»¶æˆ–å…¶ä»–ç›®æ ‡

**å‘½ä»¤ï¼š**
- makeè¾¾æˆç›®æ ‡æ‰€éœ€è¦çš„å‘½ä»¤
- åªæœ‰ç›®æ ‡ä¸å­˜åœ¨ æˆ– ä¾èµ–æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æ¯”ç›®æ ‡æ–‡ä»¶æ–° æ‰ä¼šæ‰§è¡Œå‘½ä»¤
- ç‰¹åˆ«æ³¨æ„å‘½ä»¤çš„å¼€å¤´è¦ç”¨tabé”®
## 4 ä¼ªç›®æ ‡ğŸ“•

**é—®é¢˜ï¼š** åœ¨test1çš„æ—¶å€™ï¼Œå‡å¦‚å½“å‰ç›®å½•ä¸‹å­˜åœ¨targetaã€targetbã€targetcæ–‡ä»¶ï¼Œå¹¶ä¸”éƒ½æ˜¯æœ€æ–°çš„ï¼Œé‚£ä¹ˆmake targetaå°±ä¸ä¼šæ­£å¸¸æ‰§è¡Œäº†

**è§£å†³ï¼š** Makefileä½¿ç”¨`.PHONY`å‰ç¼€æ¥åŒºåˆ†ç›®æ ‡ä»£å·ï¼ˆ`ä¼ªç›®æ ‡`ï¼‰å’Œç›®æ ‡æ–‡ä»¶ï¼Œphonyå•è¯ç¿»è¯‘æœ¬èº«å°±æ˜¯å‡çš„æ„æ€
- å³ä¸æœŸå¾…ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œå°±åº”è¯¥å°†å…¶å®šä¹‰ä¸º **ä¼ªç›®æ ‡** 

**ä¿®æ”¹test1çš„Makefile**
```makefile
# ä½¿ç”¨.PHONYè¡¨ç¤ºtargetaæ˜¯ä¸ªä¼ªç›®æ ‡
.PHONY:targeta
targeta: targetc targetb
	ls -lh

#ä½¿ç”¨.PHONYè¡¨ç¤ºtargetbæ˜¯ä¸ªä¼ªç›®æ ‡
.PHONY:targetb
targetb:
	touch test.txt

#ä½¿ç”¨.PHONYè¡¨ç¤ºtargetcæ˜¯ä¸ªä¼ªç›®æ ‡
.PHONY:targetc
targetc:
	pwd

#ä½¿ç”¨.PHONYè¡¨ç¤ºtargetdæ˜¯ä¸ªä¼ªç›®æ ‡
.PHONY:targetd
targetd:
	rm -f test.txt
```

**ä¿®æ”¹test2çš„Makefile**
```makefile
# é»˜è®¤ç›®æ ‡
# hello_mainä¾èµ–äºhello_main.cå’Œhello_func.cæ–‡ä»¶
hello_main: hello_main.c hello_func.c
	gcc -o hello_main hello_main.c hello_func.c -I .

#cleanä¼ªç›®æ ‡ï¼Œç”¨æ¥åˆ é™¤ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶
.PHONY:clean
clean:
	rm -f *.o hello_main
```

GNUç»„ç»‡å‘å¸ƒçš„è½¯ä»¶å·¥ç¨‹ä»£ç çš„Makefileï¼Œå¸¸å¸¸ä¼šæœ‰ç±»ä¼¼ä»¥ä¸Šä»£ç ä¸­å®šä¹‰çš„cleanä¼ªç›®æ ‡ï¼Œç”¨äºæ¸… é™¤ç¼–è¯‘çš„è¾“å‡ºæ–‡ä»¶ã€‚å¸¸è§ çš„è¿˜æœ‰â€œallâ€ã€â€œinstallâ€ã€â€œprintâ€ã€â€œtarâ€ç­‰åˆ†åˆ«ç”¨äºç¼–è¯‘æ‰€æœ‰å†…å®¹ã€å®‰è£…å·² ç¼–è¯‘å¥½çš„ç¨‹åºã€åˆ—å‡ºè¢«ä¿®æ”¹çš„æ–‡ä»¶åŠæ‰“åŒ…æˆtaræ–‡ä»¶ã€‚è™½ç„¶å¹¶æ²¡æœ‰å›ºå®šçš„è¦æ±‚ä¼ªç›®æ ‡å¿…é¡»ç”¨è¿™äº› åå­—ï¼Œä½†å¯ä»¥å‚è€ƒè¿™äº›ä¹ æƒ¯æ¥ç¼–å†™è‡ªå·±çš„Makefileã€‚

å¦‚æœä»¥ä¸Šä»£ç ä¸­ä¸å†™â€œ.PHONY:cleanâ€è¯­å¥ï¼Œå¹¶ä¸”åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºcleançš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå½“ æ‰§è¡Œâ€œmake cleanâ€æ—¶ï¼Œcleançš„å‘½ä»¤å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº²è‡ªå°è¯•ä¸€ä¸‹ã€‚
## 5 é»˜è®¤è§„åˆ™ğŸ“•

### 5.1 ç®€ä»‹

åœ¨[2_ç¨‹åºç¼–è¯‘GCCğŸ“•](2_ç¨‹åºç¼–è¯‘GCCğŸ“•.md) ç« èŠ‚ä¸­æåˆ°æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹åŒ…å«ä¸‹å›¾çš„æ­¥éª¤ï¼Œmakeåœ¨æ‰§è¡Œæ—¶ä¹Ÿæ˜¯åŒæ ·çš„æµç¨‹ï¼Œ**ä¸è¿‡åœ¨Makefileçš„å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šæŠŠ ç¼–è¯‘ å’Œ é“¾æ¥ è¿‡ç¨‹åˆ†å¼€**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/bf82b8caca504bad282b0f6c9aa3b813.png)
- å³hello_mainç›®æ ‡æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¾èµ– `hello_main.o` å’Œ `hello_fun.o` è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå®ƒä¸¤é“¾æ¥èµ·æ¥å°±èƒ½å¾—åˆ°æœ€ç»ˆçš„hello_mainç›®æ ‡æ–‡ä»¶
- å¦å¤–ï¼Œ**makeæœ‰ä¸€ä¸ªé»˜è®¤è§„åˆ™ï¼Œå½“æ‰¾ä¸åˆ° xxx.o æ–‡ä»¶æ—¶ï¼Œä¼šæŸ¥æ‰¾ç›®å½•ä¸‹åŒåçš„ xxx.c æ–‡ä»¶è¿›è¡Œç¼–è¯‘**

æ ¹æ®è¿™ä¸ªé»˜è®¤è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å§Makefileä¿®æ”¹å¦‚ä¸‹ï¼š
```makefile
hello_main:hello_main.o hello_fun.o
	gcc hello_main.o hello_fun.o -o hello_main

# ä»¥ä¸‹æ˜¯makeçš„é»˜è®¤è§„åˆ™ï¼Œå¯ä»¥ä¸å†™
hello_main.o:hello_main.c
	gcc hello_main.c -o hello_main.o

hello_fun.o:hello_fun.c
	gcc hello_fun.c -o hello_fun.o
```

- å°†ä¾èµ–æ–‡ä»¶ç”±cæ–‡ä»¶æ”¹ä¸ºoæ–‡ä»¶ï¼Œgccç¼–è¯‘å‘½ä»¤ä¹Ÿåšäº†ç›¸åº”ä¿®æ”¹
- ç”±äºcç¼–è¯‘æˆåŒåçš„oæ–‡ä»¶æ˜¯makeçš„é»˜è®¤è§„åˆ™ï¼Œæ‰€ä»¥ä¸Šé¢4-9è¡Œå†…å®¹å¯ä»¥ä¸å†™

ä½¿ç”¨ä¿®æ”¹åçš„Makefileç¼–è¯‘ç»“æœå¦‚ä¸‹æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/606bd0a156ae43c8b42c4996c192cefd.png)

- å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†ä¸¤æ¡é¢å¤–çš„ `cc` ç¼–è¯‘å‘½ä»¤
- è¿™æ˜¯ç”±makeé»˜è®¤è§„åˆ™æ‰§ è¡Œçš„ï¼Œå®ƒä»¬æŠŠCä»£ç ç¼–è¯‘ç”Ÿæˆäº†åŒåçš„.oæ–‡ä»¶
- ç„¶åmakeæ ¹æ®Makefileçš„å‘½ä»¤é“¾æ¥è¿™ä¸¤ ä¸ªæ–‡ä»¶å¾—åˆ°æœ€ç»ˆç›®æ ‡æ–‡ä»¶hello_main

### 5.2 ç¼ºé™·ğŸ“•

`ç¼ºé™·1ï¼š`ä½¿ç”¨Cè‡ªåŠ¨ç¼–è¯‘æˆ*.oçš„é»˜è®¤è§„åˆ™æœ‰ä¸ªç¼ºé™·ï¼Œç”±äºæ²¡æœ‰æ˜¾å¼åœ°è¡¨ç¤º*.oä¾èµ–äº.hå¤´æ–‡ ä»¶ï¼Œå‡å¦‚æˆ‘ä»¬**ä¿®æ”¹äº†å¤´æ–‡ä»¶çš„å†…å®¹ï¼Œé‚£ä¹ˆ*.oå¹¶ä¸ä¼šæ›´æ–°**ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„

`ç¼ºé™·2ï¼š`é»˜è®¤è§„åˆ™ä½¿ç”¨å›ºå®šçš„â€œccâ€è¿›è¡Œç¼–è¯‘ï¼Œå‡å¦‚æˆ‘ä»¬æƒ³ä½¿ç”¨ARM-GCCè¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œé‚£ä¹ˆç³»ç»Ÿé»˜ è®¤çš„â€œccâ€ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

`è§£å†³ï¼š`è¦è§£å†³è¿™äº›é—®é¢˜å¹¶ä¸”è®©Makefileå˜å¾—æ›´åŠ é€šç”¨ï¼Œéœ€è¦å¼•å…¥å˜é‡å’Œåˆ†æ”¯è¿›è¡Œå¤„ç†ã€‚

## 6 ä½¿ç”¨å˜é‡
### 6.1 åŸºæœ¬è¯­æ³•

åœ¨Makefileä¸­çš„å˜é‡ï¼Œæœ‰ç‚¹åƒ Cè¯­è¨€çš„å®å®šä¹‰ï¼Œåœ¨å¼•ç”¨å˜é‡çš„åœ°æ–¹ä½¿ç”¨å˜é‡ å€¼è¿›è¡Œæ›¿æ¢ã€‚å˜é‡çš„å‘½åå¯ä»¥åŒ…å«å­—ç¬¦ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ŒåŒºåˆ†å¤§å°å†™ï¼Œå®šä¹‰å˜é‡çš„æ–¹å¼æœ‰ä»¥ä¸‹å››ç§ï¼š
- `=`ï¼šå»¶æ—¶èµ‹å€¼ï¼Œåªæœ‰åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œæ‰ä¼šè¢«èµ‹å€¼
- `:=`ï¼šç›´æ¥å¤åˆ¶ï¼Œå˜é‡çš„å€¼åœ¨å®šä¹‰æ—¶å·²ç»ç¡®å®šäº†ï¼Œå’Œå»¶æ—¶èµ‹å€¼ç›¸å
- `?=`ï¼šè‹¥å˜é‡çš„å€¼ä¸ºç©ºï¼Œåˆ™èµ‹å€¼ï¼Œé€šå¸¸ç”¨äºè®¾ç½®é»˜è®¤å€¼
- `+=`ï¼šè¿½åŠ èµ‹å€¼ï¼Œå¾€å˜é‡åé¢å¢åŠ æ–°çš„å†…å®¹

**ä½¿ç”¨å˜é‡çš„è¯­æ³•å¦‚ä¸‹**
```makefile
$(å˜é‡å)
```

**ä¸¾ä¾‹ï¼š** è®²è§£è¿™å››ç§å®šä¹‰æ–¹å¼ï¼Œå¯¹äºåä¸¤ç§èµ‹å€¼æ–¹å¼ æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ€è€ƒå»¶æ—¶èµ‹å€¼å’Œç›´æ¥èµ‹å€¼çš„å·®å¼‚ï¼Œå®éªŒä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

```makefile
VAR_A = FILEA
VAR_B = $(VAR_A)
VAR_C := $(VAR_A)
VAR_A += FILEB
VAR_D ?= FILED
.PHONY:check
check:
	@echo VAR_A=$(VAR_A)  
	@echo VAR_B=$(VAR_B)  
	@echo VAR_C=$(VAR_C)  
	@echo VAR_D=$(VAR_D)  
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/957bfbbb12bbdae380b1842482714d55.png)

- VAR_Aï¼šè¿½åŠ èµ‹å€¼ï¼Œæ‰€ä»¥ä¸º FILEA FILEB
- VAR_Bï¼šå»¶æ—¶èµ‹å€¼ï¼Œåªç”¨åœ¨è°ƒç”¨çš„æ—¶å€™æ‰èµ‹å€¼ï¼Œæ‰€ä»¥æ˜¯Aå˜é‡ä¿®æ”¹åçš„å€¼ï¼ŒFILEA FILEB
- VAR_Cï¼šç«‹å³èµ‹å€¼ï¼Œæ‰€ä»¥æ˜¯Aå˜é‡ä¿®æ”¹å‰çš„å€¼ï¼ŒFILEA
- VAR_Dï¼šå˜é‡ä¸ºç©ºï¼Œèµ‹å€¼ä¸º FILED
### 6.2 æ”¹é€ é»˜è®¤è§„åˆ™

æ¥ä¸‹æ¥ä½¿ç”¨å˜é‡å¯¹å‰é¢çš„hello_mainçš„Makefileè¿›è¡Œæ”¹é€ ï¼Œå¦‚ä¸‹
```makefile
#å®šä¹‰å˜é‡
CC=gcc
CFLAGS=-I .
DEPS=hello_fun.h

#ç›®æ ‡æ–‡ä»¶
hello_main:hello_main.o hello_fun.o
	$(CC) -o hello_main hello_main.o hello_fun.o 

# *.oæ–‡ä»¶ç”Ÿæˆè§„åˆ™
%.o:%.c $(DEPS)
	$(CC) -c -o $@ $< $(CFLAGS)

#ä¼ªç›®æ ‡
.PHONY: clean
clean:
	rm -f *.o hello_main
```

- ç¬¬1~4è¡Œï¼šå®šä¹‰å˜é‡
- ç¬¬8è¡Œï¼šä½¿ç”¨$(CC)æ›¿æ¢gccï¼Œä¾¿äºåç»­æ›´æ¢ä¸åŒçš„ç¼–è¯‘å™¨ï¼›è‹¥äº¤å‰ç¼–è¯‘ï¼Œåªè¦æŠŠCCä¿®æ”¹å³å¯
- ç¬¬11è¡Œï¼š
	- `%`æ˜¯é€šé…ç¬¦ï¼Œç±»ä¼¼äº`*` 
	- `%.o:%.c`è¡¨ç¤ºï¼Œoæ–‡ä»¶ä¾èµ–ä¸cæ–‡ä»¶çš„é»˜è®¤è§„åˆ™ï¼Œè¿˜ä¾èµ–å˜é‡DEPSè¡¨ç¤ºçš„å¤´æ–‡ä»¶
- ç¬¬12è¡Œï¼š
	- ç‰¹æ®Šçš„å˜é‡`$@ï¼Œ$<`ï¼Œå¯ç†è§£ä¸ºMakefileæ–‡ä»¶ä¿ ç•™çš„å…³é”®å­—ï¼Œæ˜¯ç³»ç»Ÿä¿ç•™çš„è‡ªåŠ¨åŒ–å˜é‡
	- `$@`ä»£è¡¨äº†ç›®æ ‡æ–‡ä»¶ï¼Œå³ `%.o`
	- `$<`ä»£è¡¨äº†ç¬¬ä¸€ä¸ªä¾èµ–æ–‡ä»¶ï¼Œå³`%.c`
- å‡å¦‚ç¬¬11è¡Œ%åŒ¹é…çš„å­—ç¬¦æ˜¯hello_funæ—¶ï¼Œç¬¬12è¡Œçš„ä»£ç å¦‚ä¸‹
```makefile
#å½“"%"åŒ¹é…çš„å­—ç¬¦ä¸º"hello_func"çš„è¯ï¼š
$(CC) -c -o $@ $< $(CFLAGS)
# ç­‰ä»·ä¸
gcc -c -o hello_fun.o hello_fun.c -I .
```

ä¹Ÿå°±æ˜¯è¯´makefileå¯ä»¥åˆ©ç”¨å˜é‡åŠè‡ªåŠ¨åŒ–å˜é‡ï¼Œæ¥é‡å†™.oæ–‡ä»¶çš„é»˜è®¤ç”Ÿæˆ è§„åˆ™ï¼Œä»¥åŠå¢åŠ å¤´æ–‡ä»¶çš„ä¾èµ–
### 6.3 æ”¹é€ é“¾æ¥è§„åˆ™

ä¸*.oæ–‡ä»¶çš„é»˜è®¤è§„åˆ™ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å˜é‡æ¥ä¿®æ”¹ç”Ÿæˆæœ€ç»ˆç›®æ ‡ æ–‡ä»¶çš„é“¾æ¥è§„åˆ™ï¼Œå…·ä½“å‚è€ƒå¦‚ä¸‹ä»£ç ã€‚

```c
#å®šä¹‰å˜é‡
TARGET=hello_main
CC=gcc
CFLAGS=-I .
DEPS=hello_fun.h
OBJS=hello_main.o hello_fun.o

#ç›®æ ‡æ–‡ä»¶
$(TARGET):$(OBJS)
	$(CC) -o $@ $^ $(CFLAGS)

# *.oæ–‡ä»¶ç”Ÿæˆè§„åˆ™
%.o:%.c $(DEPS)
	$(CC) -c -o $@ $< $(CFLAGS)

#ä¼ªç›®æ ‡
.PHONY: clean
clean:
	rm -f *.o hello_main
```

- ç¬¬2è¡Œï¼šå®šä¹‰TARGETå˜é‡ï¼Œè¡¨ç¤ºç›®æ ‡æ–‡ä»¶å
- ç¬¬6è¡Œï¼šå®šä¹‰OBJSå˜é‡ï¼Œè¡¨ç¤ºä¾èµ–çš„å„ä¸ªoæ–‡ä»¶
- ç¬¬9è¡Œï¼šä½¿ç”¨å˜é‡æ›¿æ¢ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶
- ç¬¬10è¡Œï¼šä½¿ç”¨è‡ªåŠ¨åŒ–å˜é‡`$@`è¡¨ç¤ºç›®æ ‡æ–‡ä»¶`$(TARGET)`ï¼Œä½¿ç”¨è‡ªåŠ¨åŒ–å˜é‡`$^`è¡¨ç¤ºæ‰€æœ‰çš„ä¾èµ–æ–‡ä»¶å³`$(OBJS)`

ä¹Ÿå°±æ˜¯è¯´ä»¥ä¸Šä»£ç ä¸­çš„MakefileæŠŠç¼–è¯‘åŠé“¾æ¥çš„è¿‡ç¨‹éƒ½é€šè¿‡å˜é‡è¡¨ç¤ºå‡ºæ¥äº†ï¼Œéå¸¸é€šç”¨ã€‚ **ä½¿ç”¨è¿™æ ·çš„Makefileå¯ä»¥é’ˆå¯¹ä¸åŒçš„å·¥ç¨‹ç›´æ¥ä¿®æ”¹å˜é‡çš„å†…å®¹å°±å¯ä»¥ä½¿ç”¨ã€‚**
### 6.4 å…¶ä»–è‡ªåŠ¨åŒ–å˜é‡ï¼ˆæŸ¥é˜…ï¼‰

Makefileä¸­è¿˜æœ‰å…¶å®ƒè‡ªåŠ¨åŒ–å˜é‡ï¼Œæ­¤å¤„ä»…åˆ—å‡ºæ–¹ä¾¿ä»¥åä½¿ç”¨åˆ°çš„æ—¶å€™è¿›è¡ŒæŸ¥é˜…ï¼Œè§ä¸‹è¡¨ã€‚

|ç¬¦å·|æ„ä¹‰|
|---|---|
|$@|åŒ¹é…ç›®æ ‡æ–‡ä»¶|
|$%|ä¸$@ç±»ä¼¼ï¼Œä½†$%ä»…åŒ¹é…â€œåº“â€ç±»å‹çš„ç›®æ ‡æ–‡ä»¶|
|$<|ä¾èµ–ä¸­çš„ç¬¬ä¸€ä¸ªç›®æ ‡æ–‡ä»¶|
|$^|æ‰€æœ‰çš„ä¾èµ–ç›®æ ‡ï¼Œå¦‚æœä¾èµ–ä¸­æœ‰é‡å¤çš„ï¼Œåªä¿ç•™ä¸€ä»½|
|$+|æ‰€æœ‰çš„ä¾èµ–ç›®æ ‡ï¼Œå³ä½¿ä¾èµ–ä¸­æœ‰é‡å¤çš„ä¹ŸåŸæ ·ä¿ç•™|
|$?|æ‰€æœ‰æ¯”ç›®æ ‡è¦æ–°çš„ä¾èµ–ç›®æ ‡|
## 7 ä½¿ç”¨å‡½æ•°

åœ¨æ›´å¤æ‚çš„å·¥ç¨‹ä¸­ï¼Œå¤´æ–‡ä»¶ã€æºæ–‡ä»¶å¯èƒ½ä¼šæ”¾åœ¨äºŒçº§ç›®å½•ï¼Œç¼–è¯‘ç”Ÿæˆçš„*.oæˆ– å¯æ‰§è¡Œæ–‡ä»¶ä¹Ÿæ”¾åˆ°ä¸“é—¨çš„ç¼–è¯‘è¾“å‡ºç›®å½•æ–¹ä¾¿æ•´ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ç¤ºä¾‹ä¸­*.hå¤´æ–‡ä»¶ æ”¾åœ¨includesç›®å½•ä¸‹ï¼Œ`*.c`æ–‡ä»¶æ”¾åœ¨sourcesç›®å½•ä¸‹ï¼Œç¼–è¯‘è¾“å‡ºå­˜ æ”¾åœ¨buildä¸­ã€‚

å®ç°è¿™äº›å¤æ‚çš„æ“ä½œé€šå¸¸éœ€è¦ä½¿ç”¨Makefileçš„å‡½æ•°ã€‚
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a04f8c1dfe8f5b0d220b5508b0f6725e.png)

### 7.1 å‡½æ•°æ ¼å¼åŠç¤ºä¾‹

åœ¨Makefileä¸­è°ƒç”¨å‡½æ•°çš„æ–¹æ³•è·Ÿå˜é‡çš„ä½¿ç”¨ ç±»ä¼¼ï¼Œä»¥â€œ$()â€æˆ–â€œ${}â€ç¬¦å·åŒ…å«å‡½æ•°åå’Œå‚æ•°ï¼Œå…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š
```makefile
$(å‡½æ•°å å‚æ•°)
#æˆ–è€…ä½¿ç”¨èŠ±æ‹¬å·
${å‡½æ•°å å‚æ•°}
```

ä¸‹é¢ä»¥å¸¸ç”¨çš„notdirã€patsubstã€wildcardå‡½æ•°ä¸ºä¾‹ è¿›è¡Œè®²è§£ï¼Œå¹¶ä¸”ç¤ºä¾‹ä¸­éƒ½æ˜¯æˆ‘ä»¬åé¢Makefileä¸­ä½¿ç”¨åˆ°çš„å†…å®¹ã€‚
#### 7.1.1 notdirå‡½æ•°

å…¶ä»–å‚è€ƒï¼š[6.5 notdir å‡½æ•°ï¼ˆå»æ‰è·¯å¾„æ˜¾ç¤ºï¼‰](../../../3_è®¯ä¸ºè¯¾ç¨‹/1_å‰è¨€/2_Linuxå…¥é—¨åŸºç¡€.md#6.5%20notdir%20å‡½æ•°ï¼ˆå»æ‰è·¯å¾„æ˜¾ç¤ºï¼‰)

notdirå‡½æ•°ç”¨äº**å»é™¤æ–‡ä»¶è·¯å¾„ä¸­çš„ç›®å½•éƒ¨åˆ†**ã€‚å®ƒçš„æ ¼å¼å¦‚ä¸‹ï¼š
```makefile
$(notdir æ–‡ä»¶å)
```

ä¾‹å¦‚è¾“å…¥å‚æ•°â€œ./sources/hello_func.câ€ï¼Œå‡½æ•°æ‰§è¡Œå çš„è¾“å‡ºä¸ºâ€œhell_func.câ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¼šæŠŠè¾“å…¥ä¸­çš„â€œ./sources/â€è·¯å¾„éƒ¨åˆ†å»æ‰ï¼Œä¿ç•™ æ–‡ä»¶åã€‚ä½¿ç”¨èŒƒä¾‹å¦‚ä¸‹ï¼š
```makefile
#ä»¥ä¸‹æ˜¯èŒƒä¾‹
$(notdir ./sources/hello_func.c)

#ä¸Šé¢çš„å‡½æ•°æ‰§è¡Œåä¼šæŠŠè·¯å¾„ä¸­çš„â€œ./sources/â€éƒ¨åˆ†å»æ‰ï¼Œè¾“å‡ºä¸ºï¼š hello_func.c
```
#### 7.1.2 wildcardå‡½æ•°

å…¶ä»–å‚è€ƒï¼š[6.4 wildcard å‡½æ•°ï¼ˆå±•å¼€æŒ‡å®šç›®å½•ï¼‰](../../../3_è®¯ä¸ºè¯¾ç¨‹/1_å‰è¨€/2_Linuxå…¥é—¨åŸºç¡€.md#6.4%20wildcard%20å‡½æ•°ï¼ˆå±•å¼€æŒ‡å®šç›®å½•ï¼‰)

wildcardå‡½æ•°ç”¨äº`è·å–æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶ä½¿ç”¨ç©ºæ ¼åˆ†éš”å¼€`ã€‚å®ƒçš„æ ¼å¼å¦‚ä¸‹ï¼š
```makefile
$(wildcard åŒ¹é…è§„åˆ™)
```

ä¾‹å¦‚å‡½æ•°è°ƒç”¨Â `$(wildcardÂ *.c)`Â ï¼Œå‡½æ•°æ‰§è¡Œåä¼šæŠŠå½“å‰ç›®å½•çš„æ‰€ æœ‰cæ–‡ä»¶åˆ—å‡ºã€‚å‡è®¾æˆ‘ä»¬åœ¨ä¸Šå›¾ä¸­çš„Makefileç›®å½•ä¸‹æ‰§è¡Œè¯¥å‡½æ•°ï¼Œä½¿ç”¨èŒƒä¾‹å¦‚ä¸‹ï¼š
```makefile
#åœ¨sourcesç›®å½•ä¸‹æœ‰hello_func.cã€hello_main.cã€test.cæ–‡ä»¶
#æ‰§è¡Œå¦‚ä¸‹å‡½æ•°
$(wildcard sources/*.c)
#å‡½æ•°çš„è¾“å‡ºä¸ºï¼š
sources/hello_func.c sources/hello_main.c sources/test.c
```
#### 7.1.3 patsubstå‡½æ•°

å…¶ä»–å‚è€ƒï¼š[6.7 patsubst å‡½æ•°ï¼ˆæ›¿æ¢æ–‡ä»¶åç¼€ï¼‰](../../../3_è®¯ä¸ºè¯¾ç¨‹/1_å‰è¨€/2_Linuxå…¥é—¨åŸºç¡€.md#6.7%20patsubst%20å‡½æ•°ï¼ˆæ›¿æ¢æ–‡ä»¶åç¼€ï¼‰)

patsubstå‡½æ•°åŠŸèƒ½ä¸º`æ¨¡å¼å­—ç¬¦ä¸²æ›¿æ¢`ã€‚å®ƒçš„æ ¼å¼å¦‚ä¸‹ï¼š
```makefile
$(patsubst åŒ¹é…è§„åˆ™, æ›¿æ¢è§„åˆ™, è¾“å…¥çš„å­—ç¬¦ä¸²)
```

å½“è¾“å…¥çš„å­—ç¬¦ä¸²ç¬¦åˆåŒ¹é…è§„åˆ™ï¼Œé‚£ä¹ˆä½¿ç”¨æ›¿æ¢è§„åˆ™æ¥æ›¿æ¢å­—ç¬¦ä¸²ï¼Œå½“åŒ¹é…è§„åˆ™ä¸­æœ‰â€œ%â€å·æ—¶ï¼Œæ›¿æ¢è§„ åˆ™ä¹Ÿå¯ä»¥ä¾‹ç¨‹â€œ%â€å·æ¥æå–â€œ%â€åŒ¹é…çš„å†…å®¹åŠ å…¥åˆ°æœ€åæ›¿æ¢çš„å­—ç¬¦ä¸²ä¸­ã€‚æœ‰ç‚¹æŠ½è±¡ï¼Œè¯·ç›´æ¥é˜…è¯»ä»¥ä¸‹ç¤ºä¾‹ï¼š
```makefile
$(patsubst %.c, build_dir/%.o, hello_main.c )
#å‡½æ•°çš„è¾“å‡ºä¸ºï¼š
build_dir/hello_main.o

#æ‰§è¡Œå¦‚ä¸‹å‡½æ•°
$(patsubst %.c, build_dir/%.o, hello_main.xxx )
#ç”±äºhello_main.xxxä¸ç¬¦åˆåŒ¹é…è§„åˆ™"%.c"ï¼Œæ‰€ä»¥å‡½æ•°æ²¡æœ‰è¾“å‡º
```

- ç¬¬ä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸­ï¼Œç”±äºâ€œhello_main.câ€ç¬¦åˆâ€œ%.câ€çš„åŒ¹é…è§„åˆ™ï¼ˆ%åœ¨Makefileä¸­çš„ç±»ä¼¼äº`*`é€šé…ç¬¦ï¼‰ï¼Œè€Œä¸”â€œ%â€ä»â€œhello_main.câ€ä¸­æå–å‡ºäº†â€œhello_mainâ€å­—ç¬¦ï¼ŒæŠŠè¿™éƒ¨åˆ†å†…å®¹æ”¾åˆ°æ›¿æ¢è§„åˆ™â€œbuild_dir/%.oâ€çš„â€œ%â€å·ä¸­ï¼Œæ‰€ä»¥æœ€ç»ˆçš„è¾“å‡ºä¸ºâ€build_di r/hello_main.oâ€

- ç¬¬äºŒä¸ªå‡½æ•°è°ƒç”¨ä¸­ï¼Œç”±äºç”±äºâ€œhello_main.xxxâ€ä¸ç¬¦åˆâ€œ%.câ€çš„åŒ¹é…è§„åˆ™ï¼Œâ€œ.xxxâ€ä¸â€œ.câ€å¯¹ä¸ä¸Šï¼Œæ‰€ä»¥ä¸ä¼šè¿›è¡Œæ›¿æ¢ï¼Œå‡½æ•°ç›´æ¥è¿”å›ç©ºçš„å†…å®¹
#### 7.1.4 å…¶ä»–å‡½æ•°

- [6.6 dir å‡½æ•°ï¼ˆå–å‡ºç›®å½•ï¼‰](../../../3_è®¯ä¸ºè¯¾ç¨‹/1_å‰è¨€/2_Linuxå…¥é—¨åŸºç¡€.md#6.6%20dir%20å‡½æ•°ï¼ˆå–å‡ºç›®å½•ï¼‰)
- [6.8 foreach å‡½æ•°](../../../3_è®¯ä¸ºè¯¾ç¨‹/1_å‰è¨€/2_Linuxå…¥é—¨åŸºç¡€.md#6.8%20foreach%20å‡½æ•°)
### 7.2 å¤šçº§ç»“æ„å·¥ç¨‹çš„Makefile

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢ä¸‰ä¸ªå‡½æ•°ä¿®æ”¹æˆ‘ä»¬çš„Makefileï¼Œä»¥é€‚åº”åŒ…å«å¤šçº§ç›®å½•çš„å·¥ç¨‹ï¼Œä¿®æ”¹åçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º
```makefile
#å®šä¹‰å˜é‡
TARGET=hello_main
#å­˜æ”¾ä¸­é—´æ–‡ä»¶çš„è·¯å¾„
BUILD_DIR=build
#å­˜æ”¾æºæ–‡ä»¶çš„æ–‡ä»¶å¤¹
SRC_DIR=src
#å­˜æ”¾å¤´æ–‡ä»¶çš„æ–‡ä»¶å¤¹
INC_DIR=includes .
#æºæ–‡ä»¶
SRCS=$(wildcard $(SRC_DIR)/*.c)
#ç›®æ ‡æ–‡ä»¶
OBJS=$(patsubst %.c,$(BUILD_DIR)/%.o,$(notdir $(SRCS)))
#å¤´æ–‡ä»¶
DEPS = $(foreach dir,$(INC_DIR),$(wildcard $(dir)/*.h))
#æŒ‡å®šå¤´æ–‡ä»¶çš„è·¯å¾„
CFLAGS=$(patsubst %,-I%,$(INC_DIR))

#ç›®æ ‡æ–‡ä»¶
$(BUILD_DIR)/$(TARGET):$(OBJS)
	$(CC) -o $@ $^ $(CFLAGS)

# *.oæ–‡ä»¶ç”Ÿæˆè§„åˆ™
$(BUILD_DIR)/%.o:$(SRC_DIR)/%.c $(DEPS)
#åˆ›å»ºä¸€ä¸ªç¼–è¯‘ç›®å½•ï¼Œç”¨äºå­˜æ”¾è¿‡ç¨‹æ–‡ä»¶
#å‘½ä»¤å‰å¸¦@ï¼Œè¡¨ç¤ºä¸åœ¨ç»ˆç«¯ä¸Šè¾“å‡º
	@mkdir -p $(BUILD_DIR)
	$(CC) -c -o $@ $< $(CFLAGS)

#ä¼ªç›®æ ‡
.PHONY: clean cleanall
#åˆ é™¤è¾“å‡ºæ–‡ä»¶å¤¹
clean:
	rm -rf $(BUILD_DIR)
#å…¨éƒ¨åˆ é™¤
cleanall:
	rm -rf $(BUILD_DIR)
```

åˆ†æå¦‚ä¸‹ï¼š
- ç¬¬4-8è¡Œï¼š
	- BUILD_DIRèµ‹å€¼ä¸ºå·¥ç¨‹ç¼–è¯‘è¾“å‡ºè·¯å¾„build
	- SRC_DIRèµ‹å€¼ä¸ºæºæ–‡ä»¶è·¯å¾„sources
	- INC_DIRèµ‹å€¼ä¸ºå¤´æ–‡ä»¶è·¯å¾„includeså’Œå½“å‰ç›®å½• `.`

- ç¬¬10è¡Œï¼šSRCSå­˜å‚¨æ‰€æœ‰éœ€è¦ç¼–è¯‘çš„cæ–‡ä»¶ï¼Œèµ‹å€¼ä¸ºwildcardå‡½æ•°çš„è¾“å‡ºï¼Œå³`sources/hello_fun.c sources/hello_main.c`

- ç¬¬12è¡Œï¼šOBJSå­˜å‚¨æ‰€æœ‰è¦ç”Ÿæˆçš„oæ–‡ä»¶ï¼Œèµ‹å€¼ä¸ºpatsubstå‡½æ•°çš„è¾“å‡ºï¼Œå³`build/hello_fun.o build /hello_main.o`

- ç¬¬14è¡Œï¼šDEPSå­˜å‚¨æ‰€æœ‰ä¾èµ–çš„hæ–‡ä»¶ï¼Œå€¼ä¸ºforeachå‡½æ•°çš„è¾“å‡ºï¼Œ`å³å°†includesç›®å½•å’Œ`.`ç›®å½•ä¸‹æ‰€æœ‰çš„hæ–‡ä»¶æ‹¼æ¥åœ¨ä¸€èµ·`

- ç¬¬16è¡Œï¼šCFLAGSå­˜å‚¨åŒ…å«çš„hæ–‡ä»¶è·¯å¾„ï¼Œå€¼ä¸ºpassubstå‡½æ•°çš„è¾“å‡ºï¼Œå³`-Iincludes -I.`

- ç¬¬19è¡Œï¼šç›¸æ¯”äºä¹‹å‰ï¼Œåœ¨`$(TARGET)`å‰å¢åŠ äº†`$(BUILD_DIR)`è·¯å¾„ï¼Œä½¿å¾—æœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºæ”¾åœ¨buildç›®å½•ä¸‹
- ç¬¬23è¡Œï¼šä¸ä¸Šé¢ç±»ä¼¼ï¼Œç»™`.o`ç›®æ ‡æ–‡ä»¶æ·»åŠ $(BUILD_DIR)è·¯å¾„
- ç¬¬27è¡Œï¼šåœ¨æ‰§è¡Œç¼–è¯‘å‰å…ˆåˆ›å»ºbuildç›®å½•ï¼Œä»¥å­˜æ”¾åé¢çš„.oæ–‡ä»¶ï¼Œå‘½ä»¤å‰çš„â€œ@â€è¡¨ç¤ºæ‰§è¡Œè¯¥å‘½ä»¤æ—¶ä¸åœ¨ç»ˆç«¯ä¸Šè¾“å‡º
- ç¬¬34è¡Œï¼šrmåˆ é™¤å‘½ä»¤ä¹Ÿè¢«ä¿®æ”¹æˆç›´æ¥åˆ é™¤ç¼–è¯‘ç›®å½•$(BUILD_DIR)
- ç¬¬38-39è¡Œï¼šå¢åŠ äº†åˆ é™¤æ‰€æœ‰æ¶æ„ç¼–è¯‘ç›®å½•çš„ä¼ªç›®æ ‡cleanall

ä½¿ç”¨è¯¥Makefileæ—¶ï¼Œç›´æ¥åœ¨Makefileçš„ç›®å½•æ‰§è¡Œmakeå³å¯ï¼š
```shell
#ä½¿ç”¨treeå‘½ä»¤æŸ¥çœ‹ç›®å½•ç»“æ„
#è‹¥æç¤ºæ‰¾ä¸åˆ°å‘½ä»¤ï¼Œä½¿ç”¨ sudo apt install treeå®‰è£…
tree

#ç¼–è¯‘
make
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/d0dfb7feed8fa00d4c3740de88e6980f.png)

## 8 ä½¿ç”¨åˆ†æ”¯

å¦‚æœæ²¡æœ‰PCä¸Šçš„linux,å¯ä»¥è·³è¿‡æœ¬èŠ‚å†…å®¹æˆ–è€…å­¦ä¹ ä¸€ä¸‹åˆ†æ”¯çš„è¯­æ³•ã€‚

ä¸ºæ–¹ä¾¿ç›´æ¥åˆ‡æ¢GCCç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æ¡ä»¶åˆ†æ”¯å¢åŠ åˆ‡æ¢ç¼–è¯‘å™¨ çš„åŠŸèƒ½ã€‚åœ¨Makefileä¸­çš„æ¡ä»¶åˆ†æ”¯è¯­æ³•å¦‚ä¸‹ï¼š
```makefile
ifea(arg1,arg2)
åˆ†æ”¯1
else
åˆ†æ”¯2
endif
```

åˆ†æ”¯ä¼šæ¯”è¾ƒæ‹¬å·å†…çš„å‚æ•°â€œarg1â€å’Œâ€œarg2â€çš„å€¼æ˜¯å¦ç›¸ åŒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™ä¸ºçœŸï¼Œæ‰§è¡Œåˆ†æ”¯1çš„å†…å®¹ï¼Œå¦åˆ™çš„è¯ï¼Œæ‰§è¡Œåˆ†æ”¯2 çš„å†…å®¹ï¼Œå‚ æ•°arg1å’Œarg2å¯ä»¥æ˜¯å˜é‡æˆ–è€…æ˜¯å¸¸é‡ã€‚

ä½¿ç”¨åˆ†æ”¯åˆ‡æ¢GCCç¼–è¯‘å™¨çš„Makefileå¦‚ä¸‹æ‰€ç¤ºã€‚(åœ¨pcä¸Šä½¿ç”¨)
```makefile
#å®šä¹‰å˜é‡
#ARCHé»˜è®¤ä¸ºx86ï¼Œä½¿ç”¨gccç¼–è¯‘å™¨
ARCH ?= x86
TARGET = hello_main

#å­˜æ”¾ä¸­é—´æ–‡ä»¶çš„è·¯å¾„
BUILD_DIR = build_$(ARCH)
#å­˜æ”¾æºæ–‡ä»¶çš„è·¯å¾„
SRC_DIR = sources
#å­˜æ”¾å¤´æ–‡ä»¶çš„è·¯å¾„
INC_DIR = includes .

#æºæ–‡ä»¶
SRCS = $(wildcard $(SRC_DIR)/*.c)
#ç›®æ ‡æ–‡ä»¶
OBJS = $(patsubst %.c, $(BUILD_DIR)/%.o,$(notdir $(SRCS)))
#å¤´æ–‡ä»¶
DEPS = $(foreach dir,$(INC_DIR),$(wildcard $(dir)/*.h))

#æŒ‡å®šå¤´æ–‡ä»¶çš„è·¯å¾„
CFLAGS= $(patsubst %,-I%,$(INC_DIR))

#æ ¹æ®è¾“å…¥çš„ARCHå˜é‡ï¼Œé€‰æ‹©ä¸åŒçš„ç¼–è¯‘å™¨
#ARCH = x86,ä½¿ç”¨gcc
#ARCH = arm,ä½¿ç”¨arm-gcc
ifeq ($(ARCH),x86)
CC = gcc
else
CC = aarch64-linux-gnu-gcc
endif

#ç›®æ ‡æ–‡ä»¶
$(BUILD_DIR)/$(TARGET):$(OBJS)
	$(CC) -o $@ $^ $(CFLAGS)

#oæ–‡ä»¶çš„ç”Ÿæˆè§„åˆ™
$(BUILD_DIR)/%.o:$(SRC_DIR)/%.c $(DEPS)
	@mkdir -p $(BUILD_DIR)
	$(CC) -c -o $@ $< $(CFLAGS)

#ä¼ªç›®æ ‡
.PHONY: clean cleanall
#æŒ‰æ¶æ„åˆ é™¤
clean:
	rm -rf $(BUILD_DIR)

#å…¨éƒ¨åˆ é™¤
cleanall:
	rm -rf build_x86 build_arm
```

ä¿®æ”¹åçš„Makefileæ–‡ä»¶åˆ†æå¦‚ä¸‹ï¼š
- ç¬¬1~4è¡Œï¼šå¢åŠ ARCHçš„å¤åˆ¶ï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™å¤åˆ¶ä¸ºx86
- ç¬¬9è¡Œï¼šå¢åŠ ä¸åŒç¼–è¯‘æ–¹å¼è¾“å‡ºç»“æœçš„æ–‡ä»¶å¤¹
- ç¬¬25~32è¡Œï¼šå¢åŠ gccç¼–è¯‘å™¨çš„é€‰æ‹©
- ç¬¬48è¡Œï¼šé€‰æ‹©åˆ é™¤ä¸åŒç¼–è¯‘å™¨çš„è¾“å‡º
- ç¬¬48è¡Œï¼šæŠŠæ‰€æœ‰è¾“å‡ºç»“æœéƒ½åˆ é™¤

ä½¿ç”¨è¯¥Makefileæ—¶ï¼Œç›´æ¥åœ¨Makefileçš„ç›®å½•æ‰§è¡Œmakeå³å¯ï¼š
```shell
#ä½¿ç”¨treeå‘½ä»¤æŸ¥çœ‹ç›®å½•ç»“æ„
#è‹¥æç¤ºæ‰¾ä¸åˆ°å‘½ä»¤ï¼Œä½¿ç”¨ sudo apt install treeå®‰è£…
tree

#æ¸…é™¤ç¼–è¯‘è¾“å‡ºï¼Œç¡®ä¿ä¸å—ä¹‹å‰çš„ç¼–è¯‘è¾“å‡ºå½±å“
make clean
#ä½¿ç”¨ARMå¹³å°
make ARCH=ARM64
#æ¸…é™¤ç¼–è¯‘è¾“å‡º
make clean
#é»˜è®¤æ˜¯x86å¹³å°
make
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a454c42d69952119fec8f17d44fdc207.png)

æœ¬ç¤ºä¾‹ä¸­çš„Makefileç›®å‰åªæ”¯æŒä½¿ç”¨ä¸€ä¸ªæºæ–‡ä»¶ç›®å½•ï¼Œå¦‚æœæœ‰å¤šä¸ªæºæ–‡ ä»¶ç›®å½•è¿˜éœ€è¦æ”¹è¿›ï¼Œå…³äºè¿™äº›ï¼Œæˆ‘ä»¬åœ¨ä»¥åçš„å­¦ä¹ ä¸­ç»§ç»­ç§¯ç´¯ã€‚