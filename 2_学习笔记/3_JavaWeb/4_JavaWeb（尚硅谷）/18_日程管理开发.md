
# 1、第一期

涉及技术：HTML、CSS、JS

## 1.1 登录页面

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>

        .ht{
            text-align: center;
            color: cadetblue;
            font-family: 幼圆;
        }
        .tab{
            width: 500px;
            border: 5px solid cadetblue;
            margin: 0px auto;
            border-radius: 5px;
            font-family: 幼圆;
        }
        .ltr td{
            border: 1px solid  powderblue;

        }
        .ipt{
            border: 0px;
            width: 50%;

        }
        .btn1{
            border: 2px solid powderblue;
            border-radius: 4px;
            width:60px;
            background-color: antiquewhite;

        }
        #usernameMsg , #userPwdMsg {
            color: rgb(230, 87, 51);
        }

        .buttonContainer{
            text-align: center;
        }
    </style>
    <script>
        // 检验用户名格式是否合法的函数
        function checkUsername(){
            // 定义正则表示字符串的规则
            var  usernameReg= /^[a-zA-Z0-9]{5,10}$/
            // 获得用户在页面上输入的信息
            var usernameInput =document.getElementById("usernameInput")
            var username = usernameInput.value
            // 获得格式提示的框
            var usernameMsg =document.getElementById("usernameMsg")
            // 格式有误时,返回false,在页面上提示
            if(!usernameReg.test(username)){ 
                usernameMsg.innerText="用户名格式有误"
                return false
            }
            // 格式OK,返回true 在页面上提示OK
            usernameMsg.innerText="OK"
            return true

        }

        // 检验密码格式是否合法的函数
        function checkUserPwd(){
            // 定义正则表示字符串的规则
            var  userPwdReg= /^[0-9]{6}$/
            // 获得用户在页面上输入的信息
            var userPwdInput =document.getElementById("userPwdInput")
            var userPwd = userPwdInput.value
            // 获得格式提示的框
            var userPwdMsg =document.getElementById("userPwdMsg")
            // 格式有误时,返回false,在页面上提示
            if(!userPwdReg.test(userPwd)){ 
                userPwdMsg.innerText="密码必须是6位数字"
                return false
            }
            // 格式OK,返回true 在页面上提示OK
            userPwdMsg.innerText="OK"
            return true

        }

        // 表单在提交时,校验用户名和密码格式,格式OK才会提交
        function checkForm(){
            var flag1 =checkUsername()
            var flag2 =checkUserPwd()

            return flag1&&flag2
        }


    </script>

    
</head>
<body>
    <h1 class="ht">欢迎使用日程管理系统</h1>
    <h3 class="ht">请登录</h3>
    <form method="post" action="/user/login" onsubmit="return checkForm()">
        <table class="tab" cellspacing="0px">
            <tr class="ltr">
                <td>请输入账号</td>
                <td>
                    <input class="ipt" type="text" id="usernameInput" name="username" onblur="checkUsername()">
                    <span id="usernameMsg"></span>
                </td>
            </tr>
            <tr class="ltr">
                <td>请输入密码</td>
                <td>
                    <input class="ipt" type="password" id="userPwdInput"  name="userPwd" onblur="checkUserPwd()">
                    <span id="userPwdMsg"></span>
                </td>
            </tr>
            <tr class="ltr">
                <td colspan="2" class="buttonContainer">
                    <input class="btn1" type="submit" value="登录">
                    <input class="btn1" type="reset" value="重置">
                    <button class="btn1"><a href="regist.html">去注册</a></button>
                </td>
            </tr>
        </table>
    </form>
</body>
</html>
```
## 1.2 注册页面

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>

        .ht{
            text-align: center;
            color: cadetblue;
            font-family: 幼圆;
        }
        .tab{
            width: 500px;
            border: 5px solid cadetblue;
            margin: 0px auto;
            border-radius: 5px;
            font-family: 幼圆;
        }
        .ltr td{
            border: 1px solid  powderblue;

        }
        .ipt{
            border: 0px;
            width: 50%;

        }
        .btn1{
            border: 2px solid powderblue;
            border-radius: 4px;
            width:60px;
            background-color: antiquewhite;

        }

        .msg {
            color: gold;
        }

        .buttonContainer{
            text-align: center;
        }
    </style>

    <script>
        function checkUsername(){
            var usernameReg = /^[a-zA-Z0-9]{5,10}$/
            var usernameInput = document.getElementById("usernameInput")  
            var username = usernameInput.value  
            var usernameMsg = document.getElementById("usernameMsg")
            if(!usernameReg.test(username)){
                usernameMsg.innerText="格式有误"
                return false
            } 
            usernameMsg.innerText="OK"
            return true 
        }


        function checkUserPwd(){
            var userPwdReg = /^\d{6}$/
            var userPwdInput = document.getElementById("userPwdInput")  
            var userPwd = userPwdInput.value  
            var userPwdMsg = document.getElementById("userPwdMsg")
            if(!userPwdReg.test(userPwd)){
                userPwdMsg.innerText="格式有误"
                return false
            } 
            userPwdMsg.innerText="OK"
            return true 
        }


        function checkReUserPwd(){
            var userPwdReg = /^\d{6}$/
            // 再次输入的密码的格式
            var reUserPwdInput = document.getElementById("reUserPwdInput")  
            var reUserPwd = reUserPwdInput.value 
            var reUserPwdMsg = document.getElementById("reUserPwdMsg")
            if(!userPwdReg.test(reUserPwd)){
                reUserPwdMsg.innerText="格式有误"
                return false
            } 
            // 获得上次密码,对比两次密码是否一致
            var userPwdInput = document.getElementById("userPwdInput")  
            var userPwd = userPwdInput.value  
            if(reUserPwd != userPwd){
                reUserPwdMsg.innerText="两次密码不一致"
                return false
            } 
            reUserPwdMsg.innerText="OK"
            return true 
        }


        function checkForm(){
            var flag1 = checkUsername()
            var flag2 = checkUserPwd()
            var flag3 = checkReUserPwd()

            return flag1 && flag2 && flag3
        }


    </script>


   
</head>
<body>
<h1 class="ht">欢迎使用日程管理系统</h1>
<h3 class="ht">请注册</h3>
<form method="post" action="/user/regist" onsubmit="return checkForm()">
    <table class="tab" cellspacing="0px">
        <tr class="ltr">
            <td>请输入账号</td>
            <td>
                <input class="ipt" id="usernameInput" type="text" name="username" onblur="checkUsername()">
                <span id="usernameMsg" class="msg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td>请输入密码</td>
            <td>
                <input class="ipt" id="userPwdInput" type="password" name="userPwd" onblur="checkUserPwd()">
                <span id="userPwdMsg" class="msg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td>确认密码</td>
            <td>
                <input class="ipt" id="reUserPwdInput" type="password" onblur="checkReUserPwd()">
                <span id="reUserPwdMsg" class="msg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td colspan="2" class="buttonContainer">
                <input class="btn1" type="submit" value="注册">
                <input class="btn1" type="reset" value="重置">
                <button class="btn1"><a  href="login.html">去登录</a></button>
            </td>
        </tr>
    </table>

</form>
</body>
</html>
```

# 2、第二期

涉及技术：
- Tomcat的使用，并接入IDEA
- IDEA创建WebApplicaiton项目
- Servlet、Request、Response的使用
- MVC开发模式

## 2.1 项目搭建

### 1. 数据库准备

+ 创建schedule_system数据库并执行如下语句

``` sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;


-- ----------------------------
-- 创建日程表
-- ----------------------------
DROP TABLE IF EXISTS `sys_schedule`;
CREATE TABLE `sys_schedule`  (
  `sid` int NOT NULL AUTO_INCREMENT,
  `uid` int NULL DEFAULT NULL,
  `title` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  `completed` int(1) NULL DEFAULT NULL,
  PRIMARY KEY (`sid`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- 插入日程数据
-- ----------------------------

-- ----------------------------
-- 创建用户表
-- ----------------------------
DROP TABLE IF EXISTS `sys_user`;
CREATE TABLE `sys_user`  (
  `uid` int NOT NULL AUTO_INCREMENT,
  `username` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  `user_pwd` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  PRIMARY KEY (`uid`) USING BTREE,
  UNIQUE INDEX `username`(`username`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- 插入用户数据
-- ----------------------------
INSERT INTO `sys_user` VALUES (1, 'zhangsan', 'e10adc3949ba59abbe56e057f20f883e');
INSERT INTO `sys_user` VALUES (2, 'lisi', 'e10adc3949ba59abbe56e057f20f883e');

SET FOREIGN_KEY_CHECKS = 1;

```

+ 获得如下表格![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240318200641.png)
### 2. 项目结构

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240318200713.png)

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240318200725.png)

### 3. 导入依赖

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240318200838.png)
### 4. pojo包处理

>  使用lombok处理getter setter equals hashcode 构造器 

``` java
//-----------------------------------------------------
@AllArgsConstructor
@NoArgsConstructor
@Data
public class SysUser  implements Serializable {
    private Integer uid;
    private String username;
    private String userPwd;
}
//------------------------------------------------------
@AllArgsConstructor
@NoArgsConstructor
@Data
public class SysSchedule implements Serializable {
    private Integer sid;
    private Integer uid;
    private String title;
    private Integer completed;
}
//------------------------------------------------------
```

### 5. dao包处理

导入JDBCUtil连接池工具类并准备jdbc.properties配置文件

```java
public class JDBCUtil {  
    //ThreadLocal中填充的变量属于当前线程，该变量对其他线程而言是隔离的  
    // 也就是说该变量是当前线程独有的变量  
    private static ThreadLocal<Connection> threadLocal =  
            new ThreadLocal<>();  
  
    private static DataSource dataSource;  
  
    //初始化连接池  
    static{  
        //读取配置文件  
        Properties pro = new Properties();  
        try {  
            pro.load(JDBCUtil.class.getClassLoader().getResourceAsStream("jdbc.properties"));  
        } catch (IOException e) {  
            throw new RuntimeException(e);  
        }  
        //使用Druid数据库连接池获取，数据源  
        try {  
            dataSource = DruidDataSourceFactory.createDataSource(pro);  
        } catch (Exception e) {  
            throw new RuntimeException(e);  
        }  
    }  
  
    //向外提供连接池  
    public static DataSource getDataSource(){  
        return dataSource;  
    }  
  
    //向外提供连接  
    public static Connection getConnection(){  
        Connection con = threadLocal.get();  
        if (null == con){  
            try {  
                con = dataSource.getConnection();  
            } catch (SQLException e) {  
                throw new RuntimeException(e);  
            }  
        }  
        threadLocal.set(con);  
        return con;  
    }  
  
    //定义一个归还连接的方法（解除和ThreadLocal之间的关联）  
    public static void releaseConnection(){  
        Connection con = threadLocal.get();  
        if (null != con){  
            //解除关联  
            threadLocal.remove();  
            try {  
                //将连接设置回自动提交的连接  
                con.setAutoCommit(true);  
                //归还连接到数据池  
                con.close();  
            } catch (SQLException e) {  
                throw new RuntimeException(e);  
            }  
        }  
    }  
  
}
```

```properties
driverClassName=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/schedule_system
username=root
password=root
initialSize=5
maxActive=10
maxWait=1000
```

- 创建BaseDao对象并复制如下代码

```java
public abstract class BaseDao<T> {  
    private QueryRunner qr = new QueryRunner();  
  
    //定义一个类对象，用于接收子类的泛型类型  
    private Class<T> type;  
  
    public BaseDao(){  
        //获取子类的类型  
        Class<? extends BaseDao> clazz = this.getClass();  
  
        //子类获取父类  
        ParameterizedType parameterizedType = (ParameterizedType) clazz.getGenericSuperclass();  
        //ParameterizedType获取的是父类，且父类带有泛型  
        //获取父类的泛型数组  
        Type[] types = parameterizedType.getActualTypeArguments();  
        //很显然，第一个泛型就是泛型的具体类型  
        type = (Class<T>) types[0];  
    }  
  
  
    //通用的增删改操作  
    public int update(Connection con,String sql,Object ... args){  
        int update = 0;  
        try {  
            update = qr.update(con, sql, args);  
        } catch (SQLException e) {  
            e.printStackTrace();  
        }  
        return update==0?0:update;  
    }  
  
    //获取一个对象  
    public T getBean(Connection con,String sql,Object ... args){  
        T query = null;  
        try {  
            query = qr.query(con, sql, new BeanHandler<>(type),args);  
        } catch (SQLException e) {  
            e.printStackTrace();  
        }  
        return query;  
    }  
  
    //获取对象集合  
    public List<T> getBeanList(Connection con,String sql,Object ... args){  
        List<T> query = null;  
        try {  
            query = qr.query(con, sql, new BeanListHandler<>(type),args);  
        } catch (SQLException e) {  
            e.printStackTrace();  
        }  
        return query;  
    }  
  
    //获取一个值的方法，专门用来执行像 select count(*)...这样的sql语句  
    public Object getValue(Connection con,String sql,Object ... args){  
        Object query = null;  
        try {  
            query = qr.query(con, sql, new ScalarHandler<>(), args);  
        } catch (SQLException e) {  
            e.printStackTrace();  
        }  
        return query;  
    }  
}
```

### 6. service包处理

+ 接口

``` java
//-------------------------------------------------------------
public interface SysUserService {
}
//-------------------------------------------------------------
public interface SysScheduleService {
}
```

+ 实现类

```java
//-------------------------------------------------------------
public class SysUserServiceImpl implements SysUserService {
}
//-------------------------------------------------------------
public class SysScheduleServiceImpl implements SysScheduleService {
}
```

### 7. controller包处理

+ BaseController处理请求路径问题

``` java
public class BaseController extends HttpServlet {
    @Override
    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        

        String requestURI = req.getRequestURI();
        String[] split = requestURI.split("/");
        String methodName =split[split.length-1];
        // 通过反射获取要执行的方法
        Class clazz = this.getClass();
        try {
            Method method=clazz.getDeclaredMethod(methodName,HttpServletRequest.class,HttpServletResponse.class);
            // 设置方法可以访问
            method.setAccessible(true);
            // 通过反射执行代码
            method.invoke(this,req,resp);
        } catch (Exception e) {
            e.printStackTrace();
           
        }
    }
}
```

+ 多个处理器继承BaseController

```  java
//-------------------------------------------------------------@WebServlet("/user/*")
public class UserController extends BaseController{
}
//-------------------------------------------------------------@WebServlet("/schedule/*")
public class SysScheduleController  extends BaseController{
}
```
### 8. 加密工具类使用

+ 导入MD5Util工具类
``` java
public final class MD5Util {
    public static String encrypt(String strSrc) {
        try {
            char hexChars[] = { '0', '1', '2', '3', '4', '5', '6', '7', '8',
                    '9', 'a', 'b', 'c', 'd', 'e', 'f' };
            byte[] bytes = strSrc.getBytes();
            MessageDigest md = MessageDigest.getInstance("MD5");
            md.update(bytes);
            bytes = md.digest();
            int j = bytes.length;
            char[] chars = new char[j * 2];
            int k = 0;
            for (int i = 0; i < bytes.length; i++) {
                byte b = bytes[i];
                chars[k++] = hexChars[b >>> 4 & 0xf];
                chars[k++] = hexChars[b & 0xf];
            }
            return new String(chars);
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
            throw new RuntimeException("MD5加密出错!!!")
        }
    }
}
```
### 9. 页面文件导入

- 复制资源下的日程管理中的HTML到项目的web目录下即可![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240318201327.png)
## 2.2 业务代码

### 7. 注册业务处理
- controller
```java
@WebServlet("/user/*")  
public class SysUserController  extends BaseContoller {  
​  
    private SysUserService userService =new SysUserServiceImpl();  
​  
    /**  
     * 接收用户注册请求的业务处理方法( 业务接口 不是java中的interface  )  
     * @param req  
     * @param resp  
     * @throws ServletException  
     * @throws IOException  
     */  
    protected void regist(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {  
        // 1 接收客户端提交的参数  
        String username = req.getParameter("username");  
        String userPwd = req.getParameter("userPwd");  
        // 2 调用服务层方法,完成注册功能  
            //将参数放入一个SysUser对象中,在调用regist方法时传入  
        SysUser sysUser =new SysUser(null,username,userPwd);  
        int rows =userService.regist(sysUser);  
        // 3 根据注册结果(成功  失败) 做页面跳转  
        if(rows>0){  
            resp.sendRedirect("/registSuccess.html");  
        }else{  
            resp.sendRedirect("/registFail.html");  
        }  
    }  
} 
``` 
​  
- service
    

```java
public interface SysUserService {  
    /**  
     * 用户完成注册的业务方法  
     * @param registUser 用于保存注册用户名和密码的对象  
     * @return 注册成功返回>0的整数,否则返回0  
     */  
    int regist(SysUser registUser);  
}


public class SysUserServiceImpl  implements SysUserService {  
    private SysUserDao  userDao =new SysUserDaoImpl();  
    @Override  
    public int regist(SysUser sysUser) {  
​  
        // 将用户的明文密码转换为密文密码  
        sysUser.setUserPwd(MD5Util.encrypt(sysUser.getUserPwd()));  
        // 调用DAO 层的方法  将sysUser信息存入数据库  
        return userDao.addSysUser(sysUser);  
    }  
}
```

- dao
```java
public interface SysUserDao {  
​  
    /**  
     * 向数据库中增加一条用户记录的方法  
     * @param sysUser 要增加的记录的username和user_pwd字段以SysUser实体类对象的形式接收  
     * @return 增加成功返回1 增加失败返回0  
     */  
    int addSysUser(SysUser sysUser);  
}  
​
public class SysUserDaoImpl extends BaseDao implements SysUserDao {  
    @Override  
    public int addSysUser(SysUser sysUser) {  
	    String sql = "INSERT INTO sys_user VALUES(DEFAULT,?,?)";  
	    return update(con, sql, sysUser.getUsername(), sysUser.getUserPwd());  
	}
}
```
### 2. 登录业务处理

- controller
```java
@WebServlet("/user/*")  
public class SysUserController  extends BaseContoller {  
​  
    private SysUserService userService =new SysUserServiceImpl();  
    /**  
     * 接收用登录请求,完成的登录业务接口  
     * @param req  
     * @param resp  
     * @throws ServletException  
     * @throws IOException  
     */  
    protected void login(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {  
        //1 接收用户名和密码  
        String username = req.getParameter("username");  
        String userPwd = req.getParameter("userPwd");  
        //2 调用服务层方法,根据用户名查询用户信息  
        SysUser loginUser =userService.findByUsername(username);  
        if(null == loginUser){  
            // 跳转到用户名有误提示页  
            resp.sendRedirect("/loginUsernameError.html");  
        }else if(! MD5Util.encrypt(userPwd).equals(loginUser.getUserPwd())){  
            //3 判断密码是否匹配  
            // 跳转到密码有误提示页  
            resp.sendRedirect("/loginUserPwdError.html");  
        }else{  
            //4 跳转到首页  
            resp.sendRedirect("/showSchedule.html");  
        }  
​  
    }  
}
```

- service
    

```java
public interface SysUserService {  
        /**  
     * 根据用户名获得完整用户信息的方法  
     * @param username 要查询的用户名  
     * @return 如果找到了返回SysUser对象,找不到返回null  
     */  
    SysUser findByUsername(String username);  
}

public class SysUserServiceImpl implements SysUserService {  
    private SysUserDao userDao =new SysUserDaoImpl();  
​  
    @Override  
    public SysUser findByUsername(String username) {  
        // 调用服务层方法,继续查询  
​  
        return userDao.findByUsername(username);  
    }  
} 
```

- dao
​  
```java
public interface SysUserDao {  
        /**  
     * 根据用户名获得完整用户信息的方法  
     * @param username 要查询的用户名  
     * @return 如果找到了返回SysUser对象,找不到返回null  
     */  
    SysUser findByUsername(String username);  
}

public class SysUserDaoImpl extends BaseDao implements SysUserDao {  
	@Override  
	public SysUser findByName(String username) {  
	    String sql = "SELECT uid,username,user_pwd userPwd FROM sys_user WHERE username = ?";  
	    List<SysUser> userList = getBeanList(con, sql, username);  
	    return null!=userList&&userList.size()>0?userList.get(0):null;  
	} 
}
```

# 3、第三期

## 3.1 登录情况过滤

涉及技术：
- Filter过滤器
- session

> 需求说明:未登录状态下不允许访问showShedule.html和SysScheduleController相关增删改处理,重定向到login.html,登录成功后可以自由访问

+ 开发登录过滤器,对指定资源的请求进行过滤
```java
@WebFilter(urlPatterns = {"/showSchedule.html","/schedule/*"})
public class LoginFilter  implements Filter {
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request =(HttpServletRequest) servletRequest;
        HttpServletResponse response =(HttpServletResponse) servletResponse;
        HttpSession session = request.getSession();
        Object sysUser = session.getAttribute("sysUser");
        if(null != sysUser){
            // session中如果存在登录的用户 代表用户登录过,则放行
            filterChain.doFilter(servletRequest,servletResponse);

        }else{
            //用户未登录,重定向到登录页
            response.sendRedirect("/login.html");
        }
    }
}
```

- 修改用户登录请求的login方法,登录成功时,将用户信息存入session

``` java
 /**
     * 用户登录的业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void login(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // 接收用户请求参数
        // 获取要注册的用户名密码
        String username = req.getParameter("username");
        String userPwd = req.getParameter("userPwd");
        // 调用服务层方法,根据用户名查询数据库中是否有一个用户
        SysUser loginUser =userService.findByUsername(username);
        if(null == loginUser){
            // 没有根据用户名找到用户,说明用户名有误
            resp.sendRedirect("/loginUsernameError.html");
        }else if(! loginUser.getUserPwd().equals(MD5Util.encrypt(userPwd))){
            // 用户密码有误,
            resp.sendRedirect("/loginUserPwdError.html");
        }else{
            // 登录成功,将用户信息存入session
            req.getSession().setAttribute("sysUser",loginUser);
            // 登录成功,重定向到日程展示页
            resp.sendRedirect("/showSchedule.html");
        }
    }
```

# 4、第四期

## 4.1 用户名异步验证

涉及技术：ajax技术

- 注册提交之前
- 通过ajax技术先校验用户名是否已经占用了

- regist.html页面代码，修改校验用户名的方法
```js
// 校验用户名的方法
	function checkUsername(){
		// 定义正则
		var usernameReg=/^[a-zA-Z0-9]{5,10}$/
		var username =document.getElementById("usernameInput").value
		var usernameMsgSpan =document.getElementById("usernameMsg")
		if(!usernameReg.test(username)){
			usernameMsgSpan.innerText="不合法"
			return false
		}
		
		// 用户名格式正确，继续使用ajax校验用户名是否被占用
		// 1. 设置回调函数
		var request;
		if(window.XMLHttpRequest){
			request= new XMLHttpRequest();
		}else{
			request= new ActiveXObject("Microsoft.XMLHTTP");
		}
		
		// 2. 设置响应回来的信息如何处理
		request.onreadystatechange= function (){
			// request.readyState == 4 代表请求结束,已经接收到响应结果
			// request.status== 200  表示后端响应状态码是200
			if(request.readyState == 4  && request.status== 200){
				// 将后端的响应的JSON字符串转换为前端的对象
				var response =JSON.parse(request.responseText)
				console.log(response)
				//  判断业务码是否是200
				if (response.code != 200){
					usernameMsgSpan.innerText="已占用"
					return false
				}
			}
		}
		
		// 3. 设置ajax的请求方式,请求资源路径,是否为异步请求
		request.open("GET",'/user/checkUsernameUsed?username='+username,true)
		
		// 4. 发送请求
		request.send();

		// 5. 前面校验都通过（注意和异步的区别）
		usernameMsgSpan.innerText="OK"
		return true
	}
}
```

- 添加公共的JSON数据响应格式类
- `注意和HTTP响应状态码区分，这里是响应体中的内容`
```java
//业务含义和状态码对应关系的枚举
public enum ResultCodeEnum {

    SUCCESS(200,"success"),
    USERNAME_ERROR(501,"usernameError"),
    PASSWORD_ERROR(503,"passwordError"),
    NOTLOGIN(504,"notLogin"),
    USERNAME_USED(505,"userNameUsed")
    ;

    private Integer code;
    private String message;
    // 私有构造器，避免外界创建
    private ResultCodeEnum(Integer code, String message) {
        this.code = code;
        this.message = message;
    }
    public Integer getCode() {
        return code;
    }
    public String getMessage() {
        return message;
    }
}

```

- 全局统一响应的JSON格式处理类
```java
public class Result<T> {
    // 返回码
    private Integer code;
    // 返回消息
    private String message;
    // 返回数据
    private T data;
    
    public Result(){}
    
    // 构建result，只传入data信息
    protected static <T> Result<T> build(T data) {
        Result<T> result = new Result<T>();
        if (data != null)
            result.setData(data);
        return result;
    }
	
    // 构建result，传入data、code、message
    public static <T> Result<T> build(T body, Integer code, String message) {
        Result<T> result = build(body);
        result.setCode(code);
        result.setMessage(message);
        return result;
    }
    
    // 构建result，传入data、resultCodeEnum
    public static <T> Result<T> build(T body, ResultCodeEnum resultCodeEnum) {
        Result<T> result = build(body);
        result.setCode(resultCodeEnum.getCode());
        result.setMessage(resultCodeEnum.getMessage());
        return result;
    }
    
	
    //快速构建 操作成功的 Result对象
    public static<T> Result<T> ok(T data){
        Result<T> result = build(data);
        return build(data, ResultCodeEnum.SUCCESS);
    }

    
    public Result<T> message(String msg){
        this.setMessage(msg);
        return this;
    }

    
    public Result<T> code(Integer code){
        this.setCode(code);
        return this;
    }
    
    //三个属性的get和set方法...
}
```

- 增加Jackson依赖
![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240319142225.png)

- 添加WEBUtil工具类
```java
public class WebUtil {
    private static ObjectMapper objectMapper;
    // 初始化objectMapper
    static{
        objectMapper=new ObjectMapper();
        // 设置JSON和Object转换时的时间日期格式
        objectMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
    }
    // 从请求中获取JSON串并转换为Object
    public static <T> T readJson(HttpServletRequest request,Class<T> clazz){
        T t =null;
        BufferedReader reader = null;
        try {
            reader = request.getReader();
            StringBuffer buffer =new StringBuffer();
            String line =null;
            while((line = reader.readLine())!= null){
                buffer.append(line);
            }

            t= objectMapper.readValue(buffer.toString(),clazz);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        return t;
    }
    // 将Result对象转换成JSON串并放入响应对象
    public static void writeJson(HttpServletResponse response, Result result){
        response.setContentType("application/json;charset=UTF-8");
        try {
            String json = objectMapper.writeValueAsString(result);
            response.getWriter().write(json);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

- 用户名校验业务接口代码
```java
protected void checkUsernameUsed(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
	String username = req.getParameter("username");
	SysUser registUser = userService.findByUsername(username);

	//封装结果对象
	Result result=null;
	if(null ==registUser){
		// 未占用,创建一个code为200的对象
		result= Result.ok(null);
	}else{
		// 占用, 创建一个结果为505的对象
		result= Result.build(null, ResultCodeEnum.USERNAME_USED);

	}
	// 将result对象转换成JSON并响应给客户端
	WebUtil.writeJson(resp,result);

}
```

- `注意`：
	- 用户名已占用后，表单还是可以提交
	- 后续我们使用Vue的axios进行处理
# 5、第五期

## 5.1 重构项目前端

涉及技术：
- nodejs + npm
- vue + vite
- vue-router
### 1.  目标展示

+ 登录页![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322171125.png)
+ 注册页![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322171135.png)
+ 日程管理页![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322171148.png)
### 2. 创建项目，安装依赖

```shell
npm create vite
cd 项目目录
npm  install
npm  install vue-router
```

- 项目结构如下![|200](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322171410.png)
### 3. 开发视图

- Header.vue
```vue
<script setup>

</script>

<template>
  <div>
    <h1 class="ht">欢迎使用日程管理系统</h1>
    <div>
      <div  class="optionDiv">
        <router-link to="/login">
          <button class="b1s">登录</button>
        </router-link>   
        <router-link to="/regist">
          <button class="b1s">注册</button>
        </router-link>
      </div>


      <div   class="optionDiv">
        欢迎xxx   
        <button class="b1b">退出登录</button> 
        <router-link to="/showSchedule">
          <button class="b1b">查看我的日程</button>
        </router-link>
      </div>

      <br>
    </div>
  </div>
</template>

<style scoped>

  .ht{
      text-align: center;
      color: cadetblue;
      font-family: 幼圆;
  }
  .b1s{
        border: 2px solid powderblue;
        border-radius: 4px;
        width:60px;
        background-color: antiquewhite;

    }

    .b1b{
        border: 2px solid powderblue;
        border-radius: 4px;
        width:100px;
        background-color: antiquewhite;
    }
    .optionDiv{
      width: 300px;
      float: right;
    }
</style>
```

- login.vue视图
```java
<script setup>
       import{ ref,reactive} from 'vue'
       // 响应式数据,保存用户输入的表单信息
       let loginUser =reactive({
        username:'',
        userPwd:''
       })

       // 响应式数据,保存校验的提示信息
       let usernameMsg =ref('')
       let userPwdMsg = ref('')

        // 校验用户名的方法
        function checkUsername(){
            // 定义正则
            var usernameReg=/^[a-zA-Z0-9]{5,10}$/
            // 校验用户名
            if(!usernameReg.test(loginUser.username)){
                // 格式不合法
                usernameMsg.value="格式有误"
                return false
            }
            usernameMsg.value="ok"
            return true
        }
        // 校验密码的方法
        function checkUserPwd(){
            // 定义正则
            var passwordReg=/^[0-9]{6}$/
             // 校验密码
             if(!passwordReg.test(loginUser.userPwd)){
                // 格式不合法
                userPwdMsg.value="格式有误"
                return false
            }
            userPwdMsg.value="ok"
            return true
        }
</script>

<template>
  <div>
    <h3 class="ht">请登录</h3>
        <table class="tab" cellspacing="0px">
            <tr class="ltr">
                <td>请输入账号</td>
                <td>
                    <input class="ipt" 
                    type="text" 
                    v-model="loginUser.username"
                    @blur="checkUsername()">
                    <span id="usernameMsg" v-text="usernameMsg"></span>
                </td>
            </tr>
            <tr class="ltr">
                <td>请输入密码</td>
                <td>
                    <input class="ipt" 
                    type="password" 
                    v-model="loginUser.userPwd"
                    @blur="checkUserPwd()">
                    <span id="userPwdMsg" v-text="userPwdMsg"></span>
                </td>
            </tr>
            <tr class="ltr">
                <td colspan="2" class="buttonContainer">
                    <input class="btn1" type="button" value="登录">
                    <input class="btn1" type="button" value="重置">
                    <router-link to="/regist">
                      <button class="btn1">去注册</button>
                    </router-link>
                </td>
            </tr>
        </table>
  </div>
</template>

<style scoped>
	.ht{
		text-align: center;
		color: cadetblue;
		font-family: 幼圆;
	}
	.tab{
		width: 500px;
		border: 5px solid cadetblue;
		margin: 0px auto;
		border-radius: 5px;
		font-family: 幼圆;
	}
	.ltr td{
		border: 1px solid  powderblue;
	}
	.ipt{
		border: 0px;
		width: 50%;
	}
	.btn1{
		border: 2px solid powderblue;
		border-radius: 4px;
		width:60px;
		background-color: antiquewhite;
	}
	#usernameMsg , #userPwdMsg {
		color: gold;
	}
	.buttonContainer{
		text-align: center;
	}
</style>
```

- Regist.vue视图
```vue
<script setup>
      import{ ref,reactive} from 'vue'
       // 响应式数据,保存用户输入的表单信息
       let registUser =reactive({
        username:'',
        userPwd:''
       })

       // 响应式数据,保存校验的提示信息
       let reUserPwd =ref('')
       let reUserPwdMsg =ref('')
       let usernameMsg =ref('')
       let userPwdMsg = ref('')

          // 校验用户名的方法
        function checkUsername(){
            // 定义正则
            let usernameReg=/^[a-zA-Z0-9]{5,10}$/
            // 校验
            if(!usernameReg.test(registUser.username)){
              // 提示
              usernameMsg.value = "不合法"
              return false
            }
            // 通过校验
            usernameMsg.value="OK"
            return true
        }
        // 校验密码的方法
        function checkUserPwd(){
            // 定义正则
            let passwordReg=/^[0-9]{6}$/
             // 校验
             if(!passwordReg.test(registUser.userPwd)){
              // 提示
              userPwdMsg.value = "不合法"
              return false
            }
            // 通过校验
            userPwdMsg.value="OK"
            return true
        }
        // 校验密码的方法
        function checkReUserPwd(){
            // 定义正则
            let passwordReg=/^[0-9]{6}$/
            // 校验
            if(!passwordReg.test(reUserPwd.value)){
              // 提示
              reUserPwdMsg.value = "不合法"
              return false
            }
            console.log(registUser.userPwd,reUserPwd.value)
            // 校验
            if(!(registUser.userPwd==reUserPwd.value)){
              // 提示
              reUserPwdMsg.value = "不一致"
              return false
            }


            // 通过校验
            reUserPwdMsg.value="OK"
            return true
        }
</script>

<template>
  <div>
    <h3 class="ht">请注册</h3>

    <table class="tab" cellspacing="0px">
        <tr class="ltr">
            <td>请输入账号</td>
            <td>
                <input class="ipt" 
                  id="usernameInput" 
                  type="text" 
                  name="username" 
                  v-model="registUser.username"
                  @blur="checkUsername()">

                <span id="usernameMsg" class="msg" v-text="usernameMsg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td>请输入密码</td>
            <td>
                <input class="ipt" 
                id="userPwdInput" 
                type="password" 
                name="userPwd" 
                v-model="registUser.userPwd"
                @blur="checkUserPwd()">
                <span id="userPwdMsg" class="msg" v-text="userPwdMsg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td>确认密码</td>
            <td>
                <input class="ipt" 
                id="reUserPwdInput" 
                type="password" 
                v-model="reUserPwd"
                @blur="checkReUserPwd()">
                <span id="reUserPwdMsg" class="msg" v-text="reUserPwdMsg"></span>
            </td>
        </tr>
        <tr class="ltr">
            <td colspan="2" class="buttonContainer">
                <input class="btn1" type="button" value="注册">
                <input class="btn1" type="button" value="重置">
                <router-link to="/login">
                  <button class="btn1">去登录</button>
                </router-link>
            </td>
        </tr>
    </table>


  </div>
</template>

<style scoped>
       .ht{
            text-align: center;
            color: cadetblue;
            font-family: 幼圆;
        }
        .tab{
            width: 500px;
            border: 5px solid cadetblue;
            margin: 0px auto;
            border-radius: 5px;
            font-family: 幼圆;
        }
        .ltr td{
            border: 1px solid  powderblue;

        }
        .ipt{
            border: 0px;
            width: 50%;

        }
        .btn1{
            border: 2px solid powderblue;
            border-radius: 4px;
            width:60px;
            background-color: antiquewhite;

        }
        .msg {
            color: gold;
        }
        .buttonContainer{
            text-align: center;
        }
</style>
```

- ShowSchedule.vue视图
```vue
<script setup>

</script>

<template>
  <div>
    <h3 class="ht">您的日程如下</h3>
<table class="tab" cellspacing="0px">
    <tr class="ltr">
        <th>编号</th>
        <th>内容</th>
        <th>进度</th>
        <th>操作</th>
    </tr>
    <tr class="ltr">
        <td></td>
        <td></td>
        <td></td>
        <td class="buttonContainer">
             <button class="btn1">删除</button>
            <button class="btn1">保存修改</button>
        </td>
    </tr>
    <tr class="ltr buttonContainer" >
        <td colspan="4">
            <button class="btn1">新增日程</button>
        </td>

    </tr>
</table>
  </div>
</template>

<style scoped>

      .ht{
            text-align: center;
            color: cadetblue;
            font-family: 幼圆;
        }
        .tab{
            width: 80%;
            border: 5px solid cadetblue;
            margin: 0px auto;
            border-radius: 5px;
            font-family: 幼圆;
        }
        .ltr td{
            border: 1px solid  powderblue;

        }
        .ipt{
            border: 0px;
            width: 50%;

        }
        .btn1{
            border: 2px solid powderblue;
            border-radius: 4px;
            width:100px;
            background-color: antiquewhite;

        }
        #usernameMsg , #userPwdMsg {
            color: gold;
        }

        .buttonContainer{
            text-align: center;
        }

</style>
```

- App.vue视图
```vue
<script setup>

import Header from './components/Header.vue'
</script>

<template>
  <div>
    <Header></Header>
    <hr>
    <!-- 用于路由切换视图使用 -->
    <router-view></router-view>
  
  </div>
</template>

<style scoped>

</style>
```
### 4. 配置js文件

- 配置router.js
```js
import {createRouter,createWebHashHistory} from 'vue-router'

import Login from '../components/Login.vue'
import Regist from '../components/Regist.vue'
import ShowScedule from '../components/ShowSchedule.vue'

let  router = createRouter({
    history:createWebHashHistory(),
    routes:[
        {
            path:"/",
            component:Login
        },
        {
            path:"/login",
            component:Login
        },
        {
            path:"/showSchedule",
            component:ShowScedule
        },
        {
            path:"/regist",
            component:Regist
        }


    ]
})

export default router
```

- 配置main.js
```js
import { createApp } from 'vue'

import App from './App.vue'

// 导入路由
import router from './router/router.js'

let app =createApp(App)

// 全局使用路由
app.use(router)

app.mount('#app')
```

# 6、第六期

涉及技术：
- axios
- 跨域

项目先安装axios
```shell
npm install axios
```
## 6.1 前端代码处理

### 1. 创建request.js文件

在src创建utils文件夹，然后创建request.js文件
```js
import axios from 'axios'

//创建instance实例
const instance = axios.create({baseURL:'http://localhost:8080'})

//添加请求拦截
instance.interceptors.request.use(
    //设置请求头成功处理函数
    config=>{
        //处理指定的请求头
        return config
    },
    //设置请求错误处理函数
    error=>{
        return Promise.reject(error)
    }
)

//添加响应拦截
instance.interceptors.response.use(
    // 设置响应正确时的处理函数
    response=>{return response},
    // 设置响应异常时的处理函数
    error=>{return Promise.reject(error)}
)

// 默认导出instance实例
export default instance
```

### 2. 注册页面完成注册

```js
// 注册的方法
async function regist(){
	// 校验所有的输入框是否合法
	let flag1 =await checkUsername()
	let flag2 =await checkUserPwd()
	let flag3 =await checkReUserPwd()
	if(flag1 && flag2 && flag3){
	  let  {data}= await request.post("user/regist",registUser)
	  if(data.code == 200){
		// 注册成功跳转 登录页
		alert("注册成功,快去登录吧")
		router.push("/login")
	  }else{
		alert("抱歉,用户名被抢注了")
	  }
	}else{
		alert("校验不通过,请求再次检查数据")
	}
}

function clearForm(){
	registUser.username=""
	registUser.userPwd=""
	usernameMsg.value=""
	userPwdMsg.value=""
	reUserPwd.value=""
	reUserPwdMsg.value=""

}
```
### 3. 登录页面完成登录

```js
async function login(){
	// 表单数据格式都正确再提交
	let flag1 =checkUsername()
	let flag2 =checkUserPwd()
	if(!(flag1 && flag2)){
		return 
	}
   let {data} = await request.post("user/login",loginUser)
   if(data.code == 200 ){
		alert("登录成功")
		// 跳转到showSchedule
		router.push("/showSchedule")
   } else if( data.code == 503){
		alert("密码有误")

   }else if (data.code == 501 ){
		alert("用户名有误")
   }else {
		alert("未知错误")
   }
   
}
```

## 6.2 后端代码处理

### 1. 添加跨域处理器

#### 什么是跨域

同源策略（Sameoriginpolicy）是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。

`同源策略会阻止一个域的javascript脚本和另外一个域的内容进行交互。所谓同源（即指在同一个域）就是两个页面具有相同的协议（protocol），主机（host）和端口号`
#### 为什么会产生跨域

前后端分离模式下,客户端请求前端服务器获取视图资源

然后客户端自行向后端服务器获取数据资源

`前端服务器的 协议,IP和端口和后端服务器很可能是不一样的,这样就产生了跨域`

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322222905.png)
#### 如何解决跨域

> `方式一：前端项目代理模式处理`

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322223002.png)
![1683365066926](file:///F:/00_Java%E5%AD%A6%E4%B9%A0%E5%BA%93/2_%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%BE%E7%A8%8B/%E5%B0%9A%E7%A1%85%E8%B0%B7%E5%85%A8%E6%96%B0JavaWeb%E9%87%8C%E7%A8%8B%E7%A2%91%E7%89%88/%E7%AC%94%E8%AE%B0/images/1683365066926-1690533535580.png?lastModify=1711098435)

> `方式二：后端跨域过滤器方式处理`

![1683364436315](file:///F:/00_Java%E5%AD%A6%E4%B9%A0%E5%BA%93/2_%E5%B0%9A%E7%A1%85%E8%B0%B7%E8%AF%BE%E7%A8%8B/%E5%B0%9A%E7%A1%85%E8%B0%B7%E5%85%A8%E6%96%B0JavaWeb%E9%87%8C%E7%A8%8B%E7%A2%91%E7%89%88/%E7%AC%94%E8%AE%B0/images/1683364436315-1690533535580.png?lastModify=1711098435)
![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020240322223007.png)

- CrosFilter过滤器
- `告诉浏览器，后端的数据，可以正常使用`
​  
```java
@WebFilter("/*")  
public class CrosFilter implements Filter {  
    @Override  
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {  
​  
        HttpServletRequest request = (HttpServletRequest) servletRequest;  
        System.out.println(request.getMethod());  
        HttpServletResponse response = (HttpServletResponse) servletResponse;  
        response.setHeader("Access-Control-Allow-Origin", "*");  
        response.setHeader("Access-Control-Allow-Methods", "POST, GET, PUT,OPTIONS, DELETE, HEAD");  
        response.setHeader("Access-Control-Max-Age", "3600");  
        response.setHeader("Access-Control-Allow-Headers", "access-control-allow-origin, authority, content-type, version-info, X-Requested-With");  
        // 如果是跨域预检请求,则直接在此响应200业务码  
        if(request.getMethod().equalsIgnoreCase("OPTIONS")){  
            WebUtil.writeJson(response, Result.ok(null));  
        }else{  
            // 非预检请求,放行即可  
            filterChain.doFilter(servletRequest, servletResponse);  
        }  
    }  
}  
​
```

- `未来我们使用框架,直接用一个@CrossOrigin 就可以解决跨域问题了`
### 2. 重构UserController

```java
@WebServlet("/user/*")
public class UserController extends BaseController{
    private SysUserService userService =new SysUserServiceImpl();


    /**
     * 注册时校验用户名是否被占用的业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void checkUsernameUsed(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String username = req.getParameter("username");
        SysUser registUser = userService.findByUsername(username);

        //封装结果对象
        Result result=null;
        if(null ==registUser){
            // 未占用,创建一个code为200的对象
            result= Result.ok(null);
        }else{
            // 占用, 创建一个结果为505的对象
            result= Result.build(null, ResultCodeEnum.USERNAME_USED);

        }
        // 将result对象转换成JSON并响应给客户端
        WebUtil.writeJson(resp,result);

    }

    /**
     * 用户注册的业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void regist(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // 接收要注册的用户信息
        SysUser registUser = WebUtil.readJson(req, SysUser.class);
        // 调用服务层方法,将用户注册进入数据库
        int rows =userService.regist(registUser);
        Result result =null;
        if(rows>0){
           result=Result.ok(null);
        }else{
           result =Result.build(null,ResultCodeEnum.USERNAME_USED);
        }
        WebUtil.writeJson(resp,result);
    }

    /**
     * 用户登录的业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void login(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

        // 接收用户请求参数
        // 获取要登录的用户名密码
        SysUser inputUser = WebUtil.readJson(req, SysUser.class);
        // 调用服务层方法,根据用户名查询数据库中是否有一个用户
        SysUser loginUser =userService.findByUsername(inputUser.getUsername());

        Result result = null;

        if(null == loginUser){
            // 没有根据用户名找到用户,说明用户名有误
            result=Result.build(null,ResultCodeEnum.USERNAME_ERROR);
        }else if(! loginUser.getUserPwd().equals(MD5Util.encrypt(inputUser.getUserPwd()))){
            // 用户密码有误,
           result=Result.build(null,ResultCodeEnum.PASSWORD_ERROR);
        }else{
            // 登录成功
            result=Result.ok(null);
        }

        WebUtil.writeJson(resp,result);

    }
}
```

### 3. 删除登录校验过滤器

- 这里不使用cookie和session方式记录用户状态,未来使用token,所以登录过滤器删除即可

# 7、第七期

涉及技术：
- pinia

### 7.1 前端保存用户信息

- 安装pinia依赖
```shell
npm install pinia
```

- src下创建pinia.js文件
```js
// 导入pinia组件
import {createPinia} from 'pinia'
// 创建pinia对象
let pinia = createPinia()
// 导出默认的pinia
export default pinia
```

+ main.js中使用pinia
``` js
import { createApp } from 'vue'
import App from './App.vue'
// 导入路由
import router from './router/router.js'
// 导入pinia对象
import pinia from './pinia.js'
let app =createApp(App)
// 全局使用路由
app.use(router)
// 全局使用pinia
app.use(pinia)
app.mount('#app')
```

+ src/store/userStore.js 用于存储用户信息
``` javascript
import {defineStore} from 'pinia'

export const defineUser = defineStore('loginUser',{
    state:()=>{
        return {
            uid:0,
            username:''
        }
    },
    getters :{
       
    }

})
```

+ src/store/scheduleStore.js 用于存储用户的日程信息
``` javaScript
import {defineStore} from 'pinia'

export const defineSchedule = defineStore('scheduleList',{
    state:()=>{
        return {
            itemList:[
                /*{
                    sid:1,
                    uid:1,
                    title:'学java',
                    completed:1
                },
                {
                    sid:2,
                    uid:1,
                    title:'学前端',
                    completed:0
                }*/
            ]
        }
    },
    getters :{
       
    },
    actions:{

    }

})
```

### 7.2 前后端页面修改

#### HeadVue

+ Header.vue中,通过pinia的数据来判断展示何种提示 视图
	+ 使用pinia获取和{{}}获取用户名
	+ 使用pinia完成退出登录logout函数的内部逻辑

``` html
<script setup>
    /* 导入pinia中的user数据 */
    import {defineUser} from '../store/userStore.js'
    import {defineSchedule} from '../store/scheduleStore.js'
    let sysUser =defineUser()
    let schedule = defineSchedule();

    /* 导入编程式路由 */
    import {useRouter} from 'vue-router'
    let  router =useRouter()
    /* 退出登录接口 */
    function logout(){
      // 清除userPina 和schedulepinia
      sysUser.$reset()
      schedule.$reset()
      // 通过路由回到登录页
      router.push("/login")
    }
</script>

<template>
  <div>
    <h1 class="ht">欢迎使用日程管理系统</h1>
    <div>
      <div  class="optionDiv" v-if="sysUser.username == ''">
        <router-link to="/login">
          <button class="b1s">登录</button>
        </router-link>   
        <router-link to="/regist">
          <button class="b1s">注册</button>
        </router-link>
      </div>


      <div   class="optionDiv" v-else>
        欢迎{{sysUser.username}}   
        <button class="b1b" @click="logout()">退出登录</button> 
        <router-link to="/showSchedule">
          <button class="b1b">查看我的日程</button>
        </router-link>
      </div>

      <br>
    </div>
  </div>
</template>
```

#### Login.vue

- Login.vue中,登录成功后,接收后端响应回来的用户id和用户名,存储于userStore中
```vue
<script setup>  
        /* 导入pinia中的user数据 */  
        import {defineUser} from '../store/userStore.js'  
        let sysUser =defineUser()  
        /* 获取 编程式路由对象 */  
        import {useRouter} from 'vue-router'  
        let router =useRouter();  
        /* 导入axios请求对象 */  
        import request from '../utils/request.js'  
​  
       //   
       import{ ref,reactive} from 'vue'  
       // 响应式数据,保存用户输入的表单信息  
       let loginUser =reactive({  
        username:'',  
        userPwd:''  
       })  
​  
	//..... 
​  
​  
        // 登录的函数  
        async function  login(){  
            console.log("发送异步请求")  
            let {data} = await request.post("/user/login",loginUser)  
            if(data.code == 200){  
                alert("登录成功")  
                // 更新pinia数据  
                sysUser.uid =data.data.loginUser.uid  
                sysUser.username =data.data.loginUser.username  
                // 跳转到日程查询页  
                router.push("/showSchedule")  
                  
            }else if(data.code == 501){  
                alert("用户名有误,请重新输入")  
            }else if(data.code == 503){  
                alert("密码有误,请重新输入")  
            }else {  
                alert("出现未知名错误")  
            }  
        }  
  
</script>  
```


#### 后端登录login代码

+ 服务端登录处理方法,登录成功,返回登录用户的信息

``` java
    protected void login(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
	//......
	if(null == loginUser){
		// 没有根据用户名找到用户,说明用户名有误
		result=Result.build(null,ResultCodeEnum.USERNAME_ERROR);
	}else if(! loginUser.getUserPwd().equals(MD5Util.encrypt(inputUser.getUserPwd()))){
		// 用户密码有误,
	   result=Result.build(null,ResultCodeEnum.PASSWORD_ERROR);
	}else{
		// 登录成功,将用户信息存入session
		req.getSession().setAttribute("sysUser",loginUser);
		// 登录成功
		// 将密码请空后,将用户信息响应给客户端
		loginUser.setUserPwd("");
		Map<String,Object> data =new HashMap<>();
		data.put("loginUser",loginUser);
		result=Result.ok(data);
	}
	WebUtil.writeJson(resp,result);
}
```

#### router.js

+ router.js中,通过路由守卫控制只有登录状态下才可以进入showSchedule.vue

``` javascript
//注意，其他js组件导入pinia组件，还需要pinia对象
import pinia from '../pinia.js'
import {defineUser} from '../store/userStore.js'

let sysUser = defineUser(pinia)

/* 配置路由的前置守卫,在登录状态下才可以范文showSchedule.vue */
router.beforeEach( (to,from,next) =>{
    // 如果是查看日程
    if(to.path=="/showSchedule"){
        // 如果尚未的登录
        if(sysUser.username == ''){
            alert("您尚未登录,请登录后再查看日程")
            next("/login")
        }else{
            // 已经登录 放行
            next()
        }
        // 其他资源 放行
    }else{
        next()
    }
})
export default router
```


## 7.3 显示所有日程数据

- ShowSchedule.vue中向后端发送异步请求查询数据并展示

```vue
<script setup>  
    /* 引入axios */  
    import request from '../utils/request.js'  
    /* 引入pinia数据 */  
    import {defineSchedule} from '../store/scheduleStore.js'  
    import {defineUser} from '../store/userStore.js'  
    let schedule = defineSchedule();  
    let sysUser = defineUser()  
    /* 引入挂载生命周期 */  
    import { onMounted,onUpdated,ref,reactive } from 'vue';  
      
    // 第一次挂载就立刻向后端发送请求,获取最新数据  
    onMounted(async function (){  
        showSchedule()  
    })  
    async function showSchedule(){  
        let {data} = await request.get("/schedule/findAllSchedule",{params:{"uid":sysUser.uid}})  
        schedule.itemList =data.data.itemList  
    }  
​  
​  
</script>  
​  
<template>  
  <div>  
    <h3 class="ht">您的日程如下</h3>  
<table class="tab" cellspacing="0px">  
    <tr class="ltr">  
        <th>编号</th>  
        <th>内容</th>  
        <th>进度</th>  
        <th>操作</th>  
    </tr>  
    <tr class="ltr" v-for="item,index in schedule.itemList" :key="index">  
        <td v-text="index+1">  
        </td>  
        <td>  
            <input type="input" v-model="item.title">  
        </td>  
        <td>  
            <input type="radio"   value="1" v-model="item.completed"> 已完成  
            <input type="radio"   value="0" v-model="item.completed"> 未完成  
        </td>  
        <td class="buttonContainer">  
             <button class="btn1">删除</button>  
            <button class="btn1">保存修改</button>  
        </td>  
    </tr>  
    <tr class="ltr buttonContainer" >  
        <td colspan="4">  
            <button class="btn1">新增日程</button>  
        </td>  
​  
    </tr>  
</table>  
{{schedule}}  
  </div>  
</template>   
```
​

- SysScheduleController中查询数据并响应json
```java
@WebServlet("/schedule/*")
public class SysScheduleController  extends BaseController{
    private SysScheduleService scheduleService =new SysScheduleServiceImpl();
    /**
     * 查询所有日程接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void findAllSchedule(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        int uid = Integer.parseInt(req.getParameter("uid"));
        //  调用服务层方法,查询所有日程
        List<SysSchedule> itemList = scheduleService.findItemListByUid(uid);
        // 将日程信息装入result,转换JSON给客户端
        Map<String,Object> data =new HashMap<>();
        data.put("itemList",itemList);
        WebUtil.writeJson(resp,Result.ok(data));
    }
}
```

+ SysScheduleService接口和实现类代码
``` java
public interface SysScheduleService {
    List<SysSchedule> findItemListByUid(int uid);
}

// ------------------------------------------------
public class SysScheduleServiceImpl implements SysScheduleService {
    private SysScheduleDao scheduleDao =new SysScheduleDaoImpl();
    @Override
    public List<SysSchedule> findItemListByUid(int uid) {
        return scheduleDao.findItemListByUid(uid);
    }
}
```

- SysScheduleDao接口和实现类代码
```java
public interface SysScheduleDao {
    List<SysSchedule> findItemListByUid(int uid);
}
//-----------------------------------------------------
public class SysScheduleDaoImpl extends BaseDao implements SysScheduleDao {
    @Override
    public List<SysSchedule> findItemListByUid(int uid) {
        String sql = "SELECT sid,uid,title,completed from sys_schedule where uid = ?";  
		return getBeanList(con,sql,uid);
    }
}
```

## 7.4 增加和保存日程数据

- ShowSchedule.vue中向后端发送异步请求查询数据并展示

```vue
<script setup>  
    /* 引入axios */  
    import request from '../utils/request.js'  
    /* 引入pinia数据 */  
    import {defineSchedule} from '../store/scheduleStore.js'  
    import {defineUser} from '../store/userStore.js'  
    let schedule = defineSchedule();  
    let sysUser = defineUser()  
    /* 引入挂载生命周期 */  
    import { onMounted,onUpdated,ref,reactive } from 'vue';  
      
    // 新增日程
    async function addItem(){
        // 立刻向后端发送一个请求,让后端先为当前用户在数据库中增加一个默认格式的空数据
        let {data} = await request.get("/schedule/addDefaultSchedule",{params:{"uid":sysUser.uid}})
        if(data.code == 200){
            // 然后调用刷新页面数据方法,立刻获取最新数据
            showSchedule()
        }else{
            alert("添加异常")
        }
    }

    // 更新日程的方法
    async function updateItem(index){
        // 根据索引获取元素
        
        // 将元素通过 JSON串的形式 发送给服务端
        let {data} =await request.post("/schedule/updateSchedule",schedule.itemList[index])
        if(data.code == 200){
            // 服务端修改完毕后,刷新页面数据
            showSchedule()
        }else{
            alert("更新异常")
        }
​  
​  
</script>  
​  
<template>  
  <div>  
    <h3 class="ht">您的日程如下</h3>  
<table class="tab" cellspacing="0px">  
    <tr class="ltr">  
        <th>编号</th>  
        <th>内容</th>  
        <th>进度</th>  
        <th>操作</th>  
    </tr>  
    <tr class="ltr" v-for="item,index in schedule.itemList" :key="index">  
        <td v-text="index+1">  
        </td>  
        <td>  
            <input type="input" v-model="item.title">  
        </td>  
        <td>  
            <input type="radio"   value="1" v-model="item.completed"> 已完成  
            <input type="radio"   value="0" v-model="item.completed"> 未完成  
        </td>  
        <td class="buttonContainer">  
             <button class="btn1">删除</button>  
            <button class="btn1" @click="updateItem(index)">保存修改</button>  
        </td>  
    </tr>  
    <tr class="ltr buttonContainer" >  
        <td colspan="4">  
            <button class="btn1" @click="addItem()">新增日程</button>  
        </td>  
​  
    </tr>  
</table>  
{{schedule}}  
  </div>  
</template>   
```
​

- SysScheduleController中查询数据并响应json
```java
@WebServlet("/schedule/*")
public class SysScheduleController  extends BaseController{
    private SysScheduleService scheduleService =new SysScheduleServiceImpl();
    /**
     * 向数据库中增加一个新的默认数据的方法
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void addDefaultSchedule(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        int uid = Integer.parseInt(req.getParameter("uid"));
        //  调用服务层方法,为当前用户新增一个默认空数据
        scheduleService.addDefault(uid);

        WebUtil.writeJson(resp,Result.ok(null));

    }


    /**
     * 更新日程业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void updateSchedule(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        SysSchedule sysSchedule = WebUtil.readJson(req, SysSchedule.class);
        // 调用服务层方法,更新数据
        scheduleService.updateSchedule(sysSchedule);

        // 响应成功
        WebUtil.writeJson(resp,Result.ok(null));
    }
}
```

+ SysScheduleService接口和实现类代码
``` java
public interface SysScheduleService {
    Integer addDefault(int uid);
    Integer updateSchedule(SysSchedule sysSchedule);
}

// ------------------------------------------------
public class SysScheduleServiceImpl implements SysScheduleService {
    private SysScheduleDao scheduleDao =new SysScheduleDaoImpl();
    @Override
    public Integer addDefault(int uid) {
        return scheduleDao.addDefault(uid);
    }

    @Override
    public Integer updateSchedule(SysSchedule sysSchedule) {
        return scheduleDao.updateSchedule(sysSchedule);
    }
}
```

- SysScheduleDao接口和实现类代码
```java
public interface SysScheduleDao {
    Integer addDefault(int uid);
    Integer updateSchedule(SysSchedule sysSchedule);
}
//-----------------------------------------------------
public class SysScheduleDaoImpl extends BaseDao implements SysScheduleDao {
	@Override  
	public Integer addDefault(int uid) {  
	    String sql = "insert into sys_schedule value(default,?,'请输入日程',0)";  
	    return update(con,sql,uid);  
	}  
	  
	@Override  
	public Integer updateSchedule(SysSchedule sysSchedule) {  
	    String sql ="update sys_schedule set title = ? ,completed =  ? where sid =?";  
	    return update(con,sql,sysSchedule.getTitle(),sysSchedule.getCompleted(),sysSchedule.getSid());  
	}
}
```
## 7.5 删除日程数据

- ShowSchedule.vue中向后端发送异步请求查询数据并展示

```vue
<script setup>  
    /* 引入axios */  
    import request from '../utils/request.js'  
    /* 引入pinia数据 */  
    import {defineSchedule} from '../store/scheduleStore.js'  
    import {defineUser} from '../store/userStore.js'  
    let schedule = defineSchedule();  
    let sysUser = defineUser()  
    /* 引入挂载生命周期 */  
    import { onMounted,onUpdated,ref,reactive } from 'vue';  
      
    // 删除日程的方法
    async function removeItem(index){
        // 弹窗提示是否删除
        if(confirm("确定要删除该条数据")){
            // 根据索引获取要删除的item的id
            let sid = schedule.itemList[index].sid
            // 向服务端发送请求删除元素
            let{data} = await request.get("/schedule/removeSchedule",{params:{"sid":sid}})
            //根据业务码判断删除是否成功
            if(data.code == 200){
                // 删除成功,更新数据
                showSchedule()
            }else{
                // 删除失败,提示失败
                alert("删除失败")
            }
        }
    } 

</script>  
​  
<template>  
  <div>  
    <h3 class="ht">您的日程如下</h3>  
<table class="tab" cellspacing="0px">  
    <tr class="ltr">  
        <th>编号</th>  
        <th>内容</th>  
        <th>进度</th>  
        <th>操作</th>  
    </tr>  
    <tr class="ltr" v-for="item,index in schedule.itemList" :key="index">  
        <td v-text="index+1">  
        </td>  
        <td>  
            <input type="input" v-model="item.title">  
        </td>  
        <td>  
            <input type="radio"   value="1" v-model="item.completed"> 已完成  
            <input type="radio"   value="0" v-model="item.completed"> 未完成  
        </td>  
        <td class="buttonContainer">  
			<button class="btn1"  @click="removeItem(index)">删除</button>
			<button class="btn1" @click="updateItem(index)">保存修改</button> 
        </td>  
    </tr>  
    <tr class="ltr buttonContainer" >  
        <td colspan="4">  
            <button class="btn1" @click="addItem()">新增日程</button>  
        </td>  
​  
    </tr>  
</table>  
{{schedule}}  
  </div>  
</template>   
```
​

- SysScheduleController中查询数据并响应json
```java
@WebServlet("/schedule/*")
public class SysScheduleController  extends BaseController{
    private SysScheduleService scheduleService =new SysScheduleServiceImpl();
	/**
     * 删除日程业务接口
     * @param req
     * @param resp
     * @throws ServletException
     * @throws IOException
     */
    protected void removeSchedule(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // 获取要删除的日程id
        int sid = Integer.parseInt(req.getParameter("sid"));
        // 调用服务层方法,删除日程
        scheduleService.removeSchedule(sid);
        // 响应200
        WebUtil.writeJson(resp,Result.ok(null));
    }
}
```

+ SysScheduleService接口和实现类代码
``` java
public interface SysScheduleService {
    Integer removeSchedule(int sid);
}

// ------------------------------------------------
public class SysScheduleServiceImpl implements SysScheduleService {
    private SysScheduleDao scheduleDao =new SysScheduleDaoImpl();
    @Override
    public Integer removeSchedule(int sid) {
        return scheduleDao.removeBySid(sid);
    }
}
```

- SysScheduleDao接口和实现类代码
```java
public interface SysScheduleDao {
    Integer removeBySid(int sid);
}
//-----------------------------------------------------
public class SysScheduleDaoImpl extends BaseDao implements SysScheduleDao {
	@Override  
	public Integer removeBySid(int sid) {  
	    String sql ="delete from sys_schedule where sid = ?";  
	    return update(con,sql,sid);  
	}
}
```


