
## 1、缓存一致性问题是什么

缓存，都知道是持久化数据的冗余存储，但如果缓存加载了数据源的数据，但对应数据要发生变化，怎么办呢？

我们以数据源为MySQL，缓存用Redis，前面也说过，在数据库场景下，更廉价、高效但可靠性稍低的redis可以给更昂贵、较慢、可靠性强的MySQL做缓存。

前面介绍了几种缓存模式，这里我们以常见、最 实用的旁路缓存模式为基础，来进行分析。

大的方向有三：
- 更新MySQL即可，不管Redis，以过期时间兜底；
- 更新MySQL之后，操作Redis；
- 异步将MySQL的更新同步到Redis；
## 2、方向一

使用redis的过期时间，mysql更新时，redis不做处理，等待缓存过期失效，再从mysql拉取缓存。

`这种方式实现简单，但不一致的时间会比较明显，具体由业务来配置`。如果读请求非常频繁，且过期时间设置较长，则会产生很多脏数据。

优点：
- redis原生接口，开发成本低，易于实现；
- 管理成本低，出问题的概率会比较少；

不足：
- 完全依赖过期时间，时间太短容易造成缓存频繁失效，太长容易有较长时间不一致，对编程者的业务能力有一定要求。
## 3、方向二

`不光用过key的过期时间兜底，还需要再更新mysql时，同时尝试操作redis`，这里的操作分两种方式
- `更新`，直接将结果写入Redis，但实际上很少用更新
- `删除`，等待下次访问再加载回来，为什么呢？因为`更新容易带来时序性问题`

举个例子：假设a的初始值为2，两台业务服务器在同一时间发出两条请求
- 第一条，给a的值加1
- 第二条，设置a的值为5
- 若mysql中先执行第一条，再执行第二条，则mysql中a的值先变成3，最终为5
- 但由于网络传输本身有延迟，所以无法保证两条Redis更新操作谁先执行，如果第二条对应的更新先执行，Redis数据就先变成了5，然后再加1变成了6
- 这就出现了数据对不上的问题，相比于数据延迟而言，这更让人疑惑和不能接受，所以一般都选择删除。

上面有提到，这里是`尝试删除!!`，这样说是这一步操作可能失败了，失败就我们可以忽略，也就是不能让删除成为一个关键路径，影响核心流程。

因为我们有key本身的过期时间作为保障，所以最终一致性是一定达成的，主动删除redis数据只是为了减少不一致的时间。
![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020231107140617.png)

优点：
- 相对方案一，达成最终一致性的延迟更小；
- 实现成本较低，只是在方案一的基础上，增加了删除逻辑。

不足：
- 如果更新mysql成功，删除redis失败，就退化为方案一
- 在更新时候需要额外操作redis，带来了损耗
## 4、方向三

把我们搭建的消费服务作为mysql的一个slave，订阅mysql的binlog日志，解析日志内容，再更新redis。此方案和业务完全解耦，redis的更新对业务各方透明，可以减少心智成本。

![](https://image-for.oss-cn-guangzhou.aliyuncs.com/for-obsidian/Java_Study/2_%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1_Java%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83/1_Java%E5%9F%BA%E7%A1%80/1_Java%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/Pasted%20image%2020231107140901.png)

优点：
- 和业务完全解耦，在更新mysql时，不需要做额外操作；
- 无时序性问题，可靠性强

不足：
- 引入了消息队列这种算比较重的组件，还要单独搭建一个同步服务，维护它们是非常大的额外成本
- 同步服务如果压力比较大，或者崩溃了，那么在较长时间内，redis中都是老旧数据

## 5、方案选型

1. 首先确认产品上对延迟的要求，如果要求极高，且数据有可能变化，别用缓存
2. 通常来说，过期时间兜底是行之有效的办法，根据实时性期待不一样，可以增加个删除逻辑，提高一致性。
3. 从解耦层面来说，可以 使用订阅binlog的模式来更新，缺点就是重，比较适合的场景是数据不过期场景

## 6、总结

缓存数据一致性问题是非常热门的面试题，需要一些经验才能回答的到位。