
## 1 面试考点分析

HSAHTABLE是Set、Hash等数据对象的底层编码模式，有语言基础的T恤对Hash表应该都有一些认知，Hash表无论在哪里，都是考察重点。

面试的考察点集中在数据结构、渐进式扩容、扩容缩容时机这些内容。

## 2 面试题

### 2.1 HASHTABLE查找元素总数的平均时间复杂度是多少？

分析：
- 这题考察的是Redis字典的表头结构，如果表头结构中存储键值对个数的字段，那么查找元素总数的平均时间复杂度就是O(1)，而如果没有这个字段，那字典就需要去遍历所有的键值对。
- 下面是Redis字典的表头结构![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/46425755b9b09feef7e43e548b19bd4c.png)可以发现字典的表头结构中的used，就记录了当前键值对数量的字段

回答：
- HASHTABLE查找元素的平均时间复杂度是O(1)，因为HASHTABLE的表头结构中有储存键值对数量的字段used。
### 2.2 一个数据在HASHTABLE中的存储位置，是怎么计算的？

index=hash&sizemark

分析：
- 当一个新的键值对要插入到HASHTABLE中时，首先会使用哈希函数计算这个key的哈希值，Redis使用的哈希算法是MurmurHash2哈希算法，然后把`哈希值和哈希掩码做与运算得到索引值`，哈希掩码其实就是哈希表数组的大小减去1。让后续会根据索引值把键值对插入到相应的位置。

回答：
- 首先会`通过哈希函数计算出key的哈希值`，然后与`哈希掩码做与运算得到索引值`，索引值就是这个数据在HASHTABLE中的存储位置

### 2.3 HASHTABLE怎么扩容？

分析：
- HASHTABLE的扩容通过渐进式Rehash操作来完成

回答：
- 首先程序会为HASHTABLE的1号表分配空间，空间大小是第一个大于等于2倍原表大小的2次幂。
- 在Rehash进行期间，标记为rehashidx从0开始，每次对字典的键值对执行增删改查操作后，都会`将rehashidx位置的数据迁移到1号表，然后将rehashidx加1`，随着字典操作的不断执行，最终0号表的所有键值对都会被rehash到1号表上。之后，1号表会被设置为0号表，接着在1号表的位置创建一个新的空白表。
- 补充1：如果rehashidx所在位置为空，允许10次遇到空bucket
- 补充2：迁移是会迁移整个rehashidx所在位置的链表，同时rehashidx+1，used--；

### 2.4 HASHTABLE怎么缩容？

分析：
- HASHTABLE的缩容也通过渐进式rehash操作来完成，可以参考下面代码。![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/6509c157abfbb94a572072c9d21681cc.png)

回答：
- 首先，程序会为HASHTABLE的1号表分配空间，缩容前used如果小于最小值（4），那么空间就是4。如果大于最小值，就是大于原来used最近的2次幂，比如原来是6，那么空间就是8；
- 在rehash进行期间，标记为rehashidx从0开始，每次对字典的键值对支持增删改查操作后，都会将rehashidx位置的数据迁移到1号表，然后将rehashidx加1
- 随着字典操作的不断执行，最终0号表的所有键值对都会被rehash到1号表上。之后，1号表会被设置为0号表，接着在1号表的位置创建一个新的空白表

### 2.5 什么时候缩容，什么时候扩容

分析：
- HASHTABLE的扩容和缩容由哈希表的负载因子决定，负载因子 = 键值对数量 / 哈希表大小

回答：
- Redis设置了一个负载因子：`k = ht[0].used / ht[0].size`
- 扩容：
	- 当以下两个条件中的任意一个被满足时，哈希表会自动开始扩容：
		- 服务器目前`没有在执行`BGSAVE或者BGREWRITEAOF，并且负载因子 >= 1
		- 服务器目前`正在执行`BGSAVE或者BGREWRITEAOF，并且负载因子 >= 5
- 缩容：
	- 当哈希表的负载因子 < 0.1 时，程序会自动开始对哈希表进行收缩操作