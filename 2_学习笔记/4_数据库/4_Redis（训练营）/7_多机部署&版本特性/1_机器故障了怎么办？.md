
## 1 简介

Redis是内存数据库，前面有提到我们可以通过持久化机制，保存快照或者执行记录文件在磁盘上，等重启时供恢复，如果有了解过MySql这样数据的同学，可能都会很容易想到这么一个问题，如果这台机器故障了，或者磁盘换了，那数据不就全没了吗？这种情况又该怎么办呢？

## 2 主从模式

最容易想到的，就是主从模式，即给Redis加上从节点，当主节点挂掉了，可以启用从节点取而代之，这种常见模式，我们一般需要关注两个核心问题：
1. `Master和Slave之间数据怎么同步？`
2. `Slave什么情况下可以升级为Master？`

## 3 Slave数据同步

将6380设置为6379的从节点
```shell
127.0.0.1:6380> slaveof 127.0.0.1 6379
OK
```

执行info replication，能看到已经成为了从节点，更多信息我们暂时忽略![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/0b900ce809bb14ce336a347f5adeece8.png)
通过一个Key来验证![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/832af91f282414000b83dca2f8bbe3eb.png)
6380节点原本不存在的skey，在 6379设置之后，也能在6380节点查询到对应的值，说明复制成功。

历史的数据，是否已经复制呢？
我们通过`KEYS *`命令可以查看![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/d2cda0104c15688590839d306f97befc.png)
可以看到，历史的数据也完整的复刻了，如果想去掉这个从节点，可以在从节点使用`SLAVEOF no one`命令![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/2cea237516ccd164f525b862c07cff89.png)
执行之后，在6379写入的数据，就不会在同步到6380了

有了从节点，当主节点发生故障的时候，我们就可以`在业务层`将Redis连接地址，从原来的主节点，改变为从节点

可能大家会问了，怎么能知道业务连接出问题了，这里最简单的方式 是通过监控，当发现出问题了，就进行切换。

如果主节点出现问题，我们通过监控发现，然后人工取进行切换，这其实很不便利，也容易让故障得不到及时修复，所以我们可以写一些脚本来进行监测，比如在某个服务器上，专门运行脚本，检查Redis的状况，发生问题还是用脚本自动切换。

实际上，这种`监控以及自动切换的能力`，Redis已经有了完整解决方案，`就是哨兵模式`。
## 4 哨兵是什么

哨兵，顾名思义，最重要的就是放哨，即监测Redis节点故障、并提供故障转移的能力。说白了就是一套用来检测Redis服务运行情况的程序，发现了就做一些对应处理，这里有一点需要关注，`Redis的哨兵服务，本质上也是Redis进程，只是启动参数不同，有不同的职责`。
## 5 哨兵选主策略

当哨兵集群选举出哨兵leader后，由哨兵leader从Redis从节点中选择一个Reids节点作为主节点：

1. 过滤故障的节点
2. ==选择优先级slave-priority最大的从节点做为主节点==，如不存在，则继续
3. ==选择复制偏移量最大的从节点作为主节点==，如果都一样，则继续，这里解释下，数据偏移量记录写了多少数据，主服务器会把偏移量同步给从服务器，当主从的偏移量一致，则数据是完全同步的
4. ==选择runid最小的从节点作为主节点==。Redis每次启动的时候生成随机的runid作为Redis的标识

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/07856eb6f822d2d19dab5115389e2516.png)

上面我们说到了哨兵中有个哨兵leader，下面介绍下这个leader哪里来的。

首先，每一个哨兵节点都可以成为leader，当一个哨兵节点确认Redis集群的主节点主观下线后，会请求其他哨兵节点要求将自己选举的leader。被请求的哨兵节点如果没同意过其他哨兵节点的选举请求，则同意该请求，也就是选举票数+1，否则不同意

如果一个哨兵节点获得的选举票数`超过节点数的一半，且大于quorum配置的值`，则该哨兵节点选举为leader；否则重新进行选举

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/d5ab1eac1fc0773c71b36b073841886c.png)