
## 一、 存储过程

### 1.1 定义

- sql语句需要先编译然后执行，而存储过程（stored procedure）是一组为了完成特定功能的sql语句集，经编译后存储在数据库中。

### 1.2 特点

1、能完成较复杂的判断和运算    
2、可编程性强，灵活    
3、sql编程的代码可重复使用    
4、执行的速度相对快一些    
5、减少网络之间的数据传输，节省开销   

### 1.3 示例

```mysql
#语法规则：
delimiter //
create procedure 名称()
begin
.........;
end //
delimiter ;

#示例：
delimiter //
create procedure test3()
begin
select * from t_user;
end //
delimiter ;

#调用：
call test3()
```

### 1.4 定义变量

```mysql
#示例
delimiter //
create procedure test4()
begin
  -- 使用 declare语句声明一个变量
  declare  yourhobby  varchar(32)  default ' ';
  -- 使用set语句给变量赋值
  set  yourhobby = '足球';
-- 将users表中id=1的名称赋值给username
  select hobby into yourhobby from t_user where id=5;  
-- 返回变量
select yourhobby;
end //
delimiter ;

#调用：
call test4()
#变量具有数据类型和长度：与mysql的sql数据类型保持一致
#注意变量的作用域：作用范围在begin和end块之间
```

### 1.5 参数

```mysql基本语法

delimiter //
create procedure 名称([in|out|inout] 参数名 参数数据类型 )
begin
.........
end //
delimiter ;

#示例
delimiter $$
create procedure test5 (
   in userid int,
   out usertype varchar ( 32 ),
   inout userhobby varchar ( 32 )) 
   begin
   select
         type,
         hobby into usertype,
         userhobby
   from
         t_user
   where
         id = userid;
end //
delimiter;

#调用：
set @id = 1;
set @type = '';
set @hobby = '';
call test5 ( @id, @type, @hobby );
select @type,@hobby;
```

### 1.6 条件语句

```mysql
#基本结构：
if() then...
elseif() then...
else ...
end if;

#示例：
delimiter $$
create  procedure test6(in id int)
    begin
        if(id=1) then
          select 1;
elseif(id=2) then
         select 2;
end if;
end $$
delimiter ;
```

### 1.7 循环语句

```mysql
while
#语法：

delimiter $$
create procedure 名称([in|out|inout] 参数名 参数数据类型 )
begin
while(表达式) do
   ...... 
end while;
 end $$
delimiter;

#示例：
delimiter $$
create procedure test7()
begin
  declare i int default 0;
  while(i<10) do 
        select i;
        set i=i+1;
        insert into t_user(id,type,hobby)  values (i,'h','网球');   
  end while;
 end $$
delimiter;
#插入的数据可以使用函数
```

## 二、自定义函数

- 函数与存储过程最大的区别是函数有返回值，且只有一个返回值

### 2.1 语法：

```mysql
delimiter $$
create function 函数名 (参数)
returns 类型
 begin
    ···
 end $$
delimiter;

#示例：
delimiter $$
create function gethobby(userid int)
returns varchar(32)
reads sql data
  begin
        declare yourhooby varchar(32) default '';
        select hobby into yourhooby from t_user where id=userid;
        return yourhooby;
 end $$
delimiter;
 select gethobby(10)
```

注意：

如果我们开启了 bin-log, 我们就必须为我们的function指定一个参数，以下三选一：

DETERMINISTIC 确定性的，相同参数总是产生相同结果
NO SQL  没有sql语句
READS SQL DATA  读数据