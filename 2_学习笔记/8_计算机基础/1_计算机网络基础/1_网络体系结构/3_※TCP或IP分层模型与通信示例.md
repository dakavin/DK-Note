
TCP/IP是如何在媒介上进行传输的呢？本节将介绍使用TCP/IP时，从应用层到物理媒介为止数据处理的流程。
## 1 数据包首部

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/f82bbe5ede0050ca5d1c9b9501b3f06d.png)

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。通常，`为协议提供的信息为包首部`，所要发送的内容为数据。如上图所示，在下一层的角度看，从上一分层收到的包全部都被认为是本层的数据。

- 包、帧、数据包、段、消息
	- 以上五个术语都用来表述数据的单位，大致区分如下：
	- `包`可以说是全能性术语。
	- `帧`用于表示`数据链路层`中包的单位。
	- `数据包`是IP和UDP等`网络层`以上的分层中包的单位。
	- `段`则表示TCP数据流中的信息。
	- 最后，`消息`是指应用协议中的数据单位

- 包首部就像是协议的脸
	- 网络中传输的数据包有两部分组成：
	- 一部分是协议所要用到的首部，
	- 另一部分是上层传过来的数据。

首部的结构有协议的具体规范详细定义。

例如，识别上一层协议的域应该从包的哪一位开始取多少比特、如何计算校验和并插入包的哪一位等。

相互通信的两端计算机如果在识别协议的序号以及校验和的计算方法上不一样，就根本无法实现通信。

因此，在数据包的首部，明确标明了协议应该如何读取数据。发过来说，看到首部，也就能够了解该协议必要的信息以及所要处理的内容。

所以，看到包首部就如同看到协议的规范。难怪有人会说首部就像是协议的脸了。

## 2 发送数据包

假设甲给乙发送电子邮件，内容为：“早上好”。而从TCP/IP通信上看，是从一台计算机A向另一台计算机B发送电子邮件。我们就通过这个例子来讲解一些TCP/IP通信的过程。

### 2.1 应用程序处理

启动应用程序新建邮件，将收件人邮箱填好，再有键盘输入邮件内容“早上好”，鼠标点击发送按钮就可以开始TCP/IP的通信了

- 首先，应用程序中会继续编码处理。例如，日文电子邮件使用ISO-2022-JP或UTF-8进行编码。`这些编码相当于OSI的表示层功能`。

- 编码转化后，实际邮件不一定会马上被发送出去，因为有些邮件的软件有一次同时发送多个邮件的功能，也可能会有用户点击“收信”按钮以后才一并接收写邮件的功能。像这种何时建立通信连接发送数据的管理功能，从某种宽泛的意义上看术语`OSI参考模型中会话层的功能`

- 应用在发送邮件的那一刻建立TCP连接，从而利用这个TCP连接发送数据。它的过程首先是`将应用的数据发送给下一层的TCP`，再做实际的转发处理

### 2.2 TCP模块的处理

TCP根据应用的指示（这种关于连接的指示相当于OSI参考模型中的会话层），负责建立连接、发送数据以及断开连接。`TCP提供将应用层发来的数据顺利发送至对端的可靠传输`。

为了实现TCP的这一功能，需要在应用层数据的前端附加一个TCP首部。`TCP首部中包括源端口号和目标端口号`（用以识别发送主机跟接收主机上的应用）、`序号`（用以发送的包中那部分是数据）以及`校验和`（Check Sum，用来检验数据的读取是否正常进行的方法）（用以判断数据是否被损坏）。随后将附加了TCP首部的包再发给IP。

### 2.3 IP模块的处理

IP将TCP传过来的`TCP首部和TCP数据合起来当做自己的数据`，并在TCP首部的前端加上自己的IP首部。因此，IP数据包中IP首部后面紧跟着TCP首部，然后才是应用的数据首部和数据本身。`IP首部中包含接收端IP地址以及发送端IP地址`。紧随IP首部的还有用来判断其后面数据是TCP还是UDP的信息。

IP包生成后，参考路由控制表决定接收此IP包的路由或主机。随后，IP包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正的发送数据。

如果尚不知道接收端的MAC地址，可以利用ARP（Address Resolution Protocol）查找。只要知道了对端的MAC地址，就可以将MAC地址和IP地址交给以太网的驱动序，实现数据传输。

### 2.4 网络接口（以太网驱动）的处理

从IP传过来的IP包，对于以太网驱动来说不过就是数据。给这数据附加上以太网首部并进行发送处理。

`以太网首部包含接收端的MAC地址、发送端MAC地址以及标志以太网类型的以太网数据的协议`。

根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的FCS（Frame Check Sequence）有硬件计算，添加到包的最后。设置FCS的目的是为了判断数据包是否由于噪声而被破坏。

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/f02e792f4a3ffb14f60aa19b642f7719.png)

## 3 经过数据链路的包

`分组数据包`（以下简称包）经过以太网的数据链路时的大致流程如下图所示，不过请注意，该图对各个包首部做了简化。

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/458972f850dce807073495793217857a.png)

包流动时，从前往后依次被附加了以太网包首部、IP包首部、TCP包首部（或者UDP包首部）以及应用自己的包首部和数据。而包的最后则谁家了以太网包尾（包首部附加于包的前端，而包尾则追加到包的后端部分）。

每个包首部至少都会包含两个信息：
- 一个发送端和接收端地址
- 另一个是上一层的协议类型

经过每个协议分层后，都必须有识别包发送端和接受端的信息。以太网会用MAC地址，IP会用IP地址，而TCP/UDP会用端口号作为识别两端主机的地址。即使是在应用程序中，像电子邮件地址这样的信息也是一种地址标识。这些地址信息都在每个包经由各个分层时，附加到协议对应的包首部里边。

此外，每个分层的包首部中还包含一个识别位，它是用来标识上一层协议的种类信息。例如以太网的包首部中的以太网类型，IP中的协议类型以及TCP/UDP中两个端口的端口号等起着识别协议类型的作用。就是在应用的首部信息中，有时也会包含一个用来识别其数据类型的标签。
## 4 数据包接收处理

包的接收流程是发送流程的逆序过程。

### 4.1 网络接口（以太网驱动）处理

主机收到以太网包以后，首先从以太网的包首部找到MAC地址判断是否为发给自己的包。如果不是发给自己的包则丢弃数据（很多NIC产品可以设置为即使不是发给自己的包也不丢弃数据。这可以用于监控网络流量）

而如果接收到了恰好是发给自己的包，就查找以太网首部中的类型域从而确定以太网协议所传送过来的数据类型。

在这个例子中数据类型显然的IP包，因此再将数据传给处理IP的自诩，如果这时不是IP而是其他注入ARP的协议，就把数据传给ARP处理。总之，如果以太网包首部的类型域包含了一个无法识别的协议类型，则丢弃数据。

### 4.2 IP模块的处理

IP模块收到IP包首部及后面的数据部分以后，也做类似的处理。

如果判断得出包首部中的IP地址与自己的IP地址匹配，则可接受数据并从中查找上一层协议。如果上一层是TCP就将IP包首部之后的部分传给TCP处理；如果是UDP则将IP包首部后面的部分传给UDP处理。对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，在调查应该送达的主机或路由器以后再转发数据。

### 4.3 TCP模块的处理

在TCP模块中，

- 首先会计算一下`校验和`，判断数据是否被破坏。
- 然后检查是否在按照序号接收数据
- 最后检查端口号，确定具体的应用程序

数据接收完毕后，接收端则发送一个“确认回执”给发送端。如果这个回执信息未能到达发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

数据被完整的接收以后，会传给由端口号识别的应用程序

### 4.4 应用程序的处理

接收端应用程序会直接接收发送端发送的数据。通过解析数据可以获知邮件的收件人地址是乙的地址。如果主机B上没有乙的邮件信箱，那么主机B返回给发送端一个“无此收件地址”的报错信息。

但在这个例子中，主机B上恰好有乙的收件箱，所以主机B和收件人乙能够收到电子邮件的正文。邮件会被保存到本机的硬盘上。如果保存也能正常进行，那么接收端会返回一个“处理正常”的回执给发送端。反之，一旦出现磁盘满、邮件未能成功保存等问题，就会发送一个“处理异常”的回执给发送端。

由此，用户乙就可以利用主机B上的邮件客户端，接收并阅读由主机A上的用户甲发生过来的电子邮件。

## 5 SNS中的通信示例

SNS（Social Network Service），社交网络，是一种即时共享，即时发布消息给圈内特定联系人的一种服务。如前面电子邮件通信过程的描述一样，也可以分析用移动终端发送或接收SNS消息的过程。

- 首先，由于移动电话、智能手机、平板电脑等在进行分组数据的通信，因此在它们转入电池开机的那一刻，已经由通信运营商设定了具体的IP地址。
- 启动移动电话中的应用程序时，会连接指定的服务器，经过用户名、密码验证以后服务器上累积的信息就会发送到手机终端上，并由该终端显示具体内容

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/2e07b39bed88f3a5eae47edc47ba49c1.png)

类似地，通过SNS轻轻一点就能够运行各种工具、发送文本动画等，这都基于互联网的TCP/IP应用。因此，在排查这些应用的问题时，TCP/IP的知识是必不可少的。

>当然，如果是整个服务器宕机，或者服务器容器宕机，那就只能等待充分恢复之后才能继续处理客户端请求了