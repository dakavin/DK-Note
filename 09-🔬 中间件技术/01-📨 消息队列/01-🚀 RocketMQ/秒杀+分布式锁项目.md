---
æ–‡ç« æ ‡é¢˜: "[[ç§’æ€+åˆ†å¸ƒå¼é”é¡¹ç›®]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  è¯¥æ–‡è¯¦è¿°é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿæ„å»ºã€‚é€šè¿‡Spring Bootã€Redisã€RocketMQå’ŒMySQLï¼Œå®ç°å‰ç«¯åˆ†æµã€Redisåº“å­˜é¢„æ‰£ä¸ç”¨æˆ·å»é‡ã€‚åç«¯é‡‡ç”¨MQå¼‚æ­¥å¤„ç†è®¢å•ï¼Œå¹¶æ¢è®¨äº†æœ¬åœ°åŒæ­¥é”ã€MySQLè¡Œé”åŠRedisåˆ†å¸ƒå¼é”åœ¨åº“å­˜æ‰£å‡ä¸­çš„åº”ç”¨ä¸è€ƒé‡ï¼Œæ—¨åœ¨æå‡ç³»ç»Ÿæ€§èƒ½ä¸å¯é æ€§ã€‚
tags:
  - ç§’æ€ç³»ç»Ÿ
  - é«˜å¹¶å‘
  - åˆ†å¸ƒå¼é”
  - Redis
  - RocketMQ
  - Spring Boot
  - åº“å­˜æ‰£å‡
  - å¼‚æ­¥å¤„ç†
ç›¸å…³æ–‡ç« :
  - "[[7_ç§’æ€]]"
  - "[[1_Redisæ”»ç•¥]]"
  - "[[11_å¯¹è±¡è¿‡æœŸæ—¶é—´]]"
  - "[[2_Rediså®æˆ˜ç¯‡]]"
  - "[[../../../08-ğŸ› ï¸ å¼€å‘å·¥å…·/03-ğŸ‹ å®¹å™¨åŒ–/01-ğŸ“š DockeråŸºç¡€/8_Docker Compose/3_å®æˆ˜webæœåŠ¡]]"
æ–‡ç« åˆ†ç±»: ğŸ”¬ ä¸­é—´ä»¶æŠ€æœ¯
æ–‡ç« è·¯å¾„: 09-ğŸ”¬ ä¸­é—´ä»¶æŠ€æœ¯/01-ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—/01-ğŸš€ RocketMQ/ç§’æ€+åˆ†å¸ƒå¼é”é¡¹ç›®.md
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2024-08-11 18:15:12
ä¿®æ”¹æ—¶é—´: 2025-05-28 01:24:07
---

## 1 å¹¶å‘çš„äº†è§£

- å¹¶å‘ï¼šæŒ‡çš„æ˜¯å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ªæ—¶é—´æ®µå†…æ‰§è¡Œï¼›

- QPSï¼šæ¯ç§’é’Ÿç§å¤„ç†è¯·æ±‚çš„æ•°é‡

- `ç¡¬ä»¶æ–¹é¢è§£å†³`ï¼Œå¾ˆé‡è¦ï¼Œä½†æ˜¯è´µ
	- tomcatï¼šQPS  500å·¦å³
		- æ¥å£çš„å¤„ç†æ—¶é—´ 10mså·¦å³ å¯æ‰¿å—4kQPSå·¦å³
		- æ¥å£çš„å¤„ç†æ—¶é—´ 50mså·¦å³ å¯æ‰¿å—2kQPSå·¦å³
	
	- å½“æ¯ç§’æœ‰1wä¸ªè¯·æ±‚
		- ä½¿ç”¨Nginxç»™tomcatåšè´Ÿè½½å‡è¡¡ï¼ŒNginxä¸€èˆ¬å¯æ‰¿å—5wQPS
	
	- å½“æ¯ç§’æœ‰20wä¸ªè¯·æ±‚
		- ä½¿ç”¨ç¡¬ä»¶ï¼ˆLvs/F5ï¼‰ï¼Œä¸€èˆ¬å¯ä»¥æ‰¿å—30wQPS
	
	- å½“æ¯ç§’æœ‰100wä¸ªè¯·æ±‚
		- åŸŸå--->DNSè½®è¯¢ç­–ç•¥
		- å› ä¸ºä¸€ä¸ªåŸŸåæœ‰å¾ˆå¤šä¸ªipåœ°å€ï¼Œæ¯ä¸ªipåœ°å€å¯¹åº”ä¸€ä¸ªæœºæˆ¿ï¼ˆå³ä¸Šè¿°20wè¯·æ±‚çš„ç»“æ„ï¼‰
	- æ³¨æ„ï¼šäº¿çº§ï¼Œåƒä¸‡çš„å¹¶å‘è¯·æ±‚ï¼Œéƒ½æ˜¯æ‰¯æ·¡ï¼ï¼ï¼ç™¾ä¸‡å°±å¾ˆäº†ä¸å¾—äº†

- `è½¯ä»¶å±‚é¢è§£å†³`ï¼Œä»£ç å†™å¥½ï¼Œåœ¨æœ‰é™çš„ç¡¬ä»¶ä¸Šï¼Œæé«˜æ€§èƒ½
	- é™ä½æ¯ä¸ªæ¥å£çš„å¤„ç†æ—¶é—´ï¼Œè®©tomcatå¯ä»¥æ‰¿å—æ›´é«˜çš„å¹¶å‘é‡

- `å¦‚ä½•ä¼˜åŒ–æ¥å£çš„å¤„ç†ï¼ˆå“åº”ï¼‰æ—¶é—´ï¼Ÿ`
	- èƒ½å¼‚æ­¥å°±å¼‚æ­¥
	- å‡å°‘IOï¼ˆç»Ÿä¸€æŸ¥ã€ç»Ÿä¸€å†™ï¼‰
	- å°½æ—©return
	- åŠ é”ç²’åº¦å°½å¯èƒ½å°
	- äº‹åŠ¡æ§åˆ¶ç²’åº¦å°½å¯èƒ½å°
	- ......

- é’ˆå¯¹ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–
	- å‰ç«¯
		- åˆ†æµ/äººæœºæ ¡éªŒï¼ˆè®¾ç½®éªŒè¯ç ï¼Œå›¾ç‰‡æ»‘å—ï¼ŒéªŒè¯æ˜¯å¦çœŸäººï¼‰
	- åç«¯
		- ç”Ÿäº§è€…
			1. å…ˆåˆ¤æ–­åº“å­˜ï¼ˆredisï¼‰ï¼Œä¸å¤Ÿå°½æ—©returnï¼›
			2. å¤Ÿï¼Œä¸€äººä¸€å•ï¼ˆmysqlå»é‡è¡¨ / `redis setnx` / luaè„šæœ¬ï¼‰ï¼Œé‡å¤æ¶ˆè´¹return
			3. éé‡å¤æ¶ˆè´¹ï¼Œå°†ç›¸å…³ä¿¡æ¯å†™å…¥åˆ°MQä¸­
			4. å†™å…¥MQæˆåŠŸåï¼Œç›´æ¥è¿”å›
		- æ¶ˆè´¹è€…ï¼ˆç§’æ€æœåŠ¡ï¼‰
			1. æ¥æ”¶MQä¸­çš„æ¶ˆæ¯
			2. æ‰£å‡åº“å­˜
			3. å†™è®¢å•
			4. ......
## 2 æŠ€æœ¯é€‰æ‹©å‹

- Springboot +æ¥æ”¶è¯·æ±‚å¹¶æ“ä½œrediså’Œmysql

- RedisÂ Â  ç”¨äºç¼“å­˜+åˆ†å¸ƒå¼é”

- RocketmqÂ  ç”¨äºè§£è€¦Â  å‰Šå³°ï¼Œå¼‚æ­¥

- MysqlÂ Â  ç”¨äºå­˜æ”¾çœŸå®çš„å•†å“ä¿¡æ¯

- MybatisÂ Â  ç”¨äºæ“ä½œæ•°æ®åº“çš„ormæ¡†æ¶

## 3 æ¶æ„å›¾

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/3645b5a6086a77c4a50713dfea39593c.png)



## 4 å‡†å¤‡å·¥ä½œ-æ•°æ®åº“

```mysql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for goods
-- ----------------------------
DROP TABLE IF EXISTS `goods`;
CREATE TABLE `goods`  (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `goods_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL,
  `price` decimal(10, 2) NULL DEFAULT NULL,
  `stocks` int(255) NULL DEFAULT NULL,
  `status` int(255) NULL DEFAULT NULL,
  `pic` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL,
  `create_time` datetime(0) NULL DEFAULT NULL,
  `update_time` datetime(0) NULL DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- Records of goods
-- ----------------------------
INSERT INTO `goods` VALUES (1, 'å°ç±³12s', 4999.00, 1000, 2, 'xxxxxx', '2023-02-23 11:35:56', '2023-02-23 16:53:34');
INSERT INTO `goods` VALUES (2, 'åä¸ºmate50', 6999.00, 10, 2, 'xxxx', '2023-02-23 11:35:56', '2023-02-23 11:35:56');
INSERT INTO `goods` VALUES (3, 'é”¤å­pro2', 1999.00, 100, 1, NULL, '2023-02-23 11:35:56', '2023-02-23 11:35:56');

-- ----------------------------
-- Table structure for order_records
-- ----------------------------
DROP TABLE IF EXISTS `order_records`;
CREATE TABLE `order_records`  (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NULL DEFAULT NULL,
  `order_sn` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL,
  `goods_id` int(11) NULL DEFAULT NULL,
  `create_time` datetime(0) NULL DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic;

SET FOREIGN_KEY_CHECKS = 1;

```

## 5 åˆ›å»ºé¡¹ç›®ï¼ˆæ¥å—ç”¨æˆ·ç§’æ€è¯·æ±‚ï¼‰

### 5.1 Pom.xml

```xml
<dependencies>  
    <dependency>  
        <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-data-redis</artifactId>  
    </dependency>  
    <dependency>        
	    <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-web</artifactId>  
    </dependency>  
  
    <dependency>        
	    <groupId>org.projectlombok</groupId>  
        <artifactId>lombok</artifactId>  
        <optional>true</optional>  
    </dependency>  
    <dependency>        
	    <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-test</artifactId>  
        <scope>test</scope>  
    </dependency>  
    <!--hutool-->  
    <dependency>  
        <groupId>cn.hutool</groupId>  
        <artifactId>hutool-all</artifactId>  
        <version>5.7.17</version>  
    </dependency>  
    <dependency>        
	    <groupId>org.aspectj</groupId>  
        <artifactId>aspectjweaver</artifactId>  
    </dependency>  
    <!--redission-->  
    <dependency>  
        <groupId>org.redisson</groupId>  
        <artifactId>redisson</artifactId>  
        <version>3.13.6</version>  
    </dependency>  
    <dependency>        
	    <groupId>org.apache.rocketmq</groupId>  
        <artifactId>rocketmq-spring-boot-starter</artifactId>  
        <version>2.2.2</version>  
    </dependency>  
</dependencies>
```

### 5.2 ä¿®æ”¹é…ç½®æ–‡ä»¶

```yml
server:  
    port: 8081  
    tomcat:  
        threads:  
            max: 400  
spring:  
    redis:  
        host: localhost  
        port: 6379  
        database: 0  
  
rocketmq:  
    name-server: 127.0.0.1:9876
```

### 5.3 4.3åˆ›å»ºSeckillController

```java
@RestController  
public class seckillController {  
    @Autowired  
    private StringRedisTemplate stringRedisTemplate;  
    @Autowired  
    private RocketMQTemplate rocketMQTemplate;  
  
    @GetMapping("seckill")  
    public String doSeckill(Integer goodId, Integer userId) {  
        //1. ç”¨æˆ·å»é‡  
        // uniqueKey = (yyyyMMdd) + userId + goodId  
        String uk = userId + ":" + goodId;  
  
        //2. ä½¿ç”¨setnxåˆ†å¸ƒå¼é”  
        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(uk, "");  
        if (!flag){  
            return "æ‚¨å·²ç»å‚æ•°è¿‡è¯¥å•†å“çš„å‰åï¼Œè¯·å‚ä¸å…¶ä»–å•†å“(*^â–½^*)";  
        }  
  
        //3.åº“å­˜çš„é¢„æ‰£å‡  
        // å‡è®¾åº“å­˜çš„rediså­˜å‚¨æ ¼å¼ä¸º goodId:xx   ---    stock        // æ³¨æ„ï¼šå…ˆæŸ¥å†æ”¹åæ›´æ–°ï¼Œæ˜¯å¾ˆå±é™©çš„ï¼Œå®¹æ˜“å‡ºç°å¹¶å‘é—®é¢˜  
        Long stock = stringRedisTemplate.opsForValue().decrement("goodId"+goodId);  
        if (stock<=0){  
            return "è¯¥å•†å“å·²ç»è¢«åƒä¸‡ï¼Œä¸‹æ¬¡æ—©ç‚¹æ¥^_^";  
        }  
  
        //4.æ¶ˆæ¯æ”¾å…¥mq,å¼‚æ­¥å¤„ç†  
        rocketMQTemplate.asyncSend("seckillTopic", uk, new SendCallback() {  
            @Override  
            public void onSuccess(SendResult sendResult) {  
                System.out.println("å‘é€æˆåŠŸ");  
            }  
  
            @Override  
            public void onException(Throwable throwable) {  
                System.out.println("å‘é€å¤±è´¥" + throwable.getMessage());  
                System.out.println("ç”¨æˆ·Idï¼š" + userId + " --- å•†å“Idï¼š" + goodId);  
            }  
        });  
  
        //5.è¿”å›ç”¨æˆ·ä¸€ä¸ªå‡­è¯  
        return "æ­£åœ¨æ‹¼å‘½æŠ¢è´­ä¸­ï¼Œè¯·ç¨åå»ç”¨æˆ·ä¸­å¿ƒæŸ¥çœ‹";  
    }  
}
```

## 6 åˆ›å»ºé¡¹ç›®é€‰æ‹©ï¼ˆå¤„ç†ç§’æ€ï¼‰

### 6.1 å¯¼å…¥ä¾èµ–

```xml
<dependencies>  
    <dependency>  
        <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-data-redis</artifactId>  
    </dependency>  
    <dependency>        
	    <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-web</artifactId>  
    </dependency>  
    <dependency>        
	    <groupId>org.mybatis.spring.boot</groupId>  
        <artifactId>mybatis-spring-boot-starter</artifactId>  
        <version>2.3.1</version>  
    </dependency>  
  
    <dependency>        
	    <groupId>com.mysql</groupId>  
        <artifactId>mysql-connector-j</artifactId>  
        <scope>runtime</scope>  
    </dependency>  
    <dependency>        
	    <groupId>org.projectlombok</groupId>  
        <artifactId>lombok</artifactId>  
        <optional>true</optional>  
    </dependency>  
    <dependency>        
	    <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-test</artifactId>  
        <scope>test</scope>  
    </dependency>  
    <dependency>        
	    <groupId>org.mybatis.spring.boot</groupId>  
        <artifactId>mybatis-spring-boot-starter-test</artifactId>  
        <version>2.3.1</version>  
        <scope>test</scope>  
    </dependency>  
    <!--hutool-->  
    <dependency>  
        <groupId>cn.hutool</groupId>  
        <artifactId>hutool-all</artifactId>  
        <version>5.7.17</version>  
    </dependency>  
    <dependency>        
	    <groupId>org.aspectj</groupId>  
        <artifactId>aspectjweaver</artifactId>  
    </dependency>  
    <!--redission-->  
    <dependency>  
        <groupId>org.redisson</groupId>  
        <artifactId>redisson</artifactId>  
        <version>3.13.6</version>  
    </dependency>  
    <dependency>        <groupId>org.apache.rocketmq</groupId>  
        <artifactId>rocketmq-spring-boot-starter</artifactId>  
        <version>2.2.2</version>  
    </dependency>  
</dependencies>
```

### 6.2 ä¿®æ”¹ymlæ–‡ä»¶

```yml
server:  
    port: 8082  
spring:  
    datasource:  
        driver-class-name: com.mysql.cj.jdbc.Driver  
        username: root  
        password: abc123  
        url: jdbc:mysql://localhost:3306/rocketmq_miaosha?serverTimezone=GMT%2B8&useSSL=false  
    redis:  
        host: localhost  
        port: 6379  
        database: 0  
rocketmq:  
    name-server: 127.0.0.1:9876  
  
mybatis:  
    mapper-locations: classpath:mapper/*.xml  
    configuration:  
        log-impl: org.apache.ibatis.logging.stdout.StdOutImpl  
        map-underscore-to-camel-case: true
```

### 6.3 é€†å‘ç”Ÿæˆå®ä½“ç±»ç­‰

### 6.4 ä¿®æ”¹å¯åŠ¨ç±»

```java
@SpringBootApplication  
@MapperScan("com.dakkk.mapper")  
@EnableScheduling  
public class FSeckillServiceApplication {  
  
    public static void main(String[] args) {  
        SpringApplication.run(FSeckillServiceApplication.class, args);  
    }  
  
}
```

### 6.5 ä¿®æ”¹GoodsMapper

```java
public interface GoodsMapper {  
  
    List<Goods> selectSeckillGoods();  
}
```

### 6.6 ä¿®æ”¹GoodsMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE mapper  
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.dakkk.mapper.GoodsMapper">  
  
    <resultMap id="BaseResultMap" type="com.dakkk.pojo.Goods">  
            <id property="id" column="id" jdbcType="INTEGER"/>  
            <result property="goodsName" column="goods_name" jdbcType="VARCHAR"/>  
            <result property="price" column="price" jdbcType="DECIMAL"/>  
            <result property="stocks" column="stocks" jdbcType="INTEGER"/>  
            <result property="status" column="status" jdbcType="INTEGER"/>  
            <result property="pic" column="pic" jdbcType="VARCHAR"/>  
            <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>  
            <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>  
    </resultMap>  
    <select id="selectSeckillGoods" resultType="com.dakkk.pojo.Goods">  
        select id,stocks from goods where status = 1;  
    </select>  
  
</mapper>
```

### 6.7 åŒæ­¥mysqlæ•°æ®åˆ°redis

#### 6.7.1 æ–¹æ³•1

```java
/**
 *  1. æ¯å¤©10ç‚¹ æ™šä¸Š8ç‚¹ é€šè¿‡å®šæ—¶ä»»åŠ¡ å°†mysqlçš„åº“å­˜ åŒæ­¥åˆ°redisä¸­å»  
 *  2. ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œå¸Œæœ›é¡¹ç›®å¯åŠ¨å å°±åŒæ­¥æ•°æ®  
 * */
@Component  
public class DataSync {  
    @Autowired  
    private GoodsMapper goodsMapper;  
    @Autowired  
    private StringRedisTemplate stringRedisTemplate;  
  
    /**  
     * spring beançš„ç”Ÿå‘½å‘¨æœŸ  
     * åœ¨å½“å‰å¯¹è±¡ å®ä¾‹åŒ–å®Œä»¥å  
     * å±æ€§æ³¨å…¥ä»¥å  
     * æ‰§è¡Œ PostConstruct æ³¨è§£çš„æ–¹æ³•  
     */  
    @PostConstruct  
    public void initData(){  
        //1. è·å–å•†å“çš„ä¿¡æ¯  
        List<Goods> list = goodsMapper.selectSeckillGoods();  
        if (list.isEmpty()){  
            return;  
        }  
        //2. é€šè¿‡å•†å“ä¿¡æ¯åˆ°redisä¸­å»  
        list.forEach(good->{  
            stringRedisTemplate.opsForValue().set("goodId:"+good.getId(),good.getStocks().toString());  
        });  
    }  
}
```

#### 6.7.2 æ–¹æ³•2

```java
@Component  
public class MySqlToRedis2 implements CommandLineRunner {  
  
    @Resource  
    private GoodsMapper goodsMapper;  
  
    @Resource  
    private StringRedisTemplate stringRedisTemplate;  
  
    @Override  
    public void run(String... args) throws Exception {  
        initData();  
    }  
  
    private void initData() {  
        //1,æŸ¥è¯¢æ•°æ®åº“ä¸­éœ€è¦å‚äºç§’æ€çš„å•†å“æ•°æ®  
        List<Goods> goodsList = goodsMapper.querySpikeGoods();  
        ValueOperations<String, String> operations = stringRedisTemplate.opsForValue();  
//        //2,æŠŠæ•°æ®åŒæ­¥åˆ°Redis  
        for (Goods goods : goodsList) {  
            operations.set("goods:" + goods.getGoodsId(), goods.getTotalStocks().toString());  
        }  
    }  
}
```

### 6.8 åˆ›å»ºç§’æ€ç›‘å¬


- `æ‚²è§‚é”`
```java
@Component  
@RocketMQMessageListener(topic = "seckillTopic2",  
        consumerGroup = "seckill-consumer-group2",  
        consumeMode = ConsumeMode.CONCURRENTLY,  
        consumeThreadNumber = 24                // IOå¯†é›†å‹ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨æ˜¯12çº¿ç¨‹çš„  
)  
public class SeckillListener implements RocketMQListener<MessageExt> {  
    @Autowired  
    private GoodsService goodsService;  
    @Override  
    public void onMessage(MessageExt message) {  
        String msg = new String(message.getBody());  
        //String uk = userId + ":" + goodId;  
        Integer userId = Integer.parseInt(msg.split("-")[0]);  
        Integer goodId = Integer.parseInt(msg.split("-")[1]);  
  
        //ä½¿ç”¨æ‚²è§‚é”synchronized  
        //åœ¨æ–¹æ³•çš„å¤–é¢ä½¿ç”¨é”ï¼Œå› ä¸ºæ–¹æ³•æ˜¯äº‹åŠ¡æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ‰§è¡Œ  
        //å¦‚æœåœ¨æ–¹æ³•å†…åŠ é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ï¼Œäº‹åŠ¡æœ‰å¯èƒ½æœªæäº¤ï¼Œå¯¼è‡´è¶…ä¹°é—®é¢˜  
        synchronized (this){  
            goodsService.realSeckill(userId,goodId);  
        }  
    }  
}
```

- ä½¿ç”¨æ‚²è§‚é”synchronized  
- æ³¨æ„äº‹åŠ¡æ–¹æ³•å’Œé”çš„å…ˆåé¡ºåº
- `åœ¨äº‹åŠ¡æ–¹æ³•çš„å¤–é¢ä½¿ç”¨é”`ï¼Œå› ä¸ºæ–¹æ³•æ˜¯äº‹åŠ¡æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ‰§è¡Œ  
- å¦‚æœåœ¨æ–¹æ³•å†…åŠ é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ï¼Œäº‹åŠ¡æœ‰å¯èƒ½æœªæäº¤ï¼Œå¯¼è‡´è¶…ä¹°é—®é¢˜ 

- `åˆ†å¸ƒå¼é”`

- `mysql`ï¼Œåˆ©ç”¨mysqlæœ¬èº«å¯¹å¢åˆ æ”¹ä¼šåŠ å†™é”
- `å¯ä»¥ä¸åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼ŒåŠ synchronized`
```java
@Service  
public class GoodsServiceImpl extends ServiceImpl<GoodsMapper, Goods>  
    implements GoodsService{  
  
    @Autowired  
    private OrderRecordsMapper orderRecordsMapper;  
  
    @Override  
    @Transactional(rollbackFor = Exception.class)  
    public void realSeckill(Integer userId, Integer goodId) {  
        //å®ç°äº†mysqlä¸­çš„è¡Œé”ï¼Œå¯¹mysqlçš„å‹åŠ›æ¯”è¾ƒå¤§ï¼Œä¸é€‚åˆå¹¶å‘é‡å¤ªå¤§çš„æƒ…å†µ
        boolean updateFlag = update().setSql("stocks = stocks -1 ").eq("id",goodId)  
                .eq("update_time", new Date()).gt("stocks",0).update();  
        if (updateFlag){  
            OrderRecords order = new OrderRecords();  
            order.setGoodsId(goodId);  
            order.setCreateTime(new Date());  
            order.setUserId(userId);  
            orderRecordsMapper.insert(order);  
        } 
    } 
}
```

- `redisåˆ†å¸ƒå¼é”`
```java
@Component  
@RocketMQMessageListener(topic = "seckillTopic2",  
        consumerGroup = "seckill-consumer-group2",  
        consumeMode = ConsumeMode.CONCURRENTLY,  
        consumeThreadNumber = 24                // IOå¯†é›†å‹ï¼Œæˆ‘ä»¬çš„å¤„ç†å™¨æ˜¯12çº¿ç¨‹çš„  
)  
public class SeckillListener implements RocketMQListener<MessageExt> {  
    @Autowired  
    private GoodsService goodsService;  
    @Autowired  
    private StringRedisTemplate stringRedisTemplate;  
    private static final int ZX_TIME = 100000;  
  
    @Override  
    public void onMessage(MessageExt message) {  
        String msg = new String(message.getBody());  
        //String uk = userId + ":" + goodId;  
        Integer userId = Integer.parseInt(msg.split("-")[0]);  
        Integer goodId = Integer.parseInt(msg.split("-")[1]);  
  
        //ä½¿ç”¨æ‚²è§‚é”synchronized  
        //åœ¨æ–¹æ³•çš„å¤–é¢ä½¿ç”¨é”ï¼Œå› ä¸ºæ–¹æ³•æ˜¯äº‹åŠ¡æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ‰§è¡Œ  
        //å¦‚æœåœ¨æ–¹æ³•å†…åŠ é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ï¼Œäº‹åŠ¡æœ‰å¯èƒ½æœªæäº¤ï¼Œå¯¼è‡´è¶…ä¹°é—®é¢˜  
//        synchronized (this){  
//            goodsService.realSeckill(userId,goodId);  
//        }  
        // ç»™é”ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”çš„å‘é€  
        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent("lock:" + goodId, "",Duration.ofSeconds(30));  
        //è‡ªæ—‹æ“ä½œï¼Œé¿å…æ²¡æœ‰æ‹¿åˆ°é”çš„è¿›ç¨‹æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥  
        int currentThreadTime = 0;  
        // ä¸€èˆ¬ä¸è¦å†™while true  
        // è‡ªæ—‹çš„æ¬¡æ•°ä¸€èˆ¬ç»™å¤šç‚¹ï¼Œä¸ç„¶ä¼šä¸¢å¤±è®¢å•  
        while (currentThreadTime < ZX_TIME) {  
            if (flag) {  
                // æ‹¿é”æˆåŠŸ  
                try {  
                    goodsService.realSeckill(userId, goodId);  
                    return;  
                } finally {  
                    //æ— è®ºå¦‚ä½•ä¹Ÿè¦é‡Šæ”¾é”  
                    stringRedisTemplate.delete("lock:" + goodId);  
                }  
            } else {  
                //æ‹¿é”å¤±è´¥  
                currentThreadTime += 200;  
                // å› ä¸ºwhileçš„å¾ªç¯å¾ˆå¿«ï¼Œæ‰€ä»¥ä¼‘çœ   
                try {  
                    Thread.sleep(200L);  
                } catch (InterruptedException e) {  
                    throw new RuntimeException(e);  
                }  
  
            }  
        }  
  
    }  
}
```

### 6.9 ä¿®æ”¹GoodsService

```java
public interface GoodsService extends IService<Goods> {  
  
    void realSeckill(Integer userId, Integer goodId);  
}
```

### 6.10 ä¿®æ”¹GoodsServiceImpl

- å°†ä¸Šè¿°mysqlåŠ é”çš„ä»£ç 

## 7 æ€»ç»“

- æŠ€æœ¯é€‰å‹ï¼šspringboot ã€redis ã€ mysql ã€ RocketMQ ã€ Security

- è®¾è®¡ï¼šï¼ˆæŠ¢ä¼˜æƒ å·ï¼‰
	- è®¾è®¡seckill-web æ¥æ”¶å¤„ç†ç§’æ€è¯·æ±‚
	- è®¾è®¡seckill-service å¤„ç†ç§’æ€çœŸå®ä¸šåŠ¡

- éƒ¨ç½²ç»†èŠ‚ï¼š
	- ç”¨æˆ·é‡ï¼š50w
	- qpsï¼š2w+ 
		- è‡ªå·±æ‰“æ—¥å¿—ï¼ŒåŒä¸€ç§’å†…æ¥å£çš„è§¦å‘é‡ï¼Œæ¥ç»Ÿè®¡
		- nginxï¼ˆaccess.logï¼‰
	- æ—¥æ´»é‡ï¼š1-2w   ç¼©çŸ­åˆ° 1% - 5%
	- å‡ å°æœåŠ¡å™¨åŠé…ç½®ï¼š
		- 8C16G 4å° seckill-web 4å°   seckill-service 2å°
	- å¸¦å®½ï¼š100M

- æŠ€æœ¯è¦ç‚¹ï¼š
	- é€šè¿‡redisçš„setnxå‘½ä»¤ï¼Œå¯¹ç”¨æˆ·å’Œå•†å“è¿›è¡Œå»é‡å‘½ä»¤ï¼Œé˜²æ­¢ç”¨æˆ·åˆ·æ¥å£çš„è¡Œä¸º
	- é€šè¿‡æ¯å¤©çš„å®šæ—¶ä»»åŠ¡ï¼ŒæŠŠmysqlä¸­å‚æ•°ç§’æ€çš„åº“å­˜å•†å“ï¼ŒåŒæ­¥åˆ°redisï¼Œåšåº“å­˜çš„é¢„æ‰£å‡ï¼Œæå‡æ¥å£æ€§èƒ½
	- é€šè¿‡RocketMQæ¶ˆæ¯ä¸­é—´ä»¶çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œæ¥å°†ç§’æ€çš„ä¸šåŠ¡å¼‚æ­¥åŒ–ï¼Œè¿›ä¸€æ­¥æé«˜æƒ³ä½ èƒ½
	- seckill-serviceä½¿ç”¨å¹¶å‘æ¶ˆè´¹æ¨¡å¼ï¼Œå¹¶ä¸”è®¾ç½®åˆç†çš„çº¿ç¨‹æ•°é‡ï¼Œå¿«é€Ÿå¤„ç†é˜Ÿåˆ—ä¸­å †ç§¯çš„æ¶ˆæ¯
	- ä½¿ç”¨redisçš„åˆ†å¸ƒå¼é”+è‡ªæ—‹é”ï¼Œå¯¹å•†å“çš„åº“å­˜è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼ŒæŠŠå¹¶å‘å‹åŠ›è½¬ç§»åˆ°ç¨‹åºä¸­å’Œredisä¸­å»ï¼Œå‡å°‘dbå‹åŠ›
	- ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡æ³¨è§£ï¼Œå¹¶ä¸”è®¾ç½®å¼‚å¸¸å›æ»šï¼Œæ§åˆ¶æ•°æ®åº“çš„åŸå­æ›¹ç»„
	- ä½¿ç”¨jmeterå‹æµ‹å·¥å…·ï¼Œå¯¹ç§’æ€æ¥å£è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œåœ¨8C16Gçš„æœåŠ¡å™¨ï¼Œqps2k+ï¼Œè¾¾åˆ°å‹æµ‹é¢„æœŸ