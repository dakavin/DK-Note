---
文章标题: "[[2_补充：Redis之IO多路复用模型实现原理]]" 
文章作者: Dakkk
文章概要: |
  文章详细介绍了Redis单线程模式下使用IO多路复用技术解决多客户端并发连接的阻塞问题，通过文件描述符监听和事件处理机制实现高性能网络通信。
tags:
- "Redis"
- "IO多路复用"
- "单线程"
- "网络编程"
- "epoll"
- "文件描述符"
- "Reactor模式"
- "非阻塞IO"
相关文章:
- "[[3_单线程为什么能这么快（重点理解）]]"
- "[[4_Redis处理过程-源码分析（稍微了解）]]"
- "[[2_Redis单线程面试与分析]]"
- "[[3_Redis多线程面试与分析]]"
- "[[0_Java 5种IO模型]]"
文章分类: "🗄️ 数据库技术"
文章路径: "04-🗄️ 数据库技术/02-🔴 Redis/03-🎓 训练营笔记/3_Redis是怎么运作的/2_补充：Redis之IO多路复用模型实现原理.md"
文章难度: 中级 🌳
目前阶段: ✅ 已完成
重要性: ⭐⭐⭐⭐ 核心能力
创建时间: 2024-08-11 18:15:12
修改时间: 2025-05-27 23:09:58
---

## 1 Redis之I/O多路复用模型实现原理

Redis 的 I/O 多路复用模型`有效的解决单线程的服务端，使用不阻塞方式处理多个 client 端请求问题`。在看 I/O 多路复用知识之前，我们先来看看 Redis 的客服端怎么跟客户端建立连接的、单线程 socket 服务端为什么会存在 I/O 阻塞。

## 2 Redis客户端连接

Redis 通过监听一个 TCP 端口或者 Unix socket 的方式来接收来自 client 端的连接，当一个连接建立后，Redis 内部会进行以下一些操作：

- 首先，客户端 socket 会被设置为非阻塞模式，因为 Redis 在网络事件处理上采用的是`非阻塞多路复用模型`。
  
- 然后为这个 socket 设置 TCP_NODELAY 属性，禁用 Nagle 算法。
  
- 然后创建一个可读的文件事件用于监听这个客户端 socket 的数据发送。
  

## 3 阻塞I/O

在 socket 连接中，一个服务器进程和一个客户端进行通信时，当一个 client 端向服务端写数据时，如果 client 端没有发送数据，那么服务端的 read 将一直阻塞，直到客户端 write 发来数据。在一个客户和服务器通信时没什么问题，当多个客户 与 一个服务器通信时，就存在问题了。如下图，两个客服端同时连接一个服务端进行写数据的时序图
![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/11eccc093d5cbe40d6b7d7428aee0ddc.png)

从上图可以看出一个服务器进程和多个客户端进程通信的问题：

- (1) client1 和服务端建立连接后，`服务端会一直阻塞于 client1，直到 client1 客户端 write 发来数据才开始后面的操作`。服务端阻塞期间，即使其他客服端 client2 的数据提前到来，也不能处理 client2 客服端的请求。
  
- (2) 有一个严重的问题就是，如果客户端 client1 一直没有 write 数据到来，那么服务端 service 会一直阻塞，不能处理其他客户的服务。
  

上面就是 Redis 通过 Unix socket 的方式来接收来自 client 端的连接存在的 I/O 阻塞问题，而 **「I/O 多路复用」** 就是为了解决服务端一直阻塞等待某一个 client 的数据到来，即使其他client的数据提前到来，也不会被处理的问题。

## 4 I/O多路复用

为什么 Redis 中要使用 I/O 多路复用这种技术呢？

因为 Redis 是跑在==单线程==中的，所有的操作都是按照顺序线性执行的，但是==由于读写操作等待用户输入 或 输出都是阻塞的==。所以 I/O 操作在一般情况下往往不能直接返回，这会导致某一文件的 I/O 阻塞导，致整个进程无法对其它客户提供服务。而 I/O 多路复用就是为了解决这个问题而出现的。==为了让单线程(进程)的服务端应用同时处理多个客户端的事件，Redis 采用了 IO 多路复用机制。==

这里==多路== 指的是多个网络连接客户端， ==复用== 指的是复用同一个线程(单进程)。I/O 多路复用其实是使用一个线程来检查多个 Socket 的就绪状态，在单个线程中通过记录跟踪每一个 socket（I/O流）的状态来管理处理多个 I/O 流。如下图是 Redis 的 I/O 多路复用模型：

![|380](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2024/04/a76ed8b7bf01e0911337f653e0a8269e.png)

>Linux 系统中，把一切都看做是文件，当进程打开现有文件或创建新文件时，内核向进程返回一个文件描述符。可以理解文件描述符是一个索引，这样，要操作文件的时候，我们直接找到索引就可以对其进行操作了。我们将这个索引叫做文件描述符（file descriptor），简称fd。


如上图对 Redis 的 I/O 多路复用模型进行一下描述说明：

- (1)`一个 socket 客户端与服务端连接时，会生成对应一个套接字描述符`(套接字描述符是文件描述符的一种)，每一个 socket 网络连接其实都对应一个文件描述符。
  
- (2)多个客户端与服务端连接时，Redis 使用 **「I/O 多路复用程序」** 将客户端 socket 对应的 FD 注册到监 听列表(一个队列)中。当客服端执行 read、write 等操作命令时，I/O 多路复用程序会将命令封装成一个事件，并绑定到对应的 FD 上。
  
- (3)**「文件事件处理器」** 使用 I/O 多路复用模块同时监控多个文件描述符（fd）的读写情况，当 `accept`、`read`、`write` 和 `close` 文件事件产生时，文件事件处理器就会回调 FD 绑定的事件处理器进行处理相关命令操作。
  

>例如：以 Redis 的 I/O 多路复用程序 epoll 函数为例    多个客户端连接服务端时，Redis 会将客户端 socket 对应的 fd 注册进 epoll，然后 epoll 同时监听多个文件描述符(FD)是否有数据到来，如果有数据来了就通知事件处理器赶紧处理，这样就不会存在服务端一直等待某个客户端给数据的情形。 
（I/O多路复用程序函数有 select、poll、epoll、kqueue）


- (5)整个文件事件处理器是在单线程上运行的，但是通过 I/O 多路复用模块的引入，实现了同时对多个 FD 读写的监控，当`其中一个 client 端达到写或读的状态，文件事件处理器就马上执行，从而就不会出现 I/O 堵塞的问题，提高了网络通信的性能`。
  
- (6)如上图，Redis 的 I/O 多路复用模式使用的是 **「Reactor 设置模式」** 的方式来实现。
  

## 5 总结

- (1) Redis 的 I/O 多路复用程序函数有 select、poll、epoll、kqueue。select 作为备选方案，由于其在使用时会扫描全部监听的文件描述符，并且只能同时服务 1024 个文件描述符，所以是备选方案。
  
- (2) I/O 多路复用模型是利用 select、poll、epoll 函数可以同时监察多个流的 I/O 事件的能力，在空闲的时候，会把当前线程阻塞掉。当有一个或多个流有 I/O 事件时，就从阻塞态中唤醒，于是程序就会轮询一遍所有的流（epoll 是只轮询那些真正发出了事件的流），依次顺序的处理就绪的流，这种做法就避免了大量无用的等待操作。