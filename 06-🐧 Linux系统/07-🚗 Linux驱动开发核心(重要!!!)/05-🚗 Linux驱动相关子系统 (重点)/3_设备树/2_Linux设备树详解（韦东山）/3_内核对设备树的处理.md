---
æ–‡ç« æ ‡é¢˜: "[[3_å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  æ–‡ç« è¯¦ç»†è§£æäº†Linuxå†…æ ¸å¤„ç†è®¾å¤‡æ ‘ï¼ˆDTï¼‰çš„å®Œæ•´æµç¨‹ã€‚ä»bootloaderä¼ é€’DTBåœ°å€å¼€å§‹ï¼Œä¾æ¬¡ä»‹ç»äº†å¹³å°è¯†åˆ«ã€è¿è¡Œæ—¶é…ç½®æå–ã€DTBæ‰å¹³æ•°æ®å‘`device_node`æ ‘å½¢ç»“æ„çš„è½¬æ¢ã€`device_node`åˆ°`platform_device`çš„ç”Ÿæˆï¼Œä»¥åŠæœ€ç»ˆçš„`platform_device`ä¸`platform_driver`çš„åŒ¹é…æœºåˆ¶ï¼Œå¹¶æä¾›äº†è°ƒè¯•æ–¹æ³•ã€‚
tags:
  - Linuxå†…æ ¸
  - è®¾å¤‡æ ‘
  - platformè®¾å¤‡
  - é©±åŠ¨æ¨¡å‹
  - bootloader
  - ARMæ¶æ„
  - kernelå¯åŠ¨
  - device_node
ç›¸å…³æ–‡ç« :
  - "[[../1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/01_è®¾å¤‡æ ‘ï¼ˆdevice Treeï¼‰çš„ç”±æ¥]]"
  - "[[../1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/02_å›¾è§£Kernel Device Tree(è®¾å¤‡æ ‘)çš„ä½¿ç”¨]]"
  - "[[../1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/03_è®¾å¤‡æ ‘ä¸­CPUæè¿° (ä¸éœ€è¦æ”¹)]]"
  - "[[../1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/04_è®¾å¤‡æ ‘ä¸­æ—¶é’Ÿæè¿° (è¢«ä½¿ç”¨)]]"
  - "[[../1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/06_è®¾å¤‡æ ‘ä¸­ GPIO ç›¸å…³å±æ€§ (å®šä¹‰)]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/05-ğŸš— Linuxé©±åŠ¨ç›¸å…³å­ç³»ç»Ÿ (é‡ç‚¹)/2_è®¾å¤‡æ ‘/2_Linuxè®¾å¤‡æ ‘è¯¦è§£ï¼ˆéŸ¦ä¸œå±±ï¼‰/3_å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†.md
æ–‡ç« éš¾åº¦: é«˜çº§ ğŸ”¥
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­â­ ç²¾é€šå¿…å¤‡
åˆ›å»ºæ—¶é—´: 2025-04-20 14:54:21
ä¿®æ”¹æ—¶é—´: 2025-06-10 09:09:09
---

## 1 æ¦‚è¿°

Linuxå†…æ ¸ä½¿ç”¨è®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰æ•°æ®ä¸»è¦æœ‰ä¸‰ä¸ªç›®çš„ï¼š
**1. å¹³å°è¯†åˆ«**(platfrom identification)
**2. è¿è¡Œæ—¶å¡«å……**(runtime comfiguration)
**3. è®¾å¤‡å¡«å……**(device population)

æ•´ä¸ªå¤„ç†æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š`DTB -> device_node -> platform_device`

å¦‚æœæƒ³äº†è§£è¯¦ç»†çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‚è€ƒ[åµŒå…¥å¼Linuxåº”ç”¨å¼€å‘å®Œå…¨æ‰‹å†Œ](../../../../01-â‡ï¸%20å‚è€ƒèµ„æ–™/1_å‚è€ƒä¹¦ç±/åµŒå…¥å¼Linuxåº”ç”¨å¼€å‘å®Œå…¨æ‰‹å†Œ.pdf) ç¬¬16.3.1å’Œ16.3.2éƒ¨åˆ†ï¼Œéœ€è¦æ³¨æ„çš„æ—¶ï¼Œæ‰‹å†Œçš„å†…æ ¸ç‰ˆæœ¬æ˜¯2.6.2

## 2 å†…æ ¸head.Så¯¹dtbçš„ç®€å•å¤„ç†(æºå¤´åˆ†æ)

### 2.1 bootloaderä¼ å‚æœºåˆ¶

**bootloaderä¼ å‚æ–¹å¼**ï¼šå½“bootloaderå¯åŠ¨å†…æ ¸æ—¶ï¼Œä¼šè®¾ç½®r0ã€r1ã€r2ä¸‰ä¸ªå¯„å­˜å™¨ï¼š
- `r0`ï¼šä¸€èˆ¬è®¾ç½®ä¸º0
- `r1`ï¼šmachine idï¼ˆåœ¨ä½¿ç”¨è®¾å¤‡æ ‘æ—¶è¯¥å‚æ•°æ²¡æœ‰è¢«ä½¿ç”¨ï¼‰
	- æ¯ä¸ªå•æ¿å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª`machine_desc` ç»“æ„ä½“ï¼Œé‡Œé¢æœ‰initå‡½æ•°å’Œnræ•°
- `r2`ï¼š**ATAGSæˆ–DTBçš„å¼€å§‹åœ°å€**ï¼ˆè¿™æ—¶æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ï¼‰
	- ATAGSä¼ å‚æ˜¯ä»¥å‰çš„æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒéŸ¦ä¸œå±±çš„æ¯•ä¸šç­è§†é¢‘ã€Šè‡ªå·±å†™bootloaderã€‹ï¼Œåœ°å€åœ¨ï¼š`006_u-boot_å†…æ ¸_æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆæ–°1æœŸ_2æœŸé—´çš„è¡”æ¥ï¼‰-> ç¬¬002è¯¾_ä»0å†™bootloader`

bootloaderç»™å†…æ ¸ä¼ é€’å‚æ•°æœ‰ä¸¤ç§æ–¹æ³•ï¼š
- **ATAGSæ–¹å¼**ï¼ˆä¼ ç»Ÿæ–¹æ³•ï¼‰
- **DTBæ–¹å¼**ï¼ˆè®¾å¤‡æ ‘æ–¹æ³•ï¼‰

head.Sæ–‡ä»¶å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ä¸­æ‰¾åˆ°
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/65238758348c2ce08881b8a68919c7f3.png)

### 2.2 head.Sçš„æ ¸å¿ƒå¤„ç†æµç¨‹

**head.Sçš„ä¸»è¦å¤„ç†æ­¥éª¤**
```assembly
a. __lookup_processor_type : ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤è¯»å–CPU ID, æ ¹æ®è¯¥IDæ‰¾åˆ°å¯¹åº”çš„proc_info_listç»“æ„ä½“
                            (é‡Œé¢å«æœ‰è¿™ç±»CPUçš„åˆå§‹åŒ–å‡½æ•°ã€ä¿¡æ¯)
b. __vet_atags             : åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯ç”¨çš„ATAGSæˆ–DTB
c. __create_page_tables    : åˆ›å»ºé¡µè¡¨, å³åˆ›å»ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»
d. __enable_mmu            : ä½¿èƒ½MMU, ä»¥åå°±è¦ä½¿ç”¨è™šæ‹Ÿåœ°å€äº†
e. __mmap_switched         : ä¸Šè¿°å‡½æ•°é‡Œå°†ä¼šè°ƒç”¨__mmap_switched
f. å‚æ•°ä¿å­˜                 : æŠŠbootloaderä¼ å…¥çš„r2å‚æ•°, ä¿å­˜åˆ°å˜é‡__atags_pointerä¸­
g. è°ƒç”¨Cå‡½æ•°start_kernel   : è·³è½¬åˆ°Cè¯­è¨€ç¯å¢ƒ
```

**å…³é”®çš„å‚æ•°ä¼ é€’**ï¼šä½¿ç”¨çš„æ˜¯æ±‡ç¼–æŒ‡ä»¤
```c
// head.S/head-common.Sä¸­çš„å¤„ç†ï¼š
__machine_arch_type = r1;  // æŠŠbootloaderä¼ æ¥çš„r1å€¼èµ‹ç»™å˜é‡machine_arch_type
__atags_pointer = r2;      // æŠŠbootloaderä¼ æ¥çš„r2å€¼èµ‹ç»™å˜é‡atags_pointer(å³dtbé¦–åœ°å€)
```

## 3 å¹³å°ä¿¡æ¯çš„å¤„ç†(é€‰æ‹©machine_desc)

### 3.1 åŒ¹é…æœºåˆ¶è¯¦è§£

`å†…æ ¸æºç /Documentation/devicetree/usage-model.txt`
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/913e8bad518ef6ce0405619687c53854.png)


**è®¾å¤‡æ ‘ä¾§**ï¼š
- è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹çš„**compatibleå±æ€§**åˆ—å‡ºäº†ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²
- è¡¨ç¤ºå®ƒå…¼å®¹çš„å•æ¿åï¼Œä»"æœ€å…¼å®¹"åˆ°æ¬¡ä¹‹

**å†…æ ¸ä¾§**ï¼š
- å†…æ ¸ä¸­æœ‰å¤šä¸ª**machine_desc**ç»“æ„ä½“
- å…¶ä¸­æœ‰**dt_compatæˆå‘˜**ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œé‡Œé¢è¡¨ç¤ºè¯¥machine_descæ”¯æŒå“ªäº›å•æ¿

**åŒ¹é…ç®—æ³•**ï¼š
- ä½¿ç”¨compatibleå±æ€§çš„å€¼ï¼Œè·Ÿæ¯ä¸€ä¸ªmachine_desc.dt_compatæ¯”è¾ƒ
- æˆç»©ä¸º"å»åˆçš„compatibleå±æ€§å€¼çš„ä½ç½®"
- **æˆç»©è¶Šä½è¶ŠåŒ¹é…**ï¼Œå¯¹åº”çš„machine_descå³è¢«é€‰ä¸­

### 3.2 è¯¦ç»†çš„åŒ¹é…è¿‡ç¨‹

**åŒ¹é…è¿‡ç¨‹**ï¼š
1. è®¾å¤‡æ ‘ **æ ¹èŠ‚ç‚¹çš„compatibleå±æ€§** åˆ—å‡ºå…¼å®¹çš„å•æ¿åï¼ˆä»æœ€å…¼å®¹åˆ°æ¬¡ä¹‹ï¼‰ï¼Œå¦‚ä¸‹å›¾çš„smdk2440 -> smdk2410 -> smdk24xx
   ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/a972db3b41a2dc5987c9742797f4b520.png)
2. å†…æ ¸ä¸­æ¯ä¸ª `machine_desc` éƒ½æœ‰ `dt_compat` æˆå‘˜ï¼ŒæŒ‡å‘æ”¯æŒçš„å•æ¿å­—ç¬¦ä¸²æ•°ç»„
   ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/807c5f2c8af3bd3d4e0e1890631f5708.png)
3. ç”¨compatibleå±æ€§å€¼ä¸æ¯ä¸ª `mechine_desc.de_compat` æ¯”è¾ƒ
4. **æˆç»©è¶Šä½ä½åŒ¹é…** ï¼ˆæˆç»© = å»åˆçš„compatibleå±æ€§å€¼çš„ä½ç½®ï¼‰
	- dtsä¸­çš„compatibleå¤šä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œç¬¬ä¸€ä¸ªæ¯”è¾ƒæˆåŠŸåˆ™æˆç»©ä¸º1ï¼Œç¬¬äºŒä¸ªæ¯”è¾ƒæˆåŠŸåˆ™æˆç»©ä¸º2

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/a3c0e1cb6a6dc4799fe4cd8fe3b3905f.png)


**å‡½æ•°è°ƒç”¨æµç¨‹**
```c
start_kernel                                          // init/main.c
 â””â”€â”€ setup_arch(&command_line);                      // arch/arm/kernel/setup.c
     â””â”€â”€ mdesc = setup_machine_fdt(__atags_pointer); // arch/arm/kernel/devtree.c
         â”œâ”€â”€ early_init_dt_verify(phys_to_virt(dt_phys))  // åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆçš„dtb, drivers/of/ftd.c
         â”‚   â””â”€â”€ initial_boot_params = params;            // è®¾ç½®å…¨å±€DTBæŒ‡é’ˆ
         â””â”€â”€ mdesc = of_flat_dt_match_machine(mdesc_best, arch_get_next_mach);  // æ‰¾åˆ°æœ€åŒ¹é…çš„machine_desc, drivers/of/ftd.c
             â””â”€â”€ while ((data = get_next_compat(&compat))) {
                     score = of_flat_dt_match(dt_root, compat);
                     if (score > 0 && score < best_score) {
                         best_data = data;
                         best_score = score;
                     }
                 }
```
1. `start_kernel`ï¼šå†…æ ¸å¯åŠ¨çš„å…¥å£å‡½æ•°ï¼Œè´Ÿè´£åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿå’Œç¡¬ä»¶å¹³å°
2.  `setup_arch`ï¼šæ¶æ„ç›¸å…³çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè´Ÿè´£è®¾ç½®ARMæ¶æ„ç‰¹å®šçš„ç¡¬ä»¶å’Œå†…å­˜é…ç½®
	- `set_machine_fdt`ï¼šé€šè¿‡è®¾å¤‡æ ‘æ¥è¯†åˆ«å’Œè®¾ç½®æœºå™¨å¹³å°ä¿¡æ¯
		- `early_init_dt_verify`ï¼šéªŒè¯DTBçš„æœ‰æ•ˆæ€§ï¼Œå¹¶è®¾ç½®å…¨å±€DTBæŒ‡é’ˆ
		- `of_flat_dt_match_machine`ï¼šéå†æ‰€æœ‰æ³¨å†Œçš„`machine_desc`ï¼Œé€šè¿‡åŒ¹é…è®¾å¤‡æ ‘ä¸­çš„`compatible`å±æ€§æ‰¾åˆ°æœ€é€‚åˆå½“å‰ç¡¬ä»¶å¹³å°çš„æœºå™¨æè¿°ç¬¦
			- `get_next_compat`/`of_flat_dt_match`ï¼šå¾ªç¯è·å–æ¯ä¸ªmachine_descçš„compatibleå­—ç¬¦ä¸²ï¼Œä¸è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹è¿›è¡ŒåŒ¹é…æ‰“åˆ†ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„ä½œä¸ºå½“å‰å¹³å°çš„æœºå™¨æè¿°ç¬¦

**æœ€ç»ˆç»“æœ**
```c
machine_desc = mdesc;  // å°†é€‰ä¸­çš„machine_descä¿å­˜åˆ°å…¨å±€å˜é‡
```

## 4 è¿è¡Œæ—¶é…ç½®ä¿¡æ¯çš„å¤„ç†

è¿™ä¸€æ­¥ä¸»è¦æå–è®¾å¤‡æ ‘ä¸­çš„ **ç³»ç»Ÿé…ç½®ä¿¡æ¯**

### 4.1 å‡½æ•°è°ƒç”¨è¿‡ç¨‹

```c
start_kernel                                    // init/main.c
 â””â”€â”€ setup_arch(&command_line);                // arch/arm/kernel/setup.c
     â””â”€â”€ mdesc = setup_machine_fdt(__atags_pointer);  // arch/arm/kernel/devtree.c
         â””â”€â”€ early_init_dt_scan_nodes();       // drivers/of/ftd.c
             â”œâ”€â”€ /* Retrieve various information from the /chosen node */
             â”‚   of_scan_flat_dt(early_init_dt_scan_chosen, boot_command_line);
             â”œâ”€â”€ /* Initialize {size,address}-cells info */
             â”‚   of_scan_flat_dt(early_init_dt_scan_root, NULL);
             â””â”€â”€ /* Setup memory, calling early_init_dt_add_memory_arch */
                 of_scan_flat_dt(early_init_dt_scan_memory, NULL);
```
- `early_init_dt_scan_nodes`ï¼šæ‰«æè®¾å¤‡æ ‘ä¸­çš„å…³é”®èŠ‚ç‚¹ï¼Œæå–ç³»ç»Ÿå¯åŠ¨æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯
	- `early_init_dt_scan_chosen`ï¼š**æ‰«æ/chosenèŠ‚ç‚¹**ï¼Œè·å–bootloaderä¼ é€’çš„å¯åŠ¨å‚æ•°(bootargs)ç­‰ä¿¡æ¯
	- `early_init_dt_scan_root`ï¼š**æ‰«ææ ¹èŠ‚ç‚¹**ï¼Œåˆå§‹åŒ–#address-cellså’Œ#size-cellså±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰äº†å­èŠ‚ç‚¹åœ°å€å’Œå¤§å°çš„è¡¨ç¤ºæ–¹å¼
	- `early_init_dt_scan_memory`ï¼š**æ‰«æ/memoryèŠ‚ç‚¹**ï¼Œè§£æç³»ç»Ÿç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Œå¹¶é€šè¿‡early_init_dt_add_memory_archå‡½æ•°å°†å†…å­˜ä¿¡æ¯æ³¨å†Œåˆ°å†…æ ¸

åœ¨ä¸Šä¸€èŠ‚çš„`setup_machine_fdt()`å‡½æ•°æœ€åä¼šè°ƒç”¨`early_init_dt_scan_nodes()`å‡½æ•°
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/90d50a06f6dc0e885fdb288d509177d5.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/66646b2b8ba9ec02d6b155066504c485.png)


### 4.2 å…·ä½“å¤„ç†çš„ä¿¡æ¯

**a. /chosenèŠ‚ç‚¹å¤„ç†**ï¼š
- æå–chosenèŠ‚ç‚¹ä¸­**bootargså±æ€§çš„å€¼**
- å­˜å…¥å…¨å±€å˜é‡ï¼š**boot_command_line**
- è¿™ä¸ªå˜é‡åŒ…å«äº†å†…æ ¸å¯åŠ¨å‘½ä»¤è¡Œå‚æ•°

**b. æ ¹èŠ‚ç‚¹å±æ€§å¤„ç†**ï¼š
- ç¡®å®šæ ¹èŠ‚ç‚¹çš„è¿™2ä¸ªå±æ€§çš„å€¼ï¼š**`#address-cells`, `#size-cells`**
- å­˜å…¥å…¨å±€å˜é‡ï¼š**dt_root_addr_cells, dt_root_size_cells**
- è¿™äº›å€¼å†³å®šäº†åœ°å€å’Œå¤§å°å­—æ®µçš„é•¿åº¦

**c. /memoryèŠ‚ç‚¹å¤„ç†**ï¼š
- è§£æ/memoryä¸­çš„**regå±æ€§**ï¼Œæå–å‡º"base, size"ä¿¡æ¯
- æœ€ç»ˆè°ƒç”¨**memblock_add(base, size)**
- å°†å†…å­˜åŒºåŸŸæ·»åŠ åˆ°å†…æ ¸çš„å†…å­˜ç®¡ç†ç³»ç»Ÿä¸­

## 5 dtbè½¬æ¢ä¸ºdevice_node(unflatten)

### 5.1 è½¬æ¢çš„ç›®æ ‡å’Œæ„ä¹‰

**è½¬æ¢å‰**ï¼šDTBæ˜¯æ‰å¹³çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸ä¾¿äºæ“ä½œ 
**è½¬æ¢å**ï¼šå½¢æˆæ ‘å½¢çš„device_nodeç»“æ„ï¼Œä¾¿äºå†…æ ¸éå†å’Œæ“ä½œ

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/f6859f082aef0a4032dc6f1a6c681bb7.png)

**å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹**
```c
start_kernel                               // init/main.c
 â””â”€â”€ setup_arch(&command_line);           // arch/arm/kernel/setup.c
     â”œâ”€â”€ arm_memblock_init(mdesc);         // arch/arm/kernel/setup.c
     â”‚   â”œâ”€â”€ early_init_fdt_reserve_self();
     â”‚   â”‚   â””â”€â”€ /* Reserve the dtb region */
     â”‚   â”‚       // æŠŠDTBæ‰€å åŒºåŸŸä¿ç•™ä¸‹æ¥, å³è°ƒç”¨: memblock_reserve
     â”‚   â”‚       early_init_dt_reserve_memory_arch(__pa(initial_boot_params),
     â”‚   â”‚                     fdt_totalsize(initial_boot_params), 0);
     â”‚   â””â”€â”€ early_init_fdt_scan_reserved_mem();  // æ ¹æ®dtbä¸­çš„memreserveä¿¡æ¯, è°ƒç”¨memblock_reserve, å‘Šè¯‰å†…æ ¸è¿™å—å†…å­˜ä¸è¦åŠ¨ï¼
     â”‚   ----------------------ä¸‹é¢æ˜¯åˆ†æçš„é‡ç‚¹--------------------------------
     â””â”€â”€ unflatten_device_tree();          // arch/arm/kernel/setup.c
         â””â”€â”€ __unflatten_device_tree(initial_boot_params, NULL, &of_root,
                    early_init_dt_alloc_memory_arch, false);  // drivers/of/fdt.c
             â”œâ”€â”€ /* First pass, scan for size */
             â”‚   size = unflatten_dt_nodes(blob, NULL, dad, NULL);
             â”œâ”€â”€ /* Allocate memory for the expanded device tree */
             â”‚   mem = dt_alloc(size + 4, __alignof__(struct device_node));  
             â””â”€â”€ /* Second pass, do actual unflattening */
                 unflatten_dt_nodes(blob, mem, dad, mynodes);
                 â””â”€â”€ populate_node
                     â”œâ”€â”€ np = unflatten_dt_alloc(mem, sizeof(struct device_node) + allocl,
                     â”‚           __alignof__(struct device_node));
                     â”œâ”€â”€ np->full_name = fn = ((char *)np) + sizeof(*np);
                     â””â”€â”€ populate_properties
                         â””â”€â”€ pp = unflatten_dt_alloc(mem, sizeof(struct property),
                                     __alignof__(struct property));
                             â”œâ”€â”€ pp->name   = (char *)pname;
                             â”œâ”€â”€ pp->length = sz;
                             â””â”€â”€ pp->value  = (__be32 *)val;
```
1. `arm_memblock_init`ï¼šåˆå§‹åŒ–å†…å­˜å—ç®¡ç†ç³»ç»Ÿï¼Œè®¾ç½®å†…å­˜ä¿ç•™åŒºåŸŸ
	- `early_init_fdt_reserve_self`ï¼šä¿ç•™DTBè‡ªèº«å ç”¨çš„å†…å­˜åŒºåŸŸï¼Œé˜²æ­¢è¢«å†…æ ¸è¦†ç›–
	- `early_init_fdt_scan_reserved_mem`ï¼šæ‰«æè®¾å¤‡æ ‘ä¸­çš„memreserveèŠ‚ç‚¹ï¼Œå°†è¿™äº›é¢„ç•™å†…å­˜åŒºåŸŸé€šè¿‡memblock_reserveæ ‡è®°ä¸ºä¸å¯ç”¨
2. `unflatten_device_tree`ï¼šå°†æ‰å¹³åŒ–çš„è®¾å¤‡æ ‘(FDT)è½¬æ¢ä¸ºå†…æ ¸ä½¿ç”¨çš„è®¾å¤‡æ ‘ç»“æ„ä½“(device_node)
	- `__unflatten_device_tree`ï¼šæ‰§è¡Œå®é™…çš„è®¾å¤‡æ ‘å±•å¼€å·¥ä½œ
		- ç¬¬ä¸€éæ‰«æ(`unflatten_dt_nodes`)ï¼šéå†æ•´ä¸ªFDTï¼Œè®¡ç®—å±•å¼€åéœ€è¦çš„å†…å­˜å¤§å°
		- `dt_alloc`ï¼šæ ¹æ®è®¡ç®—å‡ºçš„å¤§å°åˆ†é…å†…å­˜ç©ºé—´
		- ç¬¬äºŒéæ‰«æ(unflatten_dt_nodes)ï¼šå°†FDTæ•°æ®å¡«å……åˆ°åˆ†é…çš„å†…å­˜ä¸­ï¼Œæ„å»ºdevice_nodeæ ‘å½¢ç»“æ„
			- `populate_node`ï¼šä¸ºæ¯ä¸ªè®¾å¤‡èŠ‚ç‚¹åˆ†é…device_nodeç»“æ„ä½“ï¼Œè®¾ç½®èŠ‚ç‚¹åç§°ç­‰åŸºæœ¬ä¿¡æ¯
				- `populate_properties`ï¼šä¸ºèŠ‚ç‚¹çš„æ¯ä¸ªå±æ€§åˆ†é…propertyç»“æ„ä½“ï¼ŒåŒ…æ‹¬å±æ€§åã€é•¿åº¦å’Œå€¼çš„æŒ‡é’ˆè®¾ç½®


> [!tip]+ æç¤º
> å³ä½¿æ²¡æœ‰åœ¨dtsä¸­æŒ‡å®šéœ€è¦ä¿å­˜çš„å†…å­˜ç©ºé—´ï¼Œå†…æ ¸ä¹Ÿä¼šç»™DTBç•™ä¸€å—å†…å­˜

### 5.2 é‡è¦æ•°æ®ç»“æ„ä½“

**1ã€device_nodeç»“æ„ä½“**ï¼ˆä»£è¡¨ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹ï¼‰
```c
struct device_node {
    const char *name;        // æ¥è‡ªèŠ‚ç‚¹ä¸­çš„nameå±æ€§, å¦‚æœæ²¡æœ‰è¯¥å±æ€§, åˆ™è®¾ä¸º"NULL"
    const char *type;        // æ¥è‡ªèŠ‚ç‚¹ä¸­çš„device_typeå±æ€§, å¦‚æœæ²¡æœ‰è¯¥å±æ€§, åˆ™è®¾ä¸º"NULL"
    phandle phandle;
    const char *full_name;   // èŠ‚ç‚¹çš„åå­—, node-name[@unit-address]
    struct fwnode_handle fwnode;

    struct property *properties;   // èŠ‚ç‚¹çš„å±æ€§
    struct property *deadprops;    /* removed properties */
    struct device_node *parent;    // èŠ‚ç‚¹çš„çˆ¶äº²
    struct device_node *child;     // èŠ‚ç‚¹çš„å­©å­(å­èŠ‚ç‚¹)
    struct device_node *sibling;   // èŠ‚ç‚¹çš„å…„å¼Ÿ(åŒçº§èŠ‚ç‚¹)
#if defined(CONFIG_OF_KOBJ)
    struct kobject kobj;
#endif
    unsigned long _flags;
    void *data;
#if defined(CONFIG_SPARC)
    const char *path_component_name;
    unsigned int unique_id;
    struct of_irq_controller *irq_trans;
#endif
};
```

**2ã€propertyç»“æ„ä½“**ï¼ˆä»£è¡¨ä¸€ä¸ªå±æ€§ï¼‰
```c
struct property {
    char *name;      // å±æ€§åå­—, æŒ‡å‘dtbæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²ï¼ˆstring blockï¼‰
    int length;      // å±æ€§å€¼çš„é•¿åº¦
    void *value;     // å±æ€§å€¼, æŒ‡å‘dtbæ–‡ä»¶ä¸­valueæ‰€åœ¨ä½ç½®, æ•°æ®ä»ä»¥big endianå­˜å‚¨
    struct property *next;
#if defined(CONFIG_OF_DYNAMIC) || defined(CONFIG_SPARC)
    unsigned long _flags;
#endif
#if defined(CONFIG_OF_PROMTREE)
    unsigned int unique_id;
#endif
#if defined(CONFIG_OF_KOBJ)
    struct bin_attribute attr;
#endif
};
```

**æœ€ç»ˆç»“æœ**ï¼šè¿™äº›device_nodeæ„æˆä¸€æ£µæ ‘ï¼Œæ ¹èŠ‚ç‚¹ä¸ºï¼š**of_root**

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/c08daa0da18efea0b02ca9f03409d034.png)
- æ³¨æ„ï¼šèŠ‚ç‚¹çš„åå­—æ˜¯åœ¨å°¾éƒ¨çš„stringä¸Šï¼Œæ‰€ä»¥åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™ï¼Œé™¤äº†åˆ†é…ç»“æ„ä½“çš„å¤§å°è¿˜ä¼šç»™å­è¿™ä¸ªstringåˆ†é…å¤§å°

## 6 device_nodeè½¬æ¢ä¸ºplatform_device

### 6.1 æ ¸å¿ƒé—®é¢˜

è½¬æ¢è¿‡ç¨‹éœ€è¦è§£å†³ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

**a. å“ªäº›device_nodeå¯ä»¥è½¬æ¢ä¸ºplatform_deviceï¼Ÿ**
- æ ¹èŠ‚ç‚¹ä¸‹å«æœ‰**compatibleå±æ€§**çš„å­èŠ‚ç‚¹
- å¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„compatibleå±æ€§å«æœ‰è¿™äº›ç‰¹æ®Šçš„å€¼(`"simple-bus"`,`"simple-mfd"`,`"isa"`,`"arm,amba-bus"`)ä¹‹ä¸€ï¼Œé‚£ä¹ˆ**å®ƒçš„å­èŠ‚ç‚¹(éœ€å«compatibleå±æ€§)** ä¹Ÿå¯ä»¥è½¬æ¢ä¸ºplatform_device
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/f15bc32ee4dbc1543030c088f4284462.png)
- **i2c, spiç­‰æ€»çº¿èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹**ï¼Œåº”è¯¥äº¤ç»™å¯¹åº”çš„æ€»çº¿é©±åŠ¨ç¨‹åºæ¥å¤„ç†ï¼Œå®ƒä»¬ä¸åº”è¯¥è¢«è½¬æ¢ä¸ºplatform_device
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/1fb58fb3d600b3f61be204907abd6e4a.png)
**b. æ€ä¹ˆè½¬æ¢ï¼Ÿ**
- platform_deviceä¸­å«æœ‰**resourceæ•°ç»„**ï¼Œå®ƒæ¥è‡ªdevice_nodeçš„**reg, interruptså±æ€§**
- **platform_device.dev.of_node**æŒ‡å‘device_nodeï¼Œå¯ä»¥é€šè¿‡å®ƒè·å¾—å…¶ä»–å±æ€§

### 6.2 è½¬æ¢è§„åˆ™

**è½¬æ¢è§„åˆ™**ï¼š**å¹¶éæ‰€æœ‰çš„device_nodeéƒ½èƒ½è½¬æ¢ä¸ºplatform_device**ï¼Œåªæœ‰æ»¡è¶³ä¸€ä¸‹æ¡ä»¶æ‰èƒ½è½¬æ¢
1. åŸºæœ¬æ¡ä»¶ï¼šèŠ‚ç‚¹ **å¿…é¡»åŒ…å«compatibleå±æ€§**
2. ä½ç½®æ¡ä»¶ï¼šæ»¡è¶³å…¶ä¸€å³å¯
	- æ ¹èŠ‚ç‚¹çš„ç›´æ¥å­èŠ‚ç‚¹
	- ç‰¹æ®Šçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼šçˆ¶èŠ‚ç‚¹çš„compatibleåŒ…å«ä»¥ä¸‹å€¼ä¹‹ä¸€
		- `"simple-bus"`
		- `"simple-mfd"`
		- `"isa"`
		- `"arm,amba-bus"`
3. **æ€»çº¿èŠ‚ç‚¹çš„ç‰¹æ®Šå¤„ç†**
	- **I2C/SPIæ§åˆ¶å™¨èŠ‚ç‚¹**ï¼šè½¬æ¢ä¸ºplatform_device
	- **I2C/SPIè®¾å¤‡èŠ‚ç‚¹**ï¼šä¸è½¬æ¢ä¸ºplatform_deviceï¼Œç”±å¯¹åº”æ€»çº¿é©±åŠ¨å¤„ç†

### 6.3 ç¤ºä¾‹è¯´æ˜

**ç¤ºä¾‹è¯´æ˜**ï¼š
```dts fold
/ {
	mytest {
		compatible = "mytest","simple-bus"; //ä¼šè½¬æ¢ä¸ºplatform_device
		mytest@0 {
			compatible = "mytest-0";        //ä¼šè½¬æ¢ï¼ˆçˆ¶èŠ‚ç‚¹æ˜¯simple-busï¼‰
		};
	};

	i2c {
		compatible = "samsung,i2c";          //ä¼šè½¬æ¢ï¼ˆI2Cæ§åˆ¶å™¨ï¼‰
		at24c02 {
			compatible = "at24c02";          //ä¸æ¢è½¬æ¢ï¼ˆç”±I2Cé©±åŠ¨å¤„ç†ï¼‰
		};
	};

	spi {
        compatible = "samsung,spi";           // ä¼šè½¬æ¢ï¼ˆSPIæ§åˆ¶å™¨ï¼‰
        flash@0 {
            compatible = "winbond,w25q32dw";  // ä¸ä¼šè½¬æ¢ï¼ˆç”±SPIé©±åŠ¨å¤„ç†ï¼‰
        };
    };
};
```
- `/mytest`ä¼šè¢«è½¬æ¢ä¸ºplatform_deviceï¼Œå› ä¸ºå®ƒå…¼å®¹"simple-bus"ï¼Œå®ƒçš„å­èŠ‚ç‚¹`/mytest/mytest@0`ä¹Ÿä¼šè¢«è½¬æ¢ä¸ºplatform_device
- `/i2c`èŠ‚ç‚¹ä¸€èˆ¬è¡¨ç¤ºi2cæ§åˆ¶å™¨ï¼Œå®ƒä¼šè¢«è½¬æ¢ä¸ºplatform_deviceï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¯¹åº”çš„platform_driver
- `/i2c/at24c02`èŠ‚ç‚¹ä¸ä¼šè¢«è½¬æ¢ä¸ºplatform_deviceï¼Œå®ƒè¢«å¦‚ä½•å¤„ç†å®Œå…¨ç”±çˆ¶èŠ‚ç‚¹çš„platform_driverå†³å®šï¼Œä¸€èˆ¬æ˜¯è¢«åˆ›å»ºä¸ºä¸€ä¸ª**i2c_client**
- ç±»ä¼¼åœ°ï¼Œ`/spi/flash@0`èŠ‚ç‚¹ä¸ä¼šè¢«è½¬æ¢ä¸ºplatform_deviceï¼Œä¸€èˆ¬æ˜¯è¢«åˆ›å»ºä¸ºä¸€ä¸ª**spi_device**

### 6.4 å›é¡¾platform_deviceå’Œdeviceç»“æ„ä½“

è¯¦ç»†å‚è€ƒï¼š[2 å¹³å°è®¾å¤‡](../../../03-ğŸ“Š%20å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¨¡å‹/1_å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¨¡å‹åŸºç¡€(Lubancat)/1_Linuxé©±åŠ¨åŸºç¡€çŸ¥è¯†(é‡ç‚¹)/7_å¹³å°è®¾å¤‡é©±åŠ¨.md#2%20å¹³å°è®¾å¤‡)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/8a2ce949903d7d470f99eb73ffa733b0.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/534185ef81ca5dfa62a0f763698190a2.png)

### 6.5 å‡½æ•°è°ƒç”¨è¿‡ç¨‹

**1ã€of_platform_default_populate_initè¢«è°ƒç”¨çš„è¿‡ç¨‹**ï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/cc8f7bb846d11fabe887f02e41e46e17.png)
- ä¹Ÿå°±æ˜¯åœ¨æœ€åçš„æ®µå±æ€§ï¼ˆsectionï¼‰çš„åå­—ä¸º
	- `initcall3s.init = of_platform_default_populate_init`

```c
start_kernel                          // init/main.c
 â””â”€â”€ rest_init();
     â””â”€â”€ pid = kernel_thread(kernel_init, NULL, CLONE_FS);
         â””â”€â”€ kernel_init
             â””â”€â”€ kernel_init_freeable();
                 â””â”€â”€ do_basic_setup();
                     â””â”€â”€ do_initcalls();
                         â””â”€â”€ for (level = 0; level < ARRAY_SIZE(initcall_levels) - 1; level++)
                             â””â”€â”€ do_initcall_level(level);  // æ¯”å¦‚ do_initcall_level(3)
                                 â””â”€â”€ for (fn = initcall_levels[3]; fn < initcall_levels[3+1]; fn++)
                                     â””â”€â”€ do_one_initcall(initcall_from_entry(fn));  
                                         // å°±æ˜¯è°ƒç”¨"arch_initcall_sync(fn)"ä¸­å®šä¹‰çš„fnå‡½æ•°
```
- `rest_init`ï¼šå®Œæˆå‰©ä½™çš„åˆå§‹åŒ–å·¥ä½œï¼Œåˆ›å»ºinitè¿›ç¨‹å’Œkthreaddå†…æ ¸è¿›ç¨‹
	- `kernel_thread`ï¼šåˆ›å»º1å·è¿›ç¨‹ï¼ˆinitè¿›ç¨‹ï¼‰ï¼Œè¿™æ˜¯ç³»ç»Ÿä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹
		- `kernel_init`ï¼šinitè¿›ç¨‹çš„ä¸»å‡½æ•°ï¼Œè´Ÿè´£å®Œæˆå†…æ ¸åˆå§‹åŒ–çš„æœ€åé˜¶æ®µ
			- `kernel_init_freeable`ï¼šæ‰§è¡Œå¯ä»¥åœ¨åˆå§‹åŒ–åé‡Šæ”¾çš„åˆå§‹åŒ–ä»£ç 
				- `do_basic_setup`ï¼šæ‰§è¡ŒåŸºæœ¬çš„é©±åŠ¨å’Œå­ç³»ç»Ÿåˆå§‹åŒ–
					- `do_initcalls`ï¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºè°ƒç”¨æ‰€æœ‰çš„åˆå§‹åŒ–å‡½æ•°
						- éå†æ‰€æœ‰åˆå§‹åŒ–çº§åˆ«ï¼ˆ0åˆ°7ï¼‰ï¼šä»earlyåˆ°ateä¾æ¬¡æ‰§è¡Œ
						- `do_initcall_level`ï¼šæ‰§è¡Œç‰¹å®šçº§åˆ«çš„æ‰€æœ‰åˆå§‹åŒ–å‡½æ•°
							- éå†è¯¥çº§åˆ«çš„å‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼šæ¯ä¸ªçº§åˆ«åŒ…å«å¤šä¸ªåˆå§‹åŒ–å‡½æ•°
							- `do_one_initcall`ï¼šè°ƒç”¨å…·ä½“çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™äº›å‡½æ•°é€šè¿‡xxx_initcall(fn)å®æ³¨å†Œ

åˆå§‹åŒ–çº§åˆ«åŒ…æ‹¬ï¼š
- pure_initcall (çº§åˆ«0)
- core_initcall (çº§åˆ«1)
- postcore_initcall (çº§åˆ«2)
- arch_initcall (çº§åˆ«3)
- subsys_initcall (çº§åˆ«4)
- fs_initcall (çº§åˆ«5)
- device_initcall (çº§åˆ«6)
- late_initcall (çº§åˆ«7)

**2ã€of_platform_default_populate_initç”Ÿæˆplatform_deviceçš„è¿‡ç¨‹**ï¼š
```c
of_platform_default_populate_init                     // drivers/of/platform.c
 â””â”€â”€ of_platform_default_populate(NULL, NULL, NULL);
     â””â”€â”€ of_platform_populate(NULL, of_default_bus_match_table, NULL, NULL)
         â””â”€â”€ for_each_child_of_node(root, child) {
                rc = of_platform_bus_create(child, matches, lookup, parent, true);
                // æ ¹æ®device_nodeèŠ‚ç‚¹çš„å±æ€§è®¾ç½®platform_deviceçš„resource
                â””â”€â”€ dev = of_device_alloc(np, bus_id, parent);   
                if (rc) {
                    of_node_put(child);
                    break;
                }
            }
```
1. `of_platform_default_pipulate_init`ï¼šè®¾å¤‡æ ‘å¹³å°è®¾å¤‡åˆå§‹åŒ–å‡½æ•°ï¼Œé€šè¿‡arch_initcallæ³¨å†Œï¼Œåœ¨å†…æ ¸åˆå§‹åŒ–é˜¶æ®µè‡ªåŠ¨è°ƒç”¨
2. `of_platform_default_populate`ï¼šä½¿ç”¨é»˜è®¤å‚æ•°å¡«å……å¹³å°è®¾å¤‡ï¼Œå°†è®¾å¤‡æ ‘èŠ‚ç‚¹è½¬æ¢ä¸ºplatform_device
	- `of_platform_populate`ï¼š**éå†è®¾å¤‡æ ‘åˆ›å»ºå¹³å°è®¾å¤‡çš„æ ¸å¿ƒå‡½æ•°**
		- å‚æ•°è¯´æ˜ï¼š
			- rootä¸ºNULLè¡¨ç¤ºä»è®¾å¤‡æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹
			- `of_default_bus_match_table`åŒ…å«éœ€è¦åˆ›å»ºå¹³å°è®¾å¤‡çš„æ€»çº¿ç±»å‹ï¼ˆå¦‚"simple-bus"ã€"simple-mfd"ç­‰ï¼‰
			  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/8d994ae7d56958c1d6b12627b6811d32.png)
			- lookupå’Œparentä¸ºNULLä½¿ç”¨é»˜è®¤å€¼
		- `for_each_child_of_node`ï¼šéå†æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
			- `of_platform_bus_create`ï¼šä¸ºåŒ¹é…çš„è®¾å¤‡èŠ‚ç‚¹åˆ›å»ºplatform_deviceï¼ˆå‚è€ƒä¸‹é¢ï¼‰
				- æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åŒ¹é…of_default_bus_match_tableä¸­çš„æ€»çº¿ç±»å‹
				- of_device_allocï¼šåˆ†é…å¹¶åˆå§‹åŒ–platform_deviceç»“æ„ä½“
					- è§£æè®¾å¤‡æ ‘èŠ‚ç‚¹çš„regã€interruptsç­‰å±æ€§
					- å°†è¿™äº›å±æ€§è½¬æ¢ä¸ºresourceèµ„æºï¼ˆå†…å­˜ã€ä¸­æ–­ç­‰ï¼‰
					- è®¾ç½®è®¾å¤‡åç§°ã€IDç­‰åŸºæœ¬ä¿¡æ¯
				- é€’å½’å¤„ç†å­èŠ‚ç‚¹ï¼Œä¸ºå¤šçº§æ€»çº¿åˆ›å»ºè®¾å¤‡
				- å°†åˆ›å»ºçš„platform_deviceæ³¨å†Œåˆ°ç³»ç»Ÿä¸­


**3ã€of_platform_bus_createå¤„ç†è¿‡ç¨‹**ï¼ˆå¤„ç†busèŠ‚ç‚¹ç”Ÿæˆplatform_deviceï¼Œå¹¶å†³å®šæ˜¯å¦å¤„ç†å®ƒçš„å­èŠ‚ç‚¹ï¼‰ï¼š
```c
of_platform_bus_create(bus, matches, ...)
â”œâ”€â”€ dev = of_platform_device_create_pdata(bus, bus_id, platform_data, parent);  
â”‚   // ç”ŸæˆbusèŠ‚ç‚¹çš„platform_deviceç»“æ„ä½“
â”œâ”€â”€ if (!dev || !of_match_node(matches, bus))  
â”‚   return 0;  // å¦‚æœbusèŠ‚ç‚¹çš„compatibleå±æ€§ä¸å»åˆmatchesè¡¨, å°±ä¸å¤„ç†å®ƒçš„å­èŠ‚ç‚¹
â””â”€â”€ for_each_child_of_node(bus, child) {    // å–å‡ºæ¯ä¸€ä¸ªå­èŠ‚ç‚¹
        pr_debug("   create child: %pOF\n", child);
        rc = of_platform_bus_create(child, matches, lookup, &dev->dev, strict);   
        // é€’å½’å¤„ç†å­èŠ‚ç‚¹
        if (rc) {
            of_node_put(child);
            break;
        }
    }
```
1. `of_platform_bus_create`ï¼šé€’å½’åˆ›å»ºè®¾å¤‡æ ‘èŠ‚ç‚¹å¯¹åº”çš„platform_deviceï¼Œå¤„ç†æ€»çº¿èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
2. `of_platform_device_create_pdata`ï¼šä¸ºå½“å‰busèŠ‚ç‚¹åˆ›å»ºplatform_deviceç»“æ„ä½“
	- åˆ†é…platform_deviceå†…å­˜ç©ºé—´
	- è§£æè®¾å¤‡æ ‘èŠ‚ç‚¹çš„èµ„æºä¿¡æ¯ï¼ˆregã€interruptsç­‰ï¼‰
	- è®¾ç½®è®¾å¤‡çš„åç§°ã€IDã€çˆ¶è®¾å¤‡ç­‰å±æ€§
	- å¦‚æœæä¾›äº†platform_dataï¼Œå°†å…¶å…³è”åˆ°è®¾å¤‡
	- æ³¨å†Œplatform_deviceåˆ°ç³»ç»Ÿè®¾å¤‡æ¨¡å‹ä¸­
3. æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­å¤„ç†å­èŠ‚ç‚¹
	- å¦‚æœè®¾å¤‡åˆ›å»ºå¤±è´¥ï¼ˆ!devï¼‰ï¼Œç›´æ¥è¿”å›
	- `of_match_node`ï¼šæ£€æŸ¥busèŠ‚ç‚¹çš„compatibleå±æ€§æ˜¯å¦åŒ¹é…matchesè¡¨
		- matcheré€šå¸¸æ˜¯of_default_bus_match_tableï¼ŒåŒ…å«"simple-bus"ã€"simple-mfd"ç­‰
		- åªæœ‰åŒ¹é…çš„æ€»çº¿ç±»å‹æ‰ä¼šç»§ç»­å¤„ç†å…¶å­èŠ‚ç‚¹
		- è¿™ç¡®ä¿äº†åªæœ‰çœŸæ­£çš„æ€»çº¿èŠ‚ç‚¹æ‰ä¼šé€’å½’åˆ›å»ºå­è®¾å¤‡
4. `for_each_child_of_node`ï¼šéå†å½“å‰busèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
	- `pr_debug`ï¼šæ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ­£åœ¨åˆ›å»ºçš„å­èŠ‚ç‚¹
	- `of_platform_bus_create`ï¼š**é€’å½’è°ƒç”¨è‡ªèº«å¤„ç†å­èŠ‚ç‚¹**
		- childï¼šå½“å‰å¤„ç†çš„å­èŠ‚ç‚¹
		- matchesï¼šç»§ç»­ä½¿ç”¨ç›¸åŒçš„åŒ¹é…è¡¨
		- &dev->devï¼šå°†æ–°åˆ›å»ºçš„è®¾å¤‡ä½œä¸ºå­èŠ‚ç‚¹çš„çˆ¶è®¾å¤‡
		- strictï¼šä¸¥æ ¼æ¨¡å¼æ ‡å¿—
	- é”™è¯¯å¤„ç†ï¼šå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œé‡Šæ”¾èŠ‚ç‚¹å¼•ç”¨å¹¶é€€å‡ºå¾ªç¯

### 6.6 æ€»çº¿è®¾å¤‡çš„ç‰¹æ®Šå¤„ç†

**1ã€I2Cæ€»çº¿èŠ‚ç‚¹çš„å¤„ç†è¿‡ç¨‹**ï¼š
```c
// /i2cèŠ‚ç‚¹è¢«è½¬æ¢ä¸ºplatform_deviceï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¯¹åº”çš„platform_driver
// platform_driverçš„probeå‡½æ•°ä¸­ä¼šè°ƒç”¨i2c_add_numbered_adapter:

i2c_add_numbered_adapter                    // drivers/i2c/i2c-core-base.c
 â””â”€â”€ __i2c_add_numbered_adapter
     â””â”€â”€ i2c_register_adapter
         â””â”€â”€ of_i2c_register_devices(adap);  // drivers/i2c/i2c-core-of.c
             â””â”€â”€ for_each_available_child_of_node(bus, node) {
                    client = of_i2c_register_device(adap, node);
                    â””â”€â”€ client = i2c_new_device(adap, &info);   
                        // è®¾å¤‡æ ‘ä¸­çš„i2cå­èŠ‚ç‚¹è¢«è½¬æ¢ä¸ºi2c_client
                }
```
1. I2Cæ§åˆ¶å™¨è®¾å¤‡æ ‘èŠ‚ç‚¹è½¬æ¢æµç¨‹
	- i2cæ§åˆ¶å™¨èŠ‚ç‚¹é¦–å…ˆè¢«è½¬æ¢æˆplatform_deviceï¼ˆé€šè¿‡å‰é¢çš„of_platform_populateæœºåˆ¶ï¼‰
	- å†…æ ¸ä¸­æœ‰å¯¹åº”çš„platform_driverï¼ˆå¦‚i2c-imxã€i2c-designwareç­‰ï¼‰åŒ¹é…è¯¥è®¾å¤‡
	- platform_driverçš„probeå‡½æ•°åˆå§‹åŒ–I2Cæ§åˆ¶å™¨ç¡¬ä»¶å¹¶æ³¨å†ŒI2Cé€‚é…å™¨
2. `i2c_add_numbered_adapter`ï¼šæ³¨å†ŒæŒ‡å®šç¼–å·çš„I2Cé€‚é…å™¨
	- ç”¨äºæ³¨å†Œè®¾å¤‡æ ‘ä¸­æŒ‡å®šäº†æ€»çº¿ç¼–å·çš„I2Cæ§åˆ¶å™¨
	- è®¾å¤‡æ ‘ä¸­é€šè¿‡aliasesèŠ‚ç‚¹æŒ‡å®šI2Cæ€»çº¿ç¼–å·ï¼ˆå¦‚i2c0 = &i2c1ï¼‰
3. `__i2c_add_numbered_adapter`ï¼šI2Cé€‚é…å™¨æ³¨å†Œçš„æ ¸å¿ƒå‡½æ•°
	- åˆå§‹åŒ–é€‚é…å™¨çš„å„ç§å±æ€§å’Œé“¾è¡¨
	- åˆ›å»ºé€‚é…å™¨çš„sysfså±æ€§æ–‡ä»¶
	- `of_i2c_register_devices`ï¼šè§£æè®¾å¤‡æ ‘å¹¶åˆ›å»ºI2Cè®¾å¤‡
		- å‚æ•°adaptï¼šåˆšæ³¨å†Œçš„I2Cé€‚é…å™¨
		- `for_each_available_child_of_node`ï¼šéå†I2CèŠ‚ç‚¹ä¸‹æ‰€æœ‰å¯ç”¨çš„å­èŠ‚ç‚¹
			- è·³è¿‡status = "disabled"çš„èŠ‚ç‚¹
			- `of_i2c_register_device`ï¼šä¸ºæ¯ä¸ªI2Cè®¾å¤‡èŠ‚ç‚¹åˆ›å»ºi2c_client
				- è§£æè®¾å¤‡æ ‘å±æ€§ï¼šreg(I2Cåœ°å€)ã€compatible(è®¾å¤‡ç±»å‹)ç­‰
				- å¡«å……struct i2c_board_infoç»“æ„ä½“
				- i2c_new_deviceï¼šåˆ›å»ºå¹¶æ³¨å†Œi2c_client
					- åˆ†é…i2c_clientç»“æ„ä½“
					- è®¾ç½®è®¾å¤‡åœ°å€ã€é€‚é…å™¨ã€åç§°ç­‰
					- å°†i2c_clientæ³¨å†Œåˆ°I2Cæ€»çº¿
					- è§¦å‘I2Cè®¾å¤‡é©±åŠ¨çš„åŒ¹é…å’Œç»‘å®š

**2ã€SPIæ€»çº¿èŠ‚ç‚¹çš„å¤„ç†è¿‡ç¨‹**ï¼š
```c
// /spièŠ‚ç‚¹è¢«è½¬æ¢ä¸ºplatform_deviceï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¯¹åº”çš„platform_driver
// platform_driverçš„probeå‡½æ•°ä¸­ä¼šè°ƒç”¨spi_register_master, å³spi_register_controller:

spi_register_controller               // drivers/spi/spi.c
 â””â”€â”€ of_register_spi_devices          // drivers/spi/spi.c
     â””â”€â”€ for_each_available_child_of_node(ctlr->dev.of_node, nc) {
            spi = of_register_spi_device(ctlr, nc);  // è®¾å¤‡æ ‘ä¸­çš„spiå­èŠ‚ç‚¹è¢«è½¬æ¢ä¸ºspi_device
            â”œâ”€â”€ spi = spi_alloc_device(ctlr);
            â”œâ”€â”€ rc = of_spi_parse_dt(ctlr, spi, nc);
            â””â”€â”€ rc = spi_add_device(spi);
        }
```
1. SPIæ§åˆ¶å™¨è®¾å¤‡æ ‘èŠ‚ç‚¹è½¬æ¢æµç¨‹
	- /spièŠ‚ç‚¹é¦–å…ˆè¢«è½¬æ¢æˆplatform_deviceï¼ˆé€šè¿‡å‰é¢çš„of_platform_populateæœºåˆ¶ï¼‰
	- å†…æ ¸ä¸­æœ‰å¯¹åº”çš„platform_driverï¼ˆå¦‚spi-imxã€spi-dwç­‰ï¼‰åŒ¹é…è¯¥è®¾å¤‡
	- platform_driverçš„probeå‡½æ•°åˆå§‹åŒ–SPIæ§åˆ¶å™¨ç¡¬ä»¶å¹¶æ³¨å†ŒSPIé€‚é…å™¨
2. `spi_register_controller`ï¼ˆä¹Ÿå«spi_register_masterï¼‰ï¼šæ³¨å†ŒSPIä¸»æ§åˆ¶å™¨
	- åˆå§‹åŒ–æ§åˆ¶å™¨çš„å„ä¸ªå±æ€§ï¼ˆä¼ è¾“é˜Ÿåˆ—ã€é”ã€å·¥ä½œé˜Ÿåˆ—ç­‰ï¼‰
	- è®¾ç½®æ§åˆ¶å™¨çš„æ€»çº¿ç¼–å·
	- åˆ›å»ºæ§åˆ¶å™¨çš„sysfså±æ€§æ–‡ä»¶
	- è°ƒç”¨of_register_spi_devicesè§£æå¹¶æ³¨å†ŒSPIè®¾å¤‡
3. `of_register_spi_devices`ï¼šè§£æè®¾å¤‡æ ‘å¹¶åˆ›å»ºSPIè®¾å¤‡
	- å‚æ•°ctlrï¼šåˆšæ³¨å†Œçš„SPIæ§åˆ¶å™¨
	- for_each_available_child_of_nodeï¼šéå†SPIèŠ‚ç‚¹ä¸‹æ‰€æœ‰å¯ç”¨çš„å­èŠ‚ç‚¹
		- è·³è¿‡status = "disabled"çš„èŠ‚ç‚¹
		- æ¯ä¸ªå­èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªè¿æ¥åˆ°è¯¥SPIæ€»çº¿çš„è®¾å¤‡
4. `of_register_spi_device`ï¼šä¸ºå•ä¸ªSPIè®¾å¤‡èŠ‚ç‚¹åˆ›å»ºspi_device
	- spi_alloc_deviceï¼šåˆ†é…spi_deviceç»“æ„ä½“
		- åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–åŸºæœ¬å­—æ®µ
		- è®¾ç½®è®¾å¤‡çš„æ§åˆ¶å™¨æŒ‡é’ˆ
		- åˆå§‹åŒ–è®¾å¤‡çš„ä¼ è¾“åˆ—è¡¨
	- of_spi_parse_dtï¼šè§£æè®¾å¤‡æ ‘ä¸­çš„SPIè®¾å¤‡å±æ€§
		- regï¼šç‰‡é€‰å·ï¼ˆCSå·ï¼‰
		- spi-max-frequencyï¼šæœ€å¤§æ—¶é’Ÿé¢‘ç‡
		- spi-cpolï¼šæ—¶é’Ÿææ€§
		- spi-cphaï¼šæ—¶é’Ÿç›¸ä½
		- spi-cs-highï¼šç‰‡é€‰é«˜ç”µå¹³æœ‰æ•ˆ
		- spi-3writeï¼šä¸‰çº¿æ¨¡å¼
		- spi-lsb-firstï¼šLSBä¼˜å…ˆä¼ è¾“
		- compatibleï¼šè®¾å¤‡å…¼å®¹æ€§å­—ç¬¦ä¸²
	- spi_add_deviceï¼šå°†spi_deviceæ³¨å†Œåˆ°ç³»ç»Ÿ
		- éªŒè¯ç‰‡é€‰æ˜¯å¦æœ‰æ•ˆ
		- æ£€æŸ¥æ˜¯å¦æœ‰åœ°å€å†²çª
		- è®¾ç½®è®¾å¤‡çš„æ¨¡å¼å’Œå‚æ•°
		- å°†è®¾å¤‡æ·»åŠ åˆ°SPIæ€»çº¿
		- è§¦å‘SPIè®¾å¤‡é©±åŠ¨çš„åŒ¹é…å’Œé”å®š

## 7 platform_deviceè·Ÿplatform_driverçš„åŒ¹é…

åŒ¹é…è¿‡ç¨‹å‘ç”Ÿåœ¨**drivers/base/platform.c**ä¸­

### 7.1 æ³¨å†Œplatform_driverçš„è¿‡ç¨‹

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/099d50ced70789f416f39f66860f51f7.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/640d6955c487ffcf23fa5461eee96d36.png)

```c
platform_driver_register
 â””â”€â”€ __platform_driver_register
     â”œâ”€â”€ drv->driver.probe = platform_drv_probe;
     â””â”€â”€ driver_register
         â””â”€â”€ bus_add_driver
             â”œâ”€â”€ klist_add_tail(&priv->knode_bus, &bus->p->klist_drivers);    
             â”‚   // æŠŠ platform_driver æ”¾å…¥ platform_bus_type çš„driveré“¾è¡¨ä¸­
             â””â”€â”€ driver_attach
                 â””â”€â”€ bus_for_each_dev(drv->bus, NULL, drv, __driver_attach);  
                     // å¯¹äºplatform_bus_typeä¸‹çš„æ¯ä¸€ä¸ªè®¾å¤‡, è°ƒç”¨__driver_attach
                     â””â”€â”€ __driver_attach
                         â”œâ”€â”€ ret = driver_match_device(drv, dev);  // åˆ¤æ–­devå’Œdrvæ˜¯å¦åŒ¹é…æˆåŠŸ
                         â”‚   â””â”€â”€ return drv->bus->match ? drv->bus->match(dev, drv) : 1;  
                         â”‚       // è°ƒç”¨ platform_bus_type.match
                         â””â”€â”€ driver_probe_device(drv, dev);
                             â””â”€â”€ really_probe
                                 â””â”€â”€ drv->probe  // platform_drv_probe
                                     â””â”€â”€ platform_drv_probe
                                         â”œâ”€â”€ struct platform_driver *drv = to_platform_driver(_dev->driver);
                                         â””â”€â”€ drv->probe
```
1. `platform_driver_register`ï¼šæ³¨å†Œplatformé©±åŠ¨çš„å…¥å£å‡½æ•°
	- é©±åŠ¨å¼€å‘è€…è°ƒç”¨æ­¤å‡½æ•°æ³¨å†Œè‡ªå·±çš„platform_driver
	- é€šå¸¸åœ¨é©±åŠ¨æ¨¡å—çš„initå‡½æ•°ä¸­è°ƒç”¨
2. `__platform_driver_register`ï¼šå®é™…çš„æ³¨å†Œå®ç°
	- drv->driver.probe = platform_drv_probeï¼šè®¾ç½®é€šç”¨çš„probeå‡½æ•°
		- è¿™æ˜¯ä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨platform_driverä¸­çš„probe
	- driver_registerï¼šæ³¨å†Œåˆ°é©±åŠ¨æ¨¡å‹æ ¸å¿ƒ
		- åˆå§‹åŒ–é©±åŠ¨çš„å„ç§é“¾è¡¨å’Œå¼•ç”¨è®¡æ•°
		- åˆ›å»ºé©±åŠ¨çš„sysfsç›®å½•ï¼ˆ/sys/bus/platform/drivers/xxxï¼‰
3. bus_add_driverï¼šå°†é©±åŠ¨æ·»åŠ åˆ°æ€»çº¿
	- klist_add_tailï¼šå°†é©±åŠ¨åŠ å…¥platform_bus_typeçš„é©±åŠ¨é“¾è¡¨
		- priv->knode_busï¼šé©±åŠ¨çš„é“¾è¡¨èŠ‚ç‚¹
		- bus->p->klist_driversï¼šplatformæ€»çº¿ç»´æŠ¤çš„æ‰€æœ‰é©±åŠ¨é“¾è¡¨
	- driver_attachï¼šå°è¯•å°†é©±åŠ¨ç»‘å®šè®¾å¤‡
		- æ–°é©±åŠ¨æ³¨å†Œæ—¶ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„è®¾å¤‡åœ¨ç­‰å¾…
4. bus_for_each_devï¼šéå†æ€»çº¿ä¸Šæ‰€æœ‰è®¾å¤‡
	- å‚æ•°ï¼šplatform_bus_typeã€NULLã€é©±åŠ¨æŒ‡é’ˆã€`__driver_attachå›è°ƒ`
	- å¯¹platformæ€»çº¿ä¸Šçš„æ¯ä¸ªè®¾å¤‡è°ƒç”¨`__driver_attachå›è°ƒ`
5. `__driver_attach`ï¼šå°è¯•å°†é©±åŠ¨ç»‘å®šåˆ°å•ä¸ªè®¾å¤‡
	- driver_macth_deviceï¼šæ£€æŸ¥é©±åŠ¨å’Œè®¾å¤‡æ˜¯å¦åŒ¹é…
		- è°ƒç”¨bus->matchï¼Œå³platform_bus_type.match(platform_match)
		- paltform_matchçš„åŒ¹é…è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
			- è®¾å¤‡æ ‘åŒ¹é…ï¼šof_driver_match_deviceï¼ˆæ¯”è¾ƒcompatibleï¼‰
			- ACPIåŒ¹é…ï¼šacpi_driver_match_device
			- IDè¡¨åŒ¹é…ï¼šplatform_match_idï¼ˆæ¯”è¾ƒnameå’Œid_tableï¼‰
			- åç§°åŒ¹é…ï¼šstrcmp(pdev->name, drv->name)
	- å¦‚æœåŒ¹é…æˆåŠŸï¼Œè°ƒç”¨driver_probe_device
6. driver_probe_device â†’ really_probeï¼šæ‰§è¡Œå®é™…çš„probeæ“ä½œ
	- è®¾ç½®è®¾å¤‡çš„driveræŒ‡é’ˆ
	- è°ƒç”¨æ€»çº¿çš„probeå‡½æ•°ï¼šdrv->probeï¼ˆå³platform_drv_probeï¼‰
	- platform_drv_probe
		- è·å–platform_driverç»“æ„ä½“ï¼što_platform_driver
		- è°ƒç”¨platform_driverä¸­å®šä¹‰çš„probeå‡½æ•°
		- è¿™æ˜¯é©±åŠ¨å¼€å‘è€…å®ç°çš„å…·ä½“ç¡¬ä»¶åˆå§‹åŒ–å‡½æ•°
	- å¦‚æœprobeæˆåŠŸ
		- åˆ›å»ºé©±åŠ¨å’Œè®¾å¤‡çš„sysfsé“¾æ¥
		- è®¾å¤‡è¿›å…¥ç»‘å®šçŠ¶æ€
	- å¦‚æœprobeå¤±è´¥
		- æ¸…ç†å·²åˆ†é…çš„èµ„æº
		- è®¾å¤‡ä¿æŒæœªç»‘å®šçŠ¶æ€


### 7.2 æ³¨å†Œplatform_deviceçš„è¿‡ç¨‹

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/681302a287d5d699a136949edf0b024b.png)


```c
platform_device_register
 â””â”€â”€ platform_device_add
     â””â”€â”€ device_add
         â”œâ”€â”€ bus_add_device
         â”‚   â””â”€â”€ klist_add_tail(&dev->p->knode_bus, &bus->p->klist_devices); 
         â”‚       // æŠŠ platform_device æ”¾å…¥ platform_bus_typeçš„deviceé“¾è¡¨ä¸­
         â””â”€â”€ bus_probe_device(dev);
             â””â”€â”€ device_initial_probe
                 â””â”€â”€ __device_attach
                     â””â”€â”€ ret = bus_for_each_drv(dev->bus, NULL, &data, __device_attach_driver); 
                         // å¯¹äºplatform_bus_typeä¸‹çš„æ¯ä¸€ä¸ªdriver, è°ƒç”¨ __device_attach_driver
                         â””â”€â”€ __device_attach_driver
                             â”œâ”€â”€ ret = driver_match_device(drv, dev);
                             â”‚   â””â”€â”€ return drv->bus->match ? drv->bus->match(dev, drv) : 1;  
                             â”‚       // è°ƒç”¨platform_bus_type.match
                             â””â”€â”€ driver_probe_device
```
1. platform_device_registerï¼šæ³¨å†Œå¹³å°è®¾å¤‡çš„å…¥å£å‡½æ•°
	- é©±åŠ¨å¼€å‘è€…è°ƒç”¨æ­¤å‡½æ•°æ³¨å†Œè‡ªå·±çš„platform_device
	- é€šå¸¸åœ¨é©±åŠ¨æ¨¡å—çš„initå‡½æ•°ä¸­è°ƒç”¨
2. platform_device_addï¼šå®é™…çš„è®¾å¤‡æ·»åŠ å®ç°
	- å¤„ç†platform_deviceçš„å…·ä½“æ·»åŠ é€»è¾‘
	- åˆå§‹åŒ–è®¾å¤‡ç»“æ„ä½“ï¼Œå‡†å¤‡å°†è®¾å¤‡åŠ å…¥åˆ°ç³»ç»Ÿä¸­
	- è®¾ç½®è®¾å¤‡çš„å„ç§å±æ€§å’Œèµ„æºä¿¡æ¯
3. device_addï¼šé€šç”¨è®¾å¤‡æ·»åŠ åˆ°ç³»ç»Ÿ
	- bus_add_deviceï¼šå°†è®¾å¤‡æ·»åŠ åˆ°æ€»çº¿çš„è®¾å¤‡é“¾è¡¨
		- klist_add_tailï¼šå°†platform_deviceåŠ å…¥platform_bus_typeçš„è®¾å¤‡é“¾è¡¨
		- dev->p->knode_busï¼šè®¾å¤‡çš„é“¾è¡¨èŠ‚ç‚¹
		- bus->p->klist_devicesï¼šplatformæ€»çº¿ç»´æŠ¤çš„æ‰€æœ‰è®¾å¤‡é“¾è¡¨
4. bus_prove_deviceï¼šå¯åŠ¨è®¾å¤‡æ¢æµ‹
	- device_initial_probeï¼šæ‰§è¡Œè®¾å¤‡çš„åˆå§‹æ¢æµ‹é€»è¾‘
	- ç›®æ ‡æ˜¯ä¸ºè®¾å¤‡å¯»æ‰¾åˆé€‚çš„é©±åŠ¨ç¨‹åº
5. device_initial_probeï¼šåˆå§‹æ¢æµ‹å¤„ç†
	- `__device_attach`ï¼šæ‰§è¡Œè®¾å¤‡é©±åŠ¨åŒ¹é…é€»è¾‘
	- ä¸ºå½“å‰è®¾å¤‡æ‰¾åˆ°åŒ¹é…çš„é©±åŠ¨ç¨‹åº
6. `__device_attach`ï¼šè®¾å¤‡é©±åŠ¨åŒ¹é…
	- bus_for_each_drv: éå†platform_bus_typeä¸‹çš„æ¯ä¸€ä¸ªé©±åŠ¨ç¨‹åº
	- å‚æ•°: è®¾å¤‡æ€»çº¿ã€NULLã€æ•°æ®ç»“æ„ã€__device_attach_driverå›è°ƒ
	- å¯¹platformæ€»çº¿ä¸Šçš„æ¯ä¸ªé©±åŠ¨è°ƒç”¨__device_attach_driverå›è°ƒ
7. `__device_attach_driver`ï¼šè®¾å¤‡ä¸é©±åŠ¨åŒ¹é…å›è°ƒ
	- driver_match_device: æ£€æŸ¥é©±åŠ¨å’Œè®¾å¤‡æ˜¯å¦åŒ¹é…
	    - è°ƒç”¨drv->bus->matchï¼Œå³platform_bus_type.match(platform_match)
	    - platform_matchçš„åŒ¹é…è§„åˆ™:
	        - è®¾å¤‡æ ‘åŒ¹é…: of_driver_match_device (æ¯”è¾ƒcompatible)
	        - ACPIåŒ¹é…: acpi_driver_match_device
	        - IDè¡¨åŒ¹é…: platform_match_id (æ¯”è¾ƒnameå’Œid_table)
	        - åç§°åŒ¹é…: strcmp(pdev->name, drv->name)
	- driver_probe_device: å¦‚æœåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œæ¢æµ‹æ“ä½œ
	    - å®Œæˆè®¾å¤‡ä¸é©±åŠ¨çš„ç»‘å®š


### 7.3 ğŸ“•åŒ¹é…å‡½æ•°è¯¦è§£ï¼ˆé‡ç‚¹ï¼‰

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/e76b99c87d492e0d9d4bc154049c9d59.png)

**åŒ¹é…å‡½æ•°**æ˜¯`platform_bus_type.match`ï¼Œå³`platform_match`ï¼ŒæŒ‰ä¼˜å…ˆçº§é¡ºåºåŒ¹é…ï¼š
1. **driver_overrideåŒ¹é…**ï¼š`platform_dev.driver_override` vs `platform_driver.drv->name`
2. **è®¾å¤‡æ ‘åŒ¹é…**ï¼š`platform_dev.dev.of_node.compatible` vs `platform_driver.drv->of_match_table`çš„æŸä¸€é¡¹
3. **IDè¡¨åŒ¹é…**ï¼š`platform_dev.name` vs `platform_driver.id_table`çš„æŸä¸€é¡¹
4. **åç§°åŒ¹é…**ï¼š`platform_dev.name` vs `platform_driver.drv->name`

**ä»»ä½•ä¸€ä¸ªåŒ¹é…æˆåŠŸï¼Œå³è®¤ä¸ºåŒ¹é…æˆåŠŸï¼**

## 8 å†…æ ¸ä¸­è®¾å¤‡æ ‘çš„æ“ä½œå‡½æ•°

ä¸»è¦è·¯å¾„ï¼š`å†…æ ¸æºç /include/linux` é‡Œé¢æœ‰å¾ˆå¤šofå¼€å¤´çš„å¤´æ–‡ä»¶ï¼Œå°±æ˜¯äº†
![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/40250a82a73ae95d3a8bd2986e32da2d.png)


å†…æ ¸æä¾›äº†ä¸°å¯Œçš„è®¾å¤‡æ ‘æ“ä½œAPIï¼Œç”±äºå†…æ ¸å¯¹dtbçš„å¤„ç†ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ `DTB -> device_node -> platform_device`ï¼Œæ‰€ä»¥æ“ä½œä¹Ÿå°±åˆ†ä¸ºä¸‰ç±»ï¼š

**1ã€DTBæ–‡ä»¶æ“ä½œï¼ˆä¸€èˆ¬ç”¨ä¸åˆ°ï¼‰**
- `of_fdt.h`ï¼šdtbæ–‡ä»¶ç›¸å…³å‡½æ•°

**2ã€device_nodeæ“ä½œï¼ˆå¸¸ç”¨ï¼‰**
- `of.h`ï¼šé€šç”¨å¤„ç†å‡½æ•°
    - `of_property_read_u32()`ï¼šè¯»å–u32å±æ€§å€¼
    - `of_get_child_count()`ï¼šè·å–å­èŠ‚ç‚¹æ•°é‡
- `of_address.h`ï¼šåœ°å€ç›¸å…³å‡½æ•°
    - `of_get_address()`ï¼šè·å–regå±æ€§ä¸­çš„åœ°å€ã€å¤§å°
- `of_gpio.h`ï¼šGPIOç›¸å…³å‡½æ•°
- `of_irq.h`ï¼šä¸­æ–­ç›¸å…³å‡½æ•°
- å…¶ä»–ä¸“ç”¨å¤´æ–‡ä»¶ï¼š`of_dma.h`ã€`of_pci.h`ã€`of_net.h`ç­‰

**3ã€platform_deviceæ“ä½œ**
- `of_platform.h`ï¼šè½¬æ¢ç›¸å…³å‡½æ•°
    - `of_device_alloc()`ï¼šæ ¹æ®device_nodeåˆ›å»ºplatform_device
    - `of_find_device_by_node()`ï¼šæ ¹æ®device_nodeæŸ¥æ‰¾platform_device
- `of_device.h`ï¼šè®¾å¤‡ç›¸å…³å‡½æ•°
    - `of_match_device()`ï¼šä»åŒ¹é…è¡¨ä¸­æ‰¾åˆ°æœ€ä½³åŒ¹é…é¡¹

## 9 åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥çœ‹è®¾å¤‡æ ‘ï¼ˆè°ƒè¯•åˆ©å™¨ï¼‰

### 9.1 è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿæ¥å£

Linuxæä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„è°ƒè¯•æ¥å£

**1ã€åŸå§‹DTBæ–‡ä»¶**
```shell
# æŸ¥çœ‹åŸå§‹çš„äºŒè¿›åˆ¶DTBæ•°æ®
hexdump -C /sys/firmware/fdt
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/edf546185ba76565e2cc3c3b0480eba2.png)

**2ã€ç»“æ„åŒ–è®¾å¤‡æ ‘**
```shell
# ä»¥ç›®å½•ç»“æ„å±•ç°è®¾å¤‡æ ‘
ls /sys/firmware/devicetree/base/
# æ ¹èŠ‚ç‚¹ â†’ baseç›®å½•
# æ¯ä¸ªèŠ‚ç‚¹ â†’ ä¸€ä¸ªç›®å½•  
# æ¯ä¸ªå±æ€§ â†’ ä¸€ä¸ªæ–‡ä»¶
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/1da0238402a81010429d43a62272a1b8.png)


**3ã€platform_deviceåˆ—è¡¨**
```shell
# æŸ¥çœ‹æ‰€æœ‰platform_deviceï¼ˆåŒ…æ‹¬è®¾å¤‡æ ‘å’Œä»£ç æ³¨å†Œçš„ï¼‰
ls /sys/devices/platform/

# å¯¹äºæ¥è‡ªè®¾å¤‡æ ‘çš„platform_deviceï¼Œå¯ä»¥æŸ¥çœ‹å…¶è®¾å¤‡æ ‘å±æ€§ï¼Œç‹¬æœ‰of_nodeèŠ‚ç‚¹
ls /sys/devices/platform/<è®¾å¤‡å>/of_node/

# æœ¬è´¨ä¸Šof_nodeæ˜¯é“¾æ¥äº†/sys/firmware/devicetree/base/
```

**4ã€ä¾¿æ·é“¾æ¥**
```shell
# /proc/device-tree é“¾æ¥åˆ° /sys/firmware/devicetree/base
ls /proc/device-tree
```

### 9.2 è°ƒè¯•æŠ€å·§

1. **éªŒè¯è®¾å¤‡æ ‘æ˜¯å¦æ­£ç¡®åŠ è½½**ï¼šæ£€æŸ¥`/sys/firmware/fdt`æ˜¯å¦å­˜åœ¨
2. **æŸ¥çœ‹èŠ‚ç‚¹å±æ€§**ï¼šåœ¨`/sys/firmware/devicetree/base/`ä¸­æµè§ˆ
3. **ç¡®è®¤platform_deviceç”Ÿæˆ**ï¼šæ£€æŸ¥`/sys/devices/platform/`
4. **è¿½è¸ªè®¾å¤‡æ ‘åˆ°è®¾å¤‡çš„æ˜ å°„**ï¼šé€šè¿‡`of_node`ç›®å½•æŸ¥çœ‹è®¾å¤‡å¯¹åº”çš„è®¾å¤‡æ ‘èŠ‚ç‚¹

## 10 æ€»ç»“

è®¾å¤‡æ ‘å¤„ç†çš„å®Œæ•´æµç¨‹ï¼š

1. **DTBä¼ é€’**ï¼šbootloaderé€šè¿‡r2å¯„å­˜å™¨ä¼ é€’DTBåœ°å€
2. **å¹³å°é€‰æ‹©**ï¼šæ ¹æ®compatibleå±æ€§é€‰æ‹©åˆé€‚çš„machine_desc
3. **é…ç½®æå–**ï¼šä»chosenã€memoryç­‰èŠ‚ç‚¹æå–ç³»ç»Ÿé…ç½®
4. **ç»“æ„è½¬æ¢**ï¼šDTBæ‰å¹³æ•°æ®è½¬æ¢ä¸ºdevice_nodeæ ‘å½¢ç»“æ„
5. **è®¾å¤‡ç”Ÿæˆ**ï¼šç¬¦åˆæ¡ä»¶çš„device_nodeè½¬æ¢ä¸ºplatform_device
6. **é©±åŠ¨åŒ¹é…**ï¼šplatform_deviceä¸platform_driverè¿›è¡ŒåŒ¹é…
7. **è¿è¡Œæ—¶æ“ä½œ**ï¼šä½¿ç”¨å†…æ ¸APIæ“ä½œè®¾å¤‡æ ‘
8. **è°ƒè¯•éªŒè¯**ï¼šé€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥å£æŸ¥çœ‹å’Œè°ƒè¯•è®¾å¤‡æ ‘

è¿™ä¸ªè¿‡ç¨‹ç¡®ä¿äº†ç¡¬ä»¶æè¿°ä¿¡æ¯ä»bootloaderé¡ºåˆ©ä¼ é€’åˆ°å†…æ ¸ï¼Œå¹¶æœ€ç»ˆè½¬åŒ–ä¸ºå¯æ“ä½œçš„è®¾å¤‡å¯¹è±¡ã€‚