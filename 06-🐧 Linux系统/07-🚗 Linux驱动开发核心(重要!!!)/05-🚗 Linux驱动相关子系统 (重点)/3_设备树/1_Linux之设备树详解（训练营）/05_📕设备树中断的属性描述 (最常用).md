---
æ–‡ç« æ ‡é¢˜: "[[05_ğŸ“•è®¾å¤‡æ ‘ä¸­æ–­çš„å±æ€§æè¿° (æœ€å¸¸ç”¨)]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  è¯¦ç»†ä»‹ç»Linuxè®¾å¤‡æ ‘ä¸­æ–­å±æ€§é…ç½®ï¼ŒåŒ…æ‹¬interruptsã€interrupt-controllerã€interrupt-parentç­‰å…³é”®å±æ€§çš„ä½¿ç”¨æ–¹æ³•å’Œå±‚çº§ç»“æ„å…³ç³»ã€‚
tags:
  - è®¾å¤‡æ ‘
  - ä¸­æ–­
  - Linuxé©±åŠ¨
  - GPIO
  - ä¸­æ–­æ§åˆ¶å™¨
  - RK3568
  - interruptså±æ€§
  - åµŒå…¥å¼å¼€å‘
ç›¸å…³æ–‡ç« :
  - "[[06_è®¾å¤‡æ ‘ä¸­ GPIO ç›¸å…³å±æ€§ (å®šä¹‰)]]"
  - "[[../../../../02-ğŸ’» å¼€å‘ç¯å¢ƒ/3_Lubancat-RK3568/2_é•œåƒæ„å»ºä¸éƒ¨ç½²/10_è®¾å¤‡æ ‘çš„ç®€ä»‹]]"
  - "[[../../../../01-â‡ï¸ å‚è€ƒèµ„æ–™/4_å¸¸è§é—®é¢˜è§£å†³/å­¦ä¹ é—®é¢˜è®°å½•]]"
  - "[[../../../../../05-ğŸ”§ 51&32å•ç‰‡æœºå¼€å‘/02-ğŸš€ 32å•ç‰‡æœº/01-ğŸ“– STM32åŸºç¡€/6_STM32CubeMXå®ç°HALç‚¹ç¯]]"
  - "[[../../../../../05-ğŸ”§ 51&32å•ç‰‡æœºå¼€å‘/02-ğŸš€ 32å•ç‰‡æœº/01-ğŸ“– STM32åŸºç¡€/7_GPIOè¾“å…¥æŒ‰é”®]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/04-ğŸ”Œ é©±åŠ¨å¼€å‘/01-ğŸ“ è®­ç»ƒè¥ç¬”è®°/_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£/1_ç¬”è®°/05_ğŸ“•è®¾å¤‡æ ‘ä¸­æ–­çš„å±æ€§æè¿° (æœ€å¸¸ç”¨).md
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2025-04-29 22:37:30
ä¿®æ”¹æ—¶é—´: 2025-05-28 00:37:18
---

## 1 RK ft5x06è®¾å¤‡æ ‘èŠ‚ç‚¹æ¡ˆä¾‹

ä¸‹é¢å±•ç¤ºçš„æ˜¯ `RK3568` å¼€å‘æ¿ `SDK` æºç ä¸­çš„ `ft5x06` è®¾å¤‡æ ‘ï¼Œ å…¶ä¸­è“è‰²å­—ä½“éƒ¨åˆ†å°±æ˜¯å…³äºä¸­æ–­ç›¸å…³çš„æè¿°ï¼Œ åŒ…æ‹¬äº†
- `interrupts`
- `interrupt-controller` : å¯¹å½“å‰èŠ‚ç‚¹çš„ä¸€ä¸ªå®šä¹‰ï¼ˆè¯´æ˜ï¼‰
- `#interrupt-cells`
- `interrupt-parent` ----> æŒ‡å‘gpio0\gpio1\gpio2ï¼Œå³ä¸­æ–­çš„æ¥æº

Gpio æœ‰å¾ˆå¤šç»„ï¼šgpio0 gpio1 gpio2

æ¯ç»„32ä¸ªgpioï¼šA\B\c\D

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/2a8cc27baeb8f993dc6804a2d0048d4b.png)

## 2 interruptså±æ€§ï¼ˆè®¾å¤‡æ‰€ä½¿ç”¨çš„ä¸­æ–­ï¼‰

ï¼ˆè¿™é‡Œå¤–è®¾ç»™æ¿å¡ä¸­æ–­ï¼Œä¸­æ–­ä¿¡æ¯è¦è·ŸåŸç†å›¾ï¼‰
- çœ‹åŸç†å›¾
- æ”¹è®¾å¤‡æ ‘
- åŠ è½½é©±åŠ¨ï¼ˆdeconfigï¼‰

interrupts å±æ€§ç”¨äºæŒ‡å®šè®¾å¤‡çš„ä¸­æ–­ç›¸å…³ä¿¡æ¯ã€‚ å®ƒæè¿°äº†ä¸­æ–­æ§åˆ¶å™¨çš„ç±»å‹ã€ ä¸­æ–­å·ä»¥åŠä¸­æ–­è§¦å‘ç±»å‹ã€‚ ä¸‹é¢å°†å¯¹ interrupts å±æ€§çš„å„ä¸ªæ–¹é¢è¿›è¡Œä»‹ç»ã€‚

åœ¨ç¬¬ä¸€å°èŠ‚ä¸­åˆ—ä¸¾çš„è®¾å¤‡æ ‘æºç ä¸­çš„gpio0èŠ‚ç‚¹å’Œft5x06èŠ‚ç‚¹éƒ½æ¶‰åŠåˆ°äº†interrupts å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/2684e77aa4ccd32f505f9292e0613d0e.png)

**ï¼ˆ1ï¼‰ ä¸­æ–­æ§åˆ¶å™¨ç±»å‹ï¼š**
- `å¯ä»¥ç¼ºçœæ‰ï¼ˆä½¿ç”¨è€…ï¼‰`ï¼Œå¦‚æœæœ‰interrupt-parent è¿™ä¸ªå±æ€§ï¼Œå°±å¯ä»¥ä¸ç”¨å¸¦ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ 
- interrupts å±æ€§çš„`ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†ä¸­æ–­æ§åˆ¶å™¨çš„ç±»å‹`ã€‚
	- å¸¸è§çš„ç±»å‹åŒ…æ‹¬ GIC (Generic Interrupt Controller)ã€ IRQ (Basic Interrupt Handling) ç­‰
	- ä¾‹å¦‚ï¼Œ åœ¨ç»™å®šçš„ä»£ç ç‰‡æ®µä¸­ï¼Œ GIC_SPI è¡¨ç¤ºä¸­æ–­æ§åˆ¶å™¨çš„ç±»å‹ä¸º GIC SPI ä¸­æ–­
- ä¸­æ–­æ§åˆ¶å™¨è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„ä¸­æ–­ä¿¡å·ï¼Œ å®ƒå¯ä»¥æ˜¯ç¡¬ä»¶ä¸­çš„ä¸“ç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼Œ ä¹Ÿå¯ä»¥æ˜¯å¤„ç†å™¨å†…éƒ¨çš„ä¸­æ–­æ§åˆ¶å™¨ã€‚

**ï¼ˆ2ï¼‰ ä¸­æ–­å·ï¼ˆGPIOï¼‰ï¼š**
- interrupts å±æ€§çš„`ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šäº†è®¾å¤‡æ‰€ä½¿ç”¨çš„ä¸­æ–­å·`ã€‚ ä¸­æ–­å·æ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ ç”¨äºåŒºåˆ†ä¸åŒçš„ä¸­æ–­ä¿¡å·æºã€‚ ç³»ç»Ÿä½¿ç”¨ä¸­æ–­å·æ¥è¯†åˆ«ä¸­æ–­æºå¹¶è¿›è¡Œç›¸åº”çš„ä¸­æ–­å¤„ç†ã€‚
- ä¸­æ–­å·å¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œ ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå®å®šä¹‰æˆ–ç¬¦å·å¼•ç”¨ã€‚ åœ¨ç»™å®šçš„ä»£ç ç‰‡æ®µä¸­ï¼Œ 33 è¡¨ç¤ºè¯¥è®¾å¤‡ä½¿ç”¨çš„ä¸­æ–­å·ä¸º 33ã€‚

**ï¼ˆ3ï¼‰ ä¸­æ–­è§¦å‘ç±»å‹ï¼š**
- interrupts å±æ€§çš„`ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šäº†ä¸­æ–­çš„è§¦å‘ç±»å‹`ï¼Œ å³ä¸­æ–­ä¿¡å·çš„è§¦å‘æ¡ä»¶ã€‚ å¸¸è§çš„è§¦å‘ç±»å‹åŒ…æ‹¬è¾¹æ²¿è§¦å‘å’Œç”µå¹³è§¦å‘ã€‚
	- è¾¹æ²¿è§¦å‘è¡¨ç¤ºä¸­æ–­ä¿¡å·åœ¨ä»ä½ç”µå¹³åˆ°é«˜ç”µå¹³æˆ–ä»é«˜ç”µå¹³åˆ°ä½ç”µå¹³çš„å˜åŒ–æ—¶è§¦å‘ã€‚ è§¦å‘ç±»å‹å¯ä»¥æ˜¯ä¸Šå‡æ²¿è§¦å‘ã€ ä¸‹é™æ²¿è§¦å‘æˆ–åŒè¾¹æ²¿è§¦å‘ã€‚
	- ç”µå¹³è§¦å‘è¡¨ç¤ºä¸­æ–­ä¿¡å·åœ¨ä¿æŒç‰¹å®šç”µå¹³çŠ¶æ€æ—¶è§¦å‘ï¼Œ å¯ä»¥æ˜¯é«˜ç”µå¹³è§¦å‘æˆ–ä½ç”µå¹³è§¦å‘ã€‚ åœ¨ç»™å®šçš„ä»£ç ç‰‡æ®µä¸­ï¼Œ IRQ_TYPE_LEVEL_HIGH è¡¨ç¤ºä¸­æ–­çš„è§¦å‘ç±»å‹ä¸ºé«˜ç”µå¹³è§¦å‘ã€‚
	- è§¦å‘ç±»å‹çš„å®å®šä¹‰åœ¨å†…æ ¸æºç â€œinclude/dt-bindings/interrupt-controller/irq.hâ€ ç›®å½•ä¸‹ï¼Œ å…·ä½“å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š
	  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/0b03395996af0e98902f052b9c80f9f9.png)
	  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/28021b180e50e7b291c9795b60882bd8.png)

è€Œåœ¨ ft5x06 èŠ‚ç‚¹ä¸­åªæœ‰ä¸­æ–­å·å’Œä¸­æ–­è§¦å‘ç±»å‹ä¸¤ä¸ªå‚æ•°ï¼Œ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œ å¸¦ç€ç–‘é—®æˆ‘ä»¬ç»§ç»­å­¦ä¹ ä¸‹é¢çš„å‡ ä¸ªå±æ€§ã€‚
## 3 interrupt-controllerå±æ€§ï¼ˆå½“å‰è®¾å¤‡æ˜¯ä¸­æ–­æ§åˆ¶å™¨ï¼‰

interrupt-controller å±æ€§æ˜¯è®¾å¤‡æ ‘ä¸­`ç”¨äºæè¿°ä¸­æ–­æ§åˆ¶å™¨çš„å±æ€§ä¹‹ä¸€`ã€‚ å®ƒæä¾›äº†å…³äºä¸­æ–­æ§åˆ¶å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œ ä»¥ä¾¿æ“ä½œç³»ç»Ÿå’Œå…¶ä»–è®¾å¤‡èƒ½å¤Ÿæ­£ç¡®é…ç½®å’Œä½¿ç”¨ä¸­æ–­ç³»ç»Ÿã€‚

interrupt-controller å±æ€§ç”¨äº`æ ‡è¯†å½“å‰èŠ‚ç‚¹æ‰€æè¿°çš„è®¾å¤‡æ˜¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨`ã€‚ ä¸­æ–­æ§åˆ¶å™¨æ˜¯ç¡¬ä»¶æˆ–è½¯ä»¶æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†å’Œåˆ†å‘ä¸­æ–­ä¿¡å·ã€‚ å®ƒæ¥æ”¶æ¥è‡ªå„ç§è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ï¼Œ å¹¶æ ¹æ®ä¼˜å…ˆçº§å’Œé…ç½®è§„åˆ™åˆ†å‘ä¸­æ–­ç»™ç›¸åº”çš„å¤„ç†å™¨æˆ–è®¾å¤‡ã€‚

**interrupt-controller å±æ€§æœ¬èº«æ²¡æœ‰ç‰¹å®šçš„å±æ€§å€¼ï¼Œ åªéœ€å‡ºç°åœ¨èŠ‚ç‚¹çš„å±æ€§åˆ—è¡¨ä¸­å³å¯ã€‚ å‡ºç°è¯¥å±æ€§çš„å­˜åœ¨å³è¡¨ç¤ºè¯¥èŠ‚ç‚¹æè¿°çš„è®¾å¤‡æ˜¯ä¸­æ–­æ§åˆ¶å™¨ã€‚**

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/683a2bc7747c5aabf7d5770ae91930f2.png)

rk3568.dtsi

(fdd60000 ----> è°å®šä¹‰ï¼ˆç”±ç‘èŠ¯å¾®å®šä¹‰ï¼‰é€šè¿‡èŠ¯ç‰‡æ‰‹å†Œå¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ§åˆ¶æè¿°)
## 4 interrupt-parentå±æ€§ï¼ˆè®¾å¤‡çš„ä¸­æ–­æ¥æºï¼‰

nterrupt-parent å±æ€§æ˜¯è®¾å¤‡æ ‘ä¸­ç”¨äº`å»ºç«‹ä¸­æ–­ä¿¡å·æºä¸ä¸­æ–­æ§åˆ¶å™¨ä¹‹é—´å…³è”çš„å±æ€§`ã€‚ å®ƒæŒ‡å®šäº†ä¸­æ–­ä¿¡å·æºæ‰€å±çš„ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œ ä»¥ç¡®ä¿æ­£ç¡®çš„ä¸­æ–­å¤„ç†å’Œåˆ†å‘ã€‚

interrupt-parent å±æ€§ç”¨äºæŒ‡å®šä¸­æ–­ä¿¡å·æºæ‰€å±çš„ä¸­æ–­æ§åˆ¶å™¨ã€‚ ä¸­æ–­ä¿¡å·æºæ˜¯äº§ç”Ÿä¸­æ–­çš„è®¾å¤‡æˆ–å…¶ä»–ä¸­æ–­æºèŠ‚ç‚¹ã€‚ é€šè¿‡æŒ‡å®šä¸­æ–­æ§åˆ¶å™¨ï¼Œ æ“ä½œç³»ç»Ÿå¯ä»¥æ­£ç¡®åœ°å°†ä¸­æ–­è¯·æ±‚ä¼ é€’ç»™ç›¸åº”çš„ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹è¿›è¡Œå¤„ç†å’Œåˆ†å‘ã€‚

interrupt-parent å±æ€§å€¼æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œ å®ƒæŒ‡å‘ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹çš„è·¯å¾„æˆ–æ ‡ç­¾ã€‚ å¯ä»¥ä½¿ç”¨è·¯å¾„æ¥å¼•ç”¨ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œ å¦‚/interrupt-controller-nodeï¼Œ æˆ–ä½¿ç”¨æ ‡ç­¾æ¥å¼•ç”¨ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œ å¦‚&interrupt-controller-labelï¼Œ åœ¨ç¬¬ä¸€å°èŠ‚ä¾‹å­ä¸­çš„ ft5x06 å°±æ˜¯é€šè¿‡ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹å’Œ gpio0 ä¸­æ–­æ§åˆ¶å™¨å»ºç«‹äº†è”ç³»ï¼Œ å¦‚ä¸‹æ‰€ç¤ºï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/bd392fce892415b757e30d13a68160d4.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/4f217e6d92e1d767b430cf82e7192500.png)

## 5 interrupt-cellså±æ€§

- **ä½œç”¨**ï¼šå®šä¹‰æè¿°è¯¥æ§åˆ¶å™¨ç®¡ç†çš„ä¸­æ–­æ‰€éœ€çš„ **cell æ•°é‡**ï¼ˆå³å‚æ•°ä¸ªæ•°ï¼‰ã€‚
- **ä½ç½®**ï¼šä»…å‡ºç°åœ¨ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ä¸­ã€‚
- **ç¤ºä¾‹**ï¼š
  ```dts
  gpio0: gpio-controller {
      interrupt-controller;
      #interrupt-cells = <2>;  // æ¯ä¸ªä¸­æ–­ç”¨2ä¸ªcellæè¿°
  };
  ```

  - **å…¸å‹å€¼**ï¼š
    - **2 cells**ï¼šä¸­æ–­å· + è§¦å‘ç±»å‹ï¼ˆå¦‚ `0x1` è¡¨ç¤ºè¾¹æ²¿è§¦å‘ï¼‰ã€‚
    - **3 cells**ï¼šå¯èƒ½åŒ…å«ä¼˜å…ˆçº§æˆ–é¢å¤–æ ‡å¿—ï¼ˆå¦‚ARM GICï¼‰ã€‚

**æ¿å¡ä¸¾ä¾‹**


![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/3885d4c71526e57eb9f1e6dfa6886b21.png)

![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a4cb86151e61d2f2744d744cd5c7d541.png)

åœ¨gpiooçš„ä¸­æ–­æ§åˆ¶å™¨ä¸ºgicï¼Œåœ¨gicèŠ‚ç‚¹ä¸­#interrupt-cellså±æ€§è¢«è®¾ç½®ä¸º3ï¼Œ
- è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ gpio0 èŠ‚ç‚¹ä¸­ interrupts å±æ€§æœ‰3ä¸ªå€¼
- è€Œft5x06çš„ä¸­æ–­æ§åˆ¶å™¨ä¸º gppio0ï¼Œåœ¨gpio0èŠ‚ç‚¹ä¸­ `#interrupt-cells` å±æ€§è¢«è®¾ç½®ä¸º2ï¼Œæ‰€ä»¥ft5x06èŠ‚ç‚¹çš„ interrupts å±æ€§åªæœ‰2ä¸ªå€¼
## 6 ä¸­æ–­å±‚çº§ç»“æ„

- **å±‚çº§ç»“æ„**ï¼šè®¾å¤‡çš„ä¸­æ–­é€šè¿‡Â `interrupt-parent`Â æŒ‡å‘æ§åˆ¶å™¨ï¼Œæ§åˆ¶å™¨é€šè¿‡Â `#interrupt-cells`Â å®šä¹‰å‚æ•°æ ¼å¼ï¼Œè®¾å¤‡ç”¨Â `interrupts`Â æä¾›å…·ä½“å€¼ã€‚ã€
- ç¤ºä¾‹å¦‚ä¸‹ï¼š
```dts
// é¡¶çº§ä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚GICï¼‰
gic: interrupt-controller {
    interrupt-controller;
    #interrupt-cells = <3>;
};

// æ¬¡çº§ä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚GPIOï¼‰
gpio0: gpio-controller {
    interrupt-controller;
    #interrupt-cells = <2>;
    interrupt-parent = <&gic>;  // è‡ªèº«ä¸­æ–­ä¸ŠæŠ¥è‡³GIC
    interrupts = <0 10 4>;      // å‚æ•°æ ¼å¼ç”±GICçš„3 cellså†³å®š
};

// ç»ˆç«¯è®¾å¤‡
button {
    interrupt-parent = <&gpio0>;  // æŒ‡å‘GPIOæ§åˆ¶å™¨
    interrupts = <3 1>;          // å‚æ•°æ ¼å¼ç”±GPIOçš„2 cellså†³å®š
};
```

## 7 ä¸­æ–­çš„è§£æ

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/8e6b6e9c3ee88f59bb7baf32f2acfd85.png)

å…·ä½“å¯ä»¥æŸ¥çœ‹æ–‡ç«  [13_é€šè¿‡OFå‡½æ•°è·å–ä¸­æ–­èµ„æº](13_é€šè¿‡OFå‡½æ•°è·å–ä¸­æ–­èµ„æº.md)

