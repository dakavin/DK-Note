
å­—ç¬¦è®¾å¤‡é©±åŠ¨æ˜¯Linuxé©±åŠ¨å¼€å‘çš„åŸºç¡€å’Œæ ¸å¿ƒï¼ŒæŒæ¡å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¼€å‘æ–¹æ³•ï¼Œå°±ç›¸å½“äºæŒæ¡äº†Linuxé©±åŠ¨å¼€å‘çš„ç²¾é«“ã€‚æœ¬æ–‡å°†ä»é›¶å¼€å§‹ï¼Œç³»ç»Ÿåœ°ä»‹ç»å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å®Œæ•´å¼€å‘è¿‡ç¨‹ã€‚

> [!tip]+ å­¦ä¹ è·¯çº¿å›¾ **åŸºç¡€æ¦‚å¿µ** â†’ **è®¾å¤‡æŠ½è±¡** â†’ **æ ¸å¿ƒæ•°æ®ç»“æ„** â†’ **é©±åŠ¨æ¡†æ¶** â†’ **å®é™…ç¼–ç¨‹** â†’ **é«˜çº§æŠ€å·§**

## 1 Linuxè®¾å¤‡åˆ†ç±»

åœ¨Linuxç³»ç»Ÿä¸­ï¼Œ**ä¸€åˆ‡çš†æ–‡ä»¶**çš„è®¾è®¡å“²å­¦è´¯ç©¿å§‹ç»ˆã€‚æ‰€æœ‰**ç¡¬ä»¶è®¾å¤‡**éƒ½ä¼šåœ¨`/dev`ç›®å½•ä¸‹ç”¨ç›¸åº”çš„æ–‡ä»¶è¡¨ç¤ºï¼Œé€šè¿‡è¯»å†™è¿™äº›æ–‡ä»¶å°±å¯ä»¥æ§åˆ¶å’Œè®¿é—®å®é™…çš„ç¡¬ä»¶è®¾å¤‡ã€‚

**å­—ç¬¦è®¾å¤‡ï¼ˆCharacter Deviceï¼‰**ï¼š
- **ä¼ è¾“æ–¹å¼**ï¼š`æŒ‰å­—èŠ‚/å­—ç¬¦é¡ºåºä¼ è¾“æ•°æ®`ï¼Œåƒæµæ°´ä¸€æ ·
- **ç¼“å­˜ç‰¹æ€§**ï¼šé€šå¸¸`ä¸ä½¿ç”¨ç¼“å­˜`ï¼Œæ•°æ®ç›´æ¥ä¼ è¾“
- **è®¿é—®æ–¹å¼**ï¼šåªèƒ½`æŒ‰é¡ºåºè®¿é—®`ï¼Œä¸æ”¯æŒéšæœºå®šä½
- **å…¸å‹è®¾å¤‡**ï¼šä¸²å£ã€é”®ç›˜ã€é¼ æ ‡ã€LEDã€ä¼ æ„Ÿå™¨

> [!example]+ ç”Ÿæ´»ç±»æ¯” 
> å­—ç¬¦è®¾å¤‡å°±åƒæ°´é¾™å¤´ï¼Œæ°´æŒ‰é¡ºåºæµå‡ºï¼Œä½ æ— æ³•"è·³è¿‡"å‰é¢çš„æ°´ç›´æ¥è·å–åé¢çš„æ°´

**å—è®¾å¤‡ï¼ˆBlock Deviceï¼‰**ï¼š
- **ä¼ è¾“æ–¹å¼**ï¼šä»¥`å›ºå®šå¤§å°çš„æ•°æ®å—ä¸ºå•ä½è¿›è¡Œä¼ è¾“`
- **ç¼“å­˜ç‰¹æ€§**ï¼š`ä½¿ç”¨ç¼“å­˜`æé«˜è®¿é—®æ•ˆç‡
- **è®¿é—®æ–¹å¼**ï¼š`æ”¯æŒéšæœºè®¿é—®`ï¼Œå¯ä»¥è·³è½¬åˆ°ä»»æ„ä½ç½®
- **å…¸å‹è®¾å¤‡**ï¼šç¡¬ç›˜ã€Uç›˜ã€SDå¡ã€é—ªå­˜

**ç½‘ç»œè®¾å¤‡ï¼ˆNetwork Deviceï¼‰**ï¼š
- **ç‰¹æ®Šæ€§**ï¼šä¸å­˜åœ¨äº`/dev`ç›®å½•ä¸‹
- **ä¸»è¦åŠŸèƒ½**ï¼šè´Ÿè´£ç½‘ç»œæ•°æ®çš„æ”¶å‘
- **è®¿é—®æ–¹å¼**ï¼šé€šè¿‡socketæ¥å£è®¿é—®
- **å…¸å‹è®¾å¤‡**ï¼šç½‘å¡ã€WiFiæ¨¡å—

**æ€»ç»“**
- Linuxå†…æ ¸ä¸­å¤„å¤„ä½“ç°äº†é¢å‘å¯¹è±¡çš„è®¾è®¡æ€æƒ³ï¼Œä¸ºäº†ç»Ÿä¸€å„ç§å„æ ·çš„è®¾å¤‡ï¼ŒLinuxç³»ç»Ÿå°†è®¾å¤‡åˆ†åˆ«æŠ½è±¡ä¸º
	- struct `cdev`
	- struct `block_device`
	- struct `net_device`
- å…·ä½“çš„è®¾å¤‡éƒ½å¯ä»¥åŒ…å«è¿™ä¸‰ç§å¯¹è±¡ä»è€Œç»§æ‰¿å®ƒä»¬çš„å±æ€§å’Œæ“ä½œ
- å¯ä»¥é€šè¿‡å„è‡ªå¯¹è±¡æ·»åŠ åˆ°ç›¸åº”çš„é©±åŠ¨æ¨¡å‹ï¼Œä»è€Œè¿›è¡Œç»Ÿä¸€çš„ç®¡ç†å’Œæ“ä½œ

**å­—ç¬¦è®¾å¤‡çš„ä¼˜åŠ¿**
- **å¼€å‘ç®€å•**ï¼šç›¸æ¯”å—è®¾å¤‡å’Œç½‘ç»œè®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡çš„é©±åŠ¨å¼€å‘æœ€ä¸ºç®€å•ç›´è§‚  
- **åº”ç”¨å¹¿æ³›**ï¼šå¤§å¤šæ•°åµŒå…¥å¼è®¾å¤‡éƒ½å¯ä»¥æŠ½è±¡ä¸ºå­—ç¬¦è®¾å¤‡  
- **å­¦ä¹ ä»·å€¼**ï¼šæ˜¯ç†è§£Linuxé©±åŠ¨å¼€å‘çš„æœ€ä½³å…¥é—¨ç‚¹

> [!note]+ ä¸ºä»€ä¹ˆä»å­—ç¬¦è®¾å¤‡å¼€å§‹ 
> å­—ç¬¦è®¾å¤‡é©±åŠ¨åŒ…å«äº†Linuxé©±åŠ¨å¼€å‘çš„æ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µï¼šè®¾å¤‡å·ã€file_operationsã€VFSäº¤äº’ç­‰ï¼ŒæŒæ¡äº†å­—ç¬¦è®¾å¤‡ï¼Œå…¶ä»–ç±»å‹çš„è®¾å¤‡é©±åŠ¨å°±èƒ½è§¦ç±»æ—é€š

## 2 å­—ç¬¦è®¾å¤‡æŠ½è±¡è®¾è®¡

è™½ç„¶Cè¯­è¨€æ²¡æœ‰é¢å‘å¯¹è±¡çš„è¯­æ³•ï¼Œä½†Linuxå†…æ ¸é€šè¿‡ç»“æ„ä½“çš„å·§å¦™è®¾è®¡ï¼Œå®ç°äº†é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³ã€‚

**è®¾å¤‡æŠ½è±¡å±‚æ¬¡**ï¼š
```txt
ç¡¬ä»¶è®¾å¤‡å±‚
    â†“
è®¾å¤‡é©±åŠ¨å±‚ (struct cdev)
    â†“  
è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå±‚ (VFS)
    â†“
åº”ç”¨ç¨‹åºå±‚
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/5a34253f71d05c15e0bc2302dc803238.png)

**ç¡¬ä»¶å±‚**
- é€šè¿‡æŸ¥çœ‹ç¡¬ä»¶çš„åŸç†å›¾ã€èŠ¯ç‰‡çš„æ•°æ®æ‰‹å†Œï¼Œç¡®å®šåº•å±‚éœ€è¦é…ç½®çš„å¯„å­˜å™¨
- ç„¶åå°†åº•å±‚å¯„å­˜å™¨çš„é…ç½®ï¼Œè¯»å†™æ“ä½œæ”¾åœ¨æ–‡ä»¶æ“ä½œæ¥å£é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯å®ç°file_operationsç»“æ„ä½“
**é©±åŠ¨å±‚**
- å°†æ–‡ä»¶æ“ä½œæ¥å£æ³¨å†Œåˆ°å†…æ ¸
- å†…æ ¸é€šè¿‡å†…éƒ¨æ•£åˆ—è¡¨æ¥ç™»è®°è®°å½•ä¸»æ¬¡è®¾å¤‡å·
**æ–‡ä»¶ç³»ç»Ÿå±‚**
- æ–°å»ºä¸€ä¸ªæ–‡ä»¶ç»‘å®šè¯¥æ–‡ä»¶æ“ä½œæ¥å£
- åº”ç”¨ç¨‹åºæ“ä½œæŒ‡å®šæ–‡ä»¶çš„æ–‡ä»¶æ“ä½œæ¥å£æ¥è®¾ç½®åº•å±‚å¯„å­˜å™¨

## 3 cdevï¼šå­—ç¬¦è®¾å¤‡å¯¹è±¡

Linuxå°†å­—ç¬¦è®¾å¤‡æŠ½è±¡æˆ`struct cdev`å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è®°å½•äº†è®¾å¤‡çš„æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼š

```c
// å†…æ ¸æºç /include/linux/cdev.h
struct cdev {
    struct kobject kobj;                    // å†…æ ¸å¯¹è±¡ï¼Œç”¨äºè®¾å¤‡ç®¡ç†
    struct module *owner;                   // è®¾å¤‡æ‰€å±çš„å†…æ ¸æ¨¡å—
    const struct file_operations *ops;     // è®¾å¤‡æ“ä½œæ–¹æ³•é›†
    struct list_head list;                 // è®¾å¤‡é“¾è¡¨
    dev_t dev;                             // è®¾å¤‡å·
    unsigned int count;                    // è®¾å¤‡æ•°é‡
};
```
- `kobj`ï¼šè®¾å¤‡çš„"æˆ·å£æœ¬"ï¼Œçº³å…¥Linuxç»Ÿä¸€è®¾å¤‡ç®¡ç†ä½“ç³»ï¼ˆå¦‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€ç”µæºç®¡ç†ã€çƒ­æ’æ‹”ã€ç”Ÿå‘½å‘¨æœŸã€ä¸ç”¨æˆ·é€šä¿¡ç­‰ï¼‰
- `owner`ï¼šè®¾å¤‡çš„"èº«ä»½è¯"ï¼Œé˜²æ­¢æ¨¡å—åœ¨ä½¿ç”¨æ—¶è¢«å¸è½½
- `ops`ï¼šè®¾å¤‡çš„"æ“ä½œæ‰‹å†Œ"ï¼Œå®šä¹‰äº†å¦‚ä½•æ‰“å¼€ã€å…³é—­ã€è¯»å†™è¿™ä¸ªè®¾å¤‡ï¼ˆæ˜¯VFSä¸è®¾å¤‡é©±åŠ¨çš„æ¡¥æ¢ï¼‰
- `list`ï¼šè®¾å¤‡é—´çš„â€œè”ç³»æ–¹å¼â€ï¼Œç”¨æ¥æŠŠè®¾å¤‡ä¸²æˆé“¾è¡¨
- `dev`ï¼šè®¾å¤‡çš„"ç¼–å·"ï¼Œç³»ç»Ÿä¸­çš„å”¯ä¸€æ ‡è¯†
- `count`ï¼šåŒç±»è®¾å¤‡çš„â€œæ•°é‡ç»Ÿè®¡â€ï¼Œè¡¨ç¤ºè¿™ä¸ªé©±åŠ¨ç®¡ç†å‡ ä¸ªç›¸åŒç±»å‹çš„è®¾å¤‡

> [!tip]+ ç†è§£è¦ç‚¹ 
> struct cdevå°±åƒæ¯ä¸ªå­—ç¬¦è®¾å¤‡çš„"å®Œæ•´æ¡£æ¡ˆ"ï¼ŒåŒ…å«äº†å†…æ ¸ç®¡ç†è®¾å¤‡æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯

**å®šä¹‰å­—ç¬¦è®¾å¤‡**
```c
// ç¬¬ä¸€ç§æ–¹å¼ï¼šå˜é‡å®šä¹‰
static struct cdev chrdev;

// ç¬¬äºŒç§æ–¹å¼ï¼šå†…æ ¸æä¾›çš„åŠ¨æ€åˆ†é…æ–¹å¼
// è¿”å›ä¸€ä¸ªstruct cdevç±»å‹çš„æŒ‡é’ˆï¼Œç”¨äºæè¿°å­—ç¬¦è®¾å¤‡
struct cdev *cdev_alloc(void);
```

**ç§»å‡ºæŸä¸ªå­—ç¬¦è®¾å¤‡**
```c
void cdev_del(struct cdev *p)
```
- å‚æ•°pï¼šå­—ç¬¦è®¾å¤‡ç»“æ„ä½“çš„åœ°å€
- è¿”å›å€¼ï¼šæ— 

**åˆå§‹åŒ–cdevï¼ˆå…³è”fopsï¼‰**
```c
// å†…æ ¸æºç /fs/char_dev.c
void cdev_init(struct cdev *cdev,const struct file_operations *fops)
```
- cdevï¼šstruct cdevç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡å‘éœ€è¦å…³è”çš„å­—ç¬¦è®¾å¤‡ç»“æ„ä½“
- fopsï¼šfile_operationsç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å®ç°è¯¥è®¾å¤‡æ“ä½œçš„ç»“æ„ä½“ï¼Œä¸€èˆ¬ä½œä¸ºå®å‚

**cdevæ³¨å†Œ**ï¼šå‘å†…æ ¸çš„cdev_mapæ•£åˆ—è¡¨æ·»åŠ ä¸€ä¸ªæ–°çš„å­—ç¬¦è®¾å¤‡
```c
// å†…æ ¸æºç /fs/char_dev.c
int cdev_add(struct cdev *p,dev_t dev,unsigned count);
```
- pï¼šstruct cdevç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å®šéœ€è¦æ·»åŠ çš„å­—ç¬¦è®¾å¤‡
- devï¼šdev_tç±»å‹å˜é‡ï¼ŒæŒ‡å®šè®¾å¤‡çš„èµ·å§‹ç¼–å·
- countï¼šæŒ‡å®šæ³¨å†Œå¤šå°‘ä¸ªè®¾å¤‡
- è¿”å›å€¼ï¼šé”™è¯¯ç 

**cdevæ³¨é”€**ï¼šä»ç³»ç»Ÿåˆ é™¤cdevï¼Œcdevè®¾å¤‡æ— æ³•å†æ‰“å¼€ï¼Œä¸è¿‡å·²ç»æ‰“å¼€çš„cdevè®¾å¤‡å°†ä¿æŒä¸å˜
```c
// å†…æ ¸æºç /fs/char_dev.c
void cdev_del(struct cdev *p)
```
- pï¼šstruct cdevç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å®šéœ€è¦åˆ é™¤çš„å­—ç¬¦è®¾å¤‡

## 4 cdev_mapï¼šæ•£åˆ—è¡¨

æ¯ä¸ªå­—ç¬¦è®¾å¤‡çš„â€œå®Œæ•´æ¡£æ¡ˆå¡â€ï¼ŒåŒ…å«äº†è®¾å¤‡çš„èº«ä»½ä¿¡æ¯ã€æ“ä½œæ–¹æ³•ã€ç®¡ç†å…³ç³»ç­‰æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼Œè®©å†…æ ¸èƒ½å¤Ÿç»Ÿä¸€ã€é«˜æ•ˆåœ°ç®¡ç†å„ç§å­—ç¬¦è®¾å¤‡
- **å†…æ ¸ç”¨ `cdev_map` æ•£åˆ—è¡¨æ¥ç®¡ç†æ‰€æœ‰çš„cdevç»“æ„ä½“**ï¼Œcdev_mapçš„ç±»å‹æ˜¯ `struct kobj_map`
- æŸ¥æ‰¾è§„åˆ™ï¼šç”¨ä¸»è®¾å¤‡å·é€šè¿‡æ ¼å¼ `major % 255` è®¡ç®—æ•°ç»„ä¸‹æ ‡ï¼Œ
- å†²çªå¤„ç†ï¼šç›¸åŒä¸‹æ ‡çš„è®¾å¤‡æŒ‰æ¬¡è®¾å¤‡å·æ’åºç»„æˆé“¾è¡¨
- ä¼˜åŠ¿ï¼šç»“åˆæ•°ç»„æŸ¥æ‰¾å¿«å’Œé“¾è¡¨å¢åˆ æ–¹ä¾¿çš„ç‰¹ç‚¹

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/45ddc87dd5a2751be909eedfd1bc4a98.png)

## 5 dev_tï¼šè®¾å¤‡å·

**1ã€è®¾å¤‡å·çš„å«ä¹‰**ï¼šåœ¨Linuxé‡Œï¼Œæ‰€æœ‰çš„ç¡¬ä»¶è®¾å¤‡ï¼ˆæ¯”å¦‚ç¡¬ç›˜ã€é”®ç›˜ã€é¼ æ ‡ç­‰ï¼‰éƒ½è¢«å½“ä½œ"æ–‡ä»¶"æ¥å¤„ç†ï¼Œè¿™äº›ä»£è¡¨è®¾å¤‡çš„"æ–‡ä»¶"æœ‰ä¸ªä¸“é—¨çš„å­˜æ”¾ä½ç½®ï¼Œå°±æ˜¯`/dev`æ–‡ä»¶å¤¹
- æƒ³è¦æŸ¥çœ‹ç³»ç»Ÿé‡Œæœ‰å“ªäº›è®¾å¤‡ï¼Œå¯ä»¥ç”¨å‘½ä»¤`ls -l /dev`
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a85cba2412698aa0a41d357b8277f3d8.png)
	- `c`ç”¨æ¥è¡¨ç¤ºå­—ç¬¦è®¾å¤‡ï¼Œ`b`ç”¨æ¥æ ‡è¯†å—è®¾å¤‡
	- autofsæ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡cï¼Œä¸»è®¾å¤‡å·æ˜¯10ï¼Œæ¬¡è®¾å¤‡å·æ˜¯235
	- loop0æ˜¯ä¸€ä¸ªå—è®¾å¤‡bï¼Œä¸»è®¾å¤‡å·æ˜¯7ï¼Œæ¬¡è®¾å¤‡æ˜¯0
		- loop0â€”loop3ï¼Œå…±ç”¨ä¸€ä¸ªä¸»è®¾å¤‡å·ï¼Œæ¬¡è®¾å¤‡å·ç”±0å¼€å§‹é€’å¢

**2ã€è®¾å¤‡å·çš„ç»„æˆ**ï¼šLinuxä½¿ç”¨32ä½çš„`dev_t`ç±»å‹æ¥è¡¨ç¤ºè®¾å¤‡å·ï¼š
```c
// å†…æ ¸æºç /include/types.h
// dev_tçš„å®šä¹‰
typedef u32 __kernel_dev_t;
typedef __kernel_dev_t dev_t;

// è®¾å¤‡å·ï¼š32ä½çš„æ•°å­—
é«˜12ä½ï¼šä¸»è®¾å¤‡å· (0-4095(2^12-1)ï¼Œå®é™…é™åˆ¶0-511)
ä½20ä½ï¼šæ¬¡è®¾å¤‡å· (0-1048575(2^20-1))
```
- **ä¸»è®¾å¤‡å·**ï¼šå‘Šè¯‰å†…æ ¸ä½¿ç”¨å“ªä¸ªé©±åŠ¨ç¨‹åºï¼ˆç›¸å½“äº"å…¬å¸åç§°"ï¼‰  
- **æ¬¡è®¾å¤‡å·**ï¼šå‘Šè¯‰é©±åŠ¨ç¨‹åºæ“ä½œå“ªä¸ªå…·ä½“è®¾å¤‡ï¼ˆç›¸å½“äº"å‘˜å·¥å·¥å·"ï¼‰

**3ã€è®¾å¤‡å·ç›¸å…³å®å®šä¹‰**
```c
// å†…æ ¸æºç /include/linux/kdev_t.h
#define MINORBITS    20
#define MINORMASK    ((1U << MINORBITS) - 1)

#define MAJOR(dev)   ((unsigned int) ((dev) >> MINORBITS))  // è·å–ä¸»è®¾å¤‡å·
#define MINOR(dev)   ((unsigned int) ((dev) & MINORMASK))   // è·å–æ¬¡è®¾å¤‡å·  
#define MKDEV(ma,mi) (((ma) << MINORBITS) | (mi))          // ç»„åˆè®¾å¤‡å·
```

**4ã€è®¾å¤‡å·ç”³è¯·å’Œæ³¨é”€æ–¹æ³•**

**é™æ€ç”³è¯·**ï¼ˆä¸æ¨èï¼‰ï¼š
```c
int register_chrdev_region(dev_t from, unsigned count, const char *name);
```
- `from`ï¼šdev_tç±»å‹ï¼ŒæŒ‡å®šå­—ç¬¦è®¾å¤‡çš„èµ·å§‹è®¾å¤‡å·ï¼ˆæœªè¢«å…¶ä»–è®¾å¤‡æ³¨å†Œçš„å·ç å—·ï¼‰
- `count`ï¼šä»æŒ‡å®šçš„èµ·å§‹è®¾å¤‡å·å¼€å§‹ï¼Œè¿ç»­ç”³è¯·å¤šå°‘ä¸ªè®¾å¤‡å·
- `name`ï¼šæŒ‡å®šè¯¥è®¾å¤‡çš„åç§°ï¼Œå¯ä»¥åœ¨`/proc/devices`ä¸­çœ‹åˆ°è¯¥è®¾å¤‡
- è¿”å›å€¼ï¼š0-æˆåŠŸï¼Œé0-å¤±è´¥é”™è¯¯ç 

**åŠ¨æ€ç”³è¯·**ï¼ˆæ¨èï¼‰ï¼š
```c
int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name);
```
- `dev`ï¼šdev_tæ•°æ®ç±»å‹çš„æŒ‡é’ˆï¼Œå­˜æ”¾åˆ†é…åˆ°çš„è®¾å¤‡ç¼–å·çš„èµ·å§‹å€¼
- `baseminor`ï¼šæ¬¡è®¾å¤‡å·çš„èµ·å§‹å€¼ï¼Œä¸€èˆ¬æ˜¯0
- `count`ã€`name`ã€`è¿”å›å€¼`ï¼šåŒä¸Š

> [!warning]+ é‡è¦æé†’ 
> å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®å§‹ç»ˆä½¿ç”¨åŠ¨æ€ç”³è¯·æ–¹å¼ï¼Œè®©å†…æ ¸è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„è®¾å¤‡å·

**æ³¨é”€**
```c
// å†…æ ¸æºç /fs/char_dev.c
void unregister_chrdev_region(dev_t from,unsigned count)
```
- fromï¼šæŒ‡å®šæ³¨é”€å­—ç¬¦è®¾å¤‡çš„è®¾å¤‡ç¼–å·èµ·å§‹å€¼ï¼Œä¸€èˆ¬å®šä¹‰å°†å®šä¹‰çš„dev_tå˜é‡ä½œä¸ºå®å‚
- countï¼šæŒ‡å®šæ³¨é”€å­—ç¬¦è®¾å¤‡ç¼–å·çš„ä¸ªæ•°ï¼Œå’Œç”³è¯·æ—¶çš„countç±»å‹ï¼Œé‡‡ç”¨å®å®šä¹‰è¿›è¡Œç®¡ç†

**register_chrdevå‡½æ•°**
- é™¤äº†ä¸Šè¿°ä¸¤ç§æ³¨å†Œæ–¹å¼ï¼Œè¯¥å‡½æ•°ä¹Ÿç”¨äºåˆ†é…è®¾å¤‡å·
- æ˜¯ä¸€ä¸ªå†…è”å‡½æ•°ï¼Œä¸ä»…æ”¯æŒé™æ€ç”³è¯·è®¾å¤‡å·ï¼Œä¹Ÿæ”¯æŒ`åŠ¨æ€`ç”³è¯·è®¾å¤‡å·ï¼Œå¹¶è¿”å›ä¸»è®¾å¤‡å·
```c
// å†…æ ¸æºç /include/linux/fs.h
static inline int register_chrdev(unsigned int major,const char *name,const struct file_operations *fops){
	return __register_chrdev(major,0,256,name,fops);
}
```
- majorï¼šæŒ‡å®šç”³è¯·å­—ç¬¦è®¾å¤‡çš„ä¸»è®¾å¤‡å·ï¼Œ0åˆ™è®©å†…æ ¸è‡ªåŠ¨åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„
- nameï¼šåŒä¸Š
- fopsï¼šæ“ä½œè¯¥è®¾å¤‡çš„å‡½æ•°æ¥å£æŒ‡é’ˆ
- è¿”å›ï¼šä¸»è®¾å¤‡å·

> [!tip]+ æç¤º
> å¯ä»¥çœ‹åˆ°ç›¸åŒä¸»è®¾å¤‡å·çš„è®¾å¤‡ï¼Œä¼šåœ¨å†…æ ¸ç”³è¯·256ä¸ªï¼Œé€šå¸¸ä¸éœ€è¦è¿™ä¹ˆå¤šä¸ªè®¾å¤‡ï¼Œè¿™å°±é€ æˆäº†æå¤§çš„èµ„æºæµªè´¹

**unregister_chrdevå‡½æ•°**
- å¯¹åº”ä¸Šé¢æ³¨å†Œå‡½æ•°çš„æ³¨é”€å‡½æ•°
```c
// å†…æ ¸æºç /include/linux/fs.h
static inline void unregister_chrdev(unsigned int major,const char *name){
	__unregister_chrdev(major,0,256,name);
}
```
- majorã€nameï¼šåŒä¸Š

## 6 file_operationsï¼šè®¾å¤‡æ“ä½œæ–¹æ³•é›†

`file_operations`æ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„æ ¸å¿ƒï¼Œå°±åƒä¸€ä¸ª"æ“ä½œæ‰‹å†Œ"ï¼Œå®ƒå®šä¹‰äº†åº”ç”¨ç¨‹åºå¯ä»¥å¯¹è®¾å¤‡æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œ

**æ ¸å¿ƒä½œç”¨ï¼šè¿æ¥æ¡¥æ¢**
- **ç³»ç»Ÿè°ƒç”¨** â†” **file_operations** â†” **é©±åŠ¨ç¨‹åº**
- å½“åº”ç”¨ç¨‹åºè°ƒç”¨`open`ã€`read`ã€`write`ç­‰ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¼šæŸ¥æ‰¾å¯¹åº”è®¾å¤‡çš„`file_operations`ç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨å…¶ä¸­ç›¸åº”çš„å‡½æ•°æŒ‡é’ˆ

```c
// ä¸»è¦çš„æ“ä½œå‡½æ•°
struct file_operations {
    struct module *owner;                           // æ¨¡å—æ‰€æœ‰è€…
    int (*open)(struct inode *, struct file *);     // æ‰“å¼€è®¾å¤‡
    int (*release)(struct inode *, struct file *);  // å…³é—­è®¾å¤‡
    ssize_t (*read)(struct file *, char __user *, size_t, loff_t *);      // è¯»å–æ•°æ®
    ssize_t (*write)(struct file *, const char __user *, size_t, loff_t *); // å†™å…¥æ•°æ®
    long (*unlocked_ioctl)(struct file *, unsigned int, unsigned long);    // è®¾å¤‡æ§åˆ¶
    loff_t (*llseek)(struct file *, loff_t, int);  // å®šä½æ“ä½œ
};
```
- åŸºç¡€æ“ä½œå‡½æ•°
	- `open`ï¼šè®¾å¤‡æ‰“å¼€å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºç¡¬ä»¶åˆå§‹åŒ–
		- ğŸ“•å¦‚æœè®¾ç½®ä¸ºNULLï¼Œè®¾å¤‡çš„æ‰“å¼€æ“ä½œæ°¸è¿œæˆåŠŸ
	- `release`ï¼šè®¾å¤‡é‡Šæ”¾å‡½æ•°ï¼Œæœ€åè¢«è°ƒç”¨ï¼Œç”¨äºæ¸…ç†å’Œé‡Šæ”¾èµ„æº
	- `llseek`ï¼šæ–‡ä»¶æŒ‡é’ˆç§»åŠ¨å‡½æ•°ï¼Œæ”¹å˜è¯»å†™ä½ç½®ï¼ˆå¦‚ç§»åŠ¨åˆ°æ–‡ä»¶å¼€å¤´ã€æœ«å°¾å’Œå½“å‰ä½ç½®ï¼‰
		- å‚æ•°fileï¼šå¯¹åº”æ–‡ä»¶æŒ‡é’ˆï¼Œç”¨äºè¯»å–æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆæ–‡ä»¶ç±»å‹ï¼Œè¯»å†™æƒé™ï¼‰
		- å‚æ•°loff_tï¼šåç§»é‡çš„å¤§å°
		- å‚æ•°intï¼šæŒ‡å®šåç§»çš„èµ·å§‹ç‚¹ï¼ŒSEEK_SETæ–‡ä»¶èµ·å§‹ï¼ŒSEEK_CURå½“å‰ä½ç½®ï¼ŒSEEK_EDNæ–‡ä»¶ç»“å°¾
- æ•°æ®ä¼ è¾“å‡½æ•°
	- `read`ï¼šä»è®¾å¤‡è¯»å–æ•°æ®åˆ°ç”¨æˆ·ç¨‹åº
		- è¯¥å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºNULLæ—¶ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿè°ƒç”¨readå‡½æ•°æŠ¥é”™ï¼Œæç¤ºéæ³•å‚æ•°
		- å‚æ•°fileï¼šä¸ä»‹ç»
		- å‚æ•°__userğŸ“•ï¼šç±»å‹æ˜¯æ•°æ®ç¼“å†²åŒºï¼Œ`__user`ä¿®é¥°å˜é‡è¡¨ç¤ºå…¶åœ°å€ç©ºé—´æ˜¯ç”¨æˆ·ç©ºé—´ï¼Œå†…æ ¸æ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼Œéœ€è¦ç”¨copy_to_userå‡½æ•°æ¥è¿›è¡Œæ“ä½œ
		- å‚æ•°size_tï¼šæŒ‡å®šè¯»å–çš„æ•°æ®å¤§å°
	- `write`ï¼šä»ç”¨æˆ·ç¨‹åºå†™å…¥æ•°æ®åˆ°è®¾å¤‡
		- å‚æ•°ä¸ä»‹ç»äº†ï¼Œå’Œreadå·®ä¸å¤š
	- `unlocked_ioctl`ï¼šè®¾å¤‡æ§åˆ¶æŒ‡ä»¤å‡½æ•°ï¼Œæ‰§è¡Œç‰¹æ®Šçš„æ§åˆ¶æ“ä½œ
		- å¯¹åº”äºåº”ç”¨ç¨‹åºçš„fcntlå‡½æ•°ä»¥åŠioctlå‡½æ•°
		- åœ¨kernel3.0å·²ç»å®Œå…¨åˆ é™¤äº†file_operationsä¸­çš„ioctlå‡½æ•°æŒ‡é’ˆ

å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®äº¤äº’å¯ä»¥é˜…è¯»æ–‡æ¡£ï¼š[3_å†…æ ¸ç”¨æˆ·ç©ºé—´æ•°æ®äº¤äº’](3_å†…æ ¸ç”¨æˆ·ç©ºé—´æ•°æ®äº¤äº’.md)

> [!tip]+ å¼€å‘æŠ€å·§ 
> å¦‚æœæŸä¸ªæ“ä½œä¸è¢«æ”¯æŒï¼Œå¯ä»¥å°†å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºNULLã€‚ä¾‹å¦‚ï¼ŒLEDè®¾å¤‡é€šå¸¸ä¸æ”¯æŒreadæ“ä½œï¼Œå°±å¯ä»¥å°†readè®¾ç½®ä¸ºNULL

## 7 fileï¼šæ–‡ä»¶æè¿°ç»“æ„

æ¯æ¬¡æ‰“å¼€è®¾å¤‡ï¼ˆæ–‡ä»¶ï¼‰æ—¶ï¼Œå†…æ ¸éƒ½ä¼šåˆ›å»ºä¸€ä¸ª`struct file`å¯¹è±¡ï¼š
```c
struct file {
    const struct file_operations *f_op;    // æ“ä½œæ–¹æ³•æŒ‡é’ˆ
    void *private_data;                     // ç§æœ‰æ•°æ®æŒ‡é’ˆ
    // ... å…¶ä»–æˆå‘˜
};
```
- **f_op**ï¼šæŒ‡å‘è®¾å¤‡çš„æ“ä½œæ–¹æ³•é›†ï¼Œç³»ç»Ÿè°ƒç”¨é€šè¿‡å®ƒæ‰¾åˆ°å…·ä½“çš„å¤„ç†å‡½æ•°
- **private_data**ï¼šé©±åŠ¨ç¨‹åºçš„"ä¾¿ç­¾çº¸"ï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•è®¾å¤‡ç›¸å…³çš„ä¿¡æ¯

**å·¥ä½œæµç¨‹ç¤ºä¾‹**
- **ç”¨æˆ·ç¨‹åº**è°ƒç”¨`open("/dev/led", ...)`
- **å†…æ ¸**åˆ›å»ºä¸€ä¸ª`file`ç»“æ„ä½“
- **å†…æ ¸**å°†LEDè®¾å¤‡çš„`file_operations`èµ‹å€¼ç»™`f_op`
- **é©±åŠ¨ç¨‹åº**å¯èƒ½å°†LEDè®¾å¤‡ä¿¡æ¯çš„åœ°å€å­˜å…¥`private_data`
- **åç»­æ“ä½œ**ï¼ˆread/writeï¼‰éƒ½é€šè¿‡è¿™ä¸ª`file`ç»“æ„ä½“è¿›è¡Œ
- **å…³é—­æ–‡ä»¶**æ—¶ï¼Œå†…æ ¸é‡Šæ”¾è¿™ä¸ªç»“æ„ä½“

## 8 struct inodeï¼šç´¢å¼•èŠ‚ç‚¹

**VFS inodeç»“æ„ä½“**ï¼šLinuxæ–‡ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæ˜¯Linux ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„æœ€åŸºæœ¬å•ä½ï¼Œå°±åƒæ¯ä¸ªæ–‡ä»¶çš„â€œèº«ä»½è¯â€ï¼Œ`åŒ…å«äº†æ–‡ä»¶çš„æ‰€æœ‰åŸºæœ¬ä¿¡æ¯`

**inodeåŸºæœ¬ä¿¡æ¯**
- è®¿é—®æƒé™ï¼šè°èƒ½rã€wã€xè¿™ä¸ªæ–‡ä»¶
- å±ä¸»å’Œç»„ï¼šæ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±ç»„
- æ–‡ä»¶å¤§å°ï¼šæ–‡ä»¶å ç”¨çš„ç©ºé—´
- æ—¶é—´ä¿¡æ¯ï¼šåˆ›å»ºæ—¶é—´ã€è®¿é—®æ—¶é—´ã€ä¿®æ”¹æ—¶é—´ç­‰

**inode vs fileç»“æ„ä½“çš„å¯¹æ¯”**
- inodeï¼šæ–‡ä»¶çš„â€œæˆ·å£æœ¬â€ï¼Œå³æ–‡ä»¶æœ¬èº«çš„ä¿¡æ¯
- fileï¼šæ–‡ä»¶çš„â€œä½¿ç”¨è®°å½•â€ï¼Œå³æ‰“å¼€æ–‡ä»¶çš„æ“ä½œä¿¡æ¯
- å…³ç³»ï¼šä¸€ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ªinodeï¼Œä½†å¯ä»¥æœ‰å¤šä¸ªfileç»“æ„ä½“ï¼ˆå¤šæ¬¡æ‰“å¼€åŒä¸€æ–‡ä»¶ï¼‰

`inode`åŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼š
```c
// å†…æ ¸æºç /inlcude/linux/fs.h
struct inode{
	dev_t i_rdev;        // è®¾å¤‡å·
	{ ... }
	union{
		struct pipe_inode_info *i_pipe; //linuxå†…æ ¸ç®¡é“
		struct block_device *i_bdev; //å—è®¾å¤‡è®¾ç½®ä½¿ç”¨
		struct cdev *i_cdev;  // å­—ç¬¦è®¾å¤‡æŒ‡é’ˆ
		char *i_link;
		unsigned i_dir_seq;
	};
	{ ... }
};
```
- **i_rdev**ï¼šè·å–è®¾å¤‡å·ï¼ˆåŒ…å«ä¸»æ¬¡ï¼‰ï¼Œä»è€Œç¡®å®šæ“ä½œçš„æ˜¯å“ªä¸ªè®¾å¤‡
- **i_cdev**ï¼šè·å–è®¾å¤‡çš„cdevç»“æ„ä½“ï¼Œè¿›è€Œè·å–å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯

## 9 classï¼šè®¾å¤‡ç±»

åœ¨Linuxè®¾å¤‡é©±åŠ¨ä¸­ï¼Œ**classï¼ˆè®¾å¤‡ç±»ï¼‰** æ˜¯è®¾å¤‡æ¨¡å‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä¸ºè®¾å¤‡çš„åˆ†ç±»ç®¡ç†å’Œè‡ªåŠ¨èŠ‚ç‚¹åˆ›å»ºæä¾›äº†ç»Ÿä¸€çš„æ¡†æ¶

**struct class**ç»“æ„ä½“æ˜¯Linuxå†…æ ¸ä¸­ç”¨äºè®¾å¤‡åˆ†ç±»çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š
```c
// å†…æ ¸æºç /include/linux/device.h
struct class {
    const char *name;                           // ç±»åç§°
    struct module *owner;                       // æ‹¥æœ‰æ­¤ç±»çš„æ¨¡å—
    const struct attribute_group **class_groups; // ç±»å±æ€§ç»„
    const struct attribute_group **dev_groups;   // è®¾å¤‡å±æ€§ç»„
    struct kobject *dev_kobj;                   // è®¾å¤‡kobject
    
    int (*dev_uevent)(struct device *dev, struct kobj_uevent_env *env);
    char *(*devnode)(struct device *dev, umode_t *mode);
    void (*class_release)(struct class *cls);
    void (*dev_release)(struct device *dev);
    // ... å…¶ä»–æˆå‘˜
};
```
- **name**ï¼šç±»çš„åç§°ï¼Œä¼šåœ¨`/sys/class/`ä¸‹åˆ›å»ºå¯¹åº”ç›®å½•
- **owner**ï¼šæŒ‡å‘æ‹¥æœ‰æ­¤ç±»çš„å†…æ ¸æ¨¡å—ï¼Œé˜²æ­¢æ¨¡å—åœ¨ä½¿ç”¨æ—¶è¢«å¸è½½
- **dev_uevent**ï¼šè®¾å¤‡äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç”¨äºhotplugäº‹ä»¶
- **devnode**ï¼šè®¾å¤‡èŠ‚ç‚¹åç§°ç”Ÿæˆå‡½æ•°ï¼Œå¯è‡ªå®šä¹‰è®¾å¤‡èŠ‚ç‚¹çš„æƒé™å’Œåç§°
- **dev_release**ï¼šè®¾å¤‡é‡Šæ”¾æ—¶çš„æ¸…ç†å‡½æ•°

>[!tip]+ å½¢è±¡ç†è§£ 
  classå°±åƒæ˜¯"è®¾å¤‡æˆ·ç±ç®¡ç†éƒ¨é—¨"ï¼Œè´Ÿè´£å°†åŒç±»å‹çš„è®¾å¤‡è¿›è¡Œåˆ†ç±»ç™»è®°å’Œç»Ÿä¸€ç®¡ç†

**åˆ›å»ºè®¾å¤‡ç±»**
```c
// å†…æ ¸æºç /include/linux/device.h
#define class_create(owner, name) \
({ \
    static struct lock_class_key __key; \
    __class_create(owner, name, &__key); \
})

struct class *__class_create(struct module *owner, const char *name, struct lock_class_key *key);
```
- **owner**ï¼šé€šå¸¸è®¾ç½®ä¸º`THIS_MODULE`ï¼Œè¡¨ç¤ºå½“å‰æ¨¡å—æ‹¥æœ‰æ­¤ç±»
- **name**ï¼šç±»çš„åç§°ï¼Œå°†åœ¨`/sys/class/name`ä¸‹åˆ›å»ºç›®å½•
- **è¿”å›å€¼**ï¼šæˆåŠŸè¿”å›classæŒ‡é’ˆï¼Œå¤±è´¥è¿”å›ERR_PTR()

**é”€æ¯è®¾å¤‡ç±»**
```c
// å†…æ ¸æºç /drivers/base/class.c
void class_destroy(struct class *cls);
```
- **cls**ï¼šè¦é”€æ¯çš„classæŒ‡é’ˆï¼Œç”±class_createè¿”å›

> [!warning]+ æ³¨æ„äº‹é¡¹
> - å¿…é¡»åœ¨é”€æ¯classä¹‹å‰å…ˆé”€æ¯æ‰€æœ‰å±äºè¯¥classçš„è®¾å¤‡
> - class_destroyä¼šè‡ªåŠ¨æ¸…ç†ç›¸å…³çš„sysfsç›®å½•

## 10 è®¾å¤‡èŠ‚ç‚¹åˆ›å»ºæœºåˆ¶

### 10.1 è‡ªåŠ¨åˆ›å»ºvsæ‰‹åŠ¨åˆ›å»º

**1ã€æ‰‹åŠ¨åˆ›å»º**ï¼ˆä½¿ç”¨mknodå‘½ä»¤ï¼‰ï¼š
```bash
# è¯­æ³•ï¼šmknod è®¾å¤‡å è®¾å¤‡ç±»å‹ ä¸»è®¾å¤‡å· æ¬¡è®¾å¤‡å·
mknod /dev/my_device c 236 0
```
- è®¾å¤‡ç±»å‹ï¼š
	- pï¼šåˆ›å»ºå…ˆè¿›å…ˆå‡ºFIFOç‰¹æ®Šæ–‡ä»¶ï¼Œå¯ä»¥ä¸æŒ‡å®šä¸»æ¬¡è®¾å¤‡å·
	- bï¼šåˆ›å»ºæœ‰ç¼“å†²çš„åŒºå—ç‰¹æ®Šæ–‡ä»¶
	- cï¼Œuï¼šåˆ›å»ºæ²¡æœ‰ç¼“å†²çš„å­—ç¬¦ç‰¹æ®Šæ–‡ä»¶
- ä¸»æ¬¡è®¾å¤‡å·ï¼š
	- 0xæˆ–0Xå¼€å¤´ï¼šåå…­è¿›åˆ¶æ•°è§£æ
	- 0å¼€å¤´ï¼šå…«è¿›åˆ¶æ•°è§£æ
	- å…¶ä½™æƒ…å†µï¼šåè¿›åˆ¶æ•°è§£æ

**2ã€è‡ªåŠ¨åˆ›å»º**ï¼ˆæ¨èæ–¹å¼ï¼‰ï¼š
**device_createå‡½æ•°**
- åˆ›å»ºä¸€ä¸ªè®¾å¤‡å¹¶å°†å…¶æ³¨å†Œåˆ°æ–‡ä»¶ç³»ç»Ÿ
```c
// å†…æ ¸æºç /drivers/base/core.c
struct device *device_create(struct class *class,struct device *parent,dev_t devt,void *drvdata,const char *fmt,...)
```
- classï¼šæŒ‡å‘è®¾å¤‡åº”è¯¥æ³¨å†Œåˆ°çš„structç±»çš„æŒ‡é’ˆ
- parentï¼šæŒ‡å‘è®¾å¤‡çš„çˆ¶ç»“æ„è®¾å¤‡ï¼ˆå¦‚æœæœ‰ï¼‰çš„æŒ‡é’ˆ
- devtï¼šæ·»åŠ çš„charè®¾å¤‡å·
- drvdataï¼šè¦æ·»åŠ åˆ°è®¾å¤‡è¿›è¡Œå›è°ƒçš„æ•°æ®
- fmtï¼šè¾“å…¥è®¾å¤‡åç§°
- è¿”å›å€¼ï¼šæˆåŠŸ-struct deviceç»“æ„ä½“æŒ‡é’ˆï¼Œå¤±è´¥-ERR_PTR()

**device_destoryå‡½æ•°**
- åˆ é™¤è®¾å¤‡
```c
void device_destory(struct class *class,dev_t devt)
```
- classï¼šæŒ‡å‘æ­¤è®¾å¤‡çš„structç±»æŒ‡é’ˆ
- devtï¼šä»¥å‰æ³¨å†Œçš„è®¾å¤‡çš„å¼€å‘

> [!tip]+ å¼€å‘å»ºè®® 
> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨è‡ªåŠ¨åˆ›å»ºæ–¹å¼ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿è®¾å¤‡èŠ‚ç‚¹ä¸é©±åŠ¨çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´

### 10.2 åˆ›å»ºæœºåˆ¶

- åˆ›å»ºä¸€ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶æ—¶ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹inodeç»“æ„ä½“
- å°†è¯¥è®¾å¤‡çš„è®¾å¤‡ç¼–å·è®°å½•åœ¨æˆå‘˜i_rdev
- å°†æˆå‘˜f_opæŒ‡é’ˆæŒ‡å‘äº†def_chr_fopsç»“æ„ä½“

**å…·ä½“ä»£ç è§å¦‚ä¸‹ï¼š**
```c
// mknodè°ƒç”¨å…³ç³»ï¼ˆå†…æ ¸æºç /mm/shmem.cï¼‰
static struct inode *shmen_get_inode(struct super_block *sb,const struct inode *dir,umode_t mode,dev_t dev,unsigned long flags){
	inode = new_inode(sb);
	if(inode){
		......
		switch(mode & S_IFMT){
			default:
			inode->i_op = &shmen_special_inode_operations;
			// mknodå‘½ä»¤æœ€ç»ˆæ‰§è¡Œçš„å‡½æ•°
			init_special_inode(inode,mode,dev);
			break;
			......
		}
	}else{
		shmen_free_inode(sb);
	}
	return inode;
}
```

```c
// init_special_inodeå‡½æ•°ï¼ˆæºç /fs/inode.cï¼‰
void init_special_inode(struct inode *inode,umode_t mode,dev_t rdev){
	inode->i_mode = mode;
	// åˆ¤æ–­æ–‡ä»¶çš„inodeç±»å‹ï¼Œå¦‚æœæ˜¯å­—ç¬¦è®¾å¤‡ç±»å‹
	if(S_ISCHR(mode)){
		// def_chr_fopsä½œä¸ºè¯¥æ–‡ä»¶çš„æ“ä½œæ¥å£
		inode->i_fop = &def_chr_fops;
		// è®¾å¤‡å·è®°å½•
		inode->i_rdev = rdev;
	}else if(S_ISBLK(mode)){
		inode->i_fop = ^def_blk_fops;
		inode->i_rdev = rdev;
	}else if(S_ISFIFO(mode)){
		inode->i_fop = &pipefifo_fops;
	}else if(S_ISSOCK(mode))
		; /* leave it no_open_fops */
	else
		printk(KERN_DEBUG "init_special_inode: bogus i_mode (%o) for inode %s:%lu\n",mode,inode->i_sb->s_id,inode->i_ino);
}
```

> [!warning]+ æ³¨æ„
> - inodeä¸Šçš„file_operationså¹¶ä¸æ˜¯è‡ªå·±æ„é€ çš„ï¼Œè€Œæ˜¯å­—ç¬¦è®¾å¤‡é€šç”¨çš„ï¼ï¼
> - è‡ªå·±æ„å»ºçš„file_operationsæ˜¯åœ¨åº”ç”¨ç¨‹åºè°ƒç”¨openå‡½æ•°ä¹‹åï¼Œæ‰ä¼šç»‘å®šåœ¨æ–‡ä»¶ä¸Š

### 10.3 udev/mdevè‡ªåŠ¨åˆ›å»ºåŸç†

å½“é©±åŠ¨è°ƒç”¨`device_create`å‡½æ•°æ—¶ï¼š
1. å†…æ ¸åœ¨`/sys/class/ç±»å/`ä¸‹åˆ›å»ºè®¾å¤‡ç›®å½•
2. **å†…æ ¸å‘é€ueventäº‹ä»¶**åˆ°ç”¨æˆ·ç©ºé—´
3. **udev/mdevå®ˆæŠ¤è¿›ç¨‹ç›‘å¬**åˆ°è®¾å¤‡åˆ›å»ºäº‹ä»¶
4. **è‡ªåŠ¨åœ¨/devç›®å½•**ä¸‹åˆ›å»ºå¯¹åº”çš„è®¾å¤‡æ–‡ä»¶ï¼ˆèŠ‚ç‚¹ï¼‰
5. **è®¾ç½®åˆé€‚çš„æƒé™**å’Œæ‰€æœ‰è€…

## 11 å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶

### 11.1 é©±åŠ¨å¼€å‘çš„æ ¸å¿ƒæ­¥éª¤

å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¼€å‘éµå¾ªå›ºå®šçš„æ¡†æ¶ï¼Œå¯ä»¥æ€»ç»“ä¸º"ä¸ƒæ­¥éª¤"ï¼š
```txt
1. ç”³è¯·è®¾å¤‡å·     â†’ è·å–è®¾å¤‡çš„èº«ä»½è¯å·
2. å®ç°fops      â†’ ç¼–å†™è®¾å¤‡è¯´æ˜ä¹¦
3. åˆå§‹åŒ–cdev     â†’ å‡†å¤‡è®¾å¤‡æ¡£æ¡ˆ
4. æ³¨å†Œcdev      â†’ å‘å†…æ ¸ç™»è®°è®¾å¤‡
5. åˆ›å»ºè®¾å¤‡ç±»     â†’ å»ºç«‹è®¾å¤‡åˆ†ç±»
6. åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹   â†’ ç”Ÿæˆ/devä¸‹çš„æ–‡ä»¶
7. ç¡¬ä»¶åˆå§‹åŒ–     â†’ é…ç½®å…·ä½“ç¡¬ä»¶
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/8a92c610bdd77ed9af37d8356b0454f2.png)

### 11.2 openå‡½æ•°

åœ¨Linuxä¸­ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªè®¾å¤‡ï¼ˆæ¯”å¦‚LEDã€ä¼ æ„Ÿå™¨ç­‰ï¼‰ä¹‹å‰ï¼Œéƒ½éœ€è¦å…ˆæ‰“å¼€å®ƒï¼Œopenå‡½æ•°å°±æ˜¯åšè¿™ä¸ªå·¥ä½œçš„

**ç®€å•ç†è§£**ï¼šopenå‡½æ•°å°±åƒæ˜¯è·å–è®¾å¤‡çš„â€œé’¥åŒ™â€ï¼Œæœ‰äº†è¿™æŠŠé’¥åŒ™ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œæˆ‘ä»¬æ‰èƒ½å¯¹è®¾å¤‡è¿›è¡Œè¯»å†™æ“ä½œ

**openå‡½æ•°çš„æ‰§è¡Œæµç¨‹**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/c33cdcc030c705bc73fdab80eff7267e.png)

åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨ `int fd = open("dev/xxx",O_RDWR)`æ—¶ï¼Œç³»ç»Ÿå†…éƒ¨å‘ç”Ÿäº†ä¸€ä¸‹è¿‡ç¨‹ï¼š
**ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°è®¾å¤‡æ–‡ä»¶**
- ç³»ç»Ÿåœ¨VFSä¸­æŸ¥æ‰¾ `/dev/xxx` è¿™ä¸ªè®¾å¤‡æ–‡ä»¶
- æ‰¾åˆ°å¯¹åº”çš„ `inode` èŠ‚ç‚¹
**ç¬¬äºŒæ­¥ï¼šæ ¹æ®è®¾å¤‡å·æ‰¾åˆ°è®¾å¤‡å¯¹è±¡**
- ä» `inode` ä¸­è·å–è®¾å¤‡å·ï¼ˆæ­¤å·å¯¹äºæ¯ä¸ªè®¾å¤‡å”¯ä¸€ï¼‰
- é€šè¿‡è®¾å¤‡å·åœ¨ `cdev_map` æ•£åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ `cdev` å¯¹è±¡
- `cdev` å°±æ˜¯è¿™ä¸ªå­—ç¬¦è®¾å¤‡åœ¨å†…æ ¸ä¸­çš„ä»£è¡¨
**ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ–‡ä»¶å¯¹è±¡**
- ç³»ç»Ÿåˆ›å»ºä¸€ä¸ª `struct file` å¯¹è±¡
- è¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬å’Œè®¾å¤‡ä¹‹é—´çš„æ¡¥æ¢
- ç³»ç»Ÿç”¨ä¸€ä¸ªæ•°ç»„ç®¡ç†è¿›ç¨‹ä¸­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦å°±æ˜¯æ•°ç»„çš„ä¸‹æ ‡
**ç¬¬å››æ­¥ï¼šå»ºç«‹è¿æ¥**
- å°† `file` å¯¹è±¡çš„æ“ä½œæ–¹æ³•æŒ‡é’ˆæŒ‡å‘ `cdev` ä¸­çš„æ“ä½œæ–¹æ³•
- ç®€å•è¯´å°±æ˜¯ï¼š`file->fops=cdev->fops`
- è¿™æ ·é€šè¿‡æ–‡ä»¶æè¿°ç¬¦å°±èƒ½è°ƒç”¨åˆ°è®¾å¤‡çš„å…·ä½“æ“ä½œäº†
**ç¬¬äº”æ­¥ï¼šè°ƒç”¨è®¾å¤‡çš„openå‡½æ•°**
- æœ€åè°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­çš„ `open` å‡½æ•°
- è¿™ä¸ªå‡½æ•°é€šå¸¸ç”¨äºåˆå§‹åŒ–è®¾å¤‡ã€ç”³è¯·èµ„æºç­‰

> [!note]+ ç†è§£è¦ç‚¹ 
> openå‡½æ•°çš„æ ¸å¿ƒä½œç”¨æ˜¯å»ºç«‹ä»ç”¨æˆ·ç¨‹åºåˆ°è®¾å¤‡é©±åŠ¨çš„"é€šä¿¡é“¾è·¯"ï¼Œåç»­çš„read/writeæ“ä½œéƒ½é€šè¿‡è¿™ä¸ªé“¾è·¯è¿›è¡Œ

### 11.3 openå‡½æ•°å…³é”®ä»£ç è§£æ

> [!tip]+ cdevå’Œinodeçš„ç»“æ„ä½“å®šä¹‰
> - ä¸ºäº†ä¸è¦çœ‹è¿·ç³Šäº†ï¼Œè¿™é‡Œè´´å‡ºæ¥
>   ![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/52849a80eacb7573d094a03485ece3f9.png)

openå‡½æ•°åœ¨å†…æ ¸ä¸­å¯¹åº”çš„æ˜¯sys_openå‡½æ•°

**sys_open -> do_sys_open æµç¨‹**
```c
// 1. è·å–ä¸€ä¸ªæœªä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦
fd = get_unused_fd_flags();
// 2. æ‰“å¼€æ–‡ä»¶ï¼Œåˆ›å»ºfileç»“æ„ä½“
do_file_open();
â””â”€â”€ do_dentry_open(); // æ ¸å¿ƒå‡½æ•°
```

**do_dentry_openå‡½æ•°å…³é”®æ“ä½œ**
```c
// å†…æ ¸æºç /fs/open.c
static int do_dentry_open(struct file *f,struct inode *inode,...){
	// è·å–è®¾å¤‡æ–‡ä»¶çš„æ“ä½œæ–¹æ³•é›†åˆ
	f->f_op = fops_get(inode->i_fop); //ä¸€èˆ¬æ˜¯def_chr_fops
	// å¦‚æœæœ‰openå‡½æ•°åˆ™è°ƒç”¨
	if(f->f_op->open){
		error = f->f_op->open(inode,f); // è°ƒç”¨chrdev_open
	}
}
```

**å­—ç¬¦è®¾å¤‡é€šç”¨æ“ä½œé›†åˆ**
```c
// å†…æ ¸æºç /fs/char_dev.c
const struct file_operations def_chr_fops = {
	.open = chrdev_open, // å­—ç¬¦è®¾å¤‡é€šç”¨çš„openå‡½æ•° 
	.llseek = noop_llseek,
}
```

**chrdev_openå‡½æ•°çš„æ ¸å¿ƒå·¥ä½œ**
```c fold
// å†…æ ¸æºç /fs/char_dev.c
static int chrdev_open(struct inode *inode,struct file *filp){
	const struct file_operations *fops;
	struct cdev *p;
	struct cdev *new = NULL;
	int ret = 0;
	spin_lock(&cdev_lock);
	// ä¿å­˜å­—ç¬¦è®¾å¤‡çš„è®¾å¤‡ç¼–å·
	p = inode->i_cdev;
	if(!p){
		struct kobject *kobj;
		int idx;
		spin_unlock(&cdev_lock);
		// æ ¹æ®è®¾å¤‡å·æ‰¾åˆ°å¯¹åº”çš„cdevç»“æ„ä½“å’Œkobjæˆå‘˜
		kobj = kobj_lookup(cdev_map,inode->i_rdev,&idx);
		if(!kobj)
			return -ENXIO;
		// é€šè¿‡ç»“æ„å˜é‡kobjçš„åœ°å€ï¼Œæ‰¾åˆ°åŒ…å«å®ƒçš„cdevç»“æ„ä½“çš„é¦–åœ°å€
		new = container_of(kobj,struct cdev,kobj);
		spin_lock(&cdev_lock);
		p = inode->i_cdev;
		if(!p){
			// åŒæ—¶å°†cdevç»“æ„ä½“è®°å½•åˆ°æ–‡ä»¶èŠ‚ç‚¹inodeä¸­çš„i_cdev
			inode->i_cdev = p = new;
			list_add(&&inode->i_devices,&p->list);
			new = NULL;
		}else if(!cdev_get(p))
			ret = -ENXIO;
	}else if(!cdev_get(p))
		ret = -ENXIO;
	spin_unlock(&cdev_lock);
	cdev_put(new);
	if(ret)
		return ret;
	ret = -ENXIO;
	// 2.è·å–è®¾å¤‡çš„æ“ä½œæ–¹æ³•
	fops = fops_get(p->ops);
	if(!fops)
	goto out_cdev_put;

	// 3. æ›¿æ¢fileæ“ä½œæ–¹æ³•ä¸ºè®¾å¤‡ç‰¹å®šæ–¹æ³•
	replact_fops(flip,fops);
	// 4.è°ƒç”¨è®¾å¤‡é©±åŠ¨çš„openå‡½æ•°
	if(flip->f_op->open){
		ret = flip->f_op->open(inode,filp);
		if(ret)
			goto out_cdev_put;
	}

	return 0;

	out_cdev_put;
	cdev_put(p);
	return ret;
}
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/10afd84b38b391b26dd4c57c70d5e416.png)

æœ€åè°ƒç”¨fd_installå‡½æ•°ï¼Œå®Œæˆæ–‡ä»¶æè¿°ç¬¦å’Œæ–‡ä»¶ç»“æ„ä½“fileçš„å…³è”
- ä¹‹åæˆ‘ä»¬ä½¿ç”¨fdè°ƒç”¨readã€writeå‡½æ•°ï¼›æœ€ç»ˆéƒ½ä¼šè°ƒç”¨fileç»“æ„ä½“å¯¹åº”çš„å‡½æ•°
- æœ¬è´¨ï¼šè°ƒç”¨cdevç»“æ„ä½“ä¸­opsç»“æ„ä½“å†…çš„ç›¸å…³å‡½æ•°


## 12 å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºå®éªŒ(å®é™…åº”ç”¨)

### 12.1 ç¡¬ä»¶ä»‹ç»

ä½¿ç”¨æ¿å¡ä¸º Lubancat2 - RK3568æ¿å¡

### 12.2 å®éªŒä»£ç è®²è§£

ç»“åˆå‰é¢æ‰€æœ‰çš„çŸ¥è¯†ç‚¹ï¼Œéœ€è¦çŸ¥é“å¦‚ä¸‹å†…å®¹
1. å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯ä»¥å†…æ ¸æ¨¡å—çš„å½¢å¼å­˜åœ¨çš„ï¼ï¼ï¼
2. å‘ç³»ç»Ÿæ³¨å†Œä¸€ä¸ªæ–°çš„å­—ç¬¦è®¾å¤‡ï¼Œéœ€è¦å¦‚ä¸‹å‡ æ ·ä¸œè¥¿
	- å­—ç¬¦è®¾å¤‡ç»“æ„ä½“cdev
	- è®¾å¤‡ç¼–å·devno
	- ä»¥åŠæœ€æœ€æœ€æœ€æœ€æœ€é‡è¦çš„æ“ä½œæ–¹å¼ç»“æ„ä½“file_operations
3. æœ€åï¼Œå®éªŒè®¾å¤‡æ–‡ä»¶éœ€è¦æ‰‹åŠ¨mknodåˆ›å»º

**1ã€å†…æ ¸æ¨¡å—æ¡†æ¶ä»£ç **
```c
#include <linux/cdev.h>
#include <linux/fs.h>
#include <linux/init.h>
#include <linux/module.h>
#include <linux/uaccess.h>

#define DEV_NAME "DKCharDev"
#define DEV_CNT (1)
#define BUFF_SIZE 128

// å®šä¹‰å­—ç¬¦è®¾å¤‡çš„ç¼–å·
static dev_t devno;
// å®šä¹‰å­—ç¬¦è®¾å¤‡ç»“æ„ä½“
static struct cdev chr_dev;
static int __init chrdev_init() {
    int ret = 0;
    printk("chrdev init\n");
    // 1.1 åŠ¨æ€åˆ†é…çš„æ–¹å¼ï¼Œè·å–è®¾å¤‡ç¼–å·ï¼Œæ¬¡è®¾å¤‡å·ä¸º0
    // 1.2 è®¾å¤‡åç§°ä¸ºä»€ä¹ˆDKCharDevï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ cat /proc/devicesæŸ¥çœ‹
    // 1.3 DEV_CNTä¸º1,è¡¨ç¤ºåªç”³è¯·ä¸€ä¸ªè®¾å¤‡ç¼–å·
    ret = alloc_chrdev_region(&devno, 0, DEV_CNT, DEV_NAME);
    if (ret < 0) {
        printk("fail to alloc devno\n");
        // ä½¿ç”¨gotoè¯­æ³•ï¼Œç›´æ¥è¿”å›å¯¹åº”çš„é”™è¯¯ç 
        goto alloc_err;
    }
    // 2.1 å…³è”å­—ç¬¦è®¾å¤‡ç»“æ„ä½“cdevä¸æ–‡ä»¶æ“ä½œç»“æ„ä½“file_operations
    // 2.2 è¿™é‡Œfile_operationsè¿˜æ²¡æœ‰å®šä¹‰ï¼Œä¸‹ä¸€èŠ‚è§åˆ†æ™“
    cdev_init(&chr_dev, &chr_dev_fops);
    // 3 æ·»åŠ è®¾å¤‡åˆ°cdev_mapæ•£åˆ—è¡¨ä¸­
    ret = cdev_add(&chr_dev, devno, DEV_CNT);
    if (ret < 0) {
        printk("fail to add cdev\n");
        goto add_err;
    }
    return 0;

	// æ³¨æ„ä¸‹é¢æ˜¯è¿ç»­æ‰§è¡Œçš„ï¼ï¼ï¼ï¼ï¼
    add_err:
    // æ·»åŠ è®¾å¤‡å¤±è´¥æ—¶ï¼Œéœ€è¦æ³¨é”€è®¾å¤‡å·
    unregister_chrdev_region(devno, DEV_CNT);
    alloc_err:
    return ret;
}

static void __exit chrdev_exit(){
    printk("chrdev exit\n");
    unregister_chrdev_region(devno, DEV_CNT);
    cdev_del(&chr_dev);
}

module_init(chrdev_init);
module_exit(chrdev_exit);

MODULE_LICENSE("GPL2");
MODULE_AUTHOR("dalll");
MODULE_DESCRIPTION("chrdev module");
MODULE_ALIAS("chrdev module");
```

**2ã€æ–‡ä»¶æ“ä½œæ–¹å¼çš„å®ç°**

```c
#define BUFF_SIZE 128
// æ•°æ®ç¼“å†²åŒº
static char vbuf[BUFF_SIZE];
// è™šæ‹Ÿçš„è®¾å¤‡ï¼Œæ— ç›¸å…³ç¡¬ä»¶ï¼Œå› æ­¤ç›¸å…³å‡½æ•°å¦‚ä¸‹
static int chr_dev_open(struct inode *inode,struct file *filp);
static int chr_dev_release(struct inode *inode,struct file *flip);
static ssize_t chr_dev_write(struct file *flip,const char __user *buf,size_t count,loff_t *ppos);
static ssize_t chr_dev_read(struct file *flip,char __user *buf,size_t count,loff_t *ppos);

static struct file_operations chr_dev_fops = {
    .owner = THIS_MODULE,
    .open = chr_dev_open,
    .release = chr_dev_release,
    .write = chr_dev_write,
    .read = chr_dev_read,
};
```

ç”±äºè¿™ä¸ªå­—ç¬¦è®¾å¤‡æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è®¾å¤‡ï¼Œä¸ç¡¬ä»¶æ²¡æœ‰ä»€ä¹ˆå…³è”ï¼Œå› æ­¤ï¼Œopenå’Œreleaseå‡½æ•°ç›´æ¥è¿”å›0å³å¯
```c
/**
 * è®¾å¤‡æ‰“å¼€å‡½æ•°å®ç°
 * @inode: ç´¢å¼•èŠ‚ç‚¹ï¼ŒåŒ…å«è®¾å¤‡ä¿¡æ¯
 * @flip:æ–‡ä»¶æŒ‡é’ˆï¼Œä»£è¡¨æ‰“å¼€çš„æ–‡ä»¶
 * @return: 0è¡¨ç¤ºæˆåŠŸï¼Œå¤±è´¥è¿”å›è´Ÿæ•°é”™è¯¯ç 
 */
static int chr_dev_open(struct inode *inode, struct file *filp){
    printk("\nopen\n");
    return 0;
}
/**
 * åŒä¸Š
 */
static int chr_dev_release(struct inode *inode,struct file *flip){
    printk("\nrelease\n");
    return 0;
}
```

æˆ‘ä»¬é‡ç‚¹å…³æ³¨writeå’Œreadå‡½æ•°
```c
/**
 * è®¾å¤‡å†™å…¥å‡½æ•°å®ç° - å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®å†™å…¥åˆ°è®¾å¤‡ç¼“å†²åŒº
 * @filp:æ–‡ä»¶æŒ‡é’ˆ
 * @buf:ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºæŒ‡é’ˆ
 * @count:è¦å†™å…¥çš„å­—èŠ‚æ•°
 * @ppos:æ–‡ä»¶ä½ç½®æŒ‡é’ˆçš„åœ°å€
 * @return:å®é™…å†™å…¥çš„å­—èŠ‚æ•°
 */
static ssize_t chr_dev_write(struct file *filp,const char __user *buf,size_t count,loff_t *ppos){
    // è·å–å½“å‰æ–‡ä»¶çš„è¯»å†™ä½ç½®
    unsigned long p = *ppos;
    // ç”¨äºå­˜å‚¨copy_from_userçš„è¿”å›å€¼
    int ret;
    // å®é™…è¦å†™å…¥çš„å­—èŠ‚æ•°
    int tmp = count;
    // æ£€æŸ¥å†™å…¥ä½ç½®æ˜¯å¦è¶…å‡ºç¼“å†²åŒºèŒƒå›´
    if(p > BUFF_SIZE)
        // ä½ç½®è¶…å‡ºèŒƒå›´ï¼Œè¿”å›0è¡¨ç¤ºæ— æ³•å†™å…¥
        return 0;
    // æ£€æŸ¥è¦å†™å…¥çš„ä½ç½®æ˜¯å¦ä¼šè¶…å‡ºç¼“å†²åŒºå‰©ä½™ç©ºé—´
    if(tmp > BUFF_SIZE - p){
        // è°ƒæ•´ä¸ºç¼“å†²åŒºå‰©ä½™ç©ºé—´å¤§å°
        tmp = BUFF_SIZE - p;
    }
    // copy_from_user: ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ®åˆ°å†…æ ¸ç©ºé—´
    // å‚æ•°ï¼šç›®æ ‡åœ°å€(å†…æ ¸), æºåœ°å€(ç”¨æˆ·), å­—èŠ‚æ•°
    // è¿”å›å€¼ï¼šæœªæˆåŠŸå¤åˆ¶çš„å­—èŠ‚æ•°ï¼Œ0è¡¨ç¤ºå…¨éƒ¨æˆåŠŸå¤åˆ¶
    ret = copy_from_user(vbuf+p,buf,tmp);
    // æ›´æ–°æ–‡ä»¶ä½ç½®æŒ‡é’ˆ
    *ppos += tmp;
    return tmp;
}
/**
 * åŒä¸Š
 */
static ssize_t chr_dev_read(struct file *filp,char __user *buf,size_t count,loff_t *ppos){
    unsigned long p = *ppos;
    int ret;
    int tmp = count;
    if(p>=BUFF_SIZE)
        return 0;
    if(tmp > BUFF_SIZE - p)
        tmp = BUFF_SIZE - p;
    ret = copy_to_user(buf,vbuf+p,tmp);
    *ppos += tmp;
    return tmp;
}
```

> [!warning]+ ç†è§£è¯¯åŒº
> å®é™…ä¸Šå†™å’Œè¯»çš„æ—¶å€™ï¼Œéƒ½æ˜¯å…ˆå†™è¯»åœ¨ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯æ–‡ä»¶ä½ç½®ï¼ï¼ï¼
> - p = ç”¨æˆ·è®¤ä¸ºçš„æ–‡ä»¶åç§»ä½ç½®
> - vbuf = å®é™…å­˜å‚¨æ•°æ®çš„ç¼“å†²åŒº
> - BUFF_SIZE = ç¼“å†²åŒºçš„å®é™…å¤§å°é™åˆ¶

**3ã€ç®€å•æµ‹è¯•ç¨‹åº**

ä¸‹é¢æˆ‘ä»¬å¼€å§‹ç¼–å†™åº”ç”¨ç¨‹åºï¼Œæ¥è¯»å†™æˆ‘ä»¬çš„å­—ç¬¦è®¾å¤‡
```c
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>

char *wbuf = "Hello World\n";
char rbuf[128];

int main(){
    printf("DKCharDev test!\n");
    //æ‰“å¼€æ–‡ä»¶
    int fd = open("/dev/chrdev",O_RDWR);
    //å†™å…¥æ•°æ®
    write(fd,wbuf,strlen(wbuf));
    //å†™å…¥å®Œæ¯•ï¼Œå…³é—­æ–‡ä»¶
    close(fd);
    //æ‰“å¼€æ–‡ä»¶
    fd = open("/dev/chrdev",O_RDWR);
    //è¯»å–æ–‡ä»¶å†…å®¹
    read(fd,rbuf,128);
    //æ‰“å°è¯»å–çš„å†…å®¹
    printf("The content : %s \n",rbuf);
    //è¯»å–å®Œæ¯•ï¼Œå…³é—­æ–‡ä»¶
    close(fd);
    return 0;
}
```

### 12.3 å®éªŒå‡†å¤‡

**1ã€makefileä¿®æ”¹è¯´æ˜**
```makefile
KERNEL_DIR = ../../../kernel

ARCH=arm64
CROSS_COMPILE=aarch64-linux-gnu-
export ARCH CROSS_COMPILE

# ç¼–è¯‘æˆæ¨¡å—çš„ç›®æ ‡æ–‡ä»¶å
obj-m := chrdev.o
# ç¼–è¯‘æˆæµ‹è¯•ç¨‹åºçš„ç›®æ ‡æ–‡ä»¶å
out = chrdev_test

all:
	$(MAKE) -C $(KERNEL_DIR) M=$(CURDIR) modules
	$(CROSS_COMPILE)gcc -o $(out) main.c

.PHONY: clean
clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(CURDIR) clean
	rm -f $(out)
```

**2ã€ç¼–è¯‘å‘½ä»¤è¯´æ˜**
```shell
#ä½¿ç”¨äº†ä½ç‰ˆæœ¬çš„äº¤å‰ç¼–è¯‘å™¨
#bearç”¨äºç”Ÿæˆclangdç´¢å¼•æ—¶éœ€è¦çš„compile_command.jsonæ–‡ä»¶
bear -- make CC=aarch64-linux-gnu-gcc-9 -j8
#å¦‚æœæœ¬èº«å°±æ˜¯ä½ç‰ˆæœ¬çš„äº¤å‰ç¼–è¯‘å™¨
bear --make
```

ç¼–è¯‘æˆåŠŸåï¼Œå®éªŒç›®å½•ä¸‹ä¼šç”Ÿæˆä¸¤ä¸ªåä¸ºâ€chrdev.koâ€é©±åŠ¨æ¨¡å—æ–‡ä»¶å’Œâ€ chrdev_testâ€æµ‹è¯•ç¨‹åº
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/66c4bcfefc73dc9b3ef36d7019969e13.png)

### 12.4 ç¨‹åºè¿è¡Œç»“æœ

å°†koæ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿ä¸Šï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
```shell
sudo insmod chrdev.ko

cat /proc/devices
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/79c47b6d9f4d99c675b61e69f743bf26.png)

åœ¨/proc/devicesæ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ³¨å†Œçš„å­—ç¬¦è®¾å¤‡DKCharDevï¼Œå®ƒçš„ä¸»è®¾å¤‡å·æ˜¯236ï¼Œ**æ³¨æ„ï¼šæ­¤ä¸»è®¾å¤‡å·åé¢ä¼šç”¨åˆ°**

ç»§ç»­å®éªŒï¼Œä»¥rootæƒé™ä½¿ç”¨mknodå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è®¾å¤‡chrdev
```shell
sudo mknod /dev/chrdev c 236 0
```
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/61e66f458a86c8bfebff358d4ed34fe2.png)

ä»¥rootæƒé™è¿è¡Œchrdev_testï¼Œæ•ˆæœå¦‚ä¸‹
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/aae093fc6a36ef89f746097ff4e10f0b.png)

> [!warning]+ æ³¨æ„
> å¦‚æœå‡ºç°GLIBCåº“ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºé™æ€ç¼–è¯‘åº”ç”¨ç¨‹åº
> - æŠ¥é”™å¦‚ä¸‹
>   ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/6847ddc5a410cacacc0fe204b4ea373d.png)
> - ä¿®æ”¹å¦‚ä¸‹
>   ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a2179c735ee210ba1b6d632ee22a5c06.png)

ä¹Ÿå¯ä»¥é€šè¿‡echoæˆ–catå‘½ä»¤ï¼Œæ¥æµ‹è¯•æˆ‘ä»¬çš„è®¾å¤‡é©±åŠ¨ç¨‹åº
```shell
echo "DKCharDev test" > /dev/chrdev
# æ²¡æœ‰suæƒé™ï¼Œä¹Ÿå¯ä»¥è¿™æ ·ä½¿ç”¨
sudo sh -c "echo 'DKCharDev test' > /dev/chrdev"
# éªŒè¯å¦‚ä¸‹
cat /dev/chrdev
```

å½“æˆ‘ä»¬ä¸éœ€è¦è¯¥å†…æ ¸æ¨¡å—çš„æ—¶å€™ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
```shell
# å¸è½½å†…æ ¸æ¨¡å—
rmmod chrdev.ko
# åˆ é™¤å¯¹åº”çš„è®¾å¤‡æ–‡ä»¶
rm /dev/chrdev
```

## 13 æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 13.1 å‡å°‘å†…å­˜æ‹·è´

> [!tip]+ ä¼˜åŒ–æŠ€å·§1ï¼šä½¿ç”¨ç¯å½¢ç¼“å†²åŒº å¯¹äºé¢‘ç¹è¯»å†™çš„è®¾å¤‡ï¼Œä½¿ç”¨ç¯å½¢ç¼“å†²åŒºå¯ä»¥æé«˜æ•ˆç‡
> 
> ```c
> struct ring_buffer {
>     char *buffer;
>     int head;
>     int tail;
>     int size;
> };
> ```

### 13.2 å¹¶å‘æ§åˆ¶

> [!tip]+ ä¼˜åŒ–æŠ€å·§2ï¼šåˆç†ä½¿ç”¨é”æœºåˆ¶
> 
> ```c
> struct my_device {
>     struct mutex lock;          // äº’æ–¥é”
>     wait_queue_head_t read_wait; // è¯»ç­‰å¾…é˜Ÿåˆ—
>     wait_queue_head_t write_wait; // å†™ç­‰å¾…é˜Ÿåˆ—
> };
> ```

### 13.3 ä¸­æ–­æ”¯æŒ

> [!tip]+ ä¼˜åŒ–æŠ€å·§3ï¼šæ”¯æŒéé˜»å¡IO
> 
> ```c
> static ssize_t device_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)
> {
>     if (file->f_flags & O_NONBLOCK) {
>         // éé˜»å¡æ¨¡å¼å¤„ç†
>         if (!data_available())
>             return -EAGAIN;
>     } else {
>         // é˜»å¡æ¨¡å¼å¤„ç†
>         wait_event_interruptible(read_wait, data_available());
>     }
>     
>     // æ­£å¸¸è¯»å–æ•°æ®
>     return actual_read_data(buf, count);
> }
> ```

## 14 è°ƒè¯•æŠ€å·§

### 14.1 ä½¿ç”¨printkè¿›è¡Œè°ƒè¯•

```c
// æ ¹æ®è°ƒè¯•çº§åˆ«è¾“å‡ºä¿¡æ¯
printk(KERN_DEBUG "è°ƒè¯•ä¿¡æ¯: %s\n", debug_info);
printk(KERN_INFO "æ™®é€šä¿¡æ¯: %d\n", value);
printk(KERN_WARNING "è­¦å‘Šä¿¡æ¯: %s\n", warning_msg);
printk(KERN_ERR "é”™è¯¯ä¿¡æ¯: %d\n", error_code);
```

### 14.2 åŠ¨æ€è°ƒè¯•

```c
// ä½¿ç”¨åŠ¨æ€è°ƒè¯•
#define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
#include <linux/printk.h>

// åœ¨ä»£ç ä¸­ä½¿ç”¨
pr_debug("è°ƒè¯•ä¿¡æ¯: è®¾å¤‡ID=%d\n", device_id);
pr_info("è®¾å¤‡åˆå§‹åŒ–å®Œæˆ\n");
pr_err("åˆå§‹åŒ–å¤±è´¥: %d\n", ret);
```

### 14.3 ä½¿ç”¨debugfs

```c
#include <linux/debugfs.h>

static struct dentry *debug_dir;
static int debug_value = 0;

static int __init driver_init(void)
{
    // åˆ›å»ºdebugfsç›®å½•
    debug_dir = debugfs_create_dir("my_driver", NULL);
    
    // åˆ›å»ºè°ƒè¯•æ–‡ä»¶
    debugfs_create_int("debug_value", 0644, debug_dir, &debug_value);
    
    return 0;
}
```

## 15 æœ¬ç« æ€»ç»“

å­—ç¬¦è®¾å¤‡é©±åŠ¨æ˜¯Linuxé©±åŠ¨å¼€å‘çš„åŸºç¡€ï¼ŒæŒæ¡äº†å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¼€å‘æ–¹æ³•ï¼Œå°±ä¸ºå­¦ä¹ æ›´å¤æ‚çš„é©±åŠ¨ç¨‹åºå¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
