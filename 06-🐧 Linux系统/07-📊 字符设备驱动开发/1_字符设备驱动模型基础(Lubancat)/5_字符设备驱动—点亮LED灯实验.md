---
æ–‡ç« æ ‡é¢˜: "[[5_å­—ç¬¦è®¾å¤‡é©±åŠ¨â€”ç‚¹äº®LEDç¯å®éªŒ]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  æœ¬æ–‡ä»‹ç»Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨å¼€å‘å®æˆ˜ï¼Œé€šè¿‡ç‚¹äº®LEDç¯å®éªŒè®²è§£äº†MMUã€åœ°å€è½¬æ¢ã€å¯„å­˜å™¨æ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¶æä¾›äº†å®Œæ•´çš„é©±åŠ¨ç¨‹åºä»£ç å®ç°ã€‚
tags:
  - Linuxé©±åŠ¨
  - å­—ç¬¦è®¾å¤‡
  - LEDæ§åˆ¶
  - MMU
  - ioremap
  - GPIO
  - å¯„å­˜å™¨æ“ä½œ
  - è®¾å¤‡æ ‘
ç›¸å…³æ–‡ç« :
  - "[[7_å¹³å°è®¾å¤‡é©±åŠ¨]]"
  - "[[5_ç‚¹äº®LED]]"
  - "[[6_STM32CubeMXå®ç°HALç‚¹ç¯]]"
  - "[[7_GPIOè¾“å…¥æŒ‰é”®]]"
  - "[[../../08-ğŸ—ï¸ Linuxè®¾å¤‡æ¨¡å‹ä¸è®¾å¤‡æ ‘(é‡ç‚¹)/3_è®¾å¤‡æ ‘åŸºç¡€/å‚è€ƒå†…å®¹/è®¾å¤‡æ ‘çš„å¼•è¿›å’Œä½“éªŒ]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/03-ğŸ“Š å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¨¡å‹/1_å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¨¡å‹åŸºç¡€(Lubancat)/5_å­—ç¬¦è®¾å¤‡é©±åŠ¨â€”ç‚¹äº®LEDç¯å®éªŒ.md
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2025-06-10 20:34:00
ä¿®æ”¹æ—¶é—´: 2025-06-11 13:53:14
---

ç»è¿‡ä¸Šä¸¤ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å·²ç»äº†è§£å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºçš„åŸºæœ¬æ¡†æ¶ï¼Œä¸»è¦æ˜¯æŒæ¡äº†å¦‚ä¸‹å†…å®¹ï¼š
- å¦‚ä½•ç”³è¯·å’Œé‡Šæ”¾è®¾å¤‡å·ï¼ˆalloc_chrdev_regionã€unregister_chrdev_regionï¼‰
- å…³è”/åˆå§‹åŒ–è®¾å¤‡ï¼ˆcdev_initï¼‰
- æ·»åŠ ä»¥åŠæ³¨é”€è®¾å¤‡ï¼ˆcdev_addã€cdev_delï¼‰
**cdevå’Œfile_operationsç»“æ„ä½“éå¸¸é‡è¦ï¼ï¼ï¼**

æœ¬å°èŠ‚ï¼Œå°†åšä¸€ä¸ªå°å®éªŒ-ç‚¹äº®ledï¼Œå‰é¢å·²ç»é€šè¿‡æ“ä½œå¯„å­˜å™¨çš„æ–¹å¼ç‚¹äº®äº†LED[9.2 æ§åˆ¶å¿ƒè·³ç¯](../../../../02-ğŸ’»%20å¼€å‘ç¯å¢ƒ/3_Lubancat-RK3568/1_å¿«é€Ÿä½¿ç”¨æ‰‹å†Œ/1_å¿«é€Ÿå¼€å§‹.md#9.2%20æ§åˆ¶å¿ƒè·³ç¯)ï¼Œæœ¬èŠ‚å°†å­¦ä¹ ä¸€ä¸‹å¦‚ä½•åœ¨Linuxç¯å¢ƒä¸‹é©±åŠ¨LEDç¯

é¦–å…ˆï¼Œéœ€è¦æ˜ç™½ç›´æ¥æ“ä½œå¯„å­˜å™¨å’Œé€šè¿‡é©±åŠ¨ç¨‹åºç‚¹äº®LEDçš„åŒºåˆ«

## 1 è®¾å¤‡é©±åŠ¨çš„ä½œç”¨ä¸æœ¬è´¨

ç›´æ¥æ“ä½œå¯„å­˜å™¨ç‚¹äº®LED å’Œ é€šè¿‡é©±åŠ¨ç¨‹åºç‚¹äº®LED **æœ€æœ¬è´¨çš„åŒºåˆ«å°±æ˜¯æœ‰æ— ä½¿ç”¨æ“ä½œç³»ç»Ÿ**

æ“ä½œç³»ç»Ÿçš„å­˜åœ¨å¤§å¤§é™ä½äº†åº”ç”¨è½¯ä»¶ä¸ç¡¬ä»¶å¹³å°çš„è€¦åˆåº¦ï¼Œå……å½“äº†ç¡¬ä»¶å’Œåº”ç”¨è½¯ä»¶çš„çº½å¸¦ã€‚

åº”ç”¨è½¯ä»¶åªéœ€è¦è°ƒç”¨é©±åŠ¨ç¨‹åºæ¥å£APIå°±å¯ä»¥è®©ç¡¬ä»¶å»å®Œæˆè¦æ±‚çš„å¼€å‘ï¼Œä¸éœ€è¦å…³ç³»ç¡¬ä»¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™å°†å¤§å¤§æé«˜æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§å’Œå¼€å‘æ•ˆç‡

### 1.1 é©±åŠ¨çš„ä½œç”¨

è®¾å¤‡é©±åŠ¨å°±åƒç¡¬ä»¶è®¾å¤‡å’Œæ“ä½œç³»ç»Ÿä¹‹é—´çš„â€œç¿»è¯‘å®˜â€ï¼Œä¸»è¦ä½œç”¨æ˜¯è®©è½¯ä»¶èƒ½å¤Ÿæ§åˆ¶å’Œä½¿ç”¨å„ç§ç¡¬ä»¶è®¾å¤‡ã€‚

ç®€å•è¯´ï¼Œé©±åŠ¨ç¨‹åºå°±æ˜¯è®©æ“ä½œç³»ç»Ÿ"è®¤è¯†"å¹¶"ä½¿ç”¨"ç¡¬ä»¶è®¾å¤‡çš„æ¡¥æ¢ï¼Œæ²¡æœ‰é©±åŠ¨ç¨‹åºï¼Œå†å¥½çš„ç¡¬ä»¶ä¹Ÿæ— æ³•å·¥ä½œã€‚

**é©±åŠ¨çš„æ ¸å¿ƒå·¥ä½œ**
- ç›´æ¥æ“ä½œç¡¬ä»¶å¯„å­˜å™¨ï¼ŒæŒ‰ç…§è®¾å¤‡çš„å·¥ä½œæ–¹å¼è¿›è¡Œè¯»å†™
- å¤„ç†è®¾å¤‡çš„å„ç§é€šä¿¡æ–¹å¼ï¼šè½®è¯¢æ£€æŸ¥ã€ä¸­æ–­å“åº”ã€DMAæ•°æ®ä¼ è¾“
- è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œå°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€
- æœ€ç»ˆè®©è®¾å¤‡æ­£å¸¸å·¥ä½œï¼Œå¦‚ï¼šç½‘å¡æ”¶å‘æ•°æ®ã€æ˜¾ç¤ºå™¨æ˜¾ç¤ºç”»é¢ã€ç¡¬ç›˜å­˜å‚¨æ–‡ä»¶

**ä¸¤ç§å¼€å‘æ¨¡å¼**
- **è£¸æœºå¼€å‘ï¼ˆæ— OSï¼‰**
	- å·¥ç¨‹å¸ˆå¯ä»¥è‡ªç”±å®šä¹‰æ¥å£
	- æ¯”å¦‚æ§åˆ¶LEDç¯ï¼šç›´æ¥å†™LightOn()ã€LightOff()å‡½æ•°
- **ç³»ç»Ÿå¼€å‘ï¼ˆæœ‰OSï¼‰**
	- å¿…é¡»éµå¾ªæ“ä½œç³»ç»Ÿçš„æ¶æ„è§„èŒƒ
	- æ¯”å¦‚Linuxç³»ç»Ÿè¦æ±‚å®ç°file_operationsæ¥å£
	- è¿™æ ·é©±åŠ¨æ‰èƒ½æ­£ç¡®é›†æˆåˆ°å†…æ ¸ä¸­

### 1.2 æœ‰æ— æ“ä½œç³»ç»Ÿçš„åŒºåˆ«

**æ— æ“ä½œç³»ç»Ÿï¼ˆè£¸æœºï¼‰æ—¶çš„è®¾å¤‡é©±åŠ¨**ï¼šç›´æ¥å’Œç¡¬ä»¶â€œå¯¹è¯â€ï¼Œæ¯”è¾ƒç®€å•ç›´æ¥ï¼š
- ç›´æ¥æ“ä½œå¯„å­˜å™¨æ§åˆ¶ç¡¬ä»¶
- æ¯ä¸ªè®¾å¤‡é©±åŠ¨å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è½¯ä»¶æ¨¡å—
- åŒ…å«hæ–‡ä»¶ï¼ˆå®šä¹‰æ•°æ®ç»“æ„å’Œå‡½æ•°å£°æ˜ï¼‰å’Œcæ–‡ä»¶ï¼ˆå…·ä½“å®ç°ï¼‰
- å…¶ä»–æ¨¡å—è¦ç”¨è®¾å¤‡æ—¶ï¼Œç›´æ¥åŒ…å«å¤´æ–‡ä»¶è°ƒç”¨å‡½æ•°å³å¯
- STM32å¼€å‘å°±æ˜¯å…¸å‹ä¾‹å­ï¼Œç›¸å¯¹ç®€å•

**æœ‰æ“ä½œç³»ç»Ÿæ—¶çš„è®¾å¤‡é©±åŠ¨**ï¼šå¤æ‚ä¸€äº›ï¼Œé©±åŠ¨æˆäº†â€œä¸‰æ˜æ²»â€ç»“æ„ï¼š
- `åº•å±‚`ï¼šä»ç„¶éœ€è¦ç›´æ¥æ“ä½œç¡¬ä»¶çš„éƒ¨åˆ†ï¼ˆè¿™éƒ¨åˆ†å¿…ä¸å¯å°‘ï¼‰
- `ä¸Šå±‚`ï¼šå¿…é¡»æä¾›æ“ä½œç³»ç»Ÿè§„å®šçš„æ ‡å‡†æ¥å£
- æ‰€æœ‰åŒç±»è®¾å¤‡çš„é©±åŠ¨æ¥å£éƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œä¸ç®¡å…·ä½“æ˜¯ä»€ä¹ˆè®¾å¤‡

**æ“ä½œç³»ç»Ÿå¸¦æ¥çš„å¥½å¤„ï¼š**
- `å¤šä»»åŠ¡å¹¶å‘`ï¼šå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åº
- `å†…å­˜ç®¡ç†`ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„4GBå†…å­˜ç©ºé—´ï¼ˆ32ä½Linuxï¼‰
- `ç»Ÿä¸€æ¥å£`ï¼šåº”ç”¨ç¨‹åºç”¨åŒæ ·çš„æ–¹å¼è®¿é—®æ‰€æœ‰è®¾å¤‡
	- ä¸ç®¡æ˜¯é”®ç›˜ã€ç¡¬ç›˜è¿˜æ˜¯ç½‘å¡ï¼Œéƒ½ç”¨write()ã€read()ç­‰å‡½æ•°
	- ç¨‹åºå‘˜ä¸éœ€è¦å…³å¿ƒè®¾å¤‡çš„å…·ä½“å·¥ä½œæ–¹å¼

## 2 å†…å­˜ç®¡ç†å•å…ƒMMU

åœ¨Linuxç¯å¢ƒç›´æ¥è®¿é—®ç‰©ç†å†…å­˜æ˜¯å¾ˆå±é™©çš„ï¼Œå¦‚æœç”¨æˆ·ä¸å°å¿ƒä¿®æ”¹äº†å†…å­˜ä¸­çš„æ•°æ®ï¼Œå¾ˆæœ‰å¯èƒ½é€ æˆé”™è¯¯ç”šè‡³ç³»ç»Ÿå´©æºƒã€‚**ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜å†…æ ¸å¼•å…¥äº†MMU**

### 2.1 MMUçš„åŠŸèƒ½

**MMUæ˜¯ä»€ä¹ˆï¼Ÿ** 
- MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰æ˜¯ä¸€ä¸ªå®é™…çš„ç¡¬ä»¶ï¼ˆä¸æ˜¯è½¯ä»¶ï¼‰ï¼Œå°±åƒCPUå’Œå†…å­˜ä¹‹é—´çš„â€œåœ°å€ç¿»è¯‘å®˜â€
- å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆçœŸå®çš„ç‰©ç†åœ°å€ï¼ŒåŒæ—¶ç®¡ç†å’Œä¿æŠ¤å†…å­˜

**ä¸¤ç§å†…å­˜è®¿é—®æ–¹å¼å¯¹æ¯”**
- `æ— MMUæ—¶`
  ![20250531_151048_325_copy.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/4bdb62bc38b2919c83e581db1ecc1e83.png)
	- CPUç›´æ¥å‘å‡ºç‰©ç†åœ°å€åˆ°å†…å­˜æ¡
	- ç®€å•ç›´æ¥ï¼Œä½†åŠŸèƒ½æœ‰é™
- `æœ‰MMUæ—¶`
  ![20250531_151055_285_copy.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/0b7de774d01dc0a7c4b57d66fb15f4bd.png)
	- CPUå‘å‡ºè™šæ‹Ÿåœ°å€â†’MMUæŸ¥è¯¢é¡µè¡¨â†’ç¿»è¯‘æˆç‰©ç†åœ°å€â†’è®¿é—®å†…å­˜
	- å¤æ‚ä½†åŠŸèƒ½å¼ºå¤§

**ä»€ä¹ˆæ˜¯è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ï¼Ÿ**
- `ç‰©ç†åœ°å€`ï¼šå†…å­˜æ¡ä¸ŠçœŸå®ä½ç½®
	- æ¯”å¦‚8Gå†…å­˜æ¡ï¼Œç¬¬ä¸€ä¸ªå•å…ƒæ˜¯0x0000ï¼Œç¬¬å…­ä¸ªæ˜¯0x0005
	- è¿™æ—¶ç¡¬ä»¶çš„ç»å¯¹åœ°å€
- `è™šæ‹Ÿåœ°å€`ï¼šç¨‹åºä¸­ä½¿ç”¨çš„åœ°å€
	- 32ä½ç³»ç»Ÿæœ‰4Gè™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆ2^32ï¼‰
	- ç¨‹åºçœ‹åˆ°çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œç”±MMUç¿»è¯‘æˆç‰©ç†åœ°å€

**MMUçš„ä¸»è¦åŠŸèƒ½**
1. `å†…å­˜ä¿æŠ¤`ï¼ˆé˜²æ­¢å†…å­˜è¢«æ¶æ„ä¿®æ”¹ï¼‰
	- ç»™å†…å­˜å—è®¾ç½®è¯»ã€å†™ã€æ‰§è¡Œæƒé™
	- æ£€æŸ¥CPUæ˜¯ç‰¹æƒæ¨¡å¼è¿˜æ˜¯ç”¨æˆ·æ¨¡å¼
2. `åœ°å€è½¬æ¢`
	- æä¾›ç»Ÿä¸€çš„å†…å­˜ç©ºé—´æŠ½è±¡
	- è®©ç¨‹åºè¿è¡Œåœ¨æ¯”ç‰©ç†å†…å­˜æ›´å¤§çš„è™šæ‹Ÿç©ºé—´ä¸­
	- è¿›ç¨‹ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°

**å®é™…åº”ç”¨**
- ç”¨ioremapæ˜ å°„è®¾å¤‡åœ°å€ï¼Œè®©ç¨‹åºé€šè¿‡è™šæ‹Ÿåœ°å€ç›´æ¥æ“ä½œç¡¬ä»¶å¯„å­˜å™¨
- å¾ˆå¤šå®æ—¶ç³»ç»Ÿï¼ˆuCOSã€FreeRTOSï¼‰å¯ä»¥æ— MMUè¿è¡Œï¼Œä½†åŠŸèƒ½æœ‰é™

### 2.2 TLBçš„ä½œç”¨

**é—®é¢˜çš„ç”±æ¥**ï¼šMMUè¿›è¡Œåœ°å€è½¬æ¢æ—¶æ•ˆç‡å¤ªä½
- ä¸€çº§é¡µè¡¨ï¼šæ¯æ¬¡è¯»å†™æ•°æ®éœ€è¦è®¿é—®2æ¬¡å†…å­˜ï¼ˆå…ˆæŸ¥é¡µè¡¨ï¼Œå†è®¿é—®æ•°æ®ï¼‰
- äºŒçº§é¡µè¡¨ï¼šæ¯æ¬¡è¯»å†™æ•°æ®éœ€è¦è®¿é—®3æ¬¡å†…å­˜
- è¿™æ ·é¢‘ç¹è®¿é—®å†…å­˜ä¸¥é‡å½±å“CPUæ€§èƒ½

**TLBæ˜¯ä»€ä¹ˆï¼Ÿ**
- TLBï¼ˆTranslation Lookaside Bufferï¼Œåœ°å€è½¬æ¢ç¼“å†²å™¨ï¼‰å°±æ˜¯MMUçš„â€œå°æŠ„æœ¬â€ï¼Œä¸“é—¨ç¼“å­˜æœ€è¿‘ä½¿ç”¨è¿‡çš„åœ°å€è½¬æ¢ç»“æœ

**TLBçš„å·¥ä½œæµç¨‹**
1. CPUå‘å‡ºè™šæ‹Ÿåœ°å€
2. MMUé¦–å…ˆæŸ¥çœ‹TLB
	- `å‘½ä¸­`ï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜çš„åœ°å€æè¿°ç¬¦è¿›è¡Œæƒé™æ£€æŸ¥å’Œåœ°å€è½¬æ¢
	- `æœªå‘½ä¸­`ï¼šå»å†…å­˜ä¸­æŸ¥é¡µè¡¨ï¼Œæ‰¾åˆ°åè¿›è¡Œè½¬æ¢ï¼ŒæŠŠç»“æœå­˜å…¥TLB

**TLBæ»¡äº†æ€ä¹ˆåŠï¼Ÿ**
- TLBå®¹é‡ä¸å¤§ï¼Œæ»¡äº†å°±ç”¨`roundâ€”robinç®—æ³•`ï¼ˆè½®è¯¢ç®—æ³•ï¼‰
- æ‰¾ä¸€ä¸ªæ—§æ¡ç›®è¦†ç›–æ‰ï¼Œä¸ºæ–°çš„åœ°å€è½¬æ¢è®©ä½

**å®é™…æ•ˆæœ**ï¼šTLBå¤§å¤§æé«˜äº†åœ°å€è½¬æ¢æ•ˆç‡ï¼Œé¿å…äº†æ¯æ¬¡éƒ½è¦è®¿é—®å†…å­˜æŸ¥é¡µè¡¨çš„å¼€é”€

**å¯¹å¼€å‘è€…çš„æ„ä¹‰**ï¼šåœ¨Linuxç¯å¢ƒä¸­ï¼Œç”±äºå¼€å¯äº†MMUï¼Œå¼€å‘è€…è¦è®¿é—®ç¡¬ä»¶å¯„å­˜å™¨ï¼ˆç‰©ç†åœ°å€ï¼‰æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€çš„è½¬æ¢å‡½æ•°ï¼Œè€ŒTLBçš„å­˜åœ¨è®©è¿™ç§è½¬æ¢æ›´åŠ é«˜æ•ˆ

**ç®€å•ç†è§£ï¼š** TLBå°±åƒæ˜¯åœ°å€è½¬æ¢çš„â€œç¼“å­˜â€ï¼ŒæŠŠå¸¸ç”¨çš„è½¬æ¢ç»“æœè®°ä½ï¼Œä¸‹æ¬¡ç›´æ¥ä½¿ç”¨ï¼Œé¿å…é‡å¤çš„ç¹çæŸ¥è¡¨è¿‡ç¨‹

## 3 åœ°å€è½¬æ¢å‡½æ•°

ä¸Šé¢æåˆ°äº†ç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€çš„è½¬æ¢å‡½æ•°ã€‚åŒ…æ‹¬ioremap()åœ°å€æ˜ å°„å’Œå–æ¶ˆåœ°å€æ˜ å°„iounmap()å‡½æ•°

### 3.1 ioremapå‡½æ•°

**ioremapå‡½æ•°çš„ä½œç”¨ï¼š** å°†ç‰©ç†åœ°å€æ˜ å°„æˆè™šæ‹Ÿåœ°å€ï¼Œè®©ç¨‹åºèƒ½å¤Ÿé€šè¿‡è™šæ‹Ÿåœ°å€æ“ä½œç¡¬ä»¶å¯„å­˜å™¨ã€‚

**å‡½æ•°åŸå‹ï¼š**
```c
// åœ°å€æ˜ å°„å‡½æ•°ï¼ˆå†…æ ¸æºç /arch/arc/mm/ioremap.cï¼‰
void __iomem *ioremap(phys_addr_t paddr,unsigned long size)
#define ioremap ioremap
```
- `paddr`ï¼šè¦æ˜ å°„çš„ç‰©ç†åœ°å€ï¼ˆå¯„å­˜å™¨åœ°å€ï¼‰
- `size`ï¼šéœ€è¦æ˜ å°„çš„å­—èŠ‚æ•°
- **è¿”å›å€¼**ï¼šæ˜ å°„åçš„è™šæ‹Ÿåœ°å€æŒ‡é’ˆï¼ˆç”¨è¿™ä¸ªæ¥æ“ä½œå®é™…çš„ç‰©ç†åœ°å€ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦ioremapï¼Ÿ** åœ¨å¼€å¯MMUçš„Linuxç³»ç»Ÿä¸­ï¼š
- ç¨‹åºä¸èƒ½ç›´æ¥è®¿é—®ç‰©ç†åœ°å€
- å¿…é¡»å…ˆæŠŠç‰©ç†åœ°å€æ˜ å°„ä¸ºè™šæ‹Ÿåœ°å€
- å°±åƒ51/STM32ç›´æ¥æ“ä½œå¯„å­˜å™¨ï¼Œä½†å¤šäº†ä¸€ä¸ªâ€œåœ°å€ç¿»è¯‘â€çš„æ­¥éª¤

---

ç†è®ºä¸Šï¼Œé€šè¿‡ioremapè·å–åˆ°è™šæ‹Ÿåœ°å€ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥è¯»å†™I/Oå†…å­˜ï¼Œä½†æ˜¯ä¸ºäº†ä»£ç çš„è·¨å¹³å°æ€§ï¼Œåº”è¯¥ä½¿ç”¨linuxä¸“é—¨æŒ‡å®šçš„I/Oå‡½æ•°

**æ ‡å‡†çš„I/Oè¯»å†™å‡½æ•°** ï¼š
```c
unsigned int ioread8(void __iomem *addr)
unsigned int ioread16(void __iomem *addr)
unsigned int ioread32(void __iomem *addr)

void iowrite8(u8 b, void __iomem *addr)
void iowrite16(u16 b, void __iomem *addr)
void iowrite32(u32 b, void __iomem *addr)
```
- ç±»ä¼¼çš„è¿˜æœ‰writebã€writewã€writelã€readbã€readwã€readlç­‰

> [!tip]+ ARMæ¶æ„çš„å†…å­˜I/Oä¸åŒç‚¹
> - writex(readx)å‡½æ•°ä¸iowritex(ioreadx)æœ‰ä¸€äº›åŒºåˆ«
> - writex(readx)ä¸è¿›è¡Œç«¯åºçš„æ£€æŸ¥ï¼Œè€Œiowritex(ioreadx)ä¼šè¿›è¡Œç«¯åºçš„æ£€æŸ¥

**è¯»å‡½æ•°ï¼š**
- `ioread8()` - è¯»1å­—èŠ‚
- `ioread16()` - è¯»2å­—èŠ‚
- `ioread32()` - è¯»4å­—èŠ‚

**å†™å‡½æ•°ï¼š**
- `iowrite8(data, addr)` - å†™1å­—èŠ‚
- `iowrite16(data, addr)` - å†™2å­—èŠ‚
- `iowrite32(data, addr)` - å†™4å­—èŠ‚

**å®é™…ä¾‹å­ï¼ˆæ§åˆ¶LEDï¼‰ï¼š**
```c
#define GPIO0_BASE (0xFDD60000)
#define GPIO0_DR (GPIO0_BASE+0x0000)

va_dr = ioremap(GPIO0_DR,4);  //æ˜ å°„ç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€ï¼šGPIO0çš„æ•°æ®å¯„å­˜å™¨
val = ioread32(va_dr);        //è¯»å–å¯„å­˜å™¨å€¼
val |= (0x00400000);          //è®¾ç½®GPIO0_A6å¼•è„šä½ç”µå¹³
iowrite32(val,va_dr);         //å†™å›å¯„å­˜å™¨
```

**ç®€å•ç†è§£**ï¼šioremapå°±åƒç»™ç¡¬ä»¶å¯„å­˜å™¨ç”³è¯·äº†ä¸€ä¸ªâ€œè™šæ‹Ÿé—¨ç‰Œå·â€ï¼Œç¨‹åºé€šè¿‡è¿™ä¸ªè™šæ‹Ÿé—¨ç‰Œå·å°±èƒ½æ‰¾åˆ°å¹¶æ“ä½œçœŸå®çš„ç¡¬ä»¶å¯„å­˜å™¨

### 3.2 iounmapå‡½æ•°

**iounmapå‡½æ•°çš„ä½œç”¨ï¼š** å–æ¶ˆä¹‹å‰ç”¨ioremapåˆ›å»ºçš„åœ°å€æ˜ å°„ï¼Œé‡Šæ”¾è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚

**å‡½æ•°åŸå‹ï¼š**
```c
void iounmap(void *addr)
```
- `addr`ï¼šéœ€è¦å–æ¶ˆæ˜ å°„çš„è™šæ‹Ÿåœ°å€ï¼ˆioremapçš„è¿”å›å€¼ï¼‰
- **è¿”å›å€¼**ï¼šæ— 

**ä½¿ç”¨åœºæ™¯ï¼š** å½“ä¸å†éœ€è¦è®¿é—®æŸä¸ªç¡¬ä»¶å¯„å­˜å™¨æ—¶ï¼Œåº”è¯¥é‡Šæ”¾å¯¹åº”çš„è™šæ‹Ÿåœ°å€æ˜ å°„ã€‚

**ä»£ç ç¤ºä¾‹ï¼š**
```c
// ä¹‹å‰çš„æ˜ å°„
va_dr = ioremap(GPIO0_DR, 4);

// ä½¿ç”¨è™šæ‹Ÿåœ°å€æ“ä½œå¯„å­˜å™¨
// ... å„ç§è¯»å†™æ“ä½œ ...

// ä¸å†éœ€è¦æ—¶ï¼Œé‡Šæ”¾æ˜ å°„
iounmap(va_dr);
```

**ä¸ºä»€ä¹ˆè¦ç”¨iounmapï¼Ÿ**
- é‡Šæ”¾ç³»ç»Ÿèµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼
- ç±»ä¼¼äºmallocå’Œfreeçš„é…å¯¹ä½¿ç”¨
- ioremapå’Œiounmapåº”è¯¥æˆå¯¹å‡ºç°

**ç®€å•ç†è§£ï¼š** å¦‚æœè¯´ioremapæ˜¯"ç”³è¯·è™šæ‹Ÿé—¨ç‰Œå·"ï¼Œé‚£ä¹ˆiounmapå°±æ˜¯"æ³¨é”€è™šæ‹Ÿé—¨ç‰Œå·"ï¼Œç¡®ä¿ç³»ç»Ÿèµ„æºå¾—åˆ°æ­£ç¡®é‡Šæ”¾ã€‚

**æ³¨æ„äº‹é¡¹ï¼š**
- ä¼ å…¥çš„åœ°å€`å¿…é¡»æ˜¯`ioremapè¿”å›çš„åœ°å€
- é‡Šæ”¾åä¸èƒ½å†ä½¿ç”¨è¯¥è™šæ‹Ÿåœ°å€
- é©±åŠ¨å¸è½½æ—¶ä¸€å®šè¦è°ƒç”¨iounmap

## 4 ç‚¹äº®LEDç¯å®éªŒ

ä»å‰é¢å‡ ç« å†…æ ¸æ¨¡å—å†åˆ°å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼Œä»ç†è®ºåˆ°å®è·µï¼Œæ€»ç®—æ˜¯ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œè®©æˆ‘ä»¬å¼€å§‹ç€æ‰‹æ‰‹å†™LEDçš„é©±åŠ¨ä»£ç å§ã€‚
1. é¦–å…ˆï¼Œéœ€è¦ä¸€ä¸ªLEDå­—ç¬¦è®¾å¤‡ç»“æ„ä½“ï¼ŒåŒ…å«è¦æ“ä½œçš„å¯„å­˜å™¨åœ°å€
2. å…¶æ¬¡ï¼Œæ¨¡å—çš„åŠ è½½å¸è½½å‡½æ•°
	- åŠ è½½å‡½æ•°éœ€è¦æ³¨å†Œè®¾å¤‡
	- å¸è½½å‡½æ•°åˆ™éœ€è¦é‡Šæ”¾ç”³è¯·çš„èµ„æº
3. ç„¶åæ˜¯file_operationsç»“æ„ä½“ä»¥åŠopenï¼Œwriteï¼Œreadç›¸å…³æ¥å£çš„å®ç°

### 4.1 å®éªŒè¯´æ˜

#### 4.1.1 ç¡¬ä»¶ä»‹ç»

æœ¬èŠ‚å®éªŒä½¿ç”¨åˆ°lubancat_RKç³»åˆ—æ¿ä¸Šçš„ç³»ç»ŸLEDç¯ï¼ˆæˆ–è€…è‡ªè¡Œåœ¨40pinä¸Šå¤–æ¥ledï¼‰

#### 4.1.2 ç¡¬ä»¶åŸç†å›¾åˆ†æ

LubanCatç³»åˆ—æ¿å¡ï¼Œå¼•å‡ºçš„ledå¼•è„šå¯èƒ½ä¸åŒï¼Œæ‰“å¼€ç›¸åº”çš„æ¿å¡åŸç†å›¾æ¥æŸ¥çœ‹ç¡¬ä»¶é“¾æ¥ï¼Œæ ¹æ®ä¸åŒçš„å¼•è„šæŸ¥è¯¢ç›¸åº”çš„å¯„å­˜å™¨åœ°å€ã€‚ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨gpioå¼•è„šè¿æ¥ä¸€ä¸ªLEDç¯è¿›è¡Œæµ‹è¯•ï¼‰

è¿™é‡Œä½¿ç”¨åˆ°çš„æ¿å¡ä¸ºLubancat2ä¸ºä¾‹ï¼ŒæŸ¥çœ‹çš„åŸç†å›¾æ–‡ä»¶ï¼š[LubanCat2_EBF410044V2_SCH_20230707](../../../../01-â‡ï¸%20å‚è€ƒèµ„æ–™/3_æ¿å¡å‚è€ƒæ‰‹å†Œ/1_Lubancat-RK3568/LubanCat2_EBF410044V2_SCH_20230707.pdf)ï¼Œæ¿å­ä¸Šåªæœ‰ä¸€ä¸ªç”¨æˆ·ç¯ï¼ˆä¹Ÿå°±æ˜¯ç³»ç»Ÿçš„å¿ƒè·³ç¯ï¼Œå…·ä½“ä½¿ç”¨æ—¶éœ€è¦å…³é—­ä¸‹è®¾å¤‡æ ‘çš„ledsèŠ‚ç‚¹ï¼‰ï¼Œå…·ä½“è§ä¸‹å›¾
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/c719367c3fc86975d272d90610592fb6.png)

- LEDçš„é˜´æé“¾æ¥åˆ°rk3568èŠ¯ç‰‡ä¸ŠGPIO0_C7

> [!warning]+ æ³¨æ„
> åŸç†å›¾è¦çœ‹æ¿å­åé¢çš„ç¼–å·ï¼Œä¸è¦é€‰é”™äº†ï¼Œæˆ‘çš„é€‰æ‹©æ˜¯ä¸‹é¢æ—¥æœŸçš„æ–‡ä»¶
> ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/30351db9722f51cee01052977ca5fa70.png)


> [!tip]+ æç¤º
> - RK3568ä¸­å¼•è„šç”¨GPIOç¼–å·ï¼Œå¤ç”¨å‹å¼•è„šåˆ†ä¸º5ç»„ï¼ˆ0~4ï¼‰ï¼Œæ¯ç»„é‡Œé¢éƒ½æœ‰32ä¸ªå¤ç”¨å‹å¼•è„šï¼Œè€Œä¸”åˆåˆ†ä¸º4ä¸ªå°ç»„ï¼ˆAã€Bã€Cã€Dï¼‰ï¼Œæ¯ä¸ªå°ç»„8ä¸ªå¼•è„šï¼ˆ0~7ï¼‰
> - ä¾‹å¦‚ï¼šGPIO1_A4æ˜¯GPIO0å¤§ç»„ï¼Œç¬¬1ä¸ªå°ç»„ï¼Œç¬¬5ä¸ªå¼•è„š

```txt
RK3568 GPIOå‘½åè§„åˆ™ï¼šGPIOx_yz
â”œâ”€â”€ x: ç»„å· (0~4ï¼Œå…±5ç»„)
â”œâ”€â”€ y: å°ç»„å· (A/B/C/Dï¼Œæ¯ç»„4ä¸ªå°ç»„)  
â””â”€â”€ z: å¼•è„šå· (0~7ï¼Œæ¯å°ç»„8ä¸ªå¼•è„š)
```

å¯¹äºLEDç¯è¿›è¡Œæ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸Šè¿°GPIOçš„å¯„å­˜å™¨è¿›è¡Œè¯»å†™æ“ä½œï¼Œå¯å¤§è‡´åˆ†ä¸ºä¸€ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1. ä½¿èƒ½GPIOæ—¶é’Ÿï¼ˆé»˜è®¤å¼€å¯ï¼Œä¸ç”¨è®¾ç½®ï¼‰
2. è®¾ç½®å¼•è„šå¤ç”¨ä¸ºGPIOï¼ˆå¤ä½é»˜è®¤ä¸ºGPIOï¼Œä¸åŒé…ç½®ï¼‰
3. è®¾ç½®å¼•è„šå±æ€§ï¼ˆä¸Šä¸‹æ‹‰ã€é€Ÿç‡ã€é©±åŠ¨èƒ½åŠ›ï¼Œé»˜è®¤ï¼‰
4. æ§åˆ¶GPIOå¼•è„šä¸ºè¾“å‡ºï¼Œå¹¶è¾“å‡ºé«˜ä½ç”µå¹³

å› ä¸ºGPIOçš„æ—¶é’Ÿé»˜è®¤å¼€å¯ï¼Œå¼•è„šé»˜è®¤å¤ç”¨ä¸ºGPIOï¼Œæˆ‘ä»¬**åªéœ€è¦é…ç½®GPIOçš„å¼•è„šè¾“å…¥è¾“å‡ºæ¨¡å¼åŠç”µå¹³å³å¯**

#### 4.1.3 ğŸ“•å¯¹LEDè¿›è¡Œå¯„å­˜å™¨é…ç½®

å…³äºrk3568èŠ¯ç‰‡å¯„å­˜å™¨çš„å†…å®¹ï¼Œæˆ‘ä»¬è¿™é‡Œå¿«é€Ÿæ¢³ç†ä¸€éä¼šä½¿ç”¨åˆ°çš„å¯„å­˜å™¨ï¼Œä¸ä¼šæ·±ç©¶ä¸ªå¯„å­˜å™¨å¦‚ä½•å»é…ç½®

rk3568ç³»åˆ—å¯¹åº”çš„æ‰‹å†Œï¼š
- æ•°æ®æ‰‹å†Œï¼š[Rockchip RK3568 Datasheet V1.2-20210601](../../../../01-â‡ï¸%20å‚è€ƒèµ„æ–™/3_æ¿å¡å‚è€ƒæ‰‹å†Œ/1_Lubancat-RK3568/Rockchip%20RK3568%20Datasheet%20V1.2-20210601.pdf)
- å‚è€ƒæ‰‹å†Œï¼š[Rockchip_RK3568_TRM_Part1_V1.3-20220930P](../../../../01-â‡ï¸%20å‚è€ƒèµ„æ–™/3_æ¿å¡å‚è€ƒæ‰‹å†Œ/1_Lubancat-RK3568/Rockchip_RK3568_TRM_Part1_V1.3-20220930P.pdf)

##### 4.1.3.1 å¼•è„šå¤ç”¨

å¯¹äºrockchipç³»ç±»èŠ¯ç‰‡ï¼Œéœ€è¦é€šè¿‡**å‚è€ƒæ‰‹å†Œ**ä»¥åŠ**æ•°æ®æ‰‹å†Œ**æ¥ç¡®å®šå¼•è„šçš„å¤ç”¨åŠŸèƒ½ï¼Œå¼•è„šæœç”¨ç›¸å…³ä¿¡æ¯å¯ä»¥é€šè¿‡æ•°æ®æ‰‹å†ŒæŸ¥è¯¢

ä»¥`GPIO0_C7`ä¸ºä¾‹ï¼ŒæŸ¥è¯¢[Rockchip RK3568 Datasheet V1.2-20210601](../../../../01-â‡ï¸%20å‚è€ƒèµ„æ–™/3_æ¿å¡å‚è€ƒæ‰‹å†Œ/1_Lubancat-RK3568/Rockchip%20RK3568%20Datasheet%20V1.2-20210601.pdf)æ‰‹å†Œå¯çŸ¥ï¼Œè¯¥å¼•è„šå¯ä»¥å¤ç”¨gpioåŠŸèƒ½ï¼ŒI2Sã€UARTç­‰åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/cb620d7fdf99d92f0486f414b2ecd015.png)


**å®šä½åˆ°GPIO0_C7æ‰€å¯¹åº”çš„æ§åˆ¶å¯„å­˜å™¨**
- æŸ¥çœ‹å‚è€ƒæ‰‹å†Œç¬¬16.5ç« çš„Interface Descriptionå¯çŸ¥ï¼Œæœ‰ä¸¤ç§ï¼ˆPMUGRFå’ŒGRFï¼‰å¤ç”¨ç›¸å…³çš„å¯„å­˜å™¨ï¼Œè€Œ`GPIO0ç»„å¤ç”¨åŠŸèƒ½åœ¨PMU_GRFå¯„å­˜å™¨`ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/10f7d3f91fd294c0c6008a8d224ed425.png)

- ç„¶åæŸ¥çœ‹ä¸Šå›¾çº¢æ¡†ï¼Œå¯ä»¥çŸ¥é“æ§åˆ¶å¯„å­˜å™¨åç§°ä¸º `PMU_GRF_GPIO0C_IOMUX_H`ï¼Œç„¶åæœç´¢è¯¥å¯„å­˜å™¨çš„é…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/30fb21e0e697dca80848bf2eaac5d386.png)

- `PMU_GRF_GPIO0C_IOMUX_H`å¯„å­˜å™¨ï¼Œå…±32ä½ï¼Œåœ°å€åç§»0x0014ï¼Œæ˜¯GPIO0Aç»„çš„IOMUXæ§åˆ¶é«˜ä½å¯„å­˜å™¨
	- é«˜16ä½éƒ½æ˜¯ä½¿èƒ½æ‹‰ï¼Œæ§åˆ¶ä½16ä½çš„å†™ä½¿èƒ½
	- ä½16ä½å¯¹åº”4ä¸ªå¼•è„šï¼Œæ¯ä¸ªå¼•è„šå ç”¨4bitsï¼ˆå®é™…æ˜¯3ä½ï¼‰
	- ä¸åŒçš„å€¼å¼•è„šæœç”¨ä¸ºä¸åŒåŠŸèƒ½
	- å¦‚GPIO0_C7å¼•è„šï¼Œæ§åˆ¶è¯¥å¼•è„šå¤ä½åŠŸèƒ½çš„[14:12]ä½ï¼Œéƒ½ä¸º0æ—¶ï¼Œå¤ç”¨ä¸ºGPIOåŠŸèƒ½ï¼Œè€Œç³»ç»Ÿå¤ä½é»˜è®¤ä¸º0ï¼Œæœ¬å®éªŒå¯ä»¥ä¸è¿›è¡Œé…ç½®
	- å¦‚æœè¦å¤ç”¨ä¸ºUART4_RXM0åŠŸèƒ½ï¼Œå°±éœ€è¦å°†[14:12]ä½è®¾ç½®ä¸º010ï¼Œä¹Ÿå°±æ˜¯å°†ç¬¬13ä½è®¾ç½®ä¸º1ï¼Œå› ä¸ºé«˜16ä½æ§åˆ¶å¯¹åº”ä½16ä½å†™ä½¿èƒ½ï¼Œæ‰€ä»¥éœ€è¦å°†ç¬¬13+16bitä½ï¼Œä¹Ÿå°±æ˜¯ä½17bitä½è®¾ç½®ä¸º1ï¼Œä»è€Œæ‰èƒ½å¯¹ç¬¬1bitä½è¿›è¡Œå†™æ“ä½œ

##### 4.1.3.2 å¼•è„šç”µå¹³ï¼ˆDRï¼‰

é€šè¿‡è®¾ç½®GPIOå¯„å­˜å™¨æ¥è®¾ç½®è¾“å…¥è¾“å‡ºã€é«˜ä½ç”µå¹³ã€ä¸­æ–­ã€æŠ–åŠ¨ç­‰ä¸€äº›å¼•è„šçš„é©±åŠ¨èƒ½åŠ›ï¼Œç”µæ°”å±æ€§ç­‰ï¼Œä¸»è¦é€šè¿‡è®¾ç½®General Register Files (GRF)
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/da3e084032b79edbe0ee209cf8cea59b.png)
- `GPIO_SWPORT_DR_L`ï¼šä½ä½å¼•è„šæ•°æ®å¯„å­˜å™¨ï¼Œè®¾ç½®é«˜ä½ç”µå¹³
- `GPIO_SWPORT_DR_H`ï¼šé«˜ä½å¼•è„šæ•°æ®å¯„å­˜å™¨ï¼Œè®¾ç½®é«˜ä½ç”µå¹³

GPIO_SWPORT_DR_Lå’ŒGPIO_SWPORT_DR_Hå¯„å­˜å™¨å…·ä½“å¦‚ä¸‹
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/524007c4458245cf6f647672a1872e14.png)

**ä»¥GPIO_SWPORT_DR_Hå¯„å­˜å™¨è¯´æ˜**
- é«˜16bitæ§åˆ¶ä½16bitçš„å†™ä½¿èƒ½
- ä½16ä½æ§åˆ¶GPIOçš„é«˜ä½ç”µå¹³ï¼Œ1=é«˜ç”µå¹³ï¼Œ0=ä½ç”µå¹³
- è¿™ä¸ªå¯„å­˜å™¨å®é™…æ§åˆ¶çš„GPIOæ•°é‡æ˜¯16ä¸ªï¼Œä¹ŸGPIO1ä¸­çš„Aå’ŒBç»„
	- GPIO0_C0--->ç¬¬0ä½
	- .......
	- GPIO0_D7--->ç¬¬15ä½
- æ‰€ä»¥å¦‚æœè¦æ§åˆ¶GPIO0_C7ä¸ºé«˜ç”µå¹³ï¼Œå°±è¦å†™GPIO_SWPORT_DR_Hå¯„å­˜å™¨
	- å†™ä½¿èƒ½æ‹‰ï¼Œç¬¬ï¼ˆ16+7ï¼‰bitè®¾ç½®ä¸º1
	- é«˜ç”µå¹³ï¼Œç¬¬7bitè®¾ç½®ä¸º1

##### 4.1.3.3 å¼•è„šè¾“å…¥è¾“å‡ºæ¨¡å¼ï¼ˆDDRï¼‰

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/dfe5a5dac4004d282606ca949c002e4c.png)
- GPIO_SWPORT_DDR_Lï¼šä½ä½å¼•è„šæ•°æ®æ–¹å‘å¯„å­˜å™¨ï¼Œæ§åˆ¶è¾“å…¥æˆ–è€…è¾“å‡º
- GPIO_SWPORT_DDR_Hï¼šé«˜ä½å¼•è„šæ•°æ®æ–¹å‘å¯„å­˜å™¨ï¼Œæ§åˆ¶è¾“å…¥æˆ–è€…è¾“å‡º

GPIO_SWPORT_DDR_Lå’ŒGPIO_SWPORT_DDR_Hå¯„å­˜å™¨å…·ä½“å¦‚ä¸‹
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/021cd625d948e878e9b0e390fa686fc6.png)

**ä»¥GPIO_SWPORT_DDR_Lå¯„å­˜å™¨è¯´æ˜**
- é«˜16bitæ§åˆ¶ä½16bitçš„å†™ä½¿èƒ½
- ä½16ä½æ§åˆ¶GPIOçš„è¾“å‡ºæ–¹å‘ï¼Œ1=è¾“å‡ºï¼Œ0=è¾“å…¥
- è¿™ä¸ªå¯„å­˜å™¨å®é™…æ§åˆ¶çš„GPIOæ•°é‡æ˜¯16ä¸ªï¼Œä¹ŸGPIO0ä¸­çš„Cå’ŒDç»„
	- GPIO0_C0--->ç¬¬0ä½
	- .......
	- GPIO0_D7--->ç¬¬15ä½
- æ‰€ä»¥å¦‚æœè¦æ§åˆ¶GPIO0_C7çš„è¾“å‡ºï¼Œå°±è¦å†™GPIO_SWPORT_DDR_Lå¯„å­˜å™¨
	- å†™ä½¿èƒ½æ‹‰ï¼Œç¬¬ï¼ˆ16+7ï¼‰bitè®¾ç½®ä¸º1
	- é«˜ç”µå¹³ï¼Œç¬¬7bitè®¾ç½®ä¸º1

##### 4.1.3.4 å¼•è„šä¸Šä¸‹æ‹‰

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/a05eb15e6a232286946d3f2ae5e66ae4.png)

GRF_GPIOA_Pæ˜¯ç›¸åº”GPIOä¸Šæ‹‰æˆ–ä¸‹æ‹‰çš„æ§åˆ¶å¯„å­˜å™¨ï¼Œä»¥GPIO0_C7è¿›è¡Œè¯´æ˜

GRF_GPIOA_På¯„å­˜å™¨å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/4a86874ced63c494c2acc3966c43a9d4.png)


- é«˜16bitæ§åˆ¶ä½16bitçš„å†™ä½¿èƒ½
- å…¶ä¸­[15:14]bitæ§åˆ¶gpio1a4çš„ä¸Šä¸‹æ‹‰é…ç½®
- å¦‚æœè¦å°†GPIO0_C7è®¾ç½®ä¸ºä¸Šæ‹‰æ¨¡å¼
	- [15:14]bitä½è®¾ç½®ä¸º1
	- 14+16bitä½è®¾ç½®ä¸º1

### 4.2 ä»£ç è®²è§£

#### 4.2.1 å®šä¹‰GPIOå¯„å­˜å™¨ç‰©ç†åœ°å€

ä»¥GPIO0_C7ä¸ºä¾‹ï¼Œéœ€è¦å…ˆç¡®å®šGPIO1çš„åŸºåœ°å€ï¼Œå…¶ä½™å¯„å­˜å™¨å‡åœ¨åŸºåœ°å€ä¸Šè¿›è¡Œåç§»ï¼ŒæŸ¥è¯¢[Rockchip_RK3568_TRM_Part1_V1.3-20220930P](../../5_ç¡¬ä»¶èµ„æº/Rockchip_RK3568_TRM_Part1_V1.3-20220930P.pdf) æ‰‹å†Œä¸­çš„`1.1 Address Mapping`å¯çŸ¥ï¼ŒGPIO1çš„åŸºåœ°å€ä¸º`0xFDD60000`ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/974d008efca1476910956636d4566411.png)


> [!tip]+ æç¤º
> - å¤ç”¨å·²ç»æ˜¯GPIOäº†ï¼Œä¸ç”¨è®¾ç½®
> - ä¸Šä¸‹æ‹‰è¿™é‡Œç”¨ä¸åˆ°ï¼Œä¸ç”¨è®¾ç½®
> - åªéœ€è¦è®¾ç½®ç”µå¹³å’Œæ–¹å‘å³å¯

ç¡®å®šåŸºåœ°å€åï¼Œéœ€è¦ç¡®å®šç”µå¹³å’Œæ–¹å‘å¯„å­˜å™¨å¯¹äºåŸºåœ°å€çš„åç§»é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/9ae6c2c367a083b18b7aeba93a8ce356.png)


ä»ä¸Šå›¾å¯çŸ¥éœ€è¦è®¾ç½®çš„å¯„å­˜å™¨åœ°å€ä¸ºbase+offsetï¼Œç¼–å†™ä»£ç å¦‚ä¸‹ï¼š
```c
#define GPIO0_BASE (0xFDD60000)

//ä¸€ä¸ªå¯„å­˜å™¨32ä½ï¼Œé«˜16ä½éƒ½æ˜¯ä½¿èƒ½ï¼Œä½16ä½å¯¹åº”16ä¸ªå¼•è„šï¼Œæ§åˆ¶ç”µå¹³
//GPIO1_A0 ... GPIO1_A7 ... GPIO1_B7
#define GPIO0_DR_L (GPIO0_BASE + 0x0000) //ä½16ä½å¼•è„š(A~B)
#define GPIO0_DR_H (GPIO0_BASE + 0x0004) //é«˜16ä½å¼•è„š(C~D)

//æ§åˆ¶æ–¹å‘ï¼ŒåŒä¸Š
#define GPIO0_DDR_L (GPIO0_BASE + 0x0008)
#define GPIO0_DDR_H (GPIO0_BASE + 0x000C)
```

ä»£ç ä½¿ç”¨å®å®šä¹‰ï¼Œå®šä¹‰LEDç¯ä½¿ç”¨åˆ°çš„GPIOèµ„æºç‰©ç†åœ°å€ï¼Œåé¢éœ€è¦å°†è¿™äº›å¯„å­˜å™¨åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ä¸Š

#### 4.2.2 ç¼–å†™LEDå­—ç¬¦è®¾å¤‡ç»“æ„ä½“ä¸”åˆå§‹åŒ–

```c
// ledç¯çš„ç»“æ„ä½“
struct led_chrdev{
	struct cdev dev;
	unsigned int __iomem *va_dr;  // æ•°æ®å¯„å­˜å™¨ï¼Œè®¾ç½®è¾“å‡ºçš„ç”µå‹
	unsigned int __iomem *va_ddr; // æ•°æ®æ–¹å‘å¯„å­˜å™¨ï¼Œè¾“å…¥æˆ–è€…è¾“å‡º

	unsigned int led_pin; //å¼•è„š
}

// RGBç¯çš„ç»“æ„ä½“æ•°ç»„ï¼Œé’ˆå¯¹å¤šä¸ªledçš„æƒ…å†µ
static struct led_chrdev led_cdev[DEV_CNT] = {
    // åç§»ï¼ŒGPIO0_C7åç§»7ä½
    {.led_pin = 7},
};
```

#### 4.2.3 å†…æ ¸RGBæ¨¡å—çš„åŠ è½½å’Œå¸è½½å‡½æ•°

**ç¬¬ä¸€éƒ¨åˆ†ï¼šRGBæ¨¡å—çš„åŠ è½½å‡½æ•°**
- æ˜ å°„LEDç»“æ„ä½“ä¸­çš„è™šæ‹Ÿåœ°å€ï¼Œå°†è™šæ‹Ÿåœ°å€å’ŒGPIOçš„ç‰©ç†å¯„å­˜å™¨ä¸€ä¸€å¯¹åº”
- è°ƒç”¨alloc_chrdev_region()å‡½æ•°ç”³è¯·ä¸€ä¸ªæœªè¢«å ç”¨çš„è®¾å¤‡å·
- è°ƒç”¨`class_create()`å‡½æ•°åˆ›å»ºä¸€ä¸ªRGBç¯çš„è®¾å¤‡ç±»
- åˆ†åˆ«ç»™ä¸‰ä¸ªLEDå»ºç«‹å…¶å¯¹åº”çš„å­—ç¬¦è®¾å¤‡ç»“æ„ä½“cdevå’Œled_chrdev_fopså…³è”
- åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡ç»“æ„ä½“ï¼Œæœ€åæ³¨å†Œå¹¶åˆ›å»ºè®¾å¤‡

**ç¬¬äºŒéƒ¨åˆ†ï¼šRGBæ¨¡å—çš„å¸è½½å‡½æ•°**
- é‡Šæ”¾LEDç»“æ„ä½“å†…æ˜ å°„çš„è™šæ‹Ÿåœ°å€
- è°ƒç”¨device_destory()å‡½æ•°ï¼Œç§»å‡ºä¸€ä¸ªè®¾å¤‡ï¼Œå¹¶ä¸”åˆ é™¤`/sys/devices/virtual`ç›®å½•ä¸‹å¯¹åº”çš„è®¾å¤‡ç›®å½•ï¼ŒåŠ`/dev`ç›®å½•ä¸‹å¯¹åº”çš„è®¾å¤‡æ–‡ä»¶
- è°ƒç”¨cdev_del()å‡½æ•°æ¥é‡Šæ”¾æ•£åˆ—è¡¨ä¸­çš„å¯¹è±¡ä»¥åŠcdevç»“æ„æœ¬èº«
- é‡Šæ”¾è¢«å ç”¨çš„è®¾å¤‡å·ï¼ŒåŠåˆ é™¤è®¾å¤‡ç±»

ä¸‹é¢ä»£ç çš„3ä¸ªLEDåŒä¸»è®¾å¤‡å·ï¼Œæ¬¡è®¾å¤‡å·ä¸ä¸€æ ·
```c
static __init int led_chrdev_init(void){
    int i = 0;
    dev_t cur_dev;
    unsigned int val = 0;

    printk("led_chrdev init(lubancat2 GPIO0_C7)\n");

    led_cdev[0].va_dr = ioremap(GPIO0_DR_H,4);
    led_cdev[0].va_ddr = ioremap(GPIO0_DDR_H,4);
    // æ³¨å†Œä¸»è®¾å¤‡å·
    alloc_chrdev_region(&devno,0,DEV_CNT,DEV_NAME);
    // åˆ›å»ºè®¾å¤‡ç±»
    led_chrdev_class = class_create(THIS_MODULE,"led_chrdev");
    // å¾ªç¯æ·»åŠ åŒä¸€é©±åŠ¨ç¨‹åºçš„è®¾å¤‡
    for(;i<DEV_CNT;i++){
        //åˆå§‹åŒ–cdev
        cdev_init(&led_cdev[i].dev,&led_chrdev_fops);
        led_cdev[i].dev.owner = THIS_MODULE;
        //è·å–cdevçš„å®Œæ•´è®¾å¤‡å·
        cur_dev = MKDEV(MAJOR(devno),MINOR(devno)+i);
        //æ·»åŠ è¯¥è®¾å¤‡åˆ°æ•£åˆ—è¡¨
        cdev_add(&led_chrdev[i].dev,cur_dev,1);
        //è®¾å¤‡èŠ‚ç‚¹åˆ›å»ºå·¥ä½œ -> /dev/DEV_NAME%d 
        device_create(led_chrdev_class,NULL,cur_dev,NULL,DEV_NAME"%d",i);
    }
    return 0;
}
module_init(led_chrdev_init);

static __exit void led_chrdev_exit(void){ 
    int i;
    dev_t cur_dev;
    printk("led chrdev exit(lubancat2 GPIO0_C7)\n");

    // é‡Šæ”¾è™šæ‹Ÿåœ°å€
    for(i=0;i<DEV_CNT;i++){
        iounmap(led_cdev[i].va_dr);
        iounmap(led_cdev[i].va_ddr);
    }

    //åˆ é™¤è®¾å¤‡èŠ‚ç‚¹å’Œcdev
    for(i=0;i<DEV_CNT;i++){
        cur_dev = MKDEV(MAJOR(devno),MINOR(devno)+i);
        device_destory(led_chrdev_class,cur_dev);
        cdev_del(&led_cdev[i].cdev);
    }

    //é‡Šæ”¾è®¾å¤‡å·
    unregister_chrdev_region(devno, DEV_CNT);
    //åˆ é™¤è®¾å¤‡ç±»
    class_destroy(led_chrdev_class);
}
module_exit(led_chardev_exit);
```

#### 4.2.4 file_operationsç»“æ„ä½“æˆå‘˜å‡½æ•°çš„å®ç°

**openå‡½æ•°éœ€è¦å®Œæˆçš„å·¥ä½œ**

**ç¬¬ä¸€æ­¥ï¼šé€šè¿‡container_ofå‡½æ•°è·å–led_chrdevç»“æ„ä½“çš„é¦–åœ°å€**

**ç¬¬äºŒæ­¥ï¼šæ–‡ä»¶ç§æœ‰æ•°æ®**
- å°†file->private_data æŒ‡å‘è®¾å¤‡ç»“æ„ä½“ï¼Œç”¨äºä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰è®¾å¤‡ç»“æ„ä½“çš„åœ°å€
- åç»­ï¼Œå¯ä»¥é€šè¿‡è¯¥ç§æœ‰æ•°æ®åŒºè®¿é—®è®¾å¤‡ç»“æ„ä½“çš„æˆå‘˜

**ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ioremap()å‡½æ•°å®ç°åœ°å€çš„æ˜ å°„**
- ä¾¿äºé€šè¿‡æ“ä½œç¨‹åºä¸­çš„è™šæ‹Ÿåœ°å€æ¥é—´æ¥æ§åˆ¶ç‰©ç†å¯„å­˜å™¨
- åé¢ä¼šä½¿ç”¨è®¾å¤‡æ ‘ï¼ˆè®¾å¤‡æ ‘æ’ä»¶ï¼‰çš„æ–¹å¼åŒºæè¿°å¯„å­˜å™¨åŠå…¶ç›¸å…³å±æ€§ï¼Œè¿™é‡Œå…ˆåŸ‹ä¸‹ä¼ç¬”ï¼Œå¾ªåºæ¸è¿›ï¼Œé¡ºè—¤æ‘¸ç“œï¼Œä¾¿äºçœŸæ­£ç†è§£å¹¶æŒæ¡linuxé©±åŠ¨ç²¾é«“

**ç¬¬å››æ­¥ï¼šé€šè¿‡ioread32()å’Œiowrite32()ç­‰å‡½æ•°æ“ä½œå¯„å­˜å™¨**
- è¿™é‡Œå†å¼ºè°ƒä¸€éï¼Œå³ä½¿ç†è®ºä¸Šå¯ä»¥ç›´æ¥æ“ä½œè¿™æ®µè™šæ‹Ÿåœ°å€äº†ä½†æ˜¯Linuxå¹¶ä¸å»ºè®®è¿™ä¹ˆåš

```c
static int led_chrdev_open(struct inode *inode,struct file *filp){
    unsigned int val = 0;
    // é€šè¿‡ç»“æ„ä½“ä¸­çš„devæˆå‘˜ï¼Œæ‰¾åˆ°è¿™ä¸ªç»“æ„ä½“å˜é‡çš„é¦–åœ°å€
    struct led_chrdev *led_cdev = (struct led_chrdev *)container_of(inode->i_cdev,struct led_chrdev, dev);
    // æŠŠæ–‡ä»¶çš„ç§æœ‰åœ°å€æŒ‡å‘è®¾å¤‡ç»“æ„ä½“ledcdev
    filp->private_data = container_of(inode->i_cdev,struct led_chrdev,dev);

    printk("open\n");

    //è®¾ç½®è¾“å‡ºæ¨¡å¼
    val = ioread32(led_cdev->va_ddr);
    // é«˜ä½ä½¿èƒ½
    val |= ((unsigned int)0x1 << (led_cdev->led_pin+16));
    // ä½ä½è®¾ç½®æ–¹å‘ä¸ºè¾“å‡º
    val |= ((unsigned int)0x1 << (led_cdev->led_pin));
    iowrite32(val,led_cdev->va_ddr);

    //è®¾ç½®é«˜ç”µå¹³
    val = ioread32(led_cdev->va_dr);
    // é«˜ä½ä½¿èƒ½
    val |= ((unsigned int)0x1 << (led_cdev->led_pin+16));
    // ä½ä½è®¾ç½®æ–¹å‘ä¸ºè¾“å‡º
    val |= ((unsigned int)0x1 << (led_cdev->led_pin));
    iowrite32(val,led_cdev->va_dr);

    return 0;
}
```

**ä¸‹é¢æ¥ç€åˆ†æwriteå‡½æ•°çš„å®ç°**
```c
static ssize_t led_chrdev_write(struct filp *filp,const char __user *bf,size_t count,loff_t *ppos){
    unsigned long val = 0;
    char ret = 0;
    struct led_chrdev *led_cdev = (struct led_chrdev *)filp->private_data;

    get_user(ret,buf);
    val = ioread32(led_cdev->va_dr);
    if(ret == '0'){
        val |= ((unsigned int)0x01 << (led_cdev->led_pin+16));
        // è®¾ç½®GPIOå¼•è„šè¾“å‡ºä½ç”µå¹³
        val &= ~((unsigned int)0x01 << (led_cdev->led_pin));
    }else{
        val |= ((unsigned int)0x01 << (led_cdev->led_pin+16));
        // è®¾ç½®GPIOå¼•è„šè¾“å‡ºé«˜ç”µå¹³
        val |= ((unsigned int)0x01 << (led_cdev->led_pin));    
    }
    iowrite32(val,led_cdev->va_dr);

    return count;
}
```

**æœ€ååˆ†æä¸€ä¸‹releaseå‡½æ•°çš„å®ç°**
- å½“æœ€åä¸€ä¸ªæ‰“å¼€è®¾å¤‡çš„ç”¨æˆ·è¿›ç¨‹æ‰§è¡Œclose()ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸å°†è°ƒç”¨é©±åŠ¨ç¨‹åºrelease()å‡½æ•°
- release()å‡½æ•°çš„ä¸»è¦ä»»åŠ¡
	- æ¸…ç†æœªç»“æŸçš„è¾“å…¥è¾“å‡ºä»æŒ¨æ
	- é‡Šæ”¾èµ„æº
	- ç”¨æˆ·è‡ªå®šä¹‰æ’ä»–æ ‡å¿—çš„å¤ä½ç­‰
- è™šæ‹Ÿåœ°å€ä¹Ÿéœ€è¦ä½¿ç”¨iounmap()å‡½æ•°é‡Šæ”¾ï¼Œä¸è¿‡åœ¨é©±åŠ¨æ¨¡å—é€€å‡ºçš„æ—¶å€™æ‰é‡Šæ”¾ï¼Œè¿™é‡Œä¸ç”¨æ“ä½œ
```c
static int led_chrdev_release(struct inode *inode,struct file *filp){
    return 0;
}
```

#### 4.2.5 LEDé©±åŠ¨å®Œæ•´ä»£ç 

åˆ°è¿™é‡Œæˆ‘ä»¬çš„ä»£ç å·²ç»åˆ†æå®Œæˆäº†ï¼Œä¸‹é¢æ˜¯æœ¬é©±åŠ¨çš„å®Œæ•´ä»£ç 
```c
#include <linux/init.h>
#include <linux/module.h>
#include <linux/cdev.h>
#include <linux/fs.h>
#include <linux/uaccess.h>
#include <linux/io.h>

#define DEV_NAME "dk_led_chrdev"
#define DEV_CNT (1)

// GPIO1çš„åŸºåœ°å€
#define GPIO0_BASE (0xFDD60000)

//ä¸€ä¸ªå¯„å­˜å™¨32ä½ï¼Œé«˜16ä½éƒ½æ˜¯ä½¿èƒ½ï¼Œä½16ä½å¯¹åº”16ä¸ªå¼•è„šï¼Œæ§åˆ¶ç”µå¹³
//GPIO1_A0 ... GPIO1_A7 ... GPIO1_B7
#define GPIO0_DR_L (GPIO0_BASE + 0x0000) //ä½16ä½å¼•è„š(A~B)
#define GPIO0_DR_H (GPIO0_BASE + 0x0004) //é«˜16ä½å¼•è„š(C~D)
//æ§åˆ¶æ–¹å‘ï¼ŒåŒä¸Š
#define GPIO0_DDR_L (GPIO0_BASE + 0x0008)
#define GPIO0_DDR_H (GPIO0_BASE + 0x000C)

static dev_t devno;
struct class *led_chrdev_class;

struct led_chrdev{
    struct cdev dev;
    unsigned int __iomem *va_dr;    //è®¾ç½®è¾“å‡ºçš„ç”µå‹
    unsigned int __iomem *va_ddr;   //è®¾ç½®è¾“å‡ºçš„æ–¹å‘
    unsigned int led_pin; //åç§»
};

static int led_chrdev_open(struct inode *inode,struct file *filp){
    unsigned int val = 0;
    // é€šè¿‡ç»“æ„ä½“ä¸­çš„devæˆå‘˜ï¼Œæ‰¾åˆ°è¿™ä¸ªç»“æ„ä½“å˜é‡çš„é¦–åœ°å€
    struct led_chrdev *led_cdev = (struct led_chrdev *)container_of(inode->i_cdev,struct led_chrdev, dev);
    // æŠŠæ–‡ä»¶çš„ç§æœ‰åœ°å€æŒ‡å‘è®¾å¤‡ç»“æ„ä½“led_chrdev
    filp->private_data = container_of(inode->i_cdev,struct led_chrdev,dev);

    printk("open\n");

    //è®¾ç½®è¾“å‡ºæ¨¡å¼
    val = ioread32(led_cdev->va_ddr);
    // é«˜ä½ä½¿èƒ½
    val |= ((unsigned int)0x1 << (led_cdev->led_pin+16));
    // ä½ä½è®¾ç½®æ–¹å‘ä¸ºè¾“å‡º
    val |= ((unsigned int)0x1 << (led_cdev->led_pin));
    iowrite32(val,led_cdev->va_ddr);

    //è®¾ç½®é«˜ç”µå¹³
    val = ioread32(led_cdev->va_dr);
    // é«˜ä½ä½¿èƒ½
    val |= ((unsigned int)0x1 << (led_cdev->led_pin+16));
    // ä½ä½è®¾ç½®æ–¹å‘ä¸ºè¾“å‡º
    val |= ((unsigned int)0x1 << (led_cdev->led_pin));
    iowrite32(val,led_cdev->va_dr);

    return 0;
}

static int led_chrdev_release(struct inode *inode,struct file *filp){
    return 0;
}

static ssize_t led_chrdev_write(struct file *filp,const char __user *buf,size_t count,loff_t *ppos){
    unsigned long val = 0;
    char ret = 0;
    struct led_chrdev *led_cdev = (struct led_chrdev *)(filp->private_data);

    get_user(ret,buf);
    val = ioread32(led_cdev->va_dr);
    if(ret == '0'){
        val |= ((unsigned int)0x01 << (led_cdev->led_pin+16));
        // è®¾ç½®GPIOå¼•è„šè¾“å‡ºä½ç”µå¹³
        val &= ~((unsigned int)0x01 << (led_cdev->led_pin));
    }else{
        val |= ((unsigned int)0x01 << (led_cdev->led_pin+16));
        // è®¾ç½®GPIOå¼•è„šè¾“å‡ºé«˜ç”µå¹³
        val |= ((unsigned int)0x01 << (led_cdev->led_pin));    
    }
    iowrite32(val,led_cdev->va_dr);

    return count;
}

static struct file_operations led_chrdev_fops = {
    .owner = THIS_MODULE,
    .open = led_chrdev_open,
    .release = led_chrdev_release,
    .write = led_chrdev_write,
};

static struct led_chrdev led_cdev[DEV_CNT] = {
    // åç§»ï¼ŒGPIO0_C7åç§»4ä½
    {.led_pin = 7},
};

static __init int led_chrdev_init(void){
    int i = 0;
    dev_t cur_dev;

    printk("led_chrdev init(lubancat2 GPIO0_C7)\n");

    led_cdev[0].va_dr = ioremap(GPIO0_DR_H,4);
    led_cdev[0].va_ddr = ioremap(GPIO0_DDR_H,4);
    // æ³¨å†Œä¸»è®¾å¤‡å·
    alloc_chrdev_region(&devno,0,DEV_CNT,DEV_NAME);
    // åˆ›å»ºè®¾å¤‡ç±»ï¼Œåç§°ä¸ºled_chrdev
    // å†³å®š/sys/class/led_chrdev/dk_led_chrdev0  â† ç±»åæ˜¯ "led_chrdev"
    led_chrdev_class = class_create(THIS_MODULE,"led_chrdev");
    // å¾ªç¯æ·»åŠ åŒä¸€é©±åŠ¨ç¨‹åºçš„è®¾å¤‡
    for(;i<DEV_CNT;i++){
        //åˆå§‹åŒ–cdev
        cdev_init(&led_cdev[i].dev,&led_chrdev_fops);
        led_cdev[i].dev.owner = THIS_MODULE;
        //è·å–cdevçš„å®Œæ•´è®¾å¤‡å·
        cur_dev = MKDEV(MAJOR(devno),MINOR(devno)+i);
        //æ·»åŠ è¯¥è®¾å¤‡åˆ°æ•£åˆ—è¡¨
        cdev_add(&led_cdev[i].dev,cur_dev,1);
        //è®¾å¤‡èŠ‚ç‚¹åˆ›å»ºå·¥ä½œ -> /dev/DEV_NAME%d 
        device_create(led_chrdev_class,NULL,cur_dev,NULL,DEV_NAME"%d",i);
    }
    return 0;
}
module_init(led_chrdev_init);

static __exit void led_chrdev_exit(void){ 
    int i;
    dev_t cur_dev;
    printk("led chrdev exit(lubancat2 GPIO0_C7)\n");

    // é‡Šæ”¾è™šæ‹Ÿåœ°å€
    for(i=0;i<DEV_CNT;i++){
        iounmap(led_cdev[i].va_dr);
        iounmap(led_cdev[i].va_ddr);
    }

    //åˆ é™¤è®¾å¤‡èŠ‚ç‚¹å’Œcdev
    for(i=0;i<DEV_CNT;i++){
        cur_dev = MKDEV(MAJOR(devno),MINOR(devno)+i);
        device_destroy(led_chrdev_class,cur_dev);
        cdev_del(&led_cdev[i].dev);
    }

    //é‡Šæ”¾è®¾å¤‡å·
    unregister_chrdev_region(devno, DEV_CNT);
    //åˆ é™¤è®¾å¤‡ç±»
    class_destroy(led_chrdev_class);
}
module_exit(led_chrdev_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("dakkk");
```

### 4.3 å®éªŒå‡†å¤‡

å¦‚å‡ºç°Â `PermissionÂ denied`Â æˆ–ç±»ä¼¼å­—æ ·ï¼Œè¯·æ³¨æ„ç”¨æˆ·æƒé™ï¼Œå¤§éƒ¨åˆ†æ“ä½œç¡¬ä»¶å¤–è®¾çš„åŠŸèƒ½ï¼Œå‡ ä¹éƒ½éœ€è¦rootç”¨æˆ·æƒé™ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æ‰§è¡Œè¯­å¥å‰åŠ å…¥sudoæˆ–ä»¥rootç”¨æˆ·è¿è¡Œç¨‹åºã€‚

#### 4.3.1 LEDé©±åŠ¨Makefile

```makefile
KERNEL_DIR=../../kernel
ARCH=arm64
CROSS_COMPILE=aarch64-linux-gnu
export ARCH CROSS_COMPILE

obj-m := led_cdev.o

all:
	$(MAKE) -C $(KERNEL_DIR) M=$(CURDIR) modules

.PHONY: clean

clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(CURDIR) clean
```

#### 4.3.2 ç¼–è¯‘å‘½ä»¤è¯´æ˜

```shell
#ä½¿ç”¨äº†ä½ç‰ˆæœ¬çš„äº¤å‰ç¼–è¯‘å™¨
#bearç”¨äºç”Ÿæˆclangdç´¢å¼•æ—¶éœ€è¦çš„compile_command.jsonæ–‡ä»¶
bear -- make CC=aarch64-linux-gnu-gcc-9 -j8
#å¦‚æœæœ¬èº«å°±æ˜¯ä½ç‰ˆæœ¬çš„äº¤å‰ç¼–è¯‘å™¨
bear --make
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/fb1f02ce5cdb101189c16744f41eee09.png)

### 4.4 ç¨‹åºè¿è¡Œç»“æœ

åœ¨é²ç­çŒ«ç³»åˆ—æ¿å¡ï¼Œç³»ç»Ÿè®¾å¤‡æ ‘ä¸­å‡é»˜è®¤ä½¿èƒ½äº†`LED`çš„è®¾å¤‡åŠŸèƒ½ï¼Œéœ€è¦å…³é—­è®¾å¤‡æ ‘çš„ledsèŠ‚ç‚¹ï¼Œå¯ä»¥ä¿®æ”¹ledsèŠ‚ç‚¹çš„ `status = "okay";` ä¸º `status = "disabled";`ï¼Œç„¶åç¼–è¯‘è®¾å¤‡æ ‘é•œåƒæ›¿æ¢ï¼Œä¹Ÿå¯ä»¥åœ¨æ¿å¡ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤å…³é—­ç³»ç»Ÿledsé©±åŠ¨å¯¹LEDçš„æ§åˆ¶
```shell
# å°†ledçš„äº®åº¦è°ƒä¸º0ï¼ŒåŒæ—¶ledçš„è§¦å‘æ¡ä»¶è‡ªåŠ¨å˜ä¸ºnone
sudo sh -c 'echo 0 > /sys/class/leds/sys_led/brightness'
```

é€šè¿‡scpå°†koæ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤åŠ è½½
```shell
scp led_cdev.ko cat@192.168.31.69:/home/cat/

sudo insmod led_cdev.ko
```

ç„¶åå¯ä»¥åœ¨/devç›®å½•ä¸‹æ‰¾åˆ°`dk_led_chrdev0`è¿™ä¸ªè®¾å¤‡ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥ç»™è®¾å¤‡å†™å…¥1/0æ¥æ§åˆ¶LEDçš„äº®ç­
```shell
# æŸ¥çœ‹ledè®¾å¤‡
ls /dev/dk*
#ç»¿ç¯äº®
sudo sh -c 'echo 0 >/dev/dk_led_chrdev0'
#ç»¿ç¯ç­
sudo sh -c 'echo 1 >/dev/dk_led_chrdev0'
```

**å¦‚æœç¯æ— æ³•æ“ä½œï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸‹gpio**
```shell
# æŸ¥çœ‹GPIOçŠ¶æ€
cat /sys/kernel/debug/gpio
# æˆ–è€…
cat /proc/interrupts | grep gpio
```