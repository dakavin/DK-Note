ğŸ“¢è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1. æ­¥éª¤ä¸€ï¼šä½¿ç”¨ class_create å‡½æ•°åˆ›å»ºä¸€ä¸ªç±»ã€‚
    
2. æ­¥éª¤äºŒï¼šä½¿ç”¨ device_create å‡½æ•°åœ¨æˆ‘ä»¬åˆ›å»ºçš„ç±»ä¸‹é¢åˆ›å»ºä¸€ä¸ªè®¾å¤‡ã€‚
    

## è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹

---

Linux é©±åŠ¨å®éªŒä¸­ï¼Œå½“æˆ‘ä»¬é€šè¿‡ insmod å‘½ä»¤åŠ è½½æ¨¡å—åï¼Œè¿˜éœ€è¦é€šè¿‡ mknod å‘½ä»¤æ¥æ‰‹åŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œè¿™æ ·ä½¿ç”¨èµ·æ¥å¤ªéº»çƒ¦äº†ï¼Œå¹¶ä¸”ä¸å¯èƒ½æ¯ä¸ªè®¾å¤‡éƒ½å»è¿™æ ·æ“ä½œï¼ŒLinux ç³»ç»Ÿçš„å­˜åœ¨å°±æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å®ç°è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œå½“åŠ è½½æ¨¡å—æ—¶ï¼Œåœ¨/dev ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºç›¸åº”çš„è®¾å¤‡æ–‡ä»¶ã€‚

  

æ€ä¹ˆè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨åµŒå…¥å¼ Linux ä¸­ä½¿ç”¨ mdev æ¥å®ç°è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶çš„è‡ªåŠ¨åˆ›å»ºå’Œåˆ é™¤ã€‚

  

udev æ˜¯ä¸€ç§å·¥å…·ï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®ç³»ç»Ÿä¸­çš„ç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€åŠ¨æ€æ›´æ–°è®¾å¤‡æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºï¼Œåˆ é™¤ç­‰ã€‚è®¾å¤‡

æ–‡ä»¶é€šå¸¸æ”¾åœ¨/dev ç›®å½•ä¸‹ã€‚

ä½¿ç”¨ udev åï¼Œåœ¨/dev ç›®å½•ä¸‹å°±åªåŒ…å«ç³»ç»Ÿä¸­çœŸæ­£å­˜åœ¨çš„è®¾å¤‡ã€‚

è€Œmdev æ˜¯ udev çš„ç®€åŒ–ç‰ˆæœ¬,æ˜¯ busybox ä¸­æ‰€å¸¦çš„ç¨‹åº,æœ€é€‚åˆç”¨åœ¨åµŒå…¥å¼ç³»ç»Ÿ,è€Œ udev ä¸€èˆ¬ç”¨åœ¨ PC ä¸Šçš„linux ä¸­,ç›¸å¯¹ mdev æ¥è¯´è¦å¤æ‚äº›ï¼Œæ‰€ä»¥åœ¨åµŒå…¥å¼ Linux ä¸­ä½¿ç”¨ mdev æ¥å®ç°è®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶çš„è‡ªåŠ¨åˆ›å»ºå’Œåˆ é™¤ã€‚

### åˆ›å»ºå’Œåˆ é™¤ç±»å‡½æ•°

å†…æ ¸ä¸­å®šä¹‰äº† struct class ç»“æ„ä½“ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸€ä¸ª struct class ç»“æ„ä½“ç±»å‹å˜é‡å¯¹åº”ä¸€ä¸ªç±»ï¼Œå†…æ ¸åŒæ—¶æä¾›äº† class_create ç”¨æ¥åˆ›å»ºä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å­˜æ”¾äº sysfs ä¸‹é¢ï¼Œä¸€æ—¦åˆ›å»ºå¥½äº†è¿™ä¸ªç±»ï¼Œå†è°ƒç”¨ device_createæ¥åœ¨/dev ç›®å½•ä¸‹åˆ›å»ºç›¸åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚è¿™æ ·ï¼ŒåŠ è½½æ¨¡å—çš„æ—¶å€™ï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„ udev ä¼šè‡ªåŠ¨å“åº” device_createï¼Œå»/sysfs ä¸‹å¯»æ‰¾å¯¹åº”çš„ç±»ä»è€Œåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€‚

åœ¨ Linux é©±åŠ¨ç¨‹åºä¸­ä¸€èˆ¬é€šè¿‡ class_create å’Œ class_destroy æ¥å®Œæˆè®¾å¤‡èŠ‚ç‚¹çš„åˆ›å»ºå’Œåˆ é™¤ã€‚é¦–å…ˆè¦åˆ›å»ºä¸€ä¸ª class ç±»ç»“æ„ä½“ï¼Œclass ç»“æ„ä½“å®šä¹‰åœ¨ include/linux/device.h é‡Œé¢ã€‚class_create æ˜¯ä¸ªå®ï¼Œå®å®šä¹‰å¦‚ä¸‹ï¼š

```C
#define class_create(owner, name) \({ \static struct lock_class_key __key; \ __class_create(owner, name, &__key); \})
struct class *__class_create(struct module *owner, const char *name, struct lock_class_key *key)
```

class_create ä¸€å…±æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° owner ä¸€èˆ¬ä¸º THIS_MODULEï¼Œå‚æ•° name æ˜¯ç±»åå­—ã€‚è¿”å›å€¼æ˜¯ä¸ªæŒ‡å‘ç»“æ„ä½“ class çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçš„ç±»ã€‚

å¸è½½é©±åŠ¨ç¨‹åºçš„æ—¶å€™éœ€è¦åˆ é™¤æ‰ç±»ï¼Œç±»åˆ é™¤å‡½æ•°ä¸º class_destroyï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```C
void class_destroy(struct class *cls);
```

å‚æ•° cls å°±æ˜¯è¦åˆ é™¤çš„ç±»ã€‚

### åˆ›å»ºè®¾å¤‡å‡½æ•°

å½“ä½¿ç”¨ä¸ŠèŠ‚çš„å‡½æ•°åˆ›å»ºå®Œæˆä¸€ä¸ªç±»åï¼Œä½¿ç”¨ device_create å‡½æ•°åœ¨è¿™ä¸ªç±»ä¸‹åˆ›å»ºä¸€ä¸ªè®¾å¤‡ã€‚device_create å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```C
struct device *device_create(struct class *class, struct device *parent, dev_t devt, void *drvdata, const char *fmt, ...)
```

device_create æ˜¯ä¸ªå¯å˜å‚æ•°å‡½æ•°ï¼Œå‚æ•° class å°±æ˜¯è®¾å¤‡è¦åˆ›å»ºå“ªä¸ªç±»ä¸‹é¢ï¼›å‚æ•° parent æ˜¯çˆ¶è®¾å¤‡ï¼Œä¸€èˆ¬ä¸º NULLï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰çˆ¶è®¾å¤‡ï¼›å‚æ•° devt æ˜¯è®¾å¤‡å·ï¼›å‚æ•° drvdata æ˜¯è®¾å¤‡å¯èƒ½ä¼šä½¿ç”¨çš„ä¸€äº›æ•°æ®ï¼Œä¸€èˆ¬ä¸º NULLï¼›å‚æ•° fmt æ˜¯è®¾å¤‡åå­—ï¼Œå¦‚æœè®¾ç½® fmt=xxx çš„è¯ï¼Œå°±ä¼šç”Ÿæˆ/dev/xxx è¿™ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚è¿”å›å€¼å°±æ˜¯åˆ›å»ºå¥½çš„è®¾å¤‡ã€‚

åŒæ ·çš„ï¼Œå¸è½½é©±åŠ¨çš„æ—¶å€™éœ€è¦åˆ é™¤æ‰åˆ›å»ºçš„è®¾å¤‡ï¼Œè®¾å¤‡åˆ é™¤å‡½æ•°ä¸º device_destroyï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```C
void device_destroy(struct class *class, dev_t devt)
```

å‚æ•° class æ˜¯è¦åˆ é™¤çš„è®¾å¤‡æ‰€å¤„çš„ç±»ï¼Œå‚æ•° devt æ˜¯è¦åˆ é™¤çš„è®¾å¤‡å·ã€‚

## åˆ›å»ºç±»å‡½æ•°

---

æ¡ˆä¾‹ï¼š

```C
/*
* @Author:topeet * @Description:å­—ç¬¦è®¾å¤‡è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æ­¥éª¤ä¸€åˆ›å»ºç±»ï¼Œåˆ›å»ºè®¾å¤‡
*/
#include <linux/init.h> //åˆå§‹åŒ–å¤´æ–‡ä»¶
#include <linux/module.h> //æœ€åŸºæœ¬çš„æ–‡ä»¶ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ å’Œå¸è½½æ¨¡å—ã€‚
#include <linux/fs.h> //åŒ…å«äº†æ–‡ä»¶æ“ä½œç›¸å…³ struct çš„å®šä¹‰ï¼Œä¾‹å¦‚å¤§åé¼é¼çš„ struct file_operations
#include <linux/kdev_t.h>
#include <linux/cdev.h> //å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„ cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚//åŒ…å«äº† cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚
#define DEVICE_NUMBER 1 //å®šä¹‰æ¬¡è®¾å¤‡å·çš„ä¸ªæ•°
#define DEVICE_SNAME "schrdev" //å®šä¹‰é™æ€æ³¨å†Œè®¾å¤‡çš„åç§°
#define DEVICE_ANAME "achrdev" //å®šä¹‰åŠ¨æ€æ³¨å†Œè®¾å¤‡çš„åç§°
#define DEVICE_MINOR_NUMBER 0 //å®šä¹‰æ¬¡è®¾å¤‡å·çš„èµ·å§‹åœ°å€
#include <linux/device.h> //åŒ…å«äº† deviceã€class ç­‰ç»“æ„çš„å®šä¹‰
#define DEVICE_CLASS_NAME "chrdev_class" 
#define DEVICE_NODE_NAME "chrdev_test" //å®å®šä¹‰è®¾å¤‡èŠ‚ç‚¹çš„åå­—
static int major_num, minor_num; //å®šä¹‰ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·
struct class *class; /* ç±» */
struct cdev cdev; //å®šä¹‰ä¸€ä¸ª cdev ç»“æ„ä½“
module_param(major_num, int, S_IRUSR); //é©±åŠ¨æ¨¡å—ä¼ å…¥æ™®é€šå‚æ•° major_num
module_param(minor_num, int, S_IRUSR); //é©±åŠ¨æ¨¡å—ä¼ å…¥æ™®é€šå‚æ•° minor_num
dev_t dev_num; /* è®¾å¤‡å· */
/**
* @description: æ‰“å¼€è®¾å¤‡
* @param {structinode} *inodeï¼šä¼ é€’ç»™é©±åŠ¨çš„ inode * @param {structfile} *fileï¼šè®¾å¤‡æ–‡ä»¶ï¼Œfile ç»“æ„ä½“æœ‰ä¸ªå«åš private_data çš„æˆå‘˜å˜é‡ï¼Œ
* ä¸€èˆ¬åœ¨ open çš„æ—¶å€™å°† private_data æŒ‡å‘è®¾å¤‡ç»“æ„ä½“ã€‚
* @return: 0 æˆåŠŸ;å…¶ä»– å¤±è´¥
*/
int chrdev_open(struct inode *inode, struct file *file)
{
        printk("chrdev_open\n");
        return 0;
}
// è®¾å¤‡æ“ä½œå‡½æ•°ç»“æ„ä½“
struct file_operations chrdev_ops = {
        .owner = THIS_MODULE, 
        .open = chrdev_open};
/**

* @description: é©±åŠ¨å…¥å£å‡½æ•°
* @param {*}æ— 
* @return {*} 0 æˆåŠŸ;å…¶ä»– å¤±è´¥
*/
static int hello_init(void)
{
        int ret; //å‡½æ•°è¿”å›å€¼
        if (major_num)
        {
                /*é™æ€æ³¨å†Œè®¾å¤‡å·*/
                printk("major_num = %d\n", major_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„ä¸»è®¾å¤‡å·
                printk("minor_num = %d\n", minor_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„æ¬¡è®¾å¤‡å·
                dev_num = MKDEV(major_num, minor_num); //MKDEV å°†ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·åˆå¹¶ä¸ºä¸€ä¸ªè®¾å¤‡å·
                ret = register_chrdev_region(dev_num, DEVICE_NUMBER, DEVICE_SNAME); //æ³¨å†Œè®¾å¤‡å·
                if (ret < 0)
                {
                        printk("register_chrdev_region error\n");
                }
                printk("register_chrdev_region ok\n"); //é™æ€æ³¨å†Œè®¾å¤‡å·æˆåŠŸ
        }
        else
        {
                /*åŠ¨æ€æ³¨å†Œè®¾å¤‡å·*/
                ret = alloc_chrdev_region(&dev_num, DEVICE_MINOR_NUMBER, 1, DEVICE_ANAME);
                if (ret < 0)
                {
                        printk("alloc_chrdev_region error\n");
                }
                printk("alloc_chrdev_region ok\n"); //åŠ¨æ€æ³¨å†Œè®¾å¤‡å·æˆåŠŸ
                major_num = MAJOR(dev_num); //å°†ä¸»è®¾å¤‡å·å–å‡ºæ¥
                minor_num = MINOR(dev_num); //å°†æ¬¡è®¾å¤‡å·å–å‡ºæ¥
                printk("major_num = %d\n", major_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„ä¸»è®¾å¤‡å·
                printk("minor_num = %d\n", minor_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„æ¬¡è®¾å¤‡å·
        }
        // åˆå§‹åŒ– cdev
        cdev.owner = THIS_MODULE;
        cdev_init(&cdev, &chrdev_ops);
        // å‘ç³»ç»Ÿæ³¨å†Œè®¾å¤‡
        cdev_add(&cdev, dev_num, DEVICE_NUMBER);
        // åˆ›å»º class ç±»
        class = class_create(THIS_MODULE, DEVICE_CLASS_NAME);
        return 0;
}
/**
* @description: é©±åŠ¨å‡ºå£å‡½æ•°
* @param {*}æ— 
* @return {*}æ— 
*/
static void hello_exit(void)
{
        //æ³¨é”€è®¾å¤‡å·
        unregister_chrdev_region(MKDEV(major_num, minor_num), DEVICE_NUMBER);
        //åˆ é™¤è®¾å¤‡
        cdev_del(&cdev);
        //åˆ é™¤ç±»
        class_destroy(class);
        printk("gooodbye! \n");
}
// å°†ä¸Šé¢ä¸¤ä¸ªå‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å’Œå‡ºå£å‡½æ•°
module_init(hello_init);
module_exit(hello_exit);
// LICENSE
MODULE_LICENSE("GPL");
```

å¦‚æœåˆ›å»ºç±»æˆåŠŸäº†ä»¥åï¼Œä»–ä¼šåœ¨å¼€å‘æ¿çš„/sys/class/ä¸‹é¢ç”Ÿæˆä¸€ä¸ªåä¸ºâ€œchrdev_classâ€çš„ç±»ã€‚

```C
insmod chrdev.ko
ls /sys/class
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/bfeea0e92599d753f5ae2471f3fd146d.png)


## åˆ›å»ºè®¾å¤‡å‡½æ•°

---

åœ¨ä¸Šä¸€ç« èŠ‚ä»£ç çš„åŸºç¡€ä¸Šæ·»åŠ åˆ›å»ºè®¾å¤‡çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```C
/*
* @Author:topeet * @Description:å­—ç¬¦è®¾å¤‡è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æ­¥éª¤ä¸€åˆ›å»ºç±»ï¼Œåˆ›å»ºè®¾å¤‡
*/
#include <linux/init.h> //åˆå§‹åŒ–å¤´æ–‡ä»¶
#include <linux/module.h> //æœ€åŸºæœ¬çš„æ–‡ä»¶ï¼Œæ”¯æŒåŠ¨æ€æ·»åŠ å’Œå¸è½½æ¨¡å—ã€‚
#include <linux/fs.h> //åŒ…å«äº†æ–‡ä»¶æ“ä½œç›¸å…³ struct çš„å®šä¹‰ï¼Œä¾‹å¦‚å¤§åé¼é¼çš„ struct file_operations
#include <linux/kdev_t.h>
#include <linux/cdev.h> //å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„ cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚//åŒ…å«äº† cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚
#define DEVICE_NUMBER 1 //å®šä¹‰æ¬¡è®¾å¤‡å·çš„ä¸ªæ•°
#define DEVICE_SNAME "schrdev" //å®šä¹‰é™æ€æ³¨å†Œè®¾å¤‡çš„åç§°
#define DEVICE_ANAME "achrdev" //å®šä¹‰åŠ¨æ€æ³¨å†Œè®¾å¤‡çš„åç§°
#define DEVICE_MINOR_NUMBER 0 //å®šä¹‰æ¬¡è®¾å¤‡å·çš„èµ·å§‹åœ°å€
#include <linux/device.h> //åŒ…å«äº† deviceã€class ç­‰ç»“æ„çš„å®šä¹‰
#define DEVICE_CLASS_NAME "chrdev_class" 
#define DEVICE_NODE_NAME "chrdev_test" //å®å®šä¹‰è®¾å¤‡èŠ‚ç‚¹çš„åå­—
static int major_num, minor_num; //å®šä¹‰ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·
struct class *class; /* ç±» */
struct device *device; /* è®¾å¤‡ */
struct cdev cdev; //å®šä¹‰ä¸€ä¸ª cdev ç»“æ„ä½“
module_param(major_num, int, S_IRUSR); //é©±åŠ¨æ¨¡å—ä¼ å…¥æ™®é€šå‚æ•° major_num
module_param(minor_num, int, S_IRUSR); //é©±åŠ¨æ¨¡å—ä¼ å…¥æ™®é€šå‚æ•° minor_num
dev_t dev_num; /* è®¾å¤‡å· */
/**
* @description: æ‰“å¼€è®¾å¤‡
* @param {structinode} *inodeï¼šä¼ é€’ç»™é©±åŠ¨çš„ inode * @param {structfile} *fileï¼šè®¾å¤‡æ–‡ä»¶ï¼Œfile ç»“æ„ä½“æœ‰ä¸ªå«åš private_data çš„æˆå‘˜å˜é‡ï¼Œ
* ä¸€èˆ¬åœ¨ open çš„æ—¶å€™å°† private_data æŒ‡å‘è®¾å¤‡ç»“æ„ä½“ã€‚
* @return: 0 æˆåŠŸ;å…¶ä»– å¤±è´¥
*/
int chrdev_open(struct inode *inode, struct file *file)
{
        printk("chrdev_open\n");
        return 0;
}
// è®¾å¤‡æ“ä½œå‡½æ•°ç»“æ„ä½“
struct file_operations chrdev_ops = {
        .owner = THIS_MODULE, 
        .open = chrdev_open};
/**
* @description: é©±åŠ¨å…¥å£å‡½æ•°
* @param {*}æ— 
* @return {*} 0 æˆåŠŸ;å…¶ä»– å¤±è´¥
*/
static int hello_init(void)
{
        int ret; //å‡½æ•°è¿”å›å€¼
        if (major_num)
        {
                /*é™æ€æ³¨å†Œè®¾å¤‡å·*/
                printk("major_num = %d\n", major_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„ä¸»è®¾å¤‡å·
                printk("minor_num = %d\n", minor_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„æ¬¡è®¾å¤‡å·
                dev_num = MKDEV(major_num, minor_num); //MKDEV å°†ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·åˆå¹¶ä¸ºä¸€ä¸ªè®¾å¤‡å·
                ret = register_chrdev_region(dev_num, DEVICE_NUMBER, DEVICE_SNAME); //æ³¨å†Œè®¾å¤‡å·
                if (ret < 0)
                {
                        printk("register_chrdev_region error\n");
                }
                printk("register_chrdev_region ok\n"); //é™æ€æ³¨å†Œè®¾å¤‡å·æˆåŠŸ
        }
        else
        {
                /*åŠ¨æ€æ³¨å†Œè®¾å¤‡å·*/
                ret = alloc_chrdev_region(&dev_num, DEVICE_MINOR_NUMBER, 1, DEVICE_ANAME);
                if (ret < 0)
                {
                        printk("alloc_chrdev_region error\n");
                }
                printk("alloc_chrdev_region ok\n"); //åŠ¨æ€æ³¨å†Œè®¾å¤‡å·æˆåŠŸ
                major_num = MAJOR(dev_num); //å°†ä¸»è®¾å¤‡å·å–å‡ºæ¥
                minor_num = MINOR(dev_num); //å°†æ¬¡è®¾å¤‡å·å–å‡ºæ¥
                printk("major_num = %d\n", major_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„ä¸»è®¾å¤‡å·
                printk("minor_num = %d\n", minor_num); //æ‰“å°ä¼ å…¥è¿›æ¥çš„æ¬¡è®¾å¤‡å·
        }
        // åˆå§‹åŒ– cdev
        cdev.owner = THIS_MODULE;
        cdev_init(&cdev, &chrdev_ops);
        // å‘ç³»ç»Ÿæ³¨å†Œè®¾å¤‡
        cdev_add(&cdev, dev_num, DEVICE_NUMBER);
        // åˆ›å»º class ç±»
        class = class_create(THIS_MODULE, DEVICE_CLASS_NAME);
        // åœ¨ class ç±»ä¸‹åˆ›å»ºè®¾å¤‡
        device = device_create(class, NULL, dev_num, NULL, DEVICE_NODE_NAME);
        return 0;
}
/**
* @description: é©±åŠ¨å‡ºå£å‡½æ•°
* @param {*}æ— 
* @return {*}æ— 
*/
static void hello_exit(void)
{
        //æ³¨é”€è®¾å¤‡å·
        unregister_chrdev_region(MKDEV(major_num, minor_num), DEVICE_NUMBER);
        //åˆ é™¤è®¾å¤‡
        cdev_del(&cdev);
        //æ³¨é”€è®¾å¤‡
        device_destroy(class, dev_num);
        //åˆ é™¤ç±»
        class_destroy(class);
        printk("gooodbye! \n");
}
// å°†ä¸Šé¢ä¸¤ä¸ªå‡½æ•°æŒ‡å®šä¸ºé©±åŠ¨çš„å…¥å£å’Œå‡ºå£å‡½æ•°
module_init(hello_init);
module_exit(hello_exit);
// LICENSE 
MODULE_LICENSE("GPL");
```

ç¼–å†™åº”ç”¨æµ‹è¯•ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š

```C
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
int main(int argc,char *argv[])
{
        int fd;
        char buf[64] = {0};
        fd = open("/dev/chrdev_test",O_RDWR); //æ‰“å¼€è®¾å¤‡èŠ‚ç‚¹
        if(fd < 0)
        {
                perror("open error \n");
                return fd;
        }
        //read(fd,buf,sizeof(buf)); //ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®æ”¾å…¥ç¼“å†²åŒºä¸­
        close(fd);
        return 0;
}
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/53b32f85e1879a075a6eea5ded13c21a.png)
