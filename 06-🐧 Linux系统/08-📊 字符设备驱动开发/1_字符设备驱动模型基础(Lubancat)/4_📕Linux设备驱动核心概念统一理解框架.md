
## 1 ğŸ¯æ ¸å¿ƒç†å¿µï¼šä¸€åˆ‡çš†æ–‡ä»¶çš„è®¾å¤‡ç®¡ç†ä½“ç³»

**è®¾å¤‡è®¿é—®çš„å®Œæ•´é“¾è·¯**
```shell
ç”¨æˆ·ç¨‹åº â†’ è®¾å¤‡èŠ‚ç‚¹ â†’ VFS â†’ é©±åŠ¨ç¨‹åº â†’ ç¡¬ä»¶è®¾å¤‡
    â†“         â†“       â†“       â†“         â†“
   open    /dev/xxx  inode   f_ops    å®é™…ç¡¬ä»¶
```

## 2 ğŸ“‹æ ¸å¿ƒæ¦‚å¿µåˆ†å±‚ç†è§£

### 2.1 èº«ä»½æ ‡è¯†å±‚ï¼ˆdev_tï¼‰

**è®¾å¤‡å·ï¼ˆdev_tï¼‰**
- ä½œç”¨ï¼šè®¾å¤‡çš„å”¯ä¸€èº«ä»½è¯å·
- ç»“æ„ï¼š32bit = ä¸»è®¾å¤‡å·ï¼ˆ12bitï¼‰ + æ¬¡è®¾å¤‡å·ï¼ˆ20bitï¼‰
- æ¯”å–»ï¼šèº«ä»½è¯å· = çœä»½ä»£ç  + ä¸ªäººç”Ÿæ—¥ + ç‰¹æ®Šç¼–å·
- å…³é”®å®ï¼š
```c
MAJOR(dev)     // æå–ä¸»è®¾å¤‡å·
MINOR(dev)     // æå–æ¬¡è®¾å¤‡å·  
MKDEV(ma,mi)   // åˆå¹¶æˆå®Œæ•´è®¾å¤‡å·
```

### 2.2 ç®¡ç†æ³¨å†Œå±‚(cdevç»“æ„ä½“)

**cdevç»“æ„ä½“**
- ä½œç”¨ï¼šå­—ç¬¦è®¾å¤‡çš„å®Œæ•´æ¡£æ¡ˆï¼Œå†…æ ¸çš„ç®¡ç†å•å…ƒ
- æ ¸å¿ƒå­—æ®µï¼š
	- devï¼šè®¾å¤‡å·ï¼ˆèº«ä»½è¯ï¼‰
	- opsï¼šæ“ä½œæ–¹æ³•é›†ï¼ˆè¯´æ˜ä¹¦ï¼‰
	- ownerï¼šæ‰€å±æ¨¡å—ï¼ˆè´£ä»»äººï¼‰
- ç®¡ç†æ–¹å¼ï¼šæ•£åˆ—è¡¨ `cdev_map`ï¼Œé€šè¿‡ä¸»è®¾å¤‡å·å¿«é€ŸæŸ¥æ‰¾
- æ¯”å–»ï¼šæˆ·ç±ç®¡ç†ç³»ç»Ÿä¸­çš„ä¸ªäººæ¡£æ¡ˆ

### 2.3 æ–‡ä»¶ç³»ç»Ÿæ¥å£å±‚ï¼ˆç”¨æˆ·è®¿é—®çš„å…¥å£/devï¼‰

**è®¾å¤‡èŠ‚ç‚¹**
- ä½ç½®ï¼š`/dev`ç›®å½•ä¸‹çš„ç‰¹æ®Šæ–‡ä»¶
- ä½œç”¨ï¼šç”¨æˆ·ç¨‹åºè®¿é—®è®¾å¤‡çš„ç»Ÿä¸€å…¥å£
- åˆ›å»ºï¼š`mknod`å‘½ä»¤
- æ¯”å–»ï¼šé“¶è¡Œçš„æœåŠ¡çª—å£ã€ç»Ÿä¸€çš„æœåŠ¡æ¥å£

### 2.4 æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼ˆæ–‡ä»¶çš„èº«ä»½ä¿¡æ¯inodeï¼‰

**inodeç»“æ„ä½“**
- ä½œç”¨ï¼šæ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯è½½ä½“
- å…³é”®å­—æ®µï¼š
	- `i_rdev`ï¼šè®¾å¤‡å·
	- `i_cdev`ï¼šæŒ‡å‘cdevç»“æ„ä½“
- ç‰¹ç‚¹ï¼šä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ªinodeï¼Œè®°å½•æ–‡ä»¶çš„é™æ€ä¿¡æ¯
- æ¯”å–»ï¼šæˆ¿äº§è¯ï¼Œè®°å½•æˆ¿å­çš„åŸºæœ¬ä¿¡æ¯

### 2.5 è®¿é—®ä¼šè¯å±‚ï¼ˆæ–‡ä»¶æ“ä½œçš„ä¼šè¯è®°å½• fileï¼‰

**fileç»“æ„ä½“**
- ä½œç”¨ï¼šæ¯æ¬¡æ‰“å¼€æ–‡ä»¶çš„æ“ä½œä¼šè¯è®°å½•
- å…³é”®å­—æ®µï¼š
	- `f_op`ï¼šæŒ‡å‘æ“ä½œå‡½æ•°é›†
	- `private_data`ï¼šé©±åŠ¨ç§æœ‰æ•°æ®
- ç‰¹ç‚¹ï¼šä¸€æ¬¡æ‰“å¼€ä¸€ä¸ªfileï¼Œè®°å½•æ–‡ä»¶çš„åŠ¨æ€ä¿¡æ¯
- æ¯”å–»ï¼šé“¶è¡Œä¸šåŠ¡å•ï¼Œè®°å½•æœ¬æ¬¡æ“ä½œçš„ä¿¡æ¯

### 2.6 æ“ä½œå®ç°å±‚ï¼ˆå…·ä½“åŠŸèƒ½å®ç°file_operationsï¼‰

**file_operationsç»“æ„ä½“**
- ä½œç”¨ï¼šè®¾å¤‡æ“ä½œçš„å…·ä½“å®ç°æ–¹æ³•é›†
- æ ¸å¿ƒå‡½æ•°ï¼š
	- `open/release`: æ‰“å¼€/å…³é—­è®¾å¤‡
	- `read/write`: è¯»å†™æ•°æ®
	- `unlocked_ioctl`: è®¾å¤‡æ§åˆ¶
- æ¯”å–»ï¼šè®¾å¤‡æ“ä½œè¯´æ˜ä¹¦

## 3 ğŸ”„ æ•°æ®ç»“æ„å…³ç³»å›¾

```shell
è®¾å¤‡å·(dev_t) â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚
    â†“                    â”‚
cdevç»“æ„ä½“ â”€â”€â†’ file_operations
    â†‘                    â”‚
    â”‚                    â”‚
inode â”€â”€â†’ fileç»“æ„ä½“ â”€â”€â”€â”€â”€â”€â”˜
    â†‘         â”‚
    â”‚         â†“
è®¾å¤‡èŠ‚ç‚¹   ç”¨æˆ·ç¨‹åºè°ƒç”¨
(/dev/xxx)
```

## 4 ğŸ­ ç»Ÿä¸€ç†è§£ï¼šé¤å…æœåŠ¡ç±»æ¯”

|æ¦‚å¿µ|é¤å…ç±»æ¯”|æ ¸å¿ƒä½œç”¨|
|---|---|---|
|**è®¾å¤‡å·**|é¤å…åœ°å€ç¼–å·|å”¯ä¸€æ ‡è¯†è®¾å¤‡|
|**cdev**|é¤å…è¥ä¸šæ‰§ç…§|å†…æ ¸ç®¡ç†è®¾å¤‡çš„å‡­è¯|
|**è®¾å¤‡èŠ‚ç‚¹**|é¤å…é—¨ç‰Œ|ç”¨æˆ·æ‰¾åˆ°è®¾å¤‡çš„å…¥å£|
|**inode**|é¤å…åŸºæœ¬ä¿¡æ¯|æ–‡ä»¶ç³»ç»Ÿä¸­çš„è®¾å¤‡ä¿¡æ¯|
|**file**|ç”¨é¤è®°å½•å•|æ¯æ¬¡è®¿é—®çš„ä¼šè¯ä¿¡æ¯|
|**file_operations**|èœå•+æœåŠ¡æµç¨‹|å…·ä½“çš„æ“ä½œæ–¹æ³•|

## 5 ğŸ” åŒºåˆ†è¦ç‚¹

### 5.1 é™æ€ vs åŠ¨æ€

- **é™æ€(ä¸€å¯¹ä¸€)**: è®¾å¤‡å·ã€cdevã€è®¾å¤‡èŠ‚ç‚¹ã€inode
- **åŠ¨æ€(ä¸€å¯¹å¤š)**: fileç»“æ„ä½“(ä¸€ä¸ªè®¾å¤‡å¯ä»¥è¢«å¤šæ¬¡æ‰“å¼€)

### 5.2 ç®¡ç†å±‚æ¬¡

- **å†…æ ¸ç®¡ç†**: cdevã€inode
- **æ–‡ä»¶ç³»ç»Ÿ**: è®¾å¤‡èŠ‚ç‚¹ã€inode
- **ç”¨æˆ·è®¿é—®**: fileã€file_operations

### 5.3 ç”Ÿå‘½å‘¨æœŸ

- **ç³»ç»Ÿå¯åŠ¨æ—¶**: è®¾å¤‡å·åˆ†é…ã€cdevæ³¨å†Œ
- **è®¾å¤‡èŠ‚ç‚¹åˆ›å»º**: mknodå‘½ä»¤
- **æ¯æ¬¡æ‰“å¼€**: åˆ›å»ºfileç»“æ„ä½“
- **æ¯æ¬¡å…³é—­**: é”€æ¯fileç»“æ„ä½“

## 6 è®°å¿†å£è¯€

**"å·æ¡£èŠ‚ç‚¹ä¸€æ–‡æ“"**
- **å·**: è®¾å¤‡å· - èº«ä»½æ ‡è¯†
- **æ¡£**: cdev - è®¾å¤‡æ¡£æ¡ˆ
- **èŠ‚**: è®¾å¤‡èŠ‚ç‚¹ - è®¿é—®å…¥å£
- **ç‚¹**: inode - æ–‡ä»¶ä¿¡æ¯ç‚¹
- **ä¸€**: file - ä¸€æ¬¡è®¿é—®ä¼šè¯
- **æ–‡**: file_operations - æ“ä½œæ–‡æ¡£

## 7 å·¥ä½œæµç¨‹æ•´åˆ

1. é©±åŠ¨åŠ è½½ â†’ ç”³è¯·è®¾å¤‡å· â†’ åˆå§‹åŒ–cdev â†’ æ³¨å†Œåˆ°å†…æ ¸
2. åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ â†’ å»ºç«‹/devä¸‹çš„è®¿é—®å…¥å£
3. ç”¨æˆ·open â†’ åˆ›å»ºfileç»“æ„ä½“ â†’ å…³è”inode â†’ è°ƒç”¨f_ops->open
4. ç”¨æˆ·read/write â†’ é€šè¿‡fileæ‰¾åˆ°f_ops â†’ è°ƒç”¨å¯¹åº”å‡½æ•°
5. ç”¨æˆ·close â†’ è°ƒç”¨f_ops->release â†’ é”€æ¯fileç»“æ„ä½“