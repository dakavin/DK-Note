---
æ–‡ç« æ ‡é¢˜: "[[08_è®¾å¤‡æ ‘ä¸­ Pinctrlçš„æè¿°]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  ä»‹ç»Linuxè®¾å¤‡æ ‘ä¸­PinctrlèŠ‚ç‚¹çš„ä½œç”¨ã€é…ç½®æ–¹æ³•å’Œå¼•ç”¨æœºåˆ¶ï¼Œè¯¦ç»†è¯´æ˜äº†IOMUXã€PINCONFç­‰é…ç½®ç±»å‹ä»¥åŠå¤šçŠ¶æ€æ”¯æŒçš„å®ç°æ–¹å¼ã€‚
tags:
  - è®¾å¤‡æ ‘
  - Pinctrl
  - å¼•è„šæ§åˆ¶
  - IOMUX
  - PINCONF
  - GPIO
  - RKèŠ¯ç‰‡
  - åµŒå…¥å¼ç³»ç»Ÿ
ç›¸å…³æ–‡ç« :
  - "[[07_è®¾å¤‡æ ‘ä¸­ GPIO ç›¸å…³å±æ€§ (å®šä¹‰)]]"
  - "[[02_è®¾å¤‡æ ‘ï¼ˆdevice Treeï¼‰çš„ç”±æ¥]]"
  - "[[01_Linuxç³»ç»Ÿæ„æˆç®€å•ä»‹ç»]]"
  - "[[03_å›¾è§£Kernel Device Tree(è®¾å¤‡æ ‘)çš„ä½¿ç”¨]]"
  - "[[04_è®¾å¤‡æ ‘ä¸­CPUæè¿° (ä¸éœ€è¦æ”¹)]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/05-ğŸš— Linuxé©±åŠ¨ç›¸å…³å­ç³»ç»Ÿ (é‡ç‚¹)/3_è®¾å¤‡æ ‘/1_Linuxä¹‹è®¾å¤‡æ ‘è¯¦è§£ï¼ˆè®­ç»ƒè¥ï¼‰/07_è®¾å¤‡æ ‘ä¸­ Pinctrlçš„æè¿°.md
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2025-06-10 20:34:00
ä¿®æ”¹æ—¶é—´: 2025-06-11 14:47:16
---

## 1 ä»€ä¹ˆæ˜¯ Pinctrl èŠ‚ç‚¹

**pinctrl èŠ‚ç‚¹**ï¼šè®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰ä¸­ä¸“é—¨ç”¨æ¥æè¿°ç¡¬ä»¶å¹³å°**å¼•è„šæ§åˆ¶ï¼ˆPin Controlï¼‰** ç›¸å…³ä¿¡æ¯çš„ç‰¹æ®ŠèŠ‚ç‚¹ã€‚

> [!info]+ é€šä¿—ç†è§£ 
> æŠŠ pinctrl æƒ³è±¡æˆä¸€ä¸ª"å¼•è„šç®¡ç†å‘˜"ï¼Œå®ƒè´Ÿè´£å‘Šè¯‰ç³»ç»Ÿæ¯ä¸ªå¼•è„šåº”è¯¥åšä»€ä¹ˆå·¥ä½œï¼Œæ¯”å¦‚æŸä¸ªå¼•è„šæ˜¯ç”¨æ¥å‘é€ä¸²å£æ•°æ®ï¼Œè¿˜æ˜¯ç”¨æ¥æ§åˆ¶ GPIOã€‚

## 2 DTS ä¸­çš„ Pinctrl ä»‹ç»

### 2.1 Pinctrl èŠ‚ç‚¹çš„ä½ç½®

åœ¨ RK èŠ¯ç‰‡çš„è®¾å¤‡æ ‘ä¸­ï¼Œ**pinctrl èŠ‚ç‚¹**é€šå¸¸æ”¾åœ¨ `soc.dtsi` æ–‡ä»¶é‡Œï¼ˆæ¯”å¦‚ `rk3588s.dtsi` æˆ– `rk3568.dtsi`ï¼‰ï¼Œä¸€èˆ¬ä½äºæ–‡ä»¶çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/6f4afd076e6caf61bff95e31368d13eb.png)

### 2.2 Pinctrl èŠ‚ç‚¹çš„ç‰¹æ®Šæ€§

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œ**pinctrl èŠ‚ç‚¹æœ‰å‡ ä¸ªç‰¹ç‚¹**ï¼š
1. **æ²¡æœ‰ reg å±æ€§**ï¼šå®ƒä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ platform device
2. **é€šè¿‡ rockchip,grf=<&grf> ä¼ å…¥å¯„å­˜å™¨åŸºåœ°å€**ï¼šæ¢å¥è¯è¯´ï¼Œå®ƒä¸ç›´æ¥ç®¡ç†å¯„å­˜å™¨ï¼Œè€Œæ˜¯é€šè¿‡å¼•ç”¨å…¶ä»–èŠ‚ç‚¹è·å–åœ°å€
3. **é©±åŠ¨å†…éƒ¨è®¡ç®—å®é™…åœ°å€**ï¼šåŸºåœ°å€ + åç§»åœ°å€ = æœ€ç»ˆçš„å¯„å­˜å™¨åœ°å€

> [!note]+ ä¸‰ç§é…ç½®ç±»å‹
> 
> - **IOMUX**ï¼šå¼•è„šå¤šåŠŸèƒ½å¤ç”¨ï¼Œç®€å•æ¥è¯´å°±æ˜¯åˆ‡æ¢å¼•è„šåŠŸèƒ½ï¼ˆæ¯”å¦‚åŒä¸€ä¸ªå¼•è„šæ—¢å¯ä»¥åš UART ä¹Ÿå¯ä»¥åš GPIOï¼‰
> - **PINCONF**ï¼šå¼•è„šçš„ç”µæ°”å±æ€§åŠè¡Œä¸ºé…ç½®
> - **GPIO**ï¼šä½¿ç”¨å•ç‹¬çš„ gpio èŠ‚ç‚¹çš„ reg åœ°å€

### 2.3 PINCONF çš„å¸¸è§é…ç½®é¡¹

**PINCONF** ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹é…ç½®ï¼š
- **ä¸Šä¸‹æ‹‰ç”µé˜»**ï¼šæ§åˆ¶å¼•è„šçš„é»˜è®¤ç”µå¹³çŠ¶æ€
- **é©±åŠ¨èƒ½åŠ›**ï¼šæ§åˆ¶è¾“å‡ºä¿¡å·çš„å¼ºå¼±
- **è¾“å‡ºç±»å‹**ï¼šæ¨æŒ½æ¨¡å¼æˆ–å¼€æ¼æ¨¡å¼
- **è¾“å…¥/è¾“å‡ºä½¿èƒ½**ï¼šå†³å®šå¼•è„šæ˜¯è¾“å…¥è¿˜æ˜¯è¾“å‡º
- **è¾“å…¥å»¶è¿Ÿã€æ»¤æ³¢**ï¼šæ¶ˆé™¤ä¿¡å·å¹²æ‰°
- **ä¸­æ–­è§¦å‘ç±»å‹**ï¼šè¾¹æ²¿è§¦å‘æˆ–ç”µå¹³è§¦å‘
- **Schmitt è§¦å‘**ï¼šå¢å¼ºä¿¡å·ç¨³å®šæ€§
- **ä¿ç•™æ¨¡å¼ï¼ˆHIZï¼‰**ï¼šé«˜é˜»æ€æ¨¡å¼

### 2.4 å¼•ç”¨æ–¹å¼çš„ Pinctrl é…ç½®

é™¤äº†ç›´æ¥åœ¨ä¸» dtsi æ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¿˜å¯ä»¥é€šè¿‡å¼•ç”¨çš„æ–¹å¼é…ç½® pinctrl

åœ¨ `rk3568-pinctrl.dtsi` æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°è¿™ç§ç”¨æ³•ï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/8493d1260d0ef63767574ebcab3d58db.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/e6067bf4638c7bb820905a99053b0a75.png)

> [!tip]+ ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ 
> è¿™ç§åˆ†ç¦»å¼è®¾è®¡è®©ä»£ç æ›´æ¸…æ™°ï¼šä¸» dtsi å®šä¹‰åŸºæœ¬æ¡†æ¶ï¼Œpinctrl.dtsi å®šä¹‰å…·ä½“çš„å¼•è„šé…ç½®ï¼Œä¾¿äºç»´æŠ¤å’Œå¤ç”¨ã€‚

## 3 æ–°å»º pinctrl é…ç½®

### 3.1 æ˜¯å¦éœ€è¦æ–°å»º

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ**ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºæ–°çš„ pinctrl é…ç½®**ã€‚

å› ä¸º `rk3568-pinctrl.dtsi` æ–‡ä»¶å·²ç»æšä¸¾äº† rk3568 èŠ¯ç‰‡æ‰€æœ‰ `iomux` çš„å®ä¾‹ï¼Œå„ä¸ªæ¨¡å—é€šå¸¸ç›´æ¥å¼•ç”¨å³å¯ã€‚

> [!warning]+ æ³¨æ„äº‹é¡¹ 
> åªæœ‰åœ¨ç°æœ‰é…ç½®æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œæ‰éœ€è¦æ–°å»º pinctrl é…ç½®ã€‚

### 3.2 æ–°å»ºè§„åˆ™

å¦‚æœç¡®å®éœ€è¦åˆ›å»ºæ–°çš„ `iomux` å®ä¾‹ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

**è§„åˆ™ 1ï¼šä½ç½®è¦æ±‚**
- å¿…é¡»åœ¨ **pinctrl èŠ‚ç‚¹ä¸‹** åˆ›å»º

**è§„åˆ™ 2ï¼šå‘½åæ ¼å¼**
- å¿…é¡»ä»¥ **function + group** çš„å½¢å¼æ·»åŠ 

**è§„åˆ™ 3ï¼šä»£ç æ ¼å¼**
```d
function {
	group {
		rockchip,pin = <bank gpio func &ref>;
	};
};
```

> [!example]+ æ ¼å¼è¯´æ˜
> 
> - **function**ï¼šåŠŸèƒ½åç§°ï¼ˆå¦‚ uartã€spiã€i2c ç­‰ï¼‰
> - **group**ï¼šç»„åç§°ï¼ˆå¦‚ m0ã€m1 è¡¨ç¤ºä¸åŒçš„å¤ç”¨ç»„åˆï¼‰
> - **bank**ï¼šGPIO ç»„ç¼–å·
> - **gpio**ï¼šå…·ä½“çš„ GPIO ç¼–å·
> - **func**ï¼šåŠŸèƒ½ç¼–å·
> - **&ref**ï¼šå¼•ç”¨çš„å…¶ä»–èŠ‚ç‚¹

**è§„åˆ™ 4ï¼šåŸºæœ¬è§„èŒƒ**
- éµå¾ªè®¾å¤‡æ ‘çš„å…¶ä»–åŸºæœ¬è§„åˆ™ï¼ˆå¦‚å‘½åè§„èŒƒã€è¯­æ³•è¦æ±‚ç­‰ï¼‰

## 4 å¼•ç”¨ pinctrl

### 4.1 å¼•ç”¨æœºåˆ¶

æ¨¡å—å¼•ç”¨ **pinctrl** æ˜¯é€šè¿‡ä¸¤ä¸ªå…³é”®å±æ€§å®ç°çš„ï¼š
- **pinctrl-names**ï¼šå®šä¹‰çŠ¶æ€åç§°
- **pinctrl-0**ï¼šæŒ‡å®šå…·ä½“çš„ pinctrl ç»„

> [!info]+ å·¥ä½œåŸç† 
> è¿™å°±åƒç»™æ¯ä¸ªè®¾å¤‡åˆ†é…ä¸€ä¸ª"å¼•è„šä½¿ç”¨è¯´æ˜ä¹¦"ï¼Œå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè®¾å¤‡**éœ€è¦ç”¨å“ªäº›å¼•è„š**ï¼Œä»¥åŠ**å¦‚ä½•é…ç½®è¿™äº›å¼•è„š**ã€‚

### 4.2 å•ç»„å¼•ç”¨ç¤ºä¾‹

**UART2 çš„é…ç½®ç¤ºä¾‹**ï¼š
```c
uart2: serial@fe660000 {
	compatible = "rockchip,rk3568-uart", "snps,dw-apb-uart";
	reg = <0x0 0xfe660000 0x0 0x100>;
	interrupts = <GIC_SPI 118 IRQ_TYPE_LEVEL_HIGH>;
	clocks = <&cru SCLK_UART2>, <&cru PCLK_UART2>;
	clock-names = "baudclk", "apb_pclk";
	reg-shift = <2>;
	reg-io-width = <4>;
	dmas = <&dmac0 4>, <&dmac0 5>;
	pinctrl-names = "default";
	pinctrl-0 = <&uart2m0_xfer>;
	status = "disabled";
};
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`uart2m0_xfer` æ˜¯ä¸€ä¸ª **pinctrl group**ï¼Œå®ƒå®šä¹‰äº† UART2 éœ€è¦ä½¿ç”¨çš„å¼•è„šé…ç½®ã€‚

### 4.3 å¤šç»„å¼•ç”¨ç¤ºä¾‹

æ¨¡å—å¯ä»¥åŒæ—¶å¼•ç”¨å¤šç»„ **group**ï¼Œæ¯”å¦‚ PDMï¼ˆè„‰å†²å¯†åº¦è°ƒåˆ¶ï¼‰æ¨¡å—ï¼š
```c
pdm1: pdm@fe4c0000 {
	compatible = "rockchip,rk3588-pdm";
	reg = <0x0 0xfe4c0000 0x0 0x1000>;
	clocks = <&cru MCLK_PDM1>, <&cru HCLK_PDM1>;
	clock-names = "pdm_clk", "pdm_hclk";
	assigned-clocks = <&cru MCLK_PDM1>;
	assigned-clock-parents = <&cru PLL_AUPLL>;
	dmas = <&dmac1 4>;
	dma-names = "rx";
	power-domains = <&power RK3588_PD_AUDIO>;
	pinctrl-names = "default";
	pinctrl-0 = <&pdm1m0_clk&pdm1m0_clk1&pdm1m0_sdi0&pdm1m0_sdi1&pdm1m0_sdi2&pdm1m0_sdi3>;
	#sound-dai-cells = <0>;
	status = "disabled";
};
```

> [!note]+ å¤šç»„å¼•ç”¨çš„ä¼˜åŠ¿ 
> å½“ä¸€ä¸ªåŠŸèƒ½æ¨¡å—éœ€è¦ä½¿ç”¨å¤šä¸ªå¼•è„šæ—¶ï¼ˆå¦‚ PDM éœ€è¦æ—¶é’Ÿå¼•è„šå’Œå¤šä¸ªæ•°æ®å¼•è„šï¼‰ï¼Œå¯ä»¥å°†ä¸åŒç±»å‹çš„å¼•è„šåˆ†ç»„ç®¡ç†ï¼Œä½¿é…ç½®æ›´åŠ æ¸…æ™°ã€‚

### 4.4 å¤šçŠ¶æ€æ”¯æŒ

**pinctrl-names** å¯ä»¥æ”¯æŒå¤šä¸ªå®ä¾‹ï¼ˆä¹Ÿå« **state**ï¼‰ï¼Œç³»ç»Ÿé»˜è®¤æä¾›äº† 4 ç§çŠ¶æ€ï¼š
```c
#define PINCTRL_STATE_DEFAULT "default"
#define PINCTRL_STATE_INIT "init"
#define PINCTRL_STATE_IDLE "idle"
#define PINCTRL_STATE_SLEEP "sleep"
```

#### 4.4.1 çŠ¶æ€åˆ‡æ¢æœºåˆ¶

- **"init" çŠ¶æ€**ï¼šåœ¨ driver probe æœŸé—´ç”Ÿæ•ˆ
- **çŠ¶æ€åˆ‡æ¢**ï¼šprobe å®Œæˆåå¯èƒ½ä¼šåˆ‡æ¢å› "default"ï¼ˆå¦‚æœ probe ä¸­åˆ‡æ¢åˆ°å…¶ä»– stateï¼Œå°±ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢å› "init"ï¼‰

> [!tip]+ è‡ªå®šä¹‰çŠ¶æ€ 
> **pinctrl-names** æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œé©±åŠ¨ç¨‹åºä¸­å¯ä»¥æ ¹æ®éœ€è¦åŒ¹é…å’Œè§£æè‡ªå®šä¹‰çš„çŠ¶æ€åç§°ã€‚

### 4.5 è‡ªå®šä¹‰çŠ¶æ€ç¤ºä¾‹

**PWM4 çš„è‡ªå®šä¹‰çŠ¶æ€é…ç½®**ï¼š
```c
pwm4: pwm@febd0000 {
	compatible = "rockchip,rk3588-pwm", "rockchip,rk3328-pwm";
	reg = <0x0 0xfebd0000 0x0 0x10>;
	#pwm-cells = <3>;
	pinctrl-names = "active";
	pinctrl-0 = <&pwm4m0_pins>;
	clocks = <&cru CLK_PWM1>, <&cru PCLK_PWM1>;
	clock-names = "pwm", "pclk";
	status = "disabled";
};
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½¿ç”¨äº†è‡ªå®šä¹‰çš„ **"active"** çŠ¶æ€ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ "default" çŠ¶æ€ã€‚

> [!abstract]+ æœ¬ç« æ€»ç»“ 
> è®¾å¤‡æ ‘ä¸­çš„ pinctrl é…ç½®æœ¬è´¨ä¸Šæ˜¯ä¸€å¥—å¼•è„šç®¡ç†æœºåˆ¶ï¼š
> 
> 1. **ç³»ç»Ÿå®šä¹‰**ï¼šåœ¨ pinctrl.dtsi ä¸­å®šä¹‰æ‰€æœ‰å¯èƒ½çš„å¼•è„šé…ç½®
> 2. **æ¨¡å—å¼•ç”¨**ï¼šå„ä¸ªåŠŸèƒ½æ¨¡å—é€šè¿‡ pinctrl-names å’Œ pinctrl-x å¼•ç”¨éœ€è¦çš„é…ç½®
> 3. **çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒå¤šç§å·¥ä½œçŠ¶æ€ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„å¼•è„šéœ€æ±‚
> 4. **çµæ´»é…ç½®**ï¼šæ—¢æ”¯æŒæ ‡å‡†çŠ¶æ€ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰çŠ¶æ€ï¼Œé€‚åº”å„ç§åº”ç”¨åœºæ™¯

è¿™ç§è®¾è®¡è®©å¼•è„šé…ç½®æ—¢è§„èŒƒåˆçµæ´»ï¼Œå¤§å¤§ç®€åŒ–äº†ç¡¬ä»¶é©±åŠ¨çš„å¼€å‘å·¥ä½œã€‚