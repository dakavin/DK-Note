---
文章标题: "[[05_设备树中时钟描述 (被使用)]]"
文章作者: Dakkk
文章概要: |
  介绍设备树中时钟描述的原理，包括时钟生产者和消费者的概念，详细说明各种时钟相关属性的使用方法，如clock-cells、clock-frequency等配置规范。
tags:
  - 设备树
  - 时钟管理
  - BSP驱动
  - 嵌入式开发
  - 硬件配置
  - Linux内核
  - 时钟树
  - DTS
相关文章:
  - "[[02_设备树（device Tree）的由来]]"
  - "[[03_图解Kernel Device Tree(设备树)的使用]]"
  - "[[07_设备树中 GPIO 相关属性 (定义)]]"
  - "[[10_设备树的简介]]"
  - "[[参考内容/设备树的规范（dts和dtb）]]"
文章分类: 🐧 Linux系统
文章路径: 06-🐧 Linux系统/07-🚗 Linux驱动开发核心(重要!!!)/05-🚗 Linux驱动相关子系统 (重点)/3_设备树/1_Linux之设备树详解（训练营）/04_设备树中时钟描述 (被使用).md
文章难度: 中级 🌳
目前阶段: ✅ 已完成
重要性: ⭐⭐⭐⭐ 核心能力
创建时间: 2025-06-10 20:34:00
修改时间: 2025-06-10 23:52:14
---

时钟信息通常由板卡厂商来定义和描述，而我们BSP驱动开发人员的工作就是拿来使用。这就像是厂商为我们搭建好了"时钟基础设施"，我们只需要按照规范来使用就行。

> [!note]+ 什么是设备树中的时钟 
> 📢**时钟（Clock）**：用于描述`硬件设备和系统中的时钟源以及时钟相关的配置和连接关系`。

换句话说，时钟在计算机系统中就像是一个巨大的节拍器，用于同步和定时各种硬件设备的操作。想象一下交响乐团，指挥家的节拍棒就是时钟，确保所有乐器都能协调一致地演奏。

时钟系统按照角色可以分为两个主要部分：
- **时钟生产者（clock provider）**：负责定义和提供时钟信号
- **时钟消费者（clock consumer）**：负责引用和使用时钟信号

## 1 时钟生产者（clock provider）

**时钟生产者**就像是一个"时钟工厂"，负责生成和提供时钟信号的硬件或软件模块。它可以是时钟控制器、PLL（锁相环）、时钟发生器等

### 1.1 clock-cells：时钟编号位数

**#clock-cells**属性用于指定时钟编号的位数，这个概念可能听起来抽象，简单来说就是告诉系统"这个时钟节点能提供多少个不同的时钟"。

> [!tip]+ 理解clock-cells的关键
> 
> - **`#clock-cells` = 0**：表示这是一个单独的时钟源
>     
> - **`#clock-cells` = 1**：表示这个节点可以提供多个时钟，需要用编号来区分
>     

让我们通过具体例子来理解：
```dts
// 示例1：单个时钟 - 就像一个专门的24MHz振荡器
osc24m:osc24m{
	compatible = "clock";
	clock-frequency = <24000000>;
	clock-output-name = "osc24m";
	#clock-cells=<0>;  // 0表示只有一个时钟
};

// 示例2：多个时钟 - 就像一个时钟分配器，可以输出多路时钟
clock:clock{
	#clock-cells=<1>;  // 1表示有多个时钟，需要编号区分
	clock-output-names="clock1","clock2";
};
```

> [!example]+ 生活中的类比
> 想象`#clock-cells`=0就像一个单一功能的闹钟，只能在固定时间响铃；而#clock-cells=1就像一个多功能时钟，可以设置多个不同的闹铃时间

### 1.2 clock-frequency：时钟频率设定

**clock-frequency**属性是设备树中用于指定时钟频率的关键属性，就像给时钟贴上了一个"速度标签"

**作用说明：**
- 描述时钟节点所提供的时钟信号的频率，使用赫兹(Hz)作为单位
- 对于时钟生产者节点，这个属性表示该节点生成的时钟信号的频率
- 主要用于描述时钟控制器、晶振、PLL等产生时钟信号的硬件模块的输出频率

```dts
osc24m:osc24m{  
    compatible = "clock";  
    clock-frequency = <24000000>; // 24MHz = 24,000,000 Hz  
    clock-output-name = "osc24m";  
    #clock-cells=<0>;  
};
```

> [!note]+ 频率单位说明 
> 24000000 表示 24MHz，也就是每秒振荡2400万次。这个频率通常是硬件设计时就确定的，比如晶振的物理特性决定了它的振荡频率。

### 1.3 clock-output-names：时钟输出名称

**clock-output-names**属性用于为时钟生产者提供的时钟信号指定描述性名称。

**属性特点：**
- 是一个字符串数组，为每个输出时钟提供名称
- 便于在系统中识别和引用特定的时钟输出
- 通常与#clock-cells配合使用
    

```d
// 单个时钟输出  
osc24m:osc24m{  
    compatible = "clock";  
    clock-frequency = <24000000>;  
    clock-output-names = "osc24m";  // 单个输出时钟的名称  
    #clock-cells=<0>;  
};  
​  
// 多个时钟输出  
clock:clock{  
    #clock-cells=<1>;  
    clock-output-names = "clock1","clock2";  // 多个输出时钟的名称  
};
```

> [!note]+ 输出名称的作用 
> clock-output-names就像给每个时钟输出贴上标签，让其他设备能够通过名称来识别和请求特定的时钟信号。

### 1.4 clock-indices：时钟索引（暂无使用）

**clock-indices**属性用于指定时钟消费者节点所使用的时钟源的索引值，简单来说就是给每个时钟分配一个"身份证号码"

> [!info]+ 索引的作用 
> 时钟索引就像是给每个时钟源分配门牌号，方便精确定位和引用特定的时钟源。

```d
scpi_dvfs:clocks-0{  
    #clock-cells = <1>;  
    clock-indices = <0>,<1>,<2>;  
    clock-output-names = "atlclk","aplclk","gpuclk";  
};  
​  
scpi_clk:clocks-1{  
    #clock-cells = <1>;  
    clock-indices = <3>;  
    clock-output-names = "pxlclk";  
}
```

**解读说明：**
- 第一个节点中："atlclk"、"aplclk"、"gpuclk"三个时钟源的索引分别是0、1、2
- 第二个节点中："pxlclk"时钟源的索引是3

这样设计的好处是可以在复杂的时钟系统中快速定位特定的时钟源

### 1.5 assigned-clock-parents

**assigned-clock-parents**属性用于指定时钟消费者节点所使用的时钟源的父时钟源，这就像是构建一个"时钟家族树"。

> [!note]+ 时钟的层次关系 
> 在时钟系统中，某些时钟源可能是其他时钟源的"父亲"，即它们提供时钟信号给其他时钟源作为输入。这种层次结构可以实现复杂的时钟分频和倍频操作。

```c
clock:clock{
	assigned-clocks = <&clkcon 0>,<&pll 2>;
	assigned-clock-parents = <&pll 2>;
	assigned-clock-rates = <115200>,<9600>;
}
```

**详细解读：**
1. **assigned-clocks**：该节点使用两个时钟源（clkcon 0 和 pll 2）
2. **assigned-clock-parents**：指定pll 2作为父时钟源
3. **assigned-clock-rates**：两个时钟的频率分别是115200Hz和9600Hz
    

> [!example]+ 时钟继承关系类比 
> 这就像是一个电源分配系统：主电源(父时钟)通过变压器(时钟控制器)提供不同电压(不同频率)给各个设备使用。

## 2 时钟消费者（clock consumer）

**时钟消费者**就像是"时钟用户"，是那些依赖时钟信号的硬件设备或模块。它们通过引用时钟生产者节点提供的时钟源来获取所需的时钟信号

### 2.1 clocks：时钟源引用

**clocks**属性用于指定时钟消费者节点所需的时钟源，这是时钟消费者最核心的属性。

> [!tip]+ clocks属性的本质 
> clocks属性就像是一个"时钟订单"，告诉系统这个设备需要哪些时钟信号才能正常工作。

**属性特点：**
- 是一个`整数数组`，每个元素是一个时钟编号
- 表示时钟消费者需要的时钟源列表
- 通过引用的方式连接到时钟生产者


### 2.2 clock-names：时钟名称标识

**clock-names**是一个可选属性，用于指定时钟消费者节点所需时钟源的名称。它就像是给每个时钟贴上"标签"，方便识别和管理。

**属性特点：**
- 是一个字符串数组，与clocks数组一一对应
- 提供时钟源的描述性名称，增强代码可读性
- 在驱动程序中可以通过名称来获取特定的时钟

一个时钟消费者示例如下所示：
```c
clock:clock{
	clocks = <&rcu CLK_VOP>;
	clock-names = "clk_vop";
}
```
- clocks 属性指定了该节点使用的时钟源， 引用了 cru 节点中的 CLK_VOP 时钟源
- clock-names 属性指定了时钟源的名称， 这里是 “clk_vop”

### 2.3 assigned-clocks & assigned-clock-rates：时钟分配

这两个属性总是成对出现，就像是"时钟菜单"和"价格表"的关系。

**assigned-clocks**：标识时钟消费者节点所使用的时钟源
- 是一个整数数组，每个元素对应一个时钟编号
- 就像是在"时钟超市"中选择你要的商品

**assigned-clock-rates**：指定每个时钟源的时钟频率
- 是一个整数数组，每个元素对应一个时钟源的频率
- 时钟频率以Hz为单位表示
- 数量和顺序必须与assigned-clocks属性中的时钟编号相对应

> [!warning]+ 重要注意事项 
> assigned-clock-rates的元素数量必须与assigned-clocks完全对应，顺序也要一致，否则会导致时钟配置错误。

让我们看一个实际应用的例子：
```dts
cru:clock-controller@fdd20000{  
    #clock-cells = <1>;  
    assigned-clocks = <&pmucru CLK_RTC_32K>,<&cru ACLK_RKVDEC_PRE>;  
    assigned-clock-rates = <32768>,<300000000>;  
};
```

**代码解读：**
1. 第一个时钟：`&pmucru CLK_RTC_32K` 被设置为 32768Hz (32.768KHz)
2. 第二个时钟：`&cru ACLK_RKVDEC_PRE` 被设置为 300000000Hz (300MHz)

> [!example]+ 生活类比 
> 这就像是在餐厅点餐：assigned-clocks是你点的菜品清单，assigned-clock-rates是每道菜的价格，必须一一对应。

## 3 总结

> [!abstract]+ 核心要点回顾
> 
> 1. **时钟生产者**：负责定义和提供时钟，包含频率、索引、父子关系等信息
>     
> 2. **时钟消费者**：负责引用和使用时钟，通过clocks和clock-names属性连接到时钟源
>     
> 3. **配置原则**：生产者定义规则，消费者按规则使用，确保系统时钟的统一管理
>     

通过设备树的时钟描述机制，整个系统的时钟管理变得规范化和模块化。就像是建立了一套完整的"时钟供应链"，从时钟的产生、分配到最终使用，每个环节都有明确的规范和接口。

> [!tip]+ 实际应用建议 
> 在实际开发中，我们通常只需要关注时钟消费者的配置，因为时钟生产者部分大多由芯片厂商或板卡厂商预先定义好了。我们的主要工作是正确引用所需的时钟源，确保设备能够获得合适的时钟信号。

