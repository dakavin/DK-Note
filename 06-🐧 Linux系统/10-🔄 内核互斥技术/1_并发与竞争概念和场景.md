
在Linux驱动开发过程中，**并发与竞争**是必须掌握的核心概念。简单来说，当多个程序同时访问相同资源时，就可能产生竞争，导致数据错乱或系统崩溃。

## 1 核心概念理解

在深入学习并发处理之前，我们需要先理解几个关键概念。这些概念是理解整个并发机制的基础。

**1、执行单元**：在Linux内核中可以执行的代码实体（可执行单元），包括：
- **内核态线程**：运行在内核空间的线程
- **中断处理函数**：响应硬件中断的代码

> [!warning]+ 更准确的说法
> 内核互斥涉及的是**内核态的执行上下文**
> - 内核线程：完全运行在内核态的线程
> - 进程上下文中的内核代码：用户进程通过系统调用进入内核态，是以进程上下文运行内核代码
> - 中断上下文：硬中断处理函数、软中断、tasklet

> [!note]+ 通俗解释
> 
> 执行单元就像是能够独立工作的"工人"，每个工人都可以执行特定的任务。在Linux系统中，主要有两类工人：内核线程和中断处理程序。

**2、共享资源**：可以被多个执行单元访问的资源称为共享资源
- 全局变量
- 硬件寄存器
- 内存区域

> [!note]+ 通俗解释
> 
> 换句话说，就是多个"工人"都可能需要使用的工具或材料。

**3、临界资源**：临界资源是一次仅允许一个执行单元使用的共享资源。

> [!note]+ 通俗解释
> 
> 临界资源就像是一把只有一个人能使用的锤子，同时只能有一个工人使用，否则就会发生冲突。

**4、临界区**：每个执行单元访问临界资源的那段代码称为临界区(critical section)。

> [!tip]+ 生活类比
> 
> 想象一下银行的ATM机：
> 
> - ATM机就是临界资源（一次只能一个人使用）
> - 排队等待的人就是执行单元
> - 每个人操作ATM的过程就是临界区

**5、SMP**：SMP是一种紧耦合、共享存储的系统模型，它的特点是多个CPU使用共同的系统总线，因此可访问共同的外设和储存器。

## 2 并发与竞态的核心概念

理解了基础概念后，我们来学习并发和竞态的具体含义。

### 2.1 什么是并发

**并发**(Concurrency)指的是多个执行单元同时、并行被执行，或多个执行单元微观串行执行，宏观并行执行。

> [!tip]+ 实际应用场景
> 
> 就像工厂里多条生产线同时工作，每条线都在处理自己的任务，但可能需要共享某些设备或原料。

### 2.2 什么是竞态

**竞态**(Race Conditions)：并发的执行单元对共享资源(硬件资源和软件上的全局变量、静态变量等)的访问而导致的竞争状态

### 2.3 竞态形成的三个条件

竞态的产生需要同时满足三个条件，缺一不可：
1. **必须有多个执行单元**：中断（软中断、硬中断）、内核线程
2. **必须有共享资源**：全局变量
3. **必须同时访问**：资源的同时访问

> [!example]+ 生活化比喻
> 
> 竞态就像两个人同时要使用银行ATM机，如果没有排队机制，就会发生冲突。这三个条件就是：有两个人(多个执行单元)、有一台ATM机(共享资源)、两人同时到达(同时访问)。

## 3 常见的并发场景

接下来我们通过具体场景来理解并发是如何产生的。这些场景在实际驱动开发中都会遇到。

### 3.1 多CPU进程与进程之间并发

在多核处理器系统中，不同CPU核心可能同时运行不同的程序，当这些**程序访问同一个临界资源时就会产生竞态**

CPU_A运行的进程A 和 CPU_B运行的进程B 访问同一个临界资源，产生竞态。
![image.png|400](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/64e7feac1d1b65f1cd440d3829a276df.png)



> [!note]+ 场景说明
> 
> 这就像两个厨师在不同的灶台上做菜，但需要共用一个调料罐，如果同时去拿就可能发生冲突。

### 3.2 单CPU进程间的并发

由于现在的操作系统都是多任务的，即多进程，一个进程在运行的时候，不是一直占用CPU资源直到它结束，而是**每个进程都有一个时间片（在一定时间内执行）**。

简单来说，操作系统会给每个程序分配运行时间，时间到了就切换到下一个程序。如果时间片用完了操作系统就调度另外一个进程执行。**进程A和进程B访问是同一个临界资源，此时产生竞态**。
![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/3df1eb6fc324c7d6742d0b646937d06c.png)



### 3.3 单CPU上进程和中断之间的并发

在一个进程执行的过程中，如果硬件上产生了中断请求，此时操作系统必须放弃进程的执行，去执行中断处理函数，进行中断处理。

换句话说，中断具有最高优先级，可以打断正在运行的程序。此时**进程访问的临界资源和中断访问的临界资源是同一个资源产生竞态**
![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/c85711d310470720dbe341f080a94612.png)


> [!warning]+ 常见错误
> 
> 很多初学者容易忽略中断对程序的影响，认为程序会顺序执行。实际上中断随时可能发生，必须考虑这种情况

### 3.4 单CPU上中断之间的并发

在Linux系统中中断上半部函数执行的时候是屏蔽中断的，下半部函数执行的时候中断是使能的。

如果在下半部函数执行的过程中，有一个硬件中断到来，打断了下半部的函数，恰好这个**中断访问的临界资源和下半部访问的是同个临界资源，这样就产生了竞态**
![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/50890a53d8b1affa5cbbffbc81b41a8c.png)


### 3.5 多CPU中断与中断之间

CPU A产生了中断执行的中断处理函数与CPU_B产生了中断执行的中断处理函数，访问的临界资源是同一个临界资源，这样就产生了竞态
![image.png|400](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7816ad3cd101cb678ed3299d95641c33.png)


## 4 并发竞争的分类总结

通过前面的学习，我们可以将并发竞争归纳为三大类：

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7b2ff7d1f6f341b8e32032ee391e9a09.png)

1. **进程与进程之间**：单核上的抢占，多核上的SMP
2. **进程与中断之间**：中断又包含了上半部与下半部，中断总是能打断进程的执行流
3. **中断与中断之间**：外设的中断可以路由到不同的CPU上，它们之间也可能带来竞态

> [!tip]+ 记忆技巧
> 
> 可以简记为"两进程、进中断、两中断"，涵盖了所有可能的并发场景。

## 5 总结

并发与竞争是Linux驱动开发中的核心问题。理解这些概念和场景是学习各种同步机制的基础。记住竞态产生的三个必要条件：多个执行单元、共享资源、同时访问。在后续的学习中，我们将学习各种解决并发问题的技术手段。

下一步我们将学习同步与互斥的失败例子，通过实际代码看看不使用同步机制会发生什么问题。
