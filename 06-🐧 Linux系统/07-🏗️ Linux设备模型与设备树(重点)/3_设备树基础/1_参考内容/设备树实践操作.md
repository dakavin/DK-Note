---
æ–‡ç« æ ‡é¢˜: "[[è®¾å¤‡æ ‘å®è·µæ“ä½œ]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  æ–‡ç« å®è·µè®²è§£Linuxè®¾å¤‡æ ‘åº”ç”¨ï¼Œæ¶µç›–DM9000ç½‘å¡ä¸è§¦æ‘¸å±ä¸­æ–­é…ç½®ã€‚è¯¦è¿°è®¾å¤‡æ ‘ä¸­æ—¶é’Ÿç®¡ç†å’ŒPinctrlå¼•è„šæ§åˆ¶çš„æ¦‚å¿µä¸å®è·µã€‚ä»¥LCDä¸ºä¾‹ï¼Œæ¼”ç¤ºäº†è®¾å¤‡æ ‘å¦‚ä½•ç»Ÿä¸€ç®¡ç†ç¡¬ä»¶å‚æ•°ï¼Œå®ç°é©±åŠ¨ä¸ç¡¬ä»¶è§£è€¦ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
tags:
  - Device Tree
  - Linuxé©±åŠ¨
  - åµŒå…¥å¼Linux
  - ä¸­æ–­
  - æ—¶é’Ÿç®¡ç†
  - Pinctrl
  - LCDé©±åŠ¨
  - å¹³å°è®¾å¤‡
ç›¸å…³æ–‡ç« :
  - "[[../../../08-ğŸ“Š å­—ç¬¦è®¾å¤‡é©±åŠ¨å¼€å‘/1_å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¨¡å‹åŸºç¡€(Lubancat)/7_å¹³å°è®¾å¤‡é©±åŠ¨]]"
  - "[[../06_ğŸ“•è®¾å¤‡æ ‘ä¸­æ–­çš„å±æ€§æè¿° (æœ€å¸¸ç”¨)]]"
  - "[[../08_è®¾å¤‡æ ‘ä¸­ Pinctrlçš„æè¿°]]"
  - "[[8_å®šæ—¶å™¨ï¼ˆé‡ç‚¹ï¼‰]]"
  - "[[0_åŸºç¡€å‚è€ƒæ–‡æ¡£]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/05-ğŸš— Linuxé©±åŠ¨ç›¸å…³å­ç³»ç»Ÿ (é‡ç‚¹)/3_è®¾å¤‡æ ‘/2_Linuxè®¾å¤‡æ ‘è¯¦è§£ï¼ˆéŸ¦ä¸œå±±ï¼‰/6_è®¾å¤‡æ ‘å®è·µæ“ä½œ.md
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­â­ ç²¾é€šå¿…å¤‡
åˆ›å»ºæ—¶é—´: 2025-06-10 20:34:00
ä¿®æ”¹æ—¶é—´: 2025-06-10 21:45:43
---

## 1 ä½¿ç”¨è®¾å¤‡æ ‘ç»™DM9000ç½‘å¡_è§¦æ‘¸å±æŒ‡å®šä¸­æ–­

### 1.1 DM9000ç½‘å¡

è®¾å¤‡æ ‘çš„ç¼–å†™å¯ä»¥å‚è€ƒï¼š[2.2 ä½¿ç”¨è®¾å¤‡æ ‘æè¿°ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯](ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘.md#2.2%20ä½¿ç”¨è®¾å¤‡æ ‘æè¿°ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/ee81ffd66d788ad3cb8e6227eb3c28f2.png)

- ethernetè®¾å¤‡çš„çˆ¶è®¾å¤‡srom-cs4çš„compatibleå±æ€§æ˜¯`simple-bus`ï¼Œæ‰€ä»¥ethernetè®¾å¤‡ä¼šè¢«åˆ›å»ºä¸ºplatform_device(è¯¥èŠ‚ç‚¹æŒ‡å®šäº†ä¸­æ–­çš„ä¿¡æ¯)
- ç„¶åä¼šæ ¹æ®è¿™ä¸ªå¹³å°è®¾å¤‡çš„compatible åŒ¹é…åˆ°å¯¹åº”çš„é©±åŠ¨ç¨‹åºï¼ˆæˆ‘ä»¬å†™çš„ï¼‰
- åœ¨è¿™ä¸ªé©±åŠ¨ç¨‹åºä¸­ï¼Œè·å–åˆ°ä¸­æ–­çš„ä¿¡æ¯ï¼Œå³æŠŠä¸­æ–­å·virqç¡®å®šä¸‹æ¥ï¼

**ä¿®æ”¹çš„ä»£ç å¦‚ä¸‹**
- å®šä¹‰å¹³å°é©±åŠ¨å’ŒåŒ¹é…çš„èµ„æº
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/51480c442ac3db7de78e210ddffde657.png)
- å®šä¹‰probeå‡½æ•°ï¼Œè·å–ä¸­æ–­èµ„æºï¼ˆä¸­æ–­å·ï¼‰
```c
static int dm9000_probe(struct platform_device *pdev){
	struct device *dev = &pdev->dev;
	struct device_node *dp_node = dev->of_node;
	struct resource;

	res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);
	if(res){
		irq = res -> start;
		printk("get dm9000 irq %d\n", irq);
	}else{
		printk("cannot get irq res form dm9000\n");
		return -1;
	}

	//è°ƒç”¨å…¥å£å‡½æ•°
	return dm9000c_init();
}
```
- å…¥å£å‡½æ•°
```c
//æ³¨æ„å»æ‰__initè¿™ä¸ªæ®µæè¿°ï¼Œé¿å…åœ¨å†…æ ¸å¯åŠ¨åä¼šè¢«æ¶ˆæ‰
int dm9000c_init(){
	// ä¸ç”¨åœ¨è¿™é‡Œå†™ä¸­æ–­å·äº†
}
```
- removeå‡½æ•°ï¼Œè°ƒç”¨exitå‡½æ•°ï¼Œä¸€æ ·è¦å»æ‰__exit
- æœ€åæä¾›æ–°çš„initå’Œexitå‡½æ•°
	- initï¼šæ³¨å†Œdrv
	- exitï¼šæ³¨é”€drv

### 1.2 è§¦æ‘¸å±

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/54e17c27a86b41521d5bf208d5d8ea08.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/edc281181fe264ca9c2a4cd9a8dc22e4.png)

- å¯¹äºinterruptsçš„å±æ€§å€¼æ¥è¯´ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„å†…å®¹[3.2 è®¾å¤‡æ ‘æ·»åŠ è®¾å¤‡ä¿¡æ¯](ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘.md#3.2%20è®¾å¤‡æ ‘æ·»åŠ è®¾å¤‡ä¿¡æ¯)ï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹
- <1 31 9 3>ï¼š
	- 1   è¡¨ç¤ºæ˜¯å­ä¸­æ–­æ§åˆ¶å™¨
	- 31 è¡¨ç¤ºå­å‘ç»™ä¸»çš„å“ªä¸€ä¸ªä¸­æ–­å·
	- 10 è¡¨ç¤ºåœ¨å­ä¸­æ–­å™¨çš„ä¸­æ–­å·
	- 3   è¡¨ç¤ºè§¦å‘æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä¸Šå‡æ²¿æˆ–ä¸‹é™æ²¿è§¦å‘
- æ‰€ä»¥åœ¨resourceä¸­ï¼Œç¬¬0ä¸ªèµ„æºå’Œç¬¬1ä¸ªèµ„æºå’Œä¸Šé¢çš„ä¸€ä¸€å¯¹åº”

## 2 åœ¨è®¾å¤‡æ ‘ä¸­æ—¶é’Ÿçš„ç®€å•ä½¿ç”¨

**å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡åœ¨è®¾å¤‡æ ‘ä¸­å¦‚ä½•å®šä¹‰å’Œä½¿ç”¨æ—¶é’Ÿï¼Œç†è§£æ—¶é’Ÿæä¾›è€…å’Œæ¶ˆè´¹è€…çš„æ¦‚å¿µ

**å‚è€ƒæ–‡æ¡£**
- `å†…æ ¸æºç /Documentation/devicetree/bindings/clock/clock-bindings.txt`
- `å†…æ ¸æºç /Documentation/devicetree/bindings/clock/samsung,s3c2410-clock.txt`

### 2.1 æ—¶é’Ÿæä¾›è€…å’Œæ¶ˆè´¹è€…

**ç¡¬ä»¶æ¡†å›¾**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/3e4a1a2bfbb39e0eee236de2de811ae4.png)
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/5f474258c9b3ce9388035eeb1d71b49a.png)

**æ—¶é’Ÿæä¾›è€…(Clock Providers)**ï¼šè®¾å¤‡æ ‘ä¸­å®šä¹‰çš„å„ç§æ—¶é’Ÿæºï¼Œä¸ºå…¶ä»–è®¾å¤‡æä¾›æ—¶é’Ÿä¿¡å·
```dts
clocks: clock-controller@4c000000 {
	compatible = "samsung,s3c2440-clock";
	reg = <0x4c000000 0x20>;
	#clock-cells = <1>;                   // æƒ³ä½¿ç”¨è¿™ä¸ªclocksæ—¶è¦æä¾›1ä¸ªu32æ¥æŒ‡å®šå®ƒ
	                                      // æˆ–è€…è¯´ç”¨1ä¸ªu32æ¥æè¿°æ¶ˆè´¹è€…id
	                                      // æ¯”å¦‚é€‰æ‹©è¿™ä¸ªclocksä¸­å‘å‡ºçš„LCDæ—¶é’Ÿã€PWMæ—¶é’Ÿ
};
```
- `compatible`: æŒ‡å®šæ—¶é’Ÿæ§åˆ¶å™¨çš„å…¼å®¹æ€§å­—ç¬¦ä¸²
- `reg`: æ—¶é’Ÿæ§åˆ¶å™¨çš„å¯„å­˜å™¨åœ°å€èŒƒå›´
- `#clock-cells`: è¡¨ç¤ºå¼•ç”¨æ­¤æ—¶é’Ÿæ—¶éœ€è¦æä¾›çš„å‚æ•°ä¸ªæ•°

**æ—¶é’Ÿæ¶ˆè´¹è€…(Clock Consumers)**ï¼šéœ€è¦ä½¿ç”¨æ—¶é’Ÿçš„è®¾å¤‡ï¼Œé€šè¿‡`å¼•ç”¨æ—¶é’Ÿæä¾›è€…`æ¥è·å–æ‰€éœ€çš„æ—¶é’Ÿ
- ä¸å…³å¿ƒæä¾›è€…å†…éƒ¨çš„å±‚çº§ç»“æ„ï¼Œåªéœ€è¦çŸ¥é“ç›´æ¥æä¾›è€…æ˜¯è°
- ä¸å…³å¿ƒç›´æ¥æä¾›è€…çš„å®ç°ï¼Œåªè¦å‘ä»–å‘å‡ºè¯·æ±‚å³å¯
```dts
fb0: fb@4d000000{
	compatible = "jz2440,lcd";
	reg = <0x4d000000 0x60>;
	interrupts = <0 0 16 3>;
	clocks = <&clocks HCLK_LCD>;  // ä½¿ç”¨clockså³clock-controller@4c000000ä¸­çš„HCLK_LCD
};
```
- `<&clocks HCLK_LCD>`
	- `&clocks`: å¼•ç”¨åä¸ºclocksçš„æ—¶é’Ÿæ§åˆ¶å™¨
	- `HCLK_LCD`: æŒ‡å®šè¦ä½¿ç”¨çš„å…·ä½“æ—¶é’ŸID
		- ä¸€èˆ¬åœ¨æ—¶é’Ÿæä¾›è€…çš„é©±åŠ¨ç¨‹åºä¼šæœ‰å„ç§å®æ¥å®šä¹‰è¿™ä¸ªID

### 2.2 é©±åŠ¨ä¸­æ—¶é’Ÿçš„æ“ä½œ

**1ã€è·å–æ—¶é’Ÿä¸ªæ•°**
```c
// ç¡®å®šæ—¶é’Ÿä¸ªæ•°
int nr_pclks = of_count_phandle_with_args(dev->of_node, "clocks", "#clock-cells");
```

**2ã€è·å–æ—¶é’Ÿå¯¹è±¡**
```c
// è·å¾—æ—¶é’Ÿ
clk_get(NULL,clk);            //ä»¥å‰çš„æ—§æ–¹å¼

for(int i = 0; i < nr_pclks; i++){
	struct clk *clk = of_clk_get(dev->of_node, i);   //ç°åœ¨çš„æ–¹å¼
}
```

**3ã€æ—¶é’Ÿçš„ä½¿èƒ½å’Œç¦æ­¢**
```c
// ä½¿èƒ½æ—¶é’Ÿ
clk_prepare_enable(clk);

// ç¦æ­¢æ—¶é’Ÿ
clk_disable_unprepare(clk);
```

### 2.3 åº”ç”¨åœºæ™¯å’Œæ³¨æ„ç‚¹

> [!tip]+ å®é™…åº”ç”¨åœºæ™¯
> - LCDæ˜¾ç¤ºæ§åˆ¶å™¨
> - PWMå®šæ—¶å™¨
> - UARTä¸²å£æ§åˆ¶å™¨
> - SPI/I2Cæ€»çº¿æ§åˆ¶å™¨
> - ç­‰éœ€è¦ç‰¹å®šæ—¶é’Ÿé¢‘ç‡çš„å¤–è®¾

> [!warning]+ æ³¨æ„äº‹é¡¹
> - `#clock-cells`çš„å€¼å†³å®šäº†å¼•ç”¨æ—¶é’Ÿæ—¶éœ€è¦æä¾›çš„å‚æ•°ä¸ªæ•°
> - æ—¶é’Ÿçš„ä½¿èƒ½å’Œç¦æ­¢è¦æˆå¯¹å‡ºç°ï¼Œé¿å…èµ„æºæ³„æ¼
> - åœ¨é©±åŠ¨å¸è½½æ—¶è¦ç¡®ä¿æ­£ç¡®é‡Šæ”¾æ—¶é’Ÿèµ„æº

## 3 åœ¨è®¾å¤‡æ ‘ä¸­pinctrlçš„ç®€å•ä½¿ç”¨

**å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡åœ¨è®¾å¤‡æ ‘ä¸­å¦‚ä½•å®šä¹‰å’Œä½¿ç”¨pinctrlï¼ˆå¼•è„šæ§åˆ¶ï¼‰ï¼Œç†è§£Bankã€Groupã€Stateç­‰æ¦‚å¿µ

**å‚è€ƒæ–‡æ¡£**ï¼š
- `å†…æ ¸æºç /Documentation/devicetree/bindings/pinctrl/samsung-pinctrl.txt`

### 3.1 æ ¸å¿ƒæ¦‚å¿µè§£æ

**1ã€Bank(å¼•è„šç»„)**ï¼šä»¥å¼•è„šåä¸ºä¾æ®ï¼Œè¿™äº›å¼•è„šåˆ†ä¸ºè‹¥å¹²ç»„ï¼Œæ¯ç»„ç§°ä¸ºä¸€ä¸ªBank
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/91cc6c850ec056cb6ceaa539f77e1ca5.png)
**ä¸¾ä¾‹è¯´æ˜**
- s3c2440é‡Œæœ‰GPAã€GPBã€GPCç­‰Bank
- æ¯ä¸ªBankä¸­æœ‰è‹¥å¹²å¼•è„šï¼Œæ¯”å¦‚GPA0,GPA1, ...,GPC0,GPC1, ...ç­‰å¼•è„š
- å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ï¼š`å†…æ ¸æºç /Documentation/devicetree/bindings/pinctrl/samsung-pinctrl.txt`
  ![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/6c9a5b8df87444ce33f84b4405eee5d8.png)
	- bankå¿…é¡»è¿˜æœ‰ä¸¤ä¸ªå±æ€§`gpio-controller`å’Œ`#gpio-cells`
	- å…¶ä¸­`#gpio-cells`ï¼Œå¿…é¡»æŒ‡å®šæ˜¯2ä¸ªu32ï¼Œç¬¬ä¸€ä¸ªè¡¨ç¤ºè¿™ä¸ªbankçš„å¼•è„šå·ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºé«˜ä½ç”µå¹³

**2ã€Group(åŠŸèƒ½ç»„)**ï¼šä»¥åŠŸèƒ½ä¸ºä¾æ®ï¼Œå…·æœ‰ç›¸åŒåŠŸèƒ½çš„å¼•è„šç§°ä¸ºä¸€ä¸ªGroup
- **æ˜¯pinctrlä¸‹é¢çš„å­èŠ‚ç‚¹ï¼ï¼ï¼**
- è·ŸèŠ¯ç‰‡æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œéœ€è¦æŸ¥çœ‹å¯¹åº”èŠ¯ç‰‡çš„æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ°s3c2440èŠ¯ç‰‡æ˜¯è¿™ä¹ˆæè¿°çš„
  ![image.png|300](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/d86bc73c9ef700aaa61f8e2217f0c575.png)
	- `samsung,pins`ç”¨å“ªäº›å¼•è„šå®ç°åŠŸèƒ½ç»„
	- `samsung,pin-function`å¦‚ä½•é…ç½®å¼•è„šç”¨äºè¯¥åŠŸèƒ½
**ä¸¾ä¾‹è¯´æ˜**
- s3c2440ä¸­ä¸²å£0çš„TxDã€RxDå¼•è„šä½¿ç”¨GPH2,GPH3ï¼Œé‚£è¿™ä¸¤ä¸ªå¼•è„šå¯ä»¥åˆ—ä¸ºä¸€ç»„
- s3c2440ä¸­ä¸²å£0çš„æµé‡æ§åˆ¶å¼•è„šä½¿ç”¨ GPH0,GPH1ï¼Œé‚£è¿™2ä¸ªå¼•è„šä¹Ÿå¯ä»¥åˆ—ä¸ºä¸€ç»„

**3ã€State(çŠ¶æ€)**ï¼šè®¾å¤‡çš„æŸç§çŠ¶æ€ï¼Œæ¯”å¦‚å†…æ ¸è‡ªå®šä¹‰çš„"default","init","idle","sleep"çŠ¶æ€
**æ‰©å±•è¯´æ˜**:
- ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–è‡ªå·±å®šä¹‰çš„çŠ¶æ€ï¼Œæ¯”å¦‚ä¸²å£çš„â€œflow_ctrlâ€çŠ¶æ€ï¼ˆä½¿ç”¨æµé‡æ§åˆ¶ï¼‰
- è®¾å¤‡å¤„äºæŸç§çŠ¶æ€æ˜¯ï¼Œå®ƒå¯ä»¥ä½¿ç”¨è‹¥å¹²ä¸ªGroupå¼•è„š

### 3.2 è®¾å¤‡æ ‘ä¸­pinctrlèŠ‚ç‚¹å®šä¹‰

**1ã€å®šä¹‰å„ç§pin bank**
```tds
pinctrl_0 : pinctrl@56000000 {
	reg = <0x56000000 0x1000>;
	
	gpa: gpa {
		gpio-controller;           //è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªbank
		#gpio-cells = <2>;         //ä½¿ç”¨gpa bankä¸­çš„å¼•è„šæ—¶ï¼Œéœ€è¦2ä¸ªu32æ¥æŒ‡å®šå¼•è„š
	};

	gpb: gpb {
        gpio-controller;
        #gpio-cells = <2>;
    };
    
    gpc: gpc {
        gpio-controller;
        #gpio-cells = <2>;
    };
    
    gpd: gpd {
        gpio-controller;
        #gpio-cells = <2>;
    };
};
```
- å®šä¹‰äº†å„ç§pin bankï¼Œæ¯”å¦‚s3c2440æœ‰GPA,GPB,GPC,...,GPBå„ç§BANKï¼Œæ¯ä¸ªBANKä¸­æœ‰è‹¥å¹²å¼•è„š


**2ã€å®šä¹‰å„ç§group(ç»„åˆ)**
```dts
uart0_data: uart0_data {
	samsung,pin2 = "gph-0", "gph-0"; //ä½¿ç”¨é‚£äº›å¼•è„š
    samsung,pin-function = <2>;   /* åœ¨GPHCONå¯„å­˜å™¨ä¸­gph0,gph1å¯ä»¥è®¾ç½®ä»¥ä¸‹å€¼:
                                         0 --- è¾“å…¥åŠŸèƒ½
                                         1 --- è¾“å‡ºåŠŸèƒ½
                                         2 --- ä¸²å£åŠŸèƒ½
                                      æˆ‘ä»¬è¦ä½¿ç”¨ä¸²å£åŠŸèƒ½,  
                                      samsung,pin-function è®¾ç½®ä¸º2
                                   */
};

uart0_sleep: uart0_sleep {
    samsung,pins = "gph-0", "gph-1";
    samsung,pin-function = <0>;   /* åœ¨GPHCONå¯„å­˜å™¨ä¸­gph0,gph1å¯ä»¥è®¾ç½®ä»¥ä¸‹å€¼:
                                         0 --- è¾“å…¥åŠŸèƒ½
                                         1 --- è¾“å‡ºåŠŸèƒ½
                                         2 --- ä¸²å£åŠŸèƒ½
                                      æˆ‘ä»¬è¦ä½¿ç”¨è¾“å…¥åŠŸèƒ½,  
                                      samsung,pin-function è®¾ç½®ä¸º0
                                   */
};
```
- ä¸Šé¢æ˜¯ä¸²å£å¼•è„šçš„ä¸¤ä¸ªgroupï¼Œç»™ä¸‹é¢çš„ä¸²å£è®¾å¤‡èŠ‚ç‚¹ä½¿ç”¨

**3ã€è®¾å¤‡èŠ‚ç‚¹ä¸­ä½¿ç”¨pin group**
```dts
serial@50000000{
	.......
	pinctrl-names = "default", "sleep"; //æ—¢æ˜¯åå­—ï¼Œä¹Ÿæ˜¯stateï¼ˆçŠ¶æ€ï¼‰
	pinctrl-0 = <&uart0_data>;
	pinctrl-1 = <&uart0_sleep>;
};
```
- pinctrl-namesä¸­å®šä¹‰äº†2ç§state: default å’Œ sleep
- default å¯¹åº”çš„å¼•è„šæ˜¯: pinctrl-0ï¼Œå®ƒæŒ‡å®šäº†ä½¿ç”¨å“ªäº›pin group: uart0_data
- sleep å¯¹åº”çš„å¼•è„šæ˜¯: pinctrl-1ï¼Œå®ƒæŒ‡å®šäº†ä½¿ç”¨å“ªäº›pin group: uart0_sleep

### 3.3 å¹³å°è®¾å¤‡åŒ¹é…æ—¶pinctrlçš„å¤„ç†

[7.1 æ³¨å†Œplatform_driverçš„è¿‡ç¨‹](å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†.md#7.1%20æ³¨å†Œplatform_driverçš„è¿‡ç¨‹) è¿™ä¸ªè¿‡ç¨‹ä¸­è®²è§£äº†platform_driveræ³¨å†Œè¿‡ç¨‹ä¸­ä¼šå’Œplatform_deviceåŒ¹é…ï¼Œç„¶åæœ€ç»ˆè°ƒç”¨åˆ°`really_probe(drivers/base/dd.c)`

```c
really_probe:
	// å¦‚æœä½¿ç”¨äº†pinctrlï¼Œåœ¨probeä¹‹å‰ç»‘å®šå¼•è„š
	ret = pinctrl_bind_pins(dev);
		// è·å¾—defaultçŠ¶æ€ä¸‹çš„pinctrl
		dev->pins->default_state = pinctrl_lookup_state(dev->pins->p, PINCTRL_STATE_DEFAULT);
		// è·å–initçŠ¶æ€ä¸‹çš„pinctrl
		dev->pins->init_state = pinctrl_lookup_state(dev->pins->p, PINCTRL_STATE_INIT);
		// ä¼˜å…ˆè®¾ç½®initçŠ¶æ€çš„å¼•è„š
		ret = pinctrl_selece_state(dev->pins->p, dev->pins->init_state);
		// å¦‚æœæ²¡æœ‰initçŠ¶æ€ï¼Œåˆ™è®¾ç½®defaultçŠ¶æ€çš„å¼•è„š
		ret = pinctrl_select_state(dev->pins->p, dev->pins->default_state);

	......
	ret = drv->probe(dev);
```

> [!tip]+ é‡è¦æç¤º
> å¦‚æœè®¾å¤‡èŠ‚ç‚¹æŒ‡å®šäº†pinctrlï¼Œåœ¨å¯¹åº”çš„probeå‡½æ•°è¢«è°ƒç”¨ä¹‹å‰ï¼Œå…ˆ`bind pins`ï¼Œå³å…ˆç»‘å®šã€è®¾ç½®å¼•è„š

### 3.4 é©±åŠ¨ä¸­pinctrlæ“ä½œAPI

```c
// ä½¿ç”¨defaultçŠ¶æ€çš„å¼•è„š
devm_pinctrl_get_select_default(struct device *dev);

// æ ¹æ®nameé€‰æ‹©æŸç§çŠ¶æ€çš„å¼•è„š
// nameæ˜¯è®¾å¤‡æ ‘ä¸­çš„çŠ¶æ€å
pinctrl_get_select(struct device *dev, const char *name);

// ä¸å†ä½¿ç”¨ï¼Œé€€å‡ºæ—¶è°ƒç”¨
pinctrl_put(struct pinctrl *p);
```

### 3.5 åº”ç”¨åœºæ™¯å’Œæ³¨æ„ç‚¹

> [!tip]+ å®é™…åº”ç”¨åœºæ™¯
> è¿™ç§pinctrlç®¡ç†æ–¹å¼å¸¸ç”¨äºï¼š
> - ä¸²å£å¼•è„šçš„åŠŸèƒ½åˆ‡æ¢ï¼ˆæ­£å¸¸å·¥ä½œ/ä¼‘çœ æ¨¡å¼ï¼‰
> - SPI / I2C å¼•è„šçš„å¤ç”¨ç®¡ç†
> - LCDæ˜¾ç¤ºå¼•è„šçš„çŠ¶æ€æ§åˆ¶
> - PWMè¾“å‡ºå¼•è„šçš„é…ç½®ç®¡ç†

> [!warning]+ æ³¨æ„äº‹é¡¹
> - å¼•è„šçŠ¶æ€ä¼šåœ¨probeå‡½æ•°è°ƒç”¨å‰è‡ªåŠ¨é…ç½®
> - ä¼˜å…ˆä½¿ç”¨initçŠ¶æ€ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨defaultçŠ¶æ€
> - ä¸åŒçŠ¶æ€é—´çš„åˆ‡æ¢éœ€è¦å†é©±åŠ¨ä¸­ä¸»åŠ¨è°ƒç”¨ç›¸åº”API

## 4 ä½¿ç”¨è®¾å¤‡æ ‘ç»™LCDæŒ‡å®šå„ç§å‚æ•°

**å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡å¦‚ä½•åœ¨è®¾å¤‡æ ‘ä¸­ä¸ºLCDè®¾å¤‡é…ç½®æ—¶é’Ÿã€å¼•è„šæ§åˆ¶å’Œæ—¶åºå‚æ•°ï¼Œç†è§£è®¾å¤‡æ ‘ä¸é©±åŠ¨ä»£ç çš„å¯¹åº”å…³ç³»

**å‚è€ƒèµ„æ–™**ï¼š
- [è®©TQ2440ç”¨ä¸Šè®¾å¤‡æ ‘](http://www.cnblogs.com/pengdonglin137/p/6241895.html)
- [githubä»£ç ](https://github.com/pengdonglin137/linux-4.9/tree/tq2440_dt)

### 4.1 å®éªŒç¯å¢ƒæ­å»º

æ‰€ç”¨æ–‡ä»¶åœ¨: doc_and_sources_for_device_tree\source_and_images\ç¬¬5,6è¯¾çš„æºç åŠæ˜ åƒæ–‡ä»¶(ä½¿ç”¨äº†å®Œå…¨ç‰ˆçš„è®¾å¤‡æ ‘)\ç¬¬6è¯¾ç¬¬4èŠ‚_LCDé©±åŠ¨\02th_æˆ‘ä¿®æ”¹çš„

**1ã€æ›¿æ¢dtsæ–‡ä»¶**ï¼šæŠŠ"jz2440_irq.dts" æ”¾å…¥å†…æ ¸ arch/arm/boot/dtsç›®å½•

**2ã€æ›¿æ¢é©±åŠ¨æ–‡ä»¶**ï¼šæŠŠ"s3c2410fb.c" æ”¾å…¥å†…æ ¸ drivers/video/fbdev/ ç›®å½•
- ä¿®æ”¹ å†…æ ¸ drivers/video/fbdev/Makefile ï¼š
```makefile
obj-$(CONFIG_FB_S3C2410)          += lcd_4.3.o
# æ”¹ä¸º
obj-$(CONFIG_FB_S3C2410)          += s3c2410fb.o
```

**3ã€ç¼–è¯‘é©±åŠ¨ã€ç¼–è¯‘dtbs**ï¼š
```shell
export PATH=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/work/system/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabi/bin
cp config_ok .config
make uImage   // ç”Ÿæˆ arch/arm/boot/uImage
make dtbs     // ç”Ÿæˆ arch/arm/boot/dts/jz2440_irq.dtb
```

**4ã€å¯åŠ¨æµ‹è¯•**ï¼šä½¿ç”¨ä¸Šè¿°uImage, dtbå¯åŠ¨å†…æ ¸å³å¯çœ‹åˆ°LCDæœ‰ä¼é¹…å‡ºç°

### 4.2 è®¾å¤‡æ ‘ä¸­LCDé…ç½®å’Œé©±åŠ¨ä»£ç å¤„ç†

**1ã€è®¾å¤‡æ ‘ä¸­çš„æè¿°**
```dts
fb0: fb@4d000000{
	compatible = "jz2440,lcd";
	reg = <0x4d000000 0x60>;
	interrupts = <0 0 16 3>;
	
	clocks = <&clocks HCLK_LCD>;   // 1.æ—¶é’Ÿ
	clock-names = "lcd";

	pinctrl-names = "default";     // 2.pinctrl
	pinctrl-0 = <&lcd_pinctrl &lcd_backlight &gpb0_backlight>;
	status = "okay";

	// 3.æ ¹æ®LCDå¼•è„šç‰¹æ€§è®¾ç½®lcdcon5ï¼ŒæŒ‡å®šlcdæ—¶åºå‚æ•°
	lcdcon5 = <0xb09>;
	type = <0x60>;
	width = /bits/ 16 <480>;
	height = /bits/ 16 <272>;
	pixclock = <100000>;         //æŒ‡å®šåƒç´ æªç§»åŠ¨ä¸€ä¸ªåƒç´ çš„é¢‘ç‡ï¼Œå•ä½ï¼šps = 10^-12s
	xres = /bits/ 16 <480>;
	yres = /bits/ 16 <272>;
	bpp = /bits/ 16 <16>;
	left_margin = /bits/ 16 <2>;
    right_margin =/bits/ 16  <2>;
    hsync_len = /bits/ 16 <41>;
    upper_margin = /bits/ 16 <2>;
    lower_margin = /bits/ 16 <2>;
    vsync_len = /bits/ 16 <10>;
};

&pinctrl_0 {
	gpb0_backlight: gpb0_backlight {
		samsung,pins = "gpb-0";
		samsung,pin-function = <1>;
		samsung,pin-val = <1>;
	};
};
```
- **åŸºæœ¬é…ç½®**ï¼šcompatibleã€regã€interruptså®šä¹‰è®¾å¤‡åŸºæœ¬ä¿¡æ¯
- **æ—¶é’Ÿé…ç½®**ï¼šclocksæŒ‡å®šLCDä½¿ç”¨çš„æ—¶é’Ÿæº
- **å¼•è„šé…ç½®**ï¼špinctrlé…ç½®LCDç›¸å…³å¼•è„šå’ŒèƒŒå…‰æ§åˆ¶
	- ä½¿ç”¨äº†3ä¸ªgroupçš„å¼•è„šï¼Œlcd_pinctrlè¿™ä¸ªgroupå‚è€ƒä¸‹å›¾
	  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/b6d8fd14260f3ee02039f1200b82a92e.png)![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/81c70d13fc1a043c7f72486f867ce85a.png)
ä¸‹é¢è¿™äº›æ˜¯LCDçš„å‚æ•°ï¼Œéœ€è¦å¯¹LCDæœ‰ä¸€å®šçš„ç†è§£
- **æ˜¾ç¤ºå‚æ•°**ï¼šwidthã€heightã€åˆ†è¾¨ç‡ç­‰LCDç‰©ç†ç‰¹æ€§
- **æ—¶åºå‚æ•°**ï¼špixclockã€marginã€syncç­‰æ—¶åºæ§åˆ¶å‚æ•°

**2ã€é©±åŠ¨ä»£ç ä¸­çš„å¤„ç†**
- **æ—¶é’Ÿå¤„ç†**ï¼š
```c
info->clk = of_clk_get(dev->of_node, 0);
clk_prepare_enable(info->clk);
```

- **pinctrlå¤„ç†**ï¼šä»£ç ä¸­æ— éœ€å¤„ç†ï¼Œåœ¨ platform_device/platform_driveråŒ¹é…ä¹‹åå°±ä¼šè®¾ç½®"default"çŠ¶æ€å¯¹åº”çš„pinctrl

- **æ ¹æ®LCDå¼•è„šç‰¹æ€§è®¾ç½®lcdcon5, æŒ‡å®šlcdæ—¶åºå‚æ•°**ï¼šç›´æ¥è¯»è®¾å¤‡æ ‘èŠ‚ç‚¹ä¸­çš„å„ç§å±æ€§å€¼ï¼Œç”¨æ¥è®¾ç½®é©±åŠ¨å‚æ•°
```c
of_property_read_u32(np, "lcdcon5", (u32 *)(&display->lcdcon5));
of_property_read_u32(np, "type", &display->type);
of_property_read_u16(np, "width", &display->width);
of_property_read_u16(np, "height", &display->height);
of_property_read_u32(np, "pixclock", &display->pixclock);
of_property_read_u16(np, "xres", &display->xres);
of_property_read_u16(np, "yres", &display->yres);
of_property_read_u16(np, "bpp", &display->bpp);
of_property_read_u16(np, "left_margin", &display->left_margin);
of_property_read_u16(np, "right_margin", &display->right_margin);
of_property_read_u16(np, "hsync_len", &display->hsync_len);
of_property_read_u16(np, "upper_margin", &display->upper_margin);
of_property_read_u16(np, "lower_margin", &display->lower_margin);
of_property_read_u16(np, "vsync_len", &display->vsync_len);
```

**3ã€æµç¨‹æ€»ç»“**

1. **è®¾å¤‡æ ‘é…ç½®æµç¨‹**ï¼š
	- å®šä¹‰LCDè®¾å¤‡èŠ‚ç‚¹çš„åŸºæœ¬ä¿¡æ¯
	- é…ç½®æ—¶é’Ÿå’Œpinctrlå¼•ç”¨
	- è®¾ç½®LCDç‰©ç†å‚æ•°å’Œæ—¶åºå‚æ•°
2. **é©±åŠ¨å¤„ç†æµç¨‹**ï¼š
	- é€šè¿‡`of_clk_get()`è·å–æ—¶é’Ÿ
	- ç³»ç»Ÿè‡ªåŠ¨å¤„ç†pinctrlé…ç½®
	- é€šè¿‡`of_property_read_*()`ç³»åˆ—å‡½æ•°è¯»å–å„ç§å‚æ•°
3. **å‚æ•°ä¼ é€’æœºåˆ¶**ï¼š
	- è®¾å¤‡æ ‘ä¸­å®šä¹‰çš„å‚æ•°é€šè¿‡è®¾å¤‡èŠ‚ç‚¹ä¼ é€’ç»™é©±åŠ¨
	- é©±åŠ¨é€šè¿‡DT APIè¯»å–è¿™äº›å‚æ•°å¹¶åº”ç”¨åˆ°ç¡¬ä»¶é…ç½®ä¸­

### 4.3 æŠ€æœ¯è¦ç‚¹

**LCDå‚æ•°ç±»å‹**ï¼š
- **ç‰©ç†å‚æ•°**ï¼šå±å¹•å°ºå¯¸ã€åˆ†è¾¨ç‡ã€è‰²æ·±ç­‰
- **æ—¶åºå‚æ•°**ï¼šåƒç´ æ—¶é’Ÿã€åŒæ­¥ä¿¡å·é•¿åº¦ã€è¾¹è·ç­‰
- **æ§åˆ¶å‚æ•°**ï¼šå¯„å­˜å™¨é…ç½®å€¼ã€å¼•è„šçŠ¶æ€ç­‰

**DT APIä½¿ç”¨**ï¼š
- `of_property_read_u32()`: è¯»å–32ä½æ•´æ•°å±æ€§
- `of_property_read_u16()`: è¯»å–16ä½æ•´æ•°å±æ€§
- `of_clk_get()`: è·å–æ—¶é’Ÿå¯¹è±¡

é€šè¿‡è®¾å¤‡æ ‘é…ç½®LCDå‚æ•°çš„ä¼˜åŠ¿ï¼š
- **ç¡¬ä»¶æŠ½è±¡**ï¼šå°†ç¡¬ä»¶å‚æ•°ä»é©±åŠ¨ä»£ç ä¸­åˆ†ç¦»
- **é…ç½®çµæ´»**ï¼šæ›´æ¢LCDæ—¶åªéœ€ä¿®æ”¹è®¾å¤‡æ ‘
- **ä»£ç å¤ç”¨**ï¼šåŒä¸€é©±åŠ¨å¯æ”¯æŒä¸åŒè§„æ ¼çš„LCD
- **ç»´æŠ¤ç®€ä¾¿**ï¼šå‚æ•°ä¿®æ”¹æ— éœ€é‡æ–°ç¼–è¯‘é©±åŠ¨


