---
æ–‡ç« æ ‡é¢˜: "[[2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  æ–‡ç« è¯¦ç»†é˜è¿°äº†Linuxå†…æ ¸ä¸­æ–­å¤„ç†æ¡†æ¶ï¼Œä»ARMå¼‚å¸¸å‘é‡è¡¨èµ·å§‹ï¼Œç»æ±‡ç¼–åˆ°Cè¯­è¨€è½¬æ¢ï¼Œæ·±å…¥è§£æ`irq_desc`æ ¸å¿ƒç»“æ„ï¼Œå¹¶ç»“åˆå…±äº«ã€çº§è”ä¸­æ–­å®ä¾‹ï¼Œæ­ç¤ºç¡¬ä»¶ä¸­æ–­å¦‚ä½•å±‚å±‚åˆ†å‘è‡³ä¸Šå±‚é©±åŠ¨ï¼Œå±•ç°äº†å†…æ ¸åˆ†å±‚ä¸å¯æ‰©å±•æ€§è®¾è®¡ã€‚
tags:
  - Linux kernel
  - ä¸­æ–­å¤„ç†
  - ARMæ¶æ„
  - å¼‚å¸¸å‘é‡è¡¨
  - irq_desc
  - å…±äº«ä¸­æ–­
  - çº§è”ä¸­æ–­
  - å†…æ ¸æœºåˆ¶
ç›¸å…³æ–‡ç« :
  - "[[9_ä¸²è¡Œå£é€šè®¯ï¼ˆé‡ç‚¹ï¼‰]]"
  - "[[../../07-ğŸ—ï¸ Linuxè®¾å¤‡æ¨¡å‹ä¸è®¾å¤‡æ ‘(é‡ç‚¹)/3_è®¾å¤‡æ ‘åŸºç¡€/1_å‚è€ƒå†…å®¹/å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†]]"
  - "[[3_åµŒå…¥å¼é©±åŠ¨å¼€å‘å­¦ä¹ è·¯çº¿(ä¸€å£å›)]]"
  - "[[3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/01-âš¡ ä¸­æ–­åŠå¼‚å¸¸/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°.md
æ–‡ç« éš¾åº¦: é«˜çº§ ğŸ”¥
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­â­ ç²¾é€šå¿…å¤‡
åˆ›å»ºæ—¶é—´: 2025-06-10 20:34:00
ä¿®æ”¹æ—¶é—´: 2025-06-10 21:46:18
---

## 1 å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œæˆ‘ä»¬å°†äº†è§£ï¼š
- Linuxå†…æ ¸å¦‚ä½•å¤„ç†ä¸­æ–­çš„å®Œæ•´æµç¨‹
- ä»ç¡¬ä»¶å¼‚å¸¸ï¼ˆä¸­æ–­ï¼‰åˆ°Cè¯­è¨€å¤„ç†å‡½æ•°çš„è½¬æ¢è¿‡ç¨‹
- å†…æ ¸ä¸­æ–­ç®¡ç†çš„æ•°æ®ç»“æ„è®¾è®¡
- æ™®é€šä¸­æ–­å’Œçº§è”ä¸­æ–­çš„å¤„ç†æœºåˆ¶

## 2 ä¸­æ–­å¤„ç†çš„èµ·ç‚¹ï¼šå¼‚å¸¸å‘é‡è¡¨

### 2.1 ç¡¬ä»¶ä¸­æ–­å‘ç”Ÿæ—¶çš„ç¬¬ä¸€æ­¥

å‰é¢è®²è¿‡ï¼Œå½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼ŒCPUé¦–å…ˆä¼šè·³è½¬åˆ°å¼‚å¸¸å‘é‡è¡¨ï¼Œè¿™æ˜¯ä¸­æ–­å¤„ç†çš„èµ·ç‚¹ã€‚

**æ–‡ä»¶ä½ç½®**ï¼š`å†…æ ¸æºç /arch/arm/kernel/entry-armv.S`
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/c904da3eaef7808737b0203cac175cf5.png)

```s
/* arch\arm\kernel\entry-armv.S */
.section .vectors, "ax", %progbits
.L__vectors_start:
    W(b)    vector_rst      /* å¤ä½å¼‚å¸¸ */
    W(b)    vector_und      /* æœªå®šä¹‰æŒ‡ä»¤å¼‚å¸¸ */
    W(ldr)  pc, .L__vectors_start + 0x1000
    W(b)    vector_pabt     /* é¢„å–æŒ‡ä»¤ä¸­æ­¢å¼‚å¸¸ */
    W(b)    vector_dabt     /* æ•°æ®è®¿é—®ä¸­æ­¢å¼‚å¸¸ */
    W(b)    vector_addrexcptn
    W(b)    vector_irq      /* IRQä¸­æ–­å…¥å£ */
    W(b)    vector_fiq      /* FIQä¸­æ–­å…¥å£ */
```
- è¿™æ˜¯ARMå¤„ç†å™¨çš„å¼‚å¸¸å‘é‡è¡¨
- å½“å‘ç”ŸIRQä¸­æ–­æ—¶ï¼ŒCPUä¼šè‡ªåŠ¨è·³è½¬åˆ°`vector_irq`æ ‡ç­¾å¤„å¼€å§‹æ‰§è¡Œ
- `vector_irq`å®é™…ä¸Šæ˜¯é€šè¿‡å®`vector_stub irq`æ¥å®šä¹‰çš„
  
### 2.2 ä¸­æ–­åˆ†å‘æœºåˆ¶

`vector_irq`å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸­æ–­åˆ†å‘å™¨ï¼Œæ ¹æ®CPUè¢«ä¸­æ–­æ—¶çš„çŠ¶æ€æ¥å†³å®šè°ƒç”¨å“ªä¸ªå¤„ç†å‡½æ•°
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7cd541f44cb93fd147be9a417ebdfaf4.png)

**å·¦ä¾§-ä¸­æ–­åˆ†å‘å™¨ï¼ˆInterrupt dispatcherï¼‰**
```s
/*
* Interrupt dispatcher - ä¸­æ–­åˆ†å‘å™¨
*/
vector_stub irq, IRQ_MODE, 4   
/* ç›¸å½“äº vector_irq: ..., 
* å®ƒä¼šæ ¹æ®SPSRå¯„å­˜å™¨çš„å€¼åˆ¤æ–­è¢«ä¸­æ–­æ—¶CPUçš„çŠ¶æ€
* ç„¶åè°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
*/
.long   __irq_usr               @  0  (USR_26 / USR_32)
.long   __irq_invalid           @  1  (FIQ_26 / FIQ_32)
.long   __irq_invalid           @  2  (IRQ_26 / IRQ_32)
.long   __irq_svc               @  3  (SVC_26 / SVC_32)
.long   __irq_invalid           @  4-f (å…¶ä»–æ— æ•ˆæ¨¡å¼)
...
```
- `vector_stub` æ˜¯ä¸­æ–­å¤„ç†çš„å…¥å£ç‚¹ï¼ŒåŒ…å«äº†ä¸€äº›åˆ—çš„`.long`æŒ‡ä»¤ï¼Œå®šä¹‰äº†ä¸åŒä¸­æ–­å·å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¤§éƒ¨åˆ†æŒ‡å‘æ— æ•ˆä¸­æ–­å¤„ç†`__irq_invalid`
- åªæœ‰å°‘æ•°æŒ‡å‘å®é™…çš„å¤„ç†å‡½æ•°`__irq_usr(ç”¨æˆ·æ¨¡å¼ä¸­æ–­)`å’Œ`__irq_svc(ç®¡ç†æ¨¡å¼ä¸­æ–­)`ï¼Œå³è¾¹æ˜¾ç¤ºäº†ä¸­æ–­å·`@0~f`

**åˆ†å‘é€»è¾‘**
- ç³»ç»Ÿä¼šæ£€æŸ¥SPSRå¯„å­˜å™¨æ¥åˆ¤æ–­ä¸­æ–­å‘ç”Ÿæ—¶CPUçš„å·¥ä½œæ¨¡å¼
- ç”¨æˆ·æ¨¡å¼ï¼ˆUSRï¼‰è¢«ä¸­æ–­ï¼Œè°ƒç”¨`__irq_usr`
- å†…æ ¸æ¨¡å¼ï¼ˆSVCï¼‰è¢«ä¸­æ–­ï¼Œè°ƒç”¨`__irq_svc`
- è¿™ä¸¤ä¸ªå‡½æ•°çš„å¤„ç†æµç¨‹å®é™…ä¸Šæ˜¯ç›¸åŒçš„

**å³ä¾§-å‘é‡å­˜æ ¹ï¼ˆVector stubsï¼‰**
- ä»£ç è¢«å¤åˆ¶åˆ°åœ°å€ `0xffff10000`ï¼Œä»¥ä¾¿åœ¨å‘é‡ä¸­ä½¿ç”¨åˆ†æ”¯æŒ‡ä»¤è€Œä¸æ˜¯è·³è½¬æŒ‡ä»¤
- **é‡è¦é™åˆ¶**ï¼šä»£ç ä¸èƒ½è¶…è¿‡ä¸€é¡µå¤§å°
- ä½¿ç”¨åˆ†æ”¯æŒ‡ä»¤è€Œä¸æ˜¯è·³è½¬æŒ‡ä»¤ä»¥æé«˜æ•ˆç‡
- å®šä¹‰å‘é‡å­˜æ ¹çš„å®ï¼Œç”¨äºç”Ÿæˆæ ‡å‡†åŒ–çš„ä¸­æ–­å¤„ç†å…¥å£ä»£ç 
```s
.macro vector_stub, name, mode, correction=0
.align 5
```

## 3 æ±‡ç¼–åˆ°Cè¯­è¨€çš„è½¬æ¢

### 3.1 æ¨¡å¼å¤„ç†å‡½æ•°çš„ç»Ÿä¸€æµç¨‹

**æ¨¡å¼å¤„ç†å‡½æ•°**ï¼š`__irq_usr`å’Œ`__irq_svc`è¿™ä¸¤ä¸ªå‡½æ•°è™½ç„¶é’ˆå¯¹ä¸åŒæ¨¡å¼ï¼Œä½†å¤„ç†æµç¨‹å®Œå…¨ç›¸åŒï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/c08c24cc6c03c24640efa6cdb1ee200b.png)
**å¤„ç†æµç¨‹**ï¼š
```txt
ä¿å­˜ç°åœº(usr_entry) â†’ è°ƒç”¨ä¸­æ–­å¤„ç†å™¨(irq_handler) â†’ æ¢å¤ç°åœº(ret_to_user_from_irq)
```

### 3.2 å…³é”®è½¬æ¢ï¼širq_handlerå®

è¿™æ˜¯ä»**æ±‡ç¼–è½¬å‘Cè¯­è¨€å¤„ç†çš„å…³é”®ç‚¹ï¼š**
```s
.macro  irq_handler
#ifdef CONFIG_GENERIC_IRQ_MULTI_HANDLER
    ldr r1, =handle_arch_irq    /* åŠ è½½Cå‡½æ•°åœ°å€ */
    mov r0, sp                  /* ä¼ é€’å †æ ˆæŒ‡é’ˆä½œä¸ºå‚æ•° */
    badr    lr, 9997f          /* è®¾ç½®è¿”å›åœ°å€ */
    ldr pc, [r1]               /* è·³è½¬åˆ°Cå‡½æ•° */
#else
    arch_irq_handler_default
#endif
9997:
.endm
```
- è¯¥å®å°†æ§åˆ¶æƒä»æ±‡ç¼–äº¤ç»™Cå‡½æ•°çš„`handle_arch_irq`
- `handle_arch_irq`æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“èŠ¯ç‰‡çš„ä¸­æ–­å¤„ç†å‡½æ•°

### 3.3 handle_arch_irqçš„è®¾ç½®æœºåˆ¶

**è®¾ç½®å‡½æ•°**ï¼š`set_handle_irq`ï¼ˆä½äº`å†…æ ¸æºç /kernel/irq/handle.c +214`ï¼‰
![image|400](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/848a24fd5252ec588a1973e6e7f975c9.png)

**é‡è¦æ¦‚å¿µ**ï¼šä¸åŒèŠ¯ç‰‡ä¼šè®¾ç½®è‡ªå·±ç‰¹å®šçš„irqå¤„ç†å‡½æ•°

### 3.4 S3C2440çš„å…·ä½“å®ç°

**å¯¹äºS3C2440å¤„ç†å™¨çš„handle_arch_irqå¤„ç†è¿‡ç¨‹**ï¼šå®é™…çš„å¤„ç†å‡½æ•°æ˜¯s3c24xx_handle_irq
- æ‰€åœ¨è·¯å¾„ï¼š`å†…æ ¸æºç /drivers/irqchip/irq-s3c24xx.c`
  ![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7b7192e9ec83fcb7860a4b45abb4374e.png)

## 4 å†…æ ¸å¯¹ä¸­æ–­çš„å¤„ç†æ¡†æ¶

### 4.1 åŸºæœ¬è®¾è®¡æ€æƒ³

æƒ³è±¡CPUè¿æ¥äº†ä¸€ä¸ª32ä½çš„ä¸­æ–­æ§åˆ¶å™¨ï¼š
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/1be56738d964b2f49cc516174097476e.png)

**é—®é¢˜**ï¼šå¦‚ä½•ç®¡ç†32ç§ä¸åŒçš„ä¸­æ–­åŠå…¶å¤„ç†å‡½æ•°ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸€é¡¹å¯¹åº”ä¸€ä¸ªä¸­æ–­ï¼Œ**æ•°ç»„é‡Œé¢ä¿å­˜ç€ä¸­æ–­å¤„ç†å‡½æ•°æŒ‡é’ˆ**ï¼Œè¿™ä¸ªæ•°ç»„çš„å…ƒç´ å†…æ ¸ç”¨`irq_desc`ç»“æ„ä½“è¡¨ç¤º

### 4.2 æ ¸å¿ƒæ•°æ®ç»“æ„ä½“ï¼širq_desc

å†…æ ¸ä½¿ç”¨`irq_desc`ç»“æ„ä½“æ•°ç»„æ¥ç®¡ç†æ‰€æœ‰ä¸­æ–­ï¼š
![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/10d991e226d9c7a3928a71a87ce60a0a.png)

**å…³é”®æˆå‘˜ç†è§£**ï¼š
- **`action`é“¾è¡¨**ï¼ˆ`struct irqaction`ï¼‰ï¼š
    - é“¾è¡¨ä¸­çš„`handler`æ˜¯**æˆ‘ä»¬ç¼–å†™çš„å…·ä½“ä¸šåŠ¡å¤„ç†å‡½æ•°(ä¸“æ³¨äºä¸šåŠ¡ï¼Œä¸éœ€è¦å…³æ³¨èŠ¯ç‰‡ç›¸å…³çš„æ¸…é™¤ã€ä½¿èƒ½ç­‰æ“ä½œ)**
    - ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å…³æ³¨èŠ¯ç‰‡åº•å±‚æ“ä½œ
- **`handle_irq`**ï¼š
    - è´Ÿè´£è°ƒç”¨actioné“¾è¡¨ä¸­çš„handler
    - **æ¸…ç†ä¸­æ–­**ï¼ˆèŠ¯ç‰‡ç›¸å…³æ“ä½œï¼‰ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨`struct irq_desc`ç»“æ„ä½“ä¸­çš„`irq_data`é‡Œé¢çš„`chip`ä¸­çš„`*irq_ack`ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹å›¾
      ![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/5cfbf549c0b175200d679c172d5cc137.png)

### 4.3 handler_arch_irqçš„é€šç”¨å¤„ç†æµç¨‹

æ— è®ºä»€ä¹ˆèŠ¯ç‰‡ï¼ŒåŸºæœ¬æµç¨‹éƒ½æ˜¯ï¼š
1. **è¯»å–ä¸­æ–­æ§åˆ¶å™¨å¯„å­˜å™¨** â†’ è·å¾—ç¡¬ä»¶ä¸­æ–­å·ï¼ˆhwirqï¼‰
2. **è½¬æ¢ä¸­æ–­å·** â†’ å°†hwirqè½¬æ¢ä¸ºè™šæ‹Ÿä¸­æ–­å·ï¼ˆvirqï¼‰
3. **è°ƒç”¨ä¸­æ–­å¤„ç†å‡½æ•°** â†’ æ‰§è¡Œ`irq_desc[virq].handle_irq`

## 5 å®é™…åº”ç”¨åœºæ™¯ä¸¾ä¾‹

### 5.1 åœºæ™¯1ï¼šå…±äº«ä¸­æ–­å¤„ç†

**ç¡¬ä»¶é…ç½®**ï¼šåœ¨0å·ä¸­æ–­ä¸ŠåŠ ä¸€ä¸ªæˆ–é—¨èŠ¯ç‰‡
![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/bb7178f7ff83852a17d156e9018ba7db.png)
- ä¸€ä¸ªå¼•è„šæ¥ç½‘å¡netï¼Œä¸€ä¸ªå¼•è„šæ¥æ‘„åƒå¤´cam
- å½“netæˆ–camæœ‰æ•°æ®æ—¶ä¼šäº§ç”Ÿä¸­æ–­ï¼Œå³å…±äº«ä¸­æ–­çš„
- netçš„ä¸­æ–­æ˜¯irq_netï¼Œcamçš„ä¸­æ–­æ˜¯irq_camï¼Œä¹Ÿå°±æ˜¯åœ¨`S3C2410_IRQ(0)`è¿™ä¸ªirq_descçš„actioné“¾è¡¨æœ‰ä¸¤ä¸ªirqactionï¼Œå¦‚ä¸‹å›¾
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/839dc45314a0cbabdd8176985a826277.png)
**å½“å‘ç”Ÿ0å·ä¸­æ–­çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ**
1. `handle_irq`éå†actioné“¾è¡¨ä¸­çš„æ‰€æœ‰handler
2. **ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªhandler**ï¼ˆirq_netå’Œirq_camï¼‰
3. æ¯ä¸ªhandlerå†…éƒ¨åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå·±çš„è®¾å¤‡äº§ç”Ÿçš„ä¸­æ–­
4. ä¸æ˜¯è‡ªå·±çš„ä¸­æ–­å°±ç›´æ¥è¿”å›ï¼Œæ˜¯çš„è¯å°±æ‰§è¡Œç›¸åº”å¤„ç†

### 5.2 åœºæ™¯2ï¼šçº§è”ä¸­æ–­å¤„ç†

**ç¡¬ä»¶é…ç½®**ï¼š4å·ä¸­æ–­è¿æ¥å­ä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¯èƒ½äº§ç”Ÿå¤–éƒ¨ä¸­æ–­4ï¼Œå¤–éƒ¨ä¸­æ–­5ç­‰ï¼Œå’Œå…±äº«ä¸­æ–­æ˜¯ç±»ä¼¼çš„ï¼‰
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/6f481dcec110c7866cc9a2d554e12f69.png)
**ä¸­æ–­è§¦å‘æµç¨‹**ï¼š
- å½“å‘ç”Ÿå¤–éƒ¨ä¸­æ–­4ã€5ã€6ã€7ä»»æ„ä¸€ä¸ªæ—¶ï¼Œ`sub interrupt controller(å­ä¸­æ–­æ§åˆ¶å™¨)`éƒ½ä¼šå‘ä¸Šä¸€çº§çš„ä¸­æ–­æ§åˆ¶å™¨`interrupt controller`å‘å‡ºä¿¡å·ï¼Œä¸Šä¸€çº§çš„ä¸­æ–­æ§åˆ¶å™¨å°±ä¼šå‘CPUå‘å‡ºä¸­æ–­
- CPUä¼šè¯»å–æŸä¸ªå¯„å­˜å™¨ï¼Œå°±ä¼šå‘ç°æ˜¯4å·ä¸­æ–­ï¼Œå³ **ä¸Šé¢4ä¸ªå¤–éƒ¨ä¸­æ–­å‘å‡ºä¿¡å·æ—¶ï¼ŒCPUéƒ½ä¼šæ‰¾åˆ°æ˜¯4å·ä¸­æ–­**

**ä¸¤ç§å¤„ç†æ–¹æ³•**ï¼š
**æ–¹æ³•1ï¼ˆä¸€èˆ¬æ–¹æ³•ï¼‰**ï¼š
- å¯¹äºå¤–éƒ¨ä¸­æ–­4ã€5ã€6ã€7ä»»æ„ä¸€ä¸ªï¼Œéƒ½å¯ä»¥å†™å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°
- é€šè¿‡`*action`å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·ï¼Œæœ€åéƒ½è°ƒç”¨ä¸€éç¡®å®šæ˜¯å“ªä¸ªå¤–éƒ¨ä¸­æ–­

**æ–¹æ³•2ï¼ˆæ™ºèƒ½åˆ†å‘ï¼‰**ï¼š
- æ—¢ç„¶å®ƒä»¬éƒ½æœ‰`sub interrupt controller(å­ä¸­æ–­æ§åˆ¶å™¨)`äº†ï¼Œå¯ä»¥è®©å­ä¸­æ–­æ§åˆ¶å™¨å’Œä¸€ä¸ªå¯„å­˜å™¨`EINTPEND`æ¥ç»‘å®š
- æœ€åè®©4å·ä¸­æ–­å¯¹åº”çš„`irq_desc`ä¸­çš„`handler_irq`æŒ‡å‘å¦å¤–ä¸€ä¸ªåˆ†å‘å‡½æ•°`s3c_irq_demux`ï¼Œå…¶å·¥ä½œå¦‚ä¸‹
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/42823c2f4ead6c765babeead4d39697a.png)
	- è¯»å–Reg(EINTPEND)è¿›ä¸€æ­¥åˆ†è¾¨ä¸­æ–­ï¼Œå¾—åˆ°`hwirq'`
	- æ ¹æ®`hwirq'`å¾—åˆ°`virq`
	- è°ƒç”¨`irq_desc[virq].handle_irq`å¤„ç†å­ä¸­æ–­

### 5.3 å…·ä½“å®ä¾‹ï¼šæŒ‰é”®ä¸­æ–­å¤„ç†

**åœºæ™¯**ï¼šEINT5æ¥äº†ä¸€ä¸ªæŒ‰é”®è®¾å¤‡ï¼Œä¸­æ–­å¤„ç†å‡½æ•°æ˜¯`irq_key` å¦‚ä¸‹å›¾æ‰€ç¤º
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/df80b3e3c8e92e1a736ec1ed9058ce0e.png)

 ![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/3e65c9b7ea69ba0d75a4436ee237a6a4.png)
**å®Œæ•´å¤„ç†æµç¨‹**ï¼š
- æ³¨å†Œä¸­æ–­æ—¶ï¼Œæ‰¾åˆ°å¯¹åº”çš„ä¸­æ–­å·37
- æŒ‰é”®æŒ‰ä¸‹ â†’ ä¿¡å·ä¼ é€’ï¼š`å­ä¸­æ–­æ§åˆ¶å™¨ â†’ ä¸Šçº§ä¸­æ–­æ§åˆ¶å™¨ â†’ CPU`
- CPUè¯†åˆ«ä¸º4å·ä¸­æ–­ï¼Œæ‰§è¡Œ`irq_desc[4].handle_irq`
- `handle_irq`è¯»å–EINTPENDå¯„å­˜å™¨ï¼Œç¡®å®šæ˜¯EINT5
- ç„¶åå¾—åˆ°EINT5å¯¹åº”çš„`hwirq'` -> `virq`ï¼Œæœ€åè°ƒç”¨`irq_desc[virq].handle_irq`
- `irq_desc[virq].handle_irq`ä¼šå°†actioné‡Œé¢çš„hanlderï¼ˆå³irq_keyï¼‰å–å‡ºæ¥æ‰§è¡Œ

## 6 æºç åˆ†æï¼šå…³é”®å‡½æ•°è¿½è¸ª

### 6.1 s3c24xx_handle_irqåˆ†æ

**æ–‡ä»¶ä½ç½®**ï¼š`å†…æ ¸æºç /drivers/irqchip/irq-s3c24xx.c`
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/30c9dd6545976f9777b27b087cef6ef4.png)![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/d4b5d7e53838d0ca88593908875c1bc8.png)

### 6.2 handle_domain_irqåˆ†æ

**æ–‡ä»¶ä½ç½®**ï¼š`å†…æ ¸æºç /kernel/irq/irqdesc.c +654`
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/821a11772d1c416e45d0d49e6b4881f8.png)![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/064b350795c650d24030c6960c7b5334.png)

## 7 æ€»ç»“ï¼šä¸¤ç§ä¸­æ–­å¤„ç†æ¨¡å¼

### 7.1 æƒ…å†µ1ï¼šæ™®é€šä¸­æ–­ï¼ˆæ— å­ä¸­æ–­ï¼‰

å½“`irq_desc[virq].handle_irq`è¢«è°ƒç”¨æ—¶ï¼š
- éå†`irq_desc[virq].action`é“¾è¡¨ä¸­çš„æ¯ä¸ªhandlerå¹¶æ‰§è¡Œ
- ä½¿ç”¨`irq_desc[virq].irq_data.chip`ä¸­çš„å‡½æ•°æ¸…é™¤ä¸­æ–­æ ‡å¿—

### 7.2 æƒ…å†µ2ï¼šçº§è”ä¸­æ–­ï¼ˆæœ‰å­ä¸­æ–­ï¼‰

å½“è¯¥ä¸­æ–­ç”±å­ä¸­æ–­æ§åˆ¶å™¨äº§ç”Ÿæ—¶ï¼š
- è¯»å–sub int controllerå¯„å­˜å™¨ï¼Œå¾—åˆ°hwirq'
- æ ¹æ®hwirq'å¾—åˆ°å¯¹åº”çš„virq
- é€’å½’è°ƒç”¨`irq_desc[virq].handle_irq`å¤„ç†å­ä¸­æ–­

## 8 è¦ç‚¹å›é¡¾

1. **ç¡¬ä»¶åˆ°è½¯ä»¶çš„è½¬æ¢**ï¼šå¼‚å¸¸å‘é‡è¡¨ â†’ æ±‡ç¼–å¤„ç† â†’ Cè¯­è¨€å‡½æ•°
2. **ç»Ÿä¸€çš„ç®¡ç†æ¡†æ¶**ï¼širq_descæ•°ç»„ç®¡ç†æ‰€æœ‰ä¸­æ–­
3. **çµæ´»çš„å¤„ç†æœºåˆ¶**ï¼šæ”¯æŒå…±äº«ä¸­æ–­å’Œçº§è”ä¸­æ–­
4. **åˆ†å±‚è®¾è®¡æ€æƒ³**ï¼šåº•å±‚å¤„ç†èŠ¯ç‰‡ç›¸å…³æ“ä½œï¼Œä¸Šå±‚ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
5. **å¯æ‰©å±•æ€§**ï¼šä¸åŒèŠ¯ç‰‡å¯ä»¥æ³¨å†Œè‡ªå·±çš„å¤„ç†å‡½æ•°

é€šè¿‡ç†è§£è¿™ä¸ªæ¡†æ¶ï¼Œæˆ‘ä»¬å°±èƒ½æ˜ç™½Linuxå†…æ ¸æ˜¯å¦‚ä½•ä¼˜é›…åœ°å¤„ç†å„ç§å¤æ‚çš„ä¸­æ–­åœºæ™¯çš„ã€‚