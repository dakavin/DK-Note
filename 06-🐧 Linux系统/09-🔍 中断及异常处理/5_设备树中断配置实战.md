---
æ–‡ç« æ ‡é¢˜: "[[5_è®¾å¤‡æ ‘ä¸­æ–­é…ç½®å®æˆ˜]]" 
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  æ·±å…¥è®²è§£Linuxè®¾å¤‡æ ‘ä¸­æ–­é…ç½®å®æˆ˜ï¼ŒåŒ…æ‹¬GICæ§åˆ¶å™¨é…ç½®ã€è®¾å¤‡ä¸­æ–­æè¿°è¯­æ³•ã€å®é™…è®¾å¤‡é…ç½®ç¤ºä¾‹ä»¥åŠé©±åŠ¨ç¨‹åºä¸­è·å–ä¸­æ–­å·çš„å¤šç§æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚
tags:
- "è®¾å¤‡æ ‘"
- "GICä¸­æ–­æ§åˆ¶å™¨"
- "ä¸­æ–­é…ç½®"
- "ä¸­æ–­å·è·å–"
- "GPIOä¸­æ–­"
- "Platformè®¾å¤‡"
- "SPIä¸­æ–­"
- "I2Cä¸­æ–­"
ç›¸å…³æ–‡ç« :
- "[[06_ğŸ“•è®¾å¤‡æ ‘ä¸­æ–­çš„å±æ€§æè¿° (æœ€å¸¸ç”¨)]]"
- "[[ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘]]"
- "[[9_å®šæ—¶å™¨]]"
- "[[01_Linuxç³»ç»Ÿæ„æˆç®€å•ä»‹ç»]]"
- "[[02_è®¾å¤‡æ ‘ï¼ˆdevice Treeï¼‰çš„ç”±æ¥]]"
æ–‡ç« åˆ†ç±»: "ğŸ§ Linuxç³»ç»Ÿ"
æ–‡ç« è·¯å¾„: "06-ğŸ§ Linuxç³»ç»Ÿ/09-ğŸ” ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/5_è®¾å¤‡æ ‘ä¸­æ–­é…ç½®å®æˆ˜.md"
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2025-07-02 06:56:13
ä¿®æ”¹æ—¶é—´: 2025-07-04 00:58:15
---

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥ç†è§£äº†GICä¸­æ–­æ§åˆ¶å™¨çš„å·¥ä½œåŸç†ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å­¦ä¹ ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯æ˜¯å¦‚ä½•åœ¨è®¾å¤‡æ ‘ä¸­æè¿°çš„ï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œè®¾å¤‡æ ‘å°±åƒä¸€ä»½"ç¡¬ä»¶è¯´æ˜ä¹¦"ï¼Œè¯¦ç»†æè¿°äº†æ¯ä¸ªè®¾å¤‡çš„ä¸­æ–­é…ç½®ä¿¡æ¯ã€‚é©±åŠ¨ç¨‹åºé€šè¿‡è¯»å–è¿™ä»½"è¯´æ˜ä¹¦"ï¼Œå°±èƒ½çŸ¥é“åº”è¯¥ä½¿ç”¨å“ªä¸ªä¸­æ–­å·ã€ä»€ä¹ˆè§¦å‘æ–¹å¼ç­‰é‡è¦ä¿¡æ¯ã€‚ç†è§£è®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­é…ç½®ï¼Œæ˜¯ç¼–å†™è®¾å¤‡é©±åŠ¨ç¨‹åºçš„åŸºç¡€æŠ€èƒ½ã€‚

> **é‡è¦ç¬”è®°**  
> è®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­ä¿¡æ¯åŒ…æ‹¬ä¸­æ–­æ§åˆ¶å™¨é…ç½®ã€ä¸­æ–­å·åˆ†é…ã€è§¦å‘æ–¹å¼ç­‰ã€‚ç†è§£è¿™äº›é…ç½®è§„åˆ™æ˜¯ç¼–å†™è®¾å¤‡é©±åŠ¨çš„åŸºç¡€ã€‚

## 1 GICä¿¡å·è¿æ¥å…³ç³»

### 1.1 ä¸­æ–­ä¿¡å·çš„ä¼ é€’è·¯å¾„

å½“GICæ¥æ”¶åˆ°å¤–éƒ¨ä¸­æ–­ä¿¡å·ä¹‹åå°±ä¼šæŠ¥ç»™ARMå†…æ ¸ï¼Œä½†æ˜¯ARMå†…æ ¸åªæä¾›äº†4ä¸ªä¿¡å·ç»™GICæ¥æ±‡æŠ¥ä¸­æ–­æƒ…å†µï¼š**VFIQã€VIRQã€FIQå’ŒIRQ**ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚å›¾ï¼š

![GICåˆ°CPUçš„ä¿¡å·è¿æ¥](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/90565d93866a97865408f7f5b1471900.png)

GICæ¥æ”¶ä¼—å¤šçš„å¤–éƒ¨ä¸­æ–­ï¼Œç„¶åå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆå°±åªé€šè¿‡å››ä¸ªä¿¡å·æŠ¥ç»™ARMå†…æ ¸ï¼Œè¿™å››ä¸ªä¿¡å·çš„å«ä¹‰å¦‚ä¸‹ï¼š

- `VFIQ`ï¼šè™šæ‹Ÿå¿«é€Ÿä¸­æ–­
- `VIRQ`ï¼šè™šæ‹Ÿæ™®é€šä¸­æ–­
- `FIQ`ï¼šå¿«é€Ÿä¸­æ–­
- `IRQ`ï¼šæ™®é€šä¸­æ–­

> **é‡è¦è¯´æ˜**  
> VFIQå’ŒVIRQæ˜¯é’ˆå¯¹è™šæ‹ŸåŒ–çš„ï¼Œæˆ‘ä»¬è®¨è®ºä¸è™šæ‹ŸåŒ–ï¼Œå‰©ä¸‹çš„å°±æ˜¯FIQå’ŒIRQäº†ã€‚

è¿™ç§è®¾è®¡å°±åƒä¸€ä¸ªå¤§å‹ä¼ä¸šçš„æ±‡æŠ¥ç³»ç»Ÿï¼šå„ä¸ªéƒ¨é—¨ï¼ˆå¤–è®¾ï¼‰æœ‰äº‹æƒ…è¦å¤„ç†æ—¶ï¼Œéƒ½å‘æ€»ç»ç†åŠå…¬å®¤ï¼ˆGICï¼‰æ±‡æŠ¥ï¼Œæ€»ç»ç†åŠå…¬å®¤ç»è¿‡ç­›é€‰å’Œåˆ†ç±»åï¼Œåªé€šè¿‡å‡ ç§å›ºå®šçš„æ¸ é“ï¼ˆFIQ/IRQï¼‰å‘è‘£äº‹é•¿ï¼ˆCPUï¼‰æ±‡æŠ¥æœ€é‡è¦çš„äº‹æƒ…ã€‚è¿™æ ·æ—¢ä¿è¯äº†æ•ˆç‡ï¼Œåˆé¿å…äº†è‘£äº‹é•¿è¢«å¤ªå¤šçç¢ä¿¡æ¯å¹²æ‰°ã€‚

### 1.2 ä¸­æ–­ä¼˜å…ˆçº§å¤„ç†

åœ¨è¿™ä¸ªä¼ é€’è¿‡ç¨‹ä¸­ï¼ŒGICæ§åˆ¶å™¨å‘æŒ¥ç€å…³é”®çš„ç­›é€‰å’Œè°ƒåº¦ä½œç”¨ã€‚å®ƒä¸ä»…ä»…æ˜¯ç®€å•åœ°è½¬å‘ä¸­æ–­ä¿¡å·ï¼Œè€Œæ˜¯æ ¹æ®ä¸­æ–­çš„ä¼˜å…ˆçº§ã€äº²å’Œæ€§è®¾ç½®ã€ä½¿èƒ½çŠ¶æ€ç­‰å› ç´ ï¼Œæ™ºèƒ½åœ°å†³å®šä½•æ—¶ã€ä»¥ä½•ç§æ–¹å¼å‘CPUå‘é€ä¸­æ–­é€šçŸ¥ã€‚

æ¢å¥è¯è¯´ï¼ŒGICå°±åƒä¸€ä¸ªæ™ºèƒ½çš„ç§˜ä¹¦ï¼Œä¸ä»…è¦æ¥æ”¶å„éƒ¨é—¨çš„æ±‡æŠ¥ï¼Œè¿˜è¦æ ¹æ®äº‹åŠ¡çš„é‡è¦ç¨‹åº¦å’Œç´§æ€¥ç¨‹åº¦ï¼Œåˆç†å®‰æ’å‘é¢†å¯¼æ±‡æŠ¥çš„æ—¶æœºå’Œæ–¹å¼ã€‚

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿèƒ½å¤ŸåŠæ—¶å“åº”æœ€é‡è¦çš„ä¸­æ–­äº‹ä»¶ï¼ŒåŒæ—¶é¿å…äº†ä½ä¼˜å…ˆçº§ä¸­æ–­å¯¹é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„å¹²æ‰°ã€‚

## 2 è®¾å¤‡æ ‘ä¸­æ–­è¯­æ³•åŸºç¡€

åœ¨æ·±å…¥å…·ä½“é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹è®¾å¤‡æ ‘ä¸­æ–­æè¿°çš„åŸºæœ¬è¯­æ³•è§„åˆ™ã€‚è¯­æ³•å‚è€ƒæ–‡æ¡£ï¼š`Documentation/devicetree/bindings/interrupt-controller/interrupts.txt`

è®¾å¤‡æ ‘å°±åƒä¸€ç§"æ ‡å‡†åŒ–çš„é…ç½®è¯­è¨€"ï¼Œå®ƒç”¨ç»Ÿä¸€çš„æ ¼å¼æ¥æè¿°å„ç§ç¡¬ä»¶ä¿¡æ¯ã€‚å¯¹äºä¸­æ–­é…ç½®æ¥è¯´ï¼Œè¿™ç§æ ‡å‡†åŒ–å°¤å…¶é‡è¦ï¼Œå› ä¸ºå®ƒè®©ä¸åŒå‚å•†çš„ç¡¬ä»¶èƒ½å¤Ÿç”¨ç›¸åŒçš„æ–¹å¼æ¥æè¿°ä¸­æ–­ä¿¡æ¯ã€‚

ç®€å•æ¥è¯´ï¼Œè®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­é…ç½®åŒ…æ‹¬ä¸¤ä¸ªå±‚é¢ï¼š
- **ä¸­æ–­æ§åˆ¶å™¨çš„å®šä¹‰**ï¼šæè¿°ä¸­æ–­æ§åˆ¶å™¨æœ¬èº«çš„å±æ€§å’Œèƒ½åŠ›
- **è®¾å¤‡ä¸­æ–­çš„å¼•ç”¨**ï¼šå„ä¸ªè®¾å¤‡å¦‚ä½•ä½¿ç”¨è¿™äº›ä¸­æ–­æ§åˆ¶å™¨

ä¹Ÿå°±æ˜¯è¯´ï¼Œå°±åƒå…ˆè¦å»ºç«‹"ç”µè¯æ€»æœº"ï¼ˆä¸­æ–­æ§åˆ¶å™¨ï¼‰ï¼Œç„¶åå„ä¸ªéƒ¨é—¨ï¼ˆè®¾å¤‡ï¼‰æ‰èƒ½ç”³è¯·"åˆ†æœºå·"ï¼ˆä¸­æ–­èµ„æºï¼‰ã€‚

## 3 GICæ§åˆ¶å™¨èŠ‚ç‚¹é…ç½®

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹GICæ§åˆ¶å™¨åœ¨è®¾å¤‡æ ‘ä¸­æ˜¯å¦‚ä½•é…ç½®çš„ï¼Œè¿™éƒ¨åˆ†é€šå¸¸ç”±SOCå‚å®¶ç¼–å†™ã€‚æ‰“å¼€rk3568.dtsiæ–‡ä»¶ï¼ˆ`å†…æ ¸æºç /arch/arm64/boot/dts/rockchip/rk3568.dtsi`ï¼‰ï¼Œå…¶ä¸­gicèŠ‚ç‚¹å°±æ˜¯GICçš„ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼š

![GICæ§åˆ¶å™¨è®¾å¤‡æ ‘é…ç½®|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/b1d4aa13368255d110ca2964391deff1.png)

**åŸºæœ¬å±æ€§**ï¼š
- `compatible`ï¼šå¯¹åº”çš„é©±åŠ¨ä»£ç ä¸­of_device_ofæ•°ç»„å«æœ‰çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡å…¶æ‰¾åˆ°å¯¹åº”çš„**GICä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨æ–‡ä»¶**
- `reg`ï¼šæŒ‡å®šä¸­æ–­å¯„å­˜å™¨ç›¸å…³å¯„å­˜å™¨çš„åœ°å€å’Œå¤§å°ï¼ŒGICDæ˜¯Distributorå¯„å­˜å™¨ï¼ŒGICRæ˜¯Redistributorå¯„å­˜å™¨

**ä¸­æ–­æ§åˆ¶å™¨æ ‡è¯†**ï¼š
- `interrupt-controller`ï¼šè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯ä¸­æ–­æ§åˆ¶å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— å€¼å±æ€§ï¼Œåªè¦å­˜åœ¨å°±è¡¨ç¤ºè¯¥åŠŸèƒ½

**ä¸­æ–­æè¿°æ ¼å¼**ï¼š
- `#interrupt-cells`ï¼šè¡¨ç¤ºå­ä¸­æ–­è®¾å¤‡ä½¿ç”¨3ä¸ªu32æ•°æ®çš„interruptså±æ€§æ¥æè¿°ä¸­æ–­ä¿¡æ¯

è¿™ä¸ªå±æ€§å®šä¹‰äº†å¼•ç”¨æ­¤ä¸­æ–­æ§åˆ¶å™¨çš„è®¾å¤‡éœ€è¦æä¾›çš„å‚æ•°ä¸ªæ•°ã€‚å¯¹äºGICv3ï¼Œéœ€è¦3ä¸ªå‚æ•°ï¼š
1. **ç¬¬ä¸€ä½u32æ•°æ®**ï¼šä¸­æ–­ç±»å‹ï¼Œ0è¡¨ç¤ºSPIä¸­æ–­ï¼Œ1è¡¨ç¤ºPPIä¸­æ–­
2. **ç¬¬äºŒä½u32æ•°æ®**ï¼šä¸­æ–­å·
    - å¯¹äºSPIä¸­æ–­æ¥è¯´ä¸­æ–­å·çš„èŒƒå›´ä¸º32~1019ï¼ˆå…·ä½“å–å†³äºåŠå¯¼ä½“å‚å•†å®é™…ä½¿ç”¨äº†å¤šå°‘ä¸ªä¸­æ–­å·ï¼‰
    - å¯¹äºPPIä¸­æ–­æ¥è¯´ä¸­æ–­å·çš„èŒƒå›´ä¸º16~31ï¼Œä½†æ˜¯è¯¥cellæè¿°çš„ä¸­æ–­å·æ˜¯ä»0å¼€å§‹
3. **ç¬¬ä¸‰ä½u32æ•°æ®**ï¼šä¸­æ–­æ ‡å¿—
    - ä½¿ç”¨bit[3:0]è¡¨ç¤ºä¸­æ–­è§¦å‘ç±»å‹ï¼Œå®šä¹‰åœ¨`å†…æ ¸æºç /include/dt-bindings/interrupt-controller/irq.h`è¿™ä¸ªæ–‡ä»¶ä¸­
      ![ä¸­æ–­è§¦å‘ç±»å‹å®šä¹‰|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/deeefa612b212f979387087a88ffc1b4.png)
	- bit[15:8]ä¸ºPPIä¸­æ–­çš„CPUæ©ç ï¼Œåœ¨å¤šæ ¸ç³»ç»Ÿä¸­è¿™8ä½ç”¨äºè®¾ç½®PPIä¸­æ–­å‘é€åˆ°å“ªä¸ªCPUï¼Œä¸€ä½ä»£è¡¨ä¸€ä¸ªCPUï¼Œä¸º1åˆ™å°†PPIä¸­æ–­å‘é€åˆ°CPU0ï¼Œå¦åˆ™å±è”½

**ITSå­èŠ‚ç‚¹**ï¼š
- `its`ï¼šå­è®¾å¤‡èŠ‚ç‚¹ï¼ŒITSè®¾å¤‡ç”¨äºå°†æ¶ˆæ¯ä¿¡å·ä¸­æ–­ï¼ˆMSIï¼‰è·¯ç”±åˆ°CPU
- `msi-controller`ï¼šæ ‡è¯†è¯¥è®¾å¤‡æ˜¯MSIæ§åˆ¶å™¨
- `msi-cells`ï¼šå¿…é¡»æ˜¯1ï¼ŒMSIè®¾å¤‡çš„DeviceID

æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªé…ç½®å°±åƒç»™"ç”µè¯æ€»æœº"åˆ¶å®šäº†æ“ä½œè§„èŒƒï¼šæ¯æ¬¡æœ‰äººè¦ç”³è¯·åˆ†æœºæ—¶ï¼Œå¿…é¡»æä¾›3ä¸ªä¿¡æ¯ï¼ˆä¸­æ–­ç±»å‹ã€ä¸­æ–­å·ã€è§¦å‘æ–¹å¼ï¼‰ï¼Œæ€»æœºæ‰èƒ½æ­£ç¡®åˆ†é…èµ„æºã€‚

> [!tip]+ æç¤º
> è¯¦ç»†æ–‡æ¡£å¯ä»¥å‚è€ƒ `å†…æ ¸æºç /Documentation/devicetree/bindings/interrupt-controller/arm,gic-v3.txt`
> ![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/8b25721184db89e2a5eb6ed214d55d62.png)
> 
> PPIçš„ç¤ºä¾‹å‚è€ƒå¦‚ä¸‹
> ![image.png|200](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/420d2a59f53a9a6b1438528cc092b3bb.png)

## 4 å®é™…è®¾å¤‡ä¸­æ–­é…ç½®

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®é™…è®¾å¤‡æ˜¯å¦‚ä½•åœ¨è®¾å¤‡æ ‘ä¸­é…ç½®ä¸­æ–­ä¿¡æ¯çš„ï¼Œè¿™éƒ¨åˆ†é€šå¸¸**ç”±é©±åŠ¨å¼€å‘è€…æˆ–ç³»ç»Ÿé›†æˆè€…ç¼–å†™**ã€‚

**ç¤ºä¾‹ï¼šRK3568çš„SPI0åœ¨è®¾å¤‡æ ‘èŠ‚ç‚¹ä¸­é…ç½®ä¸­æ–­ä¿¡æ¯**

é¦–å…ˆæŸ¥çœ‹RK3568çš„ä¸­æ–­å·åˆ†é…è¡¨ï¼š

![RK3568ä¸­æ–­å·åˆ†é…è¡¨](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/e7f72ca4e07fff4f679bc55a347d67b2.png)

ä»è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼ŒSPI0çš„ä¸­æ–­å·æ˜¯135ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯åŠ ä¸Šäº†å‰é¢32ä¸ªPPIä¸­æ–­å·ï¼Œå¦‚æœä¸ç®—å‰é¢32ä¸ªPPIä¸­æ–­å·çš„è¯ï¼Œå°±æ˜¯135-32 = 103ã€‚è¿™ç§ç¼–å·æ–¹å¼åæ˜ äº†GICä¸­æ–­IDçš„åˆ†é…è§„åˆ™ï¼šå‰32ä¸ªIDè¢«SGIå’ŒPPIå ç”¨ï¼ŒSPIä¸­æ–­ä»ID32å¼€å§‹ã€‚

æ‰“å¼€rk3568.dtsiï¼Œæ‰¾åˆ°SPI0èŠ‚ç‚¹å†…å®¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
![SPI0è®¾å¤‡æ ‘é…ç½®|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/aee372cabc48c00f40c38b14c4fac746.png)

- `interrupts`ï¼šæè¿°è¯¥èŠ‚ç‚¹çš„ä¸­æ–­ä¿¡æ¯
- ç¬¬ä¸€ä¸ªå‚æ•°ï¼š`GIC_SPI`ï¼ˆå€¼ä¸º0ï¼‰ï¼Œè¡¨ç¤ºå…±äº«ä¸­æ–­ç±»å‹
- ç¬¬äºŒä¸ªå‚æ•°ï¼š`103`ï¼Œè¡¨ç¤ºä¸­æ–­å·ï¼ˆ135-32 = 103ï¼‰
- ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š`IRQ_TYPE_LEVEL_HIGH`ï¼Œè¡¨ç¤ºä¸­æ–­è§¦å‘æ–¹å¼ä¸ºé«˜ç”µå¹³è§¦å‘

è¿™ä¸ªé…ç½®å‘Šè¯‰å†…æ ¸ï¼šSPI0è®¾å¤‡ä½¿ç”¨ä¸€ä¸ªå…±äº«ä¸­æ–­ï¼Œç¡¬ä»¶ä¸­æ–­å·æ˜¯103ï¼ˆåœ¨SPIèŒƒå›´å†…ï¼‰ï¼Œè§¦å‘æ–¹å¼æ˜¯é«˜ç”µå¹³è§¦å‘ã€‚å½“SPI0è®¾å¤‡éœ€è¦CPUæ³¨æ„æ—¶ï¼Œå®ƒä¼šé€šè¿‡è¿™ä¸ªä¸­æ–­é€šé“å‘é€ä¿¡å·ã€‚

ç®€å•æ¥è¯´ï¼Œè¿™å°±åƒä¸ºSPI0è®¾å¤‡ç”³è¯·äº†ä¸€ä¸ª"ä¸“ç”¨ç”µè¯å·ç "ï¼Œå½“è®¾å¤‡æœ‰äº‹æƒ…è¦æ±‡æŠ¥æ—¶ï¼Œå°±æ‹¨æ‰“è¿™ä¸ªå·ç é€šçŸ¥CPUã€‚

## 5 GPIOä¸­æ–­é…ç½®

GPIOä¸­æ–­çš„é…ç½®ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºGPIOæœ¬èº«ä¹Ÿå¯ä»¥ä½œä¸ºä¸­æ–­æ§åˆ¶å™¨ä½¿ç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ã€‚

### 5.1 GPIOä¸­æ–­æ§åˆ¶å™¨é…ç½®

é¦–å…ˆçœ‹çœ‹gpio0è¿™ä¸ªå¼•è„šçš„é…ç½®ï¼Œä¸»è¦çœ‹ä¸­æ–­çš„é…ç½®ï¼š
![GPIO0ä¸­æ–­é…ç½®](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/b023713f405b9a94d8a23cae79473eac.png)
- `interrupts`ï¼šä¸­æ–­é…ç½®
    - ç¬¬ä¸€ä¸ªu32ï¼šå…±äº«ä¸­æ–­ç±»å‹
    - ç¬¬äºŒä¸ªu32ï¼šä¸­æ–­å·ä¸º33ï¼Œ33+32=65
    - ç¬¬ä¸‰ä¸ªu32ï¼šä¸­æ–­è§¦å‘ç±»å‹ä¸ºé«˜ç”µå¹³è§¦å‘
- `interrupt-controller`ï¼šè¡¨æ˜æ˜¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨
- `#interrupt-cells`ï¼šè¡¨ç¤ºåœ¨è¿™ä¸ªä¸­æ–­æ§åˆ¶å™¨ä¸‹çš„å­ä¸­æ–­è®¾å¤‡ï¼Œinterruptså±æ€§çš„å€¼ä¸º2ä¸ªu32æ•°æ®

> [!tip]+ æç¤º
> 
> - è¿™é‡Œæ²¡æœ‰æ˜¾ç¤ºinterrupt-parentï¼Œæ˜¯å› ä¸ºåœ¨æ ¹èŠ‚ç‚¹ä¸‹é¢å·²ç»å®šä¹‰äº†
> - gpio0çš„çˆ¶ä¸­æ–­æ§åˆ¶å™¨å°±æ˜¯æˆ‘ä»¬ä¹‹å‰çœ‹çš„gicæ§åˆ¶å™¨ï¼ˆæ ¹ä¸­æ–­æ§åˆ¶å™¨ï¼‰

è¿™ç§è®¾è®¡ä½“ç°äº†ä¸­æ–­ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„ï¼šGPIO0æ—¢æ˜¯GICçš„ä¸€ä¸ªä¸­æ–­æºï¼ŒåŒæ—¶å®ƒè‡ªå·±ä¹Ÿå¯ä»¥ä½œä¸ºä¸­æ–­æ§åˆ¶å™¨ï¼Œç®¡ç†è¿æ¥åˆ°å®ƒçš„å„ä¸ªGPIOå¼•è„šçš„ä¸­æ–­ã€‚è¿™å°±åƒä¸€ä¸ªéƒ¨é—¨ç»ç†ï¼Œæ—¢è¦å‘ä¸Šçº§æ±‡æŠ¥ï¼Œä¹Ÿè¦ç®¡ç†ä¸‹å±å‘˜å·¥ã€‚

### 5.2 GPIOå­è®¾å¤‡ä¸­æ–­é…ç½®

æ¥ä¸‹æ¥çœ‹çœ‹gpio0ä¸­æ–­æ§åˆ¶å™¨ä¸‹çš„å­ä¸­æ–­è®¾å¤‡é…ç½®ï¼ˆè¿™éƒ¨åˆ†é€šå¸¸ç”±ç”¨æˆ·ç¼–å†™ï¼‰ã€‚

æŸ¥çœ‹æ¿å¡å®é™…ä½¿ç”¨çš„dtsæ–‡ä»¶ `å†…æ ¸æºç /arch/arm64/boot/dts/rockchip/rk3568-lubancat-2-v2.dts`

ä¸‹é¢æ˜¯å¯¹GT911è§¦æ‘¸å±æ§åˆ¶å™¨è®¾å¤‡èŠ‚ç‚¹çš„é…ç½®ï¼š
![GT911è§¦æ‘¸å±ä¸­æ–­é…ç½®|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/062e6c3209c3b13672873de8dbf2259f.png)
- `interrupt-parent`ï¼šæŒ‡å®šçˆ¶ä¸­æ–­æ§åˆ¶å™¨ä¸ºgpio0
- `interrupts`ï¼šä¸­æ–­å¼•è„šé…ç½®ï¼ŒæŒ‰ç…§çˆ¶ä¸­æ–­çš„é™åˆ¶ä¸º2ä¸ªu32
    - ç¬¬ä¸€ä¸ªu32ï¼šä½¿ç”¨GPIO0çš„PB5å¼•è„šï¼Œï¼ˆ13å·å¼•è„šï¼Œ`0*32 + 1*8 + 5 = 13`ï¼‰ï¼Œä¹Ÿå°±æ˜¯GPIO0_B5
    - ç¬¬äºŒä¸ªu32ï¼šä½ç”µå¹³è§¦å‘

**å·¥ä½œåŸç†**ï¼š
- ç›®çš„å°±æ˜¯å½“è§¦æ‘¸äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒGT911ä¼šæ‹‰ä½æ­¤å¼•è„šé€šçŸ¥CPU
- å¯ä»¥çœ‹å‡ºä½¿ç”¨èµ·æ¥æ˜¯éå¸¸çš„ç®€å•ï¼Œåœ¨æˆ‘ä»¬å®é™…ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œåªéœ€è¦é€šè¿‡interrupt-parentå’Œinterruptsè¿™ä¸¤ä¸ªå±æ€§å³å¯è®¾ç½®æŸä¸ªGPIOçš„ä¸­æ–­åŠŸèƒ½

æ¢å¥è¯è¯´ï¼Œè¿™å°±åƒç»™è§¦æ‘¸å±å®‰è£…äº†ä¸€ä¸ª"é—¨é“ƒæŒ‰é’®"ï¼Œå½“æœ‰äººè§¦æ‘¸å±å¹•æ—¶ï¼Œè®¾å¤‡å°±ä¼šæŒ‰ä¸‹æŒ‰é’®ï¼ˆæ‹‰ä½GPIOï¼‰ï¼Œé€šçŸ¥ç³»ç»Ÿæœ‰è§¦æ‘¸äº‹ä»¶å‘ç”Ÿã€‚

## 6 ä¸­æ–­å±æ€§æ€»ç»“

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¸ä¸­æ–­æœ‰å…³çš„è®¾å¤‡æ ‘å±æ€§ä¿¡æ¯ï¼š

**æ ¸å¿ƒå±æ€§**ï¼š
- **#interrupt-cells**ï¼šæŒ‡å®šä¸­æ–­æºçš„ä¿¡æ¯cellsä¸ªæ•°ã€‚è¿™ä¸ªå±æ€§å®šä¹‰åœ¨ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ä¸­ï¼Œå‘Šè¯‰å…¶ä»–è®¾å¤‡åœ¨å¼•ç”¨è¿™ä¸ªæ§åˆ¶å™¨æ—¶éœ€è¦æä¾›å¤šå°‘ä¸ªå‚æ•°ã€‚
- **interrupt-controller**ï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹ä¸ºä¸­æ–­æ§åˆ¶å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªæ ‡å¿—æ€§å±æ€§ï¼Œæ²¡æœ‰å€¼ï¼Œåªè¦å­˜åœ¨å°±è¡¨ç¤ºè¯¥è®¾å¤‡å…·æœ‰ä¸­æ–­æ§åˆ¶èƒ½åŠ›
- **interrupt-parent**ï¼šæŒ‡å®šçˆ¶ä¸­æ–­ï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­æ§åˆ¶å™¨ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šï¼Œä¼šç»§æ‰¿çˆ¶èŠ‚ç‚¹çš„è®¾ç½®
- **interrupts**ï¼šæŒ‡å®šä¸­æ–­å·ï¼Œè§¦å‘æ–¹å¼ç­‰ã€‚è¿™ä¸ªå±æ€§åŒ…å«çš„å‚æ•°ä¸ªæ•°å¿…é¡»ä¸çˆ¶ä¸­æ–­æ§åˆ¶å™¨çš„#interrupt-cellså€¼åŒ¹é…ã€‚
- **interrupts-extended**ï¼šæ‰©å±•çš„ä¸­æ–­æŒ‡å®šæ–¹å¼ï¼Œå…è®¸ä¸ºæ¯ä¸ªä¸­æ–­å•ç‹¬æŒ‡å®šä¸­æ–­æ§åˆ¶å™¨ã€‚ä¸interruptså±æ€§äº’æ–¥ä½¿ç”¨ï¼Œæ ¼å¼ä¸º<ä¸­æ–­æ§åˆ¶å™¨å¼•ç”¨ ä¸­æ–­å‚æ•°>çš„ç»„åˆï¼Œæ”¯æŒè¿æ¥åˆ°å¤šä¸ªä¸åŒçš„ä¸­æ–­æ§åˆ¶å™¨ã€‚

> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> è¿™å››ä¸ªå±æ€§æ˜¯è®¾å¤‡æ ‘ä¸­æ–­é…ç½®çš„æ ¸å¿ƒï¼Œç¼ºå°‘ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½å¯¼è‡´ä¸­æ–­æ— æ³•æ­£å¸¸å·¥ä½œã€‚ç‰¹åˆ«è¦æ³¨æ„interrupt-parentå¿…é¡»æ­£ç¡®æŒ‡å‘å¯¹åº”çš„ä¸­æ–­æ§åˆ¶å™¨ã€‚

ç®€å•æ¥è¯´ï¼Œè¿™äº›å±æ€§å°±åƒæ˜¯å»ºç«‹é€šä¿¡ç½‘ç»œçš„åŸºç¡€è§„åˆ™ï¼š
- `#interrupt-cells`å®šä¹‰äº†"ç”µè¯å·ç çš„æ ¼å¼"
- `interrupt-controller`è¡¨æ˜"æˆ‘æ˜¯æ€»æœº"
- `interrupt-parent`æŒ‡æ˜"æˆ‘çš„ä¸Šçº§æ€»æœºæ˜¯è°"
- `interrupts`å°±æ˜¯"æˆ‘è¦ç”³è¯·çš„ç”µè¯å·ç "

## 7 ä¸­æ–­å·è·å–æ–¹æ³•

åœ¨ç†è§£äº†è®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­é…ç½®åï¼Œæˆ‘ä»¬éœ€è¦å­¦ä¹ å¦‚ä½•åœ¨é©±åŠ¨ç¨‹åºä¸­è·å–è¿™äº›ä¸­æ–­ä¿¡æ¯ã€‚**è·å–ä¸­æ–­å·æ˜¯ä¸­æ–­å¤„ç†çš„ç¬¬ä¸€æ­¥ï¼Œåªæœ‰æ­£ç¡®è·å–äº†ä¸­æ–­å·ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„ä¸­æ–­æ³¨å†Œå’Œå¤„ç†**ã€‚

### 7.1 ä¸­æ–­å·çš„æ¦‚å¿µå’Œé‡è¦æ€§

**ä¸­æ–­å·**æ˜¯Linuxå†…æ ¸ä¸ºæ¯ä¸ªä¸­æ–­æºï¼ˆè®¾å¤‡ï¼‰åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å½“ç¡¬ä»¶è®¾å¤‡äº§ç”Ÿä¸­æ–­æ—¶ï¼Œä¸­æ–­æ§åˆ¶å™¨ä¼šå°†ç¡¬ä»¶ä¸­æ–­ä¿¡å·è½¬æ¢ä¸ºå¯¹åº”çš„ä¸­æ–­å·ï¼Œç„¶åé€šçŸ¥CPUå¤„ç†ã€‚

> [!example]+ ç¤ºä¾‹
> 
> å°±åƒæ¯ä¸ªäººéƒ½æœ‰èº«ä»½è¯å·ä¸€æ ·ï¼Œæ¯ä¸ªèƒ½äº§ç”Ÿä¸­æ–­çš„è®¾å¤‡éƒ½æœ‰è‡ªå·±çš„ä¸­æ–­å·ã€‚æ¯”å¦‚ï¼š
> 
> - ä¸²å£å¯èƒ½æ˜¯ä¸­æ–­å·25
> - ç½‘å¡å¯èƒ½æ˜¯ä¸­æ–­å·26
> - GPIOæŒ‰é”®å¯èƒ½æ˜¯ä¸­æ–­å·27

åœ¨ç¼–å†™é©±åŠ¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
1. **æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°**ï¼šå‘Šè¯‰å†…æ ¸å½“æŸä¸ªä¸­æ–­å‘ç”Ÿæ—¶è°ƒç”¨æˆ‘ä»¬çš„å¤„ç†å‡½æ•°
2. **åŒºåˆ†ä¸åŒè®¾å¤‡**ï¼šåŒä¸€ç±»å‹çš„å¤šä¸ªè®¾å¤‡å¯èƒ½æœ‰ä¸åŒçš„ä¸­æ–­å·
3. **åŠ¨æ€é…ç½®**ï¼šä¸åŒç¡¬ä»¶å¹³å°å¯èƒ½ä½¿ç”¨ä¸åŒçš„ä¸­æ–­å·

> [!tip]+ é‡è¦æç¤º
> 
> ä¸­æ–­å·ä¸æ˜¯å›ºå®šçš„ï¼Œå®ƒå–å†³äºç¡¬ä»¶è®¾è®¡å’Œç³»ç»Ÿé…ç½®ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ç¼–ç¨‹æ–¹å¼åŠ¨æ€è·å–ï¼Œè€Œä¸èƒ½ç¡¬ç¼–ç ã€‚

### 7.2 ä¸­æ–­å·çš„æ¥æº

ç°ä»£Linuxç³»ç»Ÿä¸­ï¼Œä¸­æ–­ä¿¡æ¯ä¸»è¦æ¥è‡ªä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š

**1. è®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰**
- æè¿°ç¡¬ä»¶é…ç½®çš„æ•°æ®ç»“æ„
- åŒ…å«äº†å„ä¸ªè®¾å¤‡çš„ä¸­æ–­ä¿¡æ¯
- æ˜¯ä¸»æµçš„ç¡¬ä»¶æè¿°æ–¹æ³•
- é€šè¿‡ `interrupts` å±æ€§å®šä¹‰ä¸­æ–­èµ„æº

**2. Platformè®¾å¤‡èµ„æºï¼ˆPlatform Device Resourcesï¼‰**
- ä» `platform_device` ç»“æ„ä½“ä¸­çš„ `resource` å­—æ®µè·å–ä¸­æ–­èµ„æº
- ä½¿ç”¨ `platform_get_irq()` ç­‰APIè·å–ä¸­æ–­å·
- é€‚ç”¨äºplatformæ€»çº¿ä¸Šçš„è®¾å¤‡

**3. GPIOå­ç³»ç»Ÿ**
- æŸäº›GPIOå¼•è„šå¯ä»¥é…ç½®ä¸ºä¸­æ–­æº
- éœ€è¦å°†GPIOç¼–å·è½¬æ¢ä¸ºä¸­æ–­å·
- ä½¿ç”¨ `gpio_to_irq()` è¿›è¡Œè½¬æ¢

**4. SPIå­ç³»ç»Ÿ**
- ä»SPIè®¾å¤‡èŠ‚ç‚¹å¯¹åº”çš„ `spi_device` ç»“æ„ä½“è·å–ä¸­æ–­èµ„æº
- SPIè®¾å¤‡çš„ä¸­æ–­ä¿¡æ¯é€šå¸¸åœ¨è®¾å¤‡æ ‘ä¸­å®šä¹‰
- é€šè¿‡ `spi_device->irq` å­—æ®µè®¿é—®

**5. I2Cå­ç³»ç»Ÿ**
- ä»I2Cè®¾å¤‡èŠ‚ç‚¹å¯¹åº”çš„ `i2c_client` ç»“æ„ä½“è·å–ä¸­æ–­èµ„æº
- I2Cè®¾å¤‡çš„ä¸­æ–­ä¿¡æ¯åŒæ ·åœ¨è®¾å¤‡æ ‘ä¸­æè¿°
- é€šè¿‡ `i2c_client->irq` å­—æ®µè·å–

**6. å…¶ä»–æ€»çº¿å­ç³»ç»Ÿ**
- USBã€PCIeç­‰æ€»çº¿ä¹Ÿæœ‰å„è‡ªçš„ä¸­æ–­è·å–æœºåˆ¶
- æ¯ç§æ€»çº¿éƒ½æœ‰å¯¹åº”çš„APIæ¥è·å–ä¸­æ–­èµ„æº

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åŒçš„è®¾å¤‡ç±»å‹æœ‰ä¸åŒçš„"èº«ä»½ç™»è®°å¤„"ï¼Œæˆ‘ä»¬éœ€è¦åˆ°å¯¹åº”çš„åœ°æ–¹å»æŸ¥è¯¢è®¾å¤‡çš„ä¸­æ–­å·ä¿¡æ¯ã€‚

### 7.3 ä»è®¾å¤‡æ ‘è·å–ä¸­æ–­å·

ç¼–å†™é©±åŠ¨çš„æ—¶å€™éœ€è¦ç”¨åˆ°ä¸­æ–­å·ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„ä¸­æ–­å·å’Œä¸­æ–­ä¿¡æ¯å·²ç»å†™åˆ°äº†è®¾å¤‡æ ‘é‡Œé¢ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç›¸å…³å‡½æ•°ä»`interrupts`å±æ€§ä¸­æå–åˆ°å¯¹åº”çš„ä¸­æ–­å·ã€‚

**æ–¹æ³•ä¸€ï¼širq_of_parse_and_mapå‡½æ•°**
```c
unsigned int irq_of_parse_and_map(struct device_node *dev, int index);
```
- `dev`ï¼šæŒ‡å‘è®¾å¤‡æ ‘ä¸­çš„è®¾å¤‡èŠ‚ç‚¹
- `index`ï¼šç´¢å¼•å·ï¼Œ`interrupts`å±æ€§å¯èƒ½åŒ…å«å¤šæ¡ä¸­æ–­ä¿¡æ¯ï¼Œé€šè¿‡indexæŒ‡å®šï¼Œä»0å¼€å§‹
- **è¿”å›å€¼**ï¼š
    - æˆåŠŸï¼šå¯¹åº”çš„ä¸­æ–­å·ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰
    - å¤±è´¥ï¼šè¿”å›0

> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> è¿”å›å€¼ä¸º0è¡¨ç¤ºè·å–å¤±è´¥ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»æ£€æŸ¥è¿”å›å€¼çš„æœ‰æ•ˆæ€§ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ³¨å†Œä¸­æ–­å¤±è´¥ã€‚

**æ–¹æ³•äºŒï¼šof_irq_getå‡½æ•°ï¼ˆæ¨èï¼‰**
```c
int of_irq_get(struct device_node *dev, int index);
```
- `dev`ï¼šæŒ‡å‘è®¾å¤‡æ ‘ä¸­çš„è®¾å¤‡èŠ‚ç‚¹
- `index`ï¼šç´¢å¼•å·ï¼Œ`interrupts`å±æ€§å¯èƒ½åŒ…å«å¤šæ¡ä¸­æ–­ä¿¡æ¯ï¼Œé€šè¿‡indexæŒ‡å®šï¼Œä»0å¼€å§‹
- **è¿”å›å€¼**ï¼š
    - æˆåŠŸï¼šå¯¹åº”çš„ä¸­æ–­å·ï¼ˆæ­£æ•´æ•°ï¼‰
    - å¤±è´¥ï¼šè¿”å›è´Ÿæ•°é”™è¯¯ç ï¼ˆå¦‚-EINVALã€-ENOENTç­‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¦‚æœä½ çš„è®¾å¤‡èŠ‚ç‚¹æ—¢ä¸èƒ½è½¬æ¢ä¸º platform_deviceï¼Œå®ƒä¹Ÿä¸æ˜¯ I2C è®¾å¤‡ï¼Œä¸æ˜¯ SPIè®¾å¤‡ï¼Œé‚£ä¹ˆåœ¨é©±åŠ¨ç¨‹åºä¸­å¯ä»¥è‡ªè¡Œè°ƒç”¨ of_irq_getå‡½æ•°å»è§£æè®¾å¤‡æ ‘ï¼Œå¾—åˆ°ä¸­æ–­å·ã€‚

è®©æˆ‘ä»¬é€šè¿‡å®é™…ä¾‹å­æ¥ç†è§£å¦‚ä½•ä½¿ç”¨ï¼š
```dts
uart0: serial@12345678 {
    compatible = "example,uart";
    reg = <0x12345678 0x1000>;
    interrupts = <0 25 4>;  // ç¬¬ä¸€ä¸ªä¸­æ–­
    interrupt-parent = <&gic>;
    status = "okay";
};

gpio_keys: gpio-keys {
    compatible = "gpio-keys";
    interrupts = <0 30 4>,  // ç¬¬ä¸€ä¸ªä¸­æ–­ï¼šindex=0
                 <0 31 4>;  // ç¬¬äºŒä¸ªä¸­æ–­ï¼šindex=1
    interrupt-parent = <&gic>;
};
```

**è·å–ä¸­æ–­å·çš„ä»£ç ç¤ºä¾‹**ï¼š
```c
struct device_node *node;
unsigned int irq_num;

// æŸ¥æ‰¾è®¾å¤‡èŠ‚ç‚¹
node = of_find_node_by_name(NULL, "serial");
if(!node){
    printk("find node fail\n");
    return -ENODEV;
}

// è·å–ç¬¬ä¸€ä¸ªä¸­æ–­å·(index = 0)
irq_num = irq_of_parse_and_map(node, 0);
if(irq_num == 0){
    printk("get irq fail!\n");
    of_node_put(node);
    return -EINVAL;
}

printk("irq_num = %d\n",irq_num);
of_node_put(node);
```

è¿™æ®µä»£ç å±•ç¤ºäº†è·å–ä¸­æ–­å·çš„æ ‡å‡†æµç¨‹ï¼š
- é¦–å…ˆæ‰¾åˆ°è®¾å¤‡æ ‘èŠ‚ç‚¹
- ç„¶åè§£æå…¶ä¸­çš„ä¸­æ–­ä¿¡æ¯
- æœ€åæ£€æŸ¥è¿”å›å€¼çš„æœ‰æ•ˆæ€§
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å®Œè®¾å¤‡æ ‘èŠ‚ç‚¹åè¦è°ƒç”¨of_node_puté‡Šæ”¾å¼•ç”¨ã€‚

### 7.4 ä»Platformè®¾å¤‡è·å–ä¸­æ–­èµ„æº

ä¸€ä¸ªèŠ‚ç‚¹èƒ½è¢«è½¬æ¢ä¸º`platform_device`ï¼Œå¦‚æœå®ƒçš„è®¾å¤‡æ ‘é‡ŒæŒ‡å®šäº†ä¸­æ–­å±æ€§ï¼Œé‚£ä¹ˆå¯ä»¥ä»`platform_device`ä¸­è·å¾—"ä¸­æ–­èµ„æº"ï¼š
```c
struct resource *platform_get_resource(struct platform_device *dev,  
           unsigned int type, unsigned int num); 
```
- `type`ï¼šè·å–å“ªç±»èµ„æºï¼Ÿ IORESOURCE_MEMã€IORESOURCE_REGã€IORESOURCE_IRQç­‰
- `num`ï¼šè¿™ç±»èµ„æºä¸­çš„å“ªä¸€ä¸ªï¼Ÿ

**æ›´ç®€å•çš„æ–¹æ³•**ï¼š
```c
int platform_get_irq(struct platform_device *pdev, unsigned int num);
```
- `pdev`ï¼šplatformè®¾å¤‡æŒ‡é’ˆ
- `num`ï¼šä¸­æ–­èµ„æºçš„ç´¢å¼•å·
- **è¿”å›å€¼**ï¼šä¸­æ–­å·ï¼Œå¤±è´¥æ—¶è¿”å›è´Ÿæ•°

è¿™ç§æ–¹æ³•æ›´åŠ ç›´æ¥ï¼Œä¸“é—¨ç”¨äºè·å–platformè®¾å¤‡çš„ä¸­æ–­å·ã€‚

### 7.5 ä»GPIOè·å–ä¸­æ–­å·

**gpio_to_irq**å‡½æ•°ç”¨äºå°†GPIOå¼•è„šçš„ç¼–å·è½¬æ¢ä¸ºå¯¹åº”çš„ä¸­æ–­è¯·æ±‚å·ï¼š
```c
// linux/gpio.h
unsigned int gpio_to_irq(unsigned int gpio);
```
- `gpio`ï¼šè¦æ˜ å°„çš„GPIOå¼•è„šå·
- **è¿”å›å€¼**ï¼š
    - æˆåŠŸï¼šè¿”å›å€¼ä¸ºè¯¥GPIOå¼•è„šæ‰€å¯¹åº”çš„ä¸­æ–­å·
    - å¤±è´¥ï¼šè¿”å›å€¼ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºæ˜ å°„å¤±è´¥æˆ–æ— æ•ˆçš„GPIOå¼•è„šå·

> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> ä¸æ˜¯æ‰€æœ‰çš„GPIOéƒ½æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä½¿ç”¨å‰éœ€è¦ç¡®è®¤ç¡¬ä»¶æ˜¯å¦æ”¯æŒï¼Œå¹¶æ£€æŸ¥è¿”å›å€¼çš„æœ‰æ•ˆæ€§ã€‚

**å…¸å‹çš„GPIOä¸­æ–­é…ç½®æµç¨‹**ï¼š
```c fold
#include <linux/gpio.h>
#include <linux/interrupt.h>

static int gpio_pin = 123; //gpioç¼–å·
static int irq_num;

static int __init gpio_irq_init(void){
    int ret;

    //1. ç”³è¯·GPIO
    ret = gpio_request(gpio_pin, "my_gpio_irq");
    if(ret){
        printk("register gpio fail! ret = %d\n",ret);
        return ret;
    }

    //2. é…ç½®GPIOä¸ºè¾“å…¥æ¨¡å¼
    ret = gpio_direction_input(gpio_pin);
    if(ret){
        printk("set gpio input fail! ret = %d\n",ret);
        gpio_free(gpio_pin);
        return ret;
    }

    //3. è·å–GPIOå¯¹åº”çš„ä¸­æ–­å·
    irq_num = gpio_to_irq(gpio_pin);
    if(irq_num < 0){
        printk("è·å–GPIOä¸­æ–­å·å¤±è´¥: %d\n", irq_num);
        gpio_free(gpio_pin);
        return irq_num;
    }
    printk("GPIO %d å¯¹åº”çš„ä¸­æ–­å·: %d\n", gpio_pin, irq_num);

    //4. æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆåç»­ç« èŠ‚ä¼šå­¦ä¹ ï¼‰
    ret = request_irq(irq_num, my_irq_handler, IRQF_TRIGGER_RISING, "my_gpio_irq", NULL);

    return 0;
}

static void __exit gpio_irq_exit(void){
    if(irq_num >0){
        free_irq(irq_num,NULL);  //é‡Šæ”¾ä¸­æ–­
    }
    gpio_free(gpio_pin);  //é‡Šæ”¾gpio
}
```

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ä½¿ç”¨GPIOä¸­æ–­çš„å®Œæ•´æµç¨‹ï¼šç”³è¯·GPIOèµ„æºã€é…ç½®ä¸ºè¾“å…¥æ¨¡å¼ã€è·å–ä¸­æ–­å·ã€æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ã€‚æ¯ä¸€æ­¥éƒ½æœ‰ç›¸åº”çš„é”™è¯¯å¤„ç†ï¼Œç¡®ä¿èµ„æºçš„æ­£ç¡®ç®¡ç†ã€‚

### 7.6 ä»SPIå’ŒI2Cè·å–ä¸­æ–­èµ„æº

å¯¹äºI2Cè®¾å¤‡èŠ‚ç‚¹ï¼ŒI2Cæ€»çº¿é©±åŠ¨åœ¨å¤„ç†è®¾å¤‡æ ‘é‡Œçš„I2Cå­èŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå¤„ç†å…¶ä¸­çš„ä¸­æ–­ä¿¡æ¯ã€‚

ä¸€ä¸ªI2Cè®¾å¤‡ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª`i2c_client`ç»“æ„ä½“ï¼Œä¸­æ–­å·ä¼šä¿å­˜åœ¨i2c_clientçš„irqæˆå‘˜é‡Œï¼š

![I2Cä¸­æ–­å¤„ç†ä»£ç |500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/07/731eb46484ea31813ea018e1ba3bb63b.png)

å¯¹äºSPIè®¾å¤‡èŠ‚ç‚¹ï¼ŒSPIæ€»çº¿é©±åŠ¨åœ¨å¤„ç†è®¾å¤‡æ ‘é‡Œçš„SPIå­èŠ‚ç‚¹æ—¶ï¼Œä¹Ÿä¼šå¤„ç†å…¶ä¸­çš„ä¸­æ–­ä¿¡æ¯ã€‚ä¸€ä¸ªSPIè®¾å¤‡ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ªspi_deviceç»“æ„ä½“ï¼Œä¸­æ–­å·ä¼šä¿å­˜åœ¨spi_deviceçš„irqæˆå‘˜é‡Œï¼š

![SPIä¸­æ–­å¤„ç†ä»£ç |500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/07/4ac9e7699baef16dfaee6654e92bcdf2.png)

**ä½¿ç”¨æ–¹æ³•**ï¼š
```c
// I2Cè®¾å¤‡ä¸­æ–­è·å–
static int my_i2c_probe(struct i2c_client *client, const struct i2c_device_id *id)
{
    int irq = client->irq;
    if (irq > 0) {
        // æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
        ret = request_irq(irq, my_irq_handler, IRQF_TRIGGER_FALLING, 
                         "my_i2c_device", client);
    }
    return 0;
}

// SPIè®¾å¤‡ä¸­æ–­è·å–
static int my_spi_probe(struct spi_device *spi)
{
    int irq = spi->irq;
    if (irq > 0) {
        // æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
        ret = request_irq(irq, my_irq_handler, IRQF_TRIGGER_FALLING, 
                         "my_spi_device", spi);
    }
    return 0;
}
```

ç®€å•æ¥è¯´ï¼Œå¯¹äºè¿™äº›æ€»çº¿è®¾å¤‡ï¼Œä¸­æ–­å·å·²ç»è¢«æ€»çº¿é©±åŠ¨è‡ªåŠ¨è§£æå¥½äº†ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å³å¯ã€‚

## 8 é”™è¯¯å¤„ç†å’Œè°ƒè¯•

**è·å–ä¸­æ–­å·å¤±è´¥çš„å¤„ç†**ï¼š
```c
irq_num = irq_of_parse_and_map(node, 0);
if (irq_num == 0) {
    printk(KERN_ERR "æ— æ³•è·å–ä¸­æ–­å·ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ ‘é…ç½®\n");
    return -EINVAL;
}
```

**GPIOä¸­æ–­è·å–å¤±è´¥çš„å¤„ç†**ï¼š
```c
irq_num = gpio_to_irq(gpio_pin);
if (irq_num < 0) {
    printk(KERN_ERR "GPIO %d ä¸æ”¯æŒä¸­æ–­åŠŸèƒ½\n", gpio_pin);
    return irq_num;
}
```

**è°ƒè¯•æŠ€å·§**ï¼š
- ä½¿ç”¨`cat /proc/interrupts`æŸ¥çœ‹ç³»ç»Ÿä¸­å·²æ³¨å†Œçš„ä¸­æ–­
- æ£€æŸ¥è®¾å¤‡æ ‘ä¸­çš„`interrupts`å±æ€§é…ç½®
- ç¡®è®¤GPIOæ˜¯å¦æ”¯æŒä¸­æ–­åŠŸèƒ½
- æ£€æŸ¥ä¸­æ–­æ§åˆ¶å™¨çš„é…ç½®æ˜¯å¦æ­£ç¡®

> [!tip]+ é‡è¦æç¤º
> 
> åœ¨è°ƒè¯•ä¸­æ–­é—®é¢˜æ—¶ï¼Œ`/proc/interrupts`æ–‡ä»¶æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒæ˜¾ç¤ºäº†æ‰€æœ‰å·²æ³¨å†Œçš„ä¸­æ–­åŠå…¶ä½¿ç”¨æƒ…å†µã€‚

å½“æˆ‘ä»¬é‡åˆ°ä¸­æ–­ç›¸å…³é—®é¢˜æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ’æŸ¥ï¼š
1. **æ£€æŸ¥è®¾å¤‡æ ‘é…ç½®**ï¼šç¡®è®¤ä¸­æ–­æ§åˆ¶å™¨å¼•ç”¨ã€ä¸­æ–­å·ã€è§¦å‘æ–¹å¼ç­‰æ˜¯å¦æ­£ç¡®
2. **ç¡®è®¤ç¡¬ä»¶è¿æ¥**ï¼šç‰¹åˆ«æ˜¯GPIOä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œè¦æ£€æŸ¥å¼•è„šæ˜¯å¦æ­£ç¡®è¿æ¥
3. **æ£€æŸ¥å†…æ ¸æ—¥å¿—**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šå¸¸èƒ½å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜
4. **ä½¿ç”¨è°ƒè¯•æ¥å£**ï¼šæ¯”å¦‚/proc/interruptsã€/sys/kernel/debugç­‰æ¥æŸ¥çœ‹ä¸­æ–­çš„çŠ¶æ€

## 9 æ›´å¤šå¹³å°é…ç½®ç¤ºä¾‹

### 9.1 ARM Cortex-Aç³»åˆ—å¹³å°

**å…¸å‹çš„Cortex-A7å¹³å°é…ç½®ï¼ˆGICv2ï¼‰**ï¼š
```dts
gic: interrupt-controller@10481000 {
    compatible = "arm,cortex-a7-gic";
    #interrupt-cells = <3>;
    interrupt-controller;
    reg = <0x10481000 0x1000>,
          <0x10482000 0x2000>;
};

uart0: serial@10009000 {
    compatible = "arm,pl011", "arm,primecell";
    reg = <0x10009000 0x1000>;
    interrupts = <0 4 4>;  // SPI 4, é«˜ç”µå¹³è§¦å‘
    interrupt-parent = <&gic>;
    clocks = <&uartclk>, <&pclk>;
    clock-names = "uartclk", "apb_pclk";
};
```

**Cortex-A53å¹³å°é…ç½®ï¼ˆGICv3ï¼‰**ï¼š
```dts
gic: interrupt-controller@2f000000 {
    compatible = "arm,gic-v3";
    #interrupt-cells = <3>;
    interrupt-controller;
    reg = <0x0 0x2f000000 0 0x10000>,  // GICD
          <0x0 0x2f100000 0 0x200000>; // GICR
};

timer {
    compatible = "arm,armv8-timer";
    interrupts = <1 13 0xf08>,  // å®‰å…¨ç‰©ç†å®šæ—¶å™¨
                 <1 14 0xf08>,  // éå®‰å…¨ç‰©ç†å®šæ—¶å™¨
                 <1 11 0xf08>,  // è™šæ‹Ÿå®šæ—¶å™¨
                 <1 10 0xf08>;  // ç®¡ç†ç¨‹åºå®šæ—¶å™¨
    interrupt-parent = <&gic>;
};
```

### 9.2 ä¸åŒå‚å•†èŠ¯ç‰‡é…ç½®

**é«˜é€šå¹³å°ç¤ºä¾‹**ï¼š
```dts
intc: interrupt-controller@f9000000 {
    compatible = "qcom,msm-qgic2";
    interrupt-controller;
    #interrupt-cells = <3>;
    reg = <0xf9000000 0x1000>,
          <0xf9002000 0x1000>;
};

qup_spi1: spi@f9923000 {
    compatible = "qcom,spi-qup-v2.2.1";
    reg = <0xf9923000 0x500>;
    interrupts = <0 95 0>;
    interrupt-parent = <&intc>;
    // å…¶ä»–é…ç½®...
};
```

**è”å‘ç§‘å¹³å°ç¤ºä¾‹**ï¼š
```dts
gic: interrupt-controller@0c000000 {
    compatible = "arm,gic-400";
    #interrupt-cells = <3>;
    interrupt-controller;
    reg = <0 0x0c001000 0 0x1000>,
          <0 0x0c002000 0 0x2000>;
};

mmc0: mmc@11230000 {
    compatible = "mediatek,mt8173-mmc";
    reg = <0 0x11230000 0 0x1000>;
    interrupts = <GIC_SPI 39 IRQ_TYPE_LEVEL_LOW>;
    interrupt-parent = <&gic>;
    // å…¶ä»–é…ç½®...
};
```

### 9.3 ç‰¹æ®Šä¸­æ–­é…ç½®åœºæ™¯

**å¤šä¸­æ–­è®¾å¤‡é…ç½®**ï¼š
```dts
eth0: ethernet@1c30000 {
    compatible = "allwinner,sun8i-emac";
    reg = <0x01c30000 0x104>;
    interrupts = <GIC_SPI 82 IRQ_TYPE_LEVEL_HIGH>,  // MACä¸­æ–­
                 <GIC_SPI 83 IRQ_TYPE_LEVEL_HIGH>;  // PHYä¸­æ–­
    interrupt-names = "macirq", "phyirq";
    interrupt-parent = <&gic>;
    // å…¶ä»–é…ç½®...
};
```

**ä¸­æ–­çº§è”é…ç½®**ï¼š
```dts
gpio: gpio-controller@20200000 {
    compatible = "brcm,bcm2835-gpio";
    reg = <0x20200000 0xb4>;
    interrupts = <2 17>, <2 18>, <2 19>, <2 20>;
    interrupt-controller;
    #interrupt-cells = <2>;
    gpio-controller;
    #gpio-cells = <2>;
};

button: gpio-keys {
    compatible = "gpio-keys";
    interrupt-parent = <&gpio>;
    interrupts = <18 1>;  // GPIO18, ä¸‹é™æ²¿è§¦å‘
    // å…¶ä»–é…ç½®...
};
```

è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†ä¸åŒå¹³å°å’Œåœºæ™¯ä¸‹çš„ä¸­æ–­é…ç½®æ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å¦‚ä½•åœ¨å„ç§ç¯å¢ƒä¸­æ­£ç¡®é…ç½®è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯ã€‚

## 10 æ€»ç»“

é€šè¿‡è¿™ä¸ªç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æŒæ¡äº†Linuxä¸­æ–­é…ç½®å’Œè·å–çš„å®Œæ•´çŸ¥è¯†ï¼š

> [!abstract]+ æ‘˜è¦æˆ–æ€»ç»“
> 
> **æ ¸å¿ƒæŠ€èƒ½æŒæ¡**ï¼š
> 
> - ç†è§£äº†GICä¸­æ–­æ§åˆ¶å™¨çš„ä¿¡å·ä¼ é€’æœºåˆ¶å’Œè®¾å¤‡æ ‘é…ç½®æ–¹æ³•
> - æŒæ¡äº†è®¾å¤‡æ ‘ä¸­ä¸­æ–­ç›¸å…³å±æ€§çš„å«ä¹‰å’Œé…ç½®è§„åˆ™
> - å­¦ä¼šäº†åˆ†æå®é™…è®¾å¤‡çš„ä¸­æ–­é…ç½®ï¼ŒåŒ…æ‹¬SPIè®¾å¤‡å’ŒGPIOè®¾å¤‡
> - äº†è§£äº†ä¸­æ–­å·çš„æ¦‚å¿µå’Œåœ¨ç³»ç»Ÿä¸­çš„é‡è¦ä½œç”¨
> - æŒæ¡äº†ä»è®¾å¤‡æ ‘å’ŒGPIOä¸¤ç§é€”å¾„è·å–ä¸­æ–­å·çš„æ–¹æ³•
> - è®¤è¯†äº†ä¸åŒè·å–æ–¹æ³•çš„é€‚ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µ
> - å­¦ä¹ äº†å¤šç§å¹³å°çš„é…ç½®ç¤ºä¾‹å’Œç‰¹æ®Šåœºæ™¯å¤„ç†

**å…³é”®ç†è§£è¦ç‚¹**ï¼š
- è®¾å¤‡æ ‘æ˜¯ç¡¬ä»¶æè¿°ä¸è½¯ä»¶é©±åŠ¨çš„é‡è¦çº½å¸¦
- ä¸­æ–­é…ç½®éœ€è¦ç†è§£å±‚æ¬¡ç»“æ„å’Œä¿¡å·ä¼ é€’è·¯å¾„
- ä¸åŒç±»å‹è®¾å¤‡æœ‰ä¸åŒçš„ä¸­æ–­å·è·å–æ–¹æ³•
- æ­£ç¡®çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•å¯¹äºä¸­æ–­å¼€å‘è‡³å…³é‡è¦

è®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­é…ç½®æ˜¯ç¡¬ä»¶æè¿°ä¸è½¯ä»¶é©±åŠ¨çš„é‡è¦çº½å¸¦ã€‚æ­£ç¡®ç†è§£å’Œé…ç½®è¿™äº›ä¿¡æ¯ï¼Œæ˜¯ç¡®ä¿ä¸­æ–­é©±åŠ¨æ­£å¸¸å·¥ä½œçš„åŸºç¡€ã€‚é€šè¿‡å­¦ä¹ å„ç§å®é™…æ¡ˆä¾‹ï¼Œæˆ‘ä»¬ä¸ä»…æŒæ¡äº†ç†è®ºçŸ¥è¯†ï¼Œä¹Ÿè·å¾—äº†è§£å†³å®é™…é—®é¢˜çš„èƒ½åŠ›ã€‚

åœ¨ä¸‹ä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨è·å¾—ä¸­æ–­å·åï¼Œæ­£ç¡®åœ°æ³¨å†Œå’Œä½¿ç”¨ä¸­æ–­å¤„ç†å‡½æ•°ï¼ŒçœŸæ­£å®ç°å®Œæ•´çš„ä¸­æ–­é©±åŠ¨åŠŸèƒ½ã€‚

> [!question]+ å¸¸è§é—®é¢˜
> 
> **Q**: ä¸ºä»€ä¹ˆSPIä¸­æ–­å·åœ¨è®¾å¤‡æ ‘ä¸­è¦å‡å»32ï¼Ÿ 
> **A**: å› ä¸ºGICçš„ä¸­æ–­IDåˆ†é…ä¸­ï¼ŒID0~31è¢«SGIå’ŒPPIå ç”¨ï¼ŒSPIä¸­æ–­ä»ID32å¼€å§‹ã€‚è®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­å·æ˜¯ç›¸å¯¹äºSPIèµ·å§‹ä½ç½®çš„åç§»ï¼Œæ‰€ä»¥è¦å‡å»32ã€‚è¿™ç§è®¾è®¡è®©è®¾å¤‡æ ‘çš„é…ç½®æ›´åŠ ç›´è§‚ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒåœ¨SPIèŒƒå›´å†…çš„ç›¸å¯¹ç¼–å·ï¼Œè€Œä¸éœ€è¦è€ƒè™‘SGIå’ŒPPIå ç”¨çš„å‰32ä¸ªIDã€‚