---
æ–‡ç« æ ‡é¢˜: "[[6_Makefileæ–‡ä»¶ç¤ºä¾‹]]" 
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  ä»‹ç»Makefileæ–‡ä»¶ç¼–å†™æ–¹æ³•ï¼ŒåŒ…å«äº¤å‰ç¼–è¯‘é…ç½®ã€ä¾èµ–æ–‡ä»¶ç®¡ç†ã€ç›®å½•ç»“æ„è§„åˆ’ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶å¯¹æ¯”CMakeå·¥å…·çš„å·®å¼‚å’Œåº”ç”¨åœºæ™¯
tags:
- "Makefile"
- "äº¤å‰ç¼–è¯‘"
- "ä¾èµ–ç®¡ç†"
- "æ„å»ºå·¥å…·"
- "GCC"
- "ARM64"
- "CMake"
- "è‡ªåŠ¨åŒ–æ„å»º"
ç›¸å…³æ–‡ç« :
- "[[10_ç¨‹åºç¼–è¯‘å’Œè°ƒè¯•]]"
- "[[14_maven]]"
- "[[1_åˆè¯†Cè¯­è¨€]]"
- "[[1_æ­å»ºå¤šæ¨¡å—å·¥ç¨‹ï¼ˆSpring Initializrï¼‰]]"
- "[[1_Clionçš„ä½¿ç”¨]]"
æ–‡ç« åˆ†ç±»: "ğŸ§ Linuxç³»ç»Ÿ"
æ–‡ç« è·¯å¾„: "06-ğŸ§ Linuxç³»ç»Ÿ/04-ğŸ”Œ é©±åŠ¨å¼€å‘/00-â‡ï¸å®ç”¨æŠ€å·§/6_Makefileæ–‡ä»¶ç¤ºä¾‹.md"
æ–‡ç« éš¾åº¦: ä¸­çº§ ğŸŒ³
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­ æ ¸å¿ƒèƒ½åŠ›
åˆ›å»ºæ—¶é—´: 2025-05-13 20:13:49
ä¿®æ”¹æ—¶é—´: 2025-05-28 00:19:51
---

## 1 åº”ç”¨å¼€å‘

ç¼–å†™makefileæ–‡ä»¶ï¼Œæ˜¯é€šç”¨çš„ï¼Œä¸åšä»‹ç»ï¼Œä¸‹é¢ç»™å‡ºä»£ç 

```makefile
Target = fork_demo
ARCH ?= arm64
ifeq ($(ARCH),arm64)
	CC = aarch64-linux-gnu-gcc
else
	CC = gcc
endif

build_dir = build_$(ARCH)
src_dir =  sources
inc_dir = includes .

sources = $(foreach dir,$(src_dir),$(wildcard $(dir)/*.c))
objects = $(patsubst %.c,$(build_dir)/%.o,$(notdir $(sources)))
includes = $(foreach dir,$(inc_dir),$(wildcard $(dir)/*.h))

DEP_FILES := $(patsubst %, .%.d,$(objects))
DEP_FILES := $(wildcard $(DEP_FILES))

ifneq ($(DEP_FILES),)
include $(DEP_FILES)
endif

CFLAGS = $(patsubst %,-I%,$(inc_dir)) -MD -MF $(@D)/.$(@F).d

$(build_dir)/$(Target) : $(objects)  | create_build
	$(CC) $^ -o $@

$(build_dir)/%.o : $(src_dir)/%.c $(includes) | create_build
	$(CC) -c $(CFLAGS) $< -o $@

.PHONY:clean cleanall check create_build
clean:
	rm -rf $(build_dir)
cleanall:
	rm -rf build_x86 build_arm
check:
	@echo $(CFLAGS)
	@echo $(CURDIR)
	@echo $(src_dir)
	@echo $(sources)
	@echo $(objects)
create_build:
	@mkdir -p $(build_dir)

```

```makefile
#ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„åç§°
Target = system_demo
ARCH ?= arm64
#ç¼–è¯‘å™¨CC
#æ ¹æ®ä¼ å…¥çš„å‚æ•°ARCHï¼Œç¡®å®šä½¿ç”¨çš„ç¼–è¯‘å™¨
#é»˜è®¤ä½¿ç”¨gccç¼–è¯‘å™¨
#make ARCH=arm64 æ—¶ä½¿ç”¨ARM-GCCç¼–è¯‘å™¨
ifeq ($(ARCH), x86)
	CC = gcc
else
	CC = aarch64-linux-gnu-gcc
endif
#å­˜æ”¾ä¸­é—´æ–‡ä»¶çš„è·¯å¾„
build_dir = build_$(ARCH)
#å­˜æ”¾æºæ–‡ä»¶çš„æ–‡ä»¶å¤¹
src_dir =  sources
#å­˜æ”¾å¤´æ–‡ä»¶çš„æ–‡ä»¶å¤¹
inc_dir = includes .

#æºæ–‡ä»¶ï¼Œé€’å½’æ”¶é›†cæ–‡ä»¶
sources = $(foreach dir,$(src_dir),$(wildcard $(dir)/*.c))
#ç›®æ ‡æ–‡ä»¶ï¼ˆ*.oï¼‰ï¼Œè½¬æ¢ç›®æ ‡æ–‡ä»¶
objects = $(patsubst %.c,$(build_dir)/%.o,$(notdir $(sources)))
#å¤´æ–‡ä»¶ï¼Œæ”¶é›†æ‰€æœ‰å¤´æ–‡ä»¶
includes = $(foreach dir,$(inc_dir),$(wildcard $(dir)/*.h))

# ç›®æ ‡ä¾èµ–æ–‡ä»¶å¤„ç†æµç¨‹ï¼š
# 1. ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„.dæ–‡ä»¶è·¯å¾„ â†’ 2. è¿‡æ»¤çœŸå®å­˜åœ¨çš„æ–‡ä»¶ â†’ 3. åŒ…å«æœ‰æ•ˆä¾èµ–è§„åˆ™

# ç”Ÿæˆ.dæ–‡ä»¶è·¯å¾„ï¼ˆæ¯ä¸ª.oæ–‡ä»¶å¯¹åº”ä¸€ä¸ª.dæ–‡ä»¶ï¼‰
# ç¤ºä¾‹ï¼šbuild_ARM64/system.o â†’ .build_ARM64/system.o.d
# ä½œç”¨ï¼šä¸ºæ¯ä¸ªç›®æ ‡æ–‡ä»¶åˆ›å»ºå¯¹åº”çš„ä¾èµ–æ–‡ä»¶è·¯å¾„
DEP_FILES := $(patsubst %, .%.d,$(objects))

# è¿‡æ»¤å®é™…å­˜åœ¨çš„.dæ–‡ä»¶
# ç¤ºä¾‹ï¼šå¦‚æœ.build_ARM64/system.o.då­˜åœ¨åˆ™ä¿ç•™ï¼Œå¦åˆ™è¿‡æ»¤æ‰
# ç‰¹åˆ«è¯´æ˜ï¼šwildcardåœ¨è¿™é‡Œèµ·å®‰å…¨æ£€æŸ¥ä½œç”¨ï¼Œé¿å…åŒ…å«ä¸å­˜åœ¨çš„æ–‡ä»¶
DEP_FILES := $(wildcard $(DEP_FILES))

# æ¡ä»¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¾èµ–æ–‡ä»¶
# é¦–æ¬¡ç¼–è¯‘æ—¶DEP_FILESä¸ºç©ºï¼ˆè·³è¿‡includeï¼‰ï¼Œåç»­ç¼–è¯‘æ—¶ä¼šåŒ…å«å·²ç”Ÿæˆçš„ä¾èµ–è§„åˆ™
ifneq ($(DEP_FILES),)
# åŒ…å«ä¾èµ–æ–‡ä»¶ç›¸å½“äºæŠŠ.dæ–‡ä»¶å†…å®¹æ’å…¥åˆ°è¿™é‡Œ
# ç¤ºä¾‹ï¼š.build_ARM64/system.o.d å†…å®¹å¯èƒ½æ˜¯ï¼š
# build_ARM64/system.o: sources/system.c includes/system.h
include $(DEP_FILES)
endif

# ==============================================
# ç¼–è¯‘å‚æ•°é…ç½®ï¼ˆå…³é”®é€‰é¡¹è§£æï¼‰
# ==============================================
# ä¾èµ–ç”Ÿæˆé€‰é¡¹ï¼š
# -MD ç”Ÿæˆä¾èµ–ä¿¡æ¯
# -MF æŒ‡å®šä¾èµ–æ–‡ä»¶è¾“å‡ºè·¯å¾„
# 
# è·¯å¾„å˜é‡è¯´æ˜ï¼š
# $(@D) â†’ å½“å‰ç›®æ ‡æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼ˆå¦‚build_ARM64ï¼‰
# $(@F) â†’ å½“å‰ç›®æ ‡æ–‡ä»¶åï¼ˆå¦‚system.oï¼‰
# æœ€ç»ˆè·¯å¾„ç¤ºä¾‹ï¼šbuild_ARM64/.system.o.d
CFLAGS = $(patsubst %, -I%, $(inc_dir)) -MD -MF $(@D)/.$(@F).d

#é“¾æ¥è¿‡ç¨‹
$(build_dir)/$(Target) : $(objects)  | create_build
	$(CC) $^ -o $@

#ç¼–è¯‘å·¥ç¨‹
#ç¼–è¯‘srcæ–‡ä»¶å¤¹ä¸­çš„æºæ–‡ä»¶ï¼Œå¹¶å°†ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶æ”¾åœ¨objsæ–‡ä»¶å¤¹ä¸­
$(build_dir)/%.o : $(src_dir)/%.c $(includes) | create_build
	$(CC) -c $(CFLAGS) $< -o $@


#ä»¥ä¸‹ä¸ºä¼ªç›®æ ‡ï¼Œè°ƒç”¨æ–¹å¼ï¼šmake ä¼ªç›®æ ‡
#cleanï¼šç”¨äºClean Project
#checkï¼šç”¨äºæ£€æŸ¥æŸä¸ªå˜é‡çš„å€¼
.PHONY:clean cleanall check create_build
#æŒ‰æ¶æ„åˆ é™¤
clean:
	rm -rf $(build_dir)

#å…¨éƒ¨åˆ é™¤
cleanall:
	rm -rf build_x86 build_arm

#å‘½ä»¤å‰å¸¦"@",è¡¨ç¤ºä¸åœ¨ç»ˆç«¯ä¸Šè¾“å‡ºæ‰§è¡Œçš„å‘½ä»¤
#è¿™ä¸ªç›®æ ‡ä¸»è¦æ˜¯ç”¨æ¥è°ƒè¯•Makefileæ—¶è¾“å‡ºä¸€äº›å†…å®¹
check:
	@echo $(CFLAGS)
	@echo $(CURDIR)
	@echo $(src_dir)
	@echo $(sources)
	@echo $(objects)


#åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•createï¼Œç”¨äºå­˜æ”¾è¿‡ç¨‹æ–‡ä»¶
create_build:
	@mkdir -p $(build_dir)
```

**å…³é”®ç‚¹ï¼š** 
- dæ–‡ä»¶æ˜¯GCCç”Ÿæˆçš„ä¾èµ–è§„åˆ™æ–‡ä»¶ï¼Œè¢«MakefileåŒ…å«ä½¿ç”¨ï¼Œç”¨äºè®°å½•oæ–‡ä»¶æ‰€ä¾èµ–çš„cå’Œhæ–‡ä»¶
- ç¬¬ä¸€æ¬¡ç¼–è¯‘ä¼šç”Ÿæˆoæ–‡ä»¶å’Œdæ–‡ä»¶ï¼Œä¸ä¼šä½¿ç”¨dæ–‡ä»¶
- dæ–‡ä»¶ç”¨äºæŸ¥çœ‹cå’Œhæ–‡ä»¶ä¿®æ”¹åï¼Œé‚£å°±ä¿®æ”¹oæ–‡ä»¶
- -MD å’Œ -MFé€‰é¡¹æ˜¯ç”¨äºç”Ÿæˆdæ–‡ä»¶å’Œç¡®å®šdæ–‡ä»¶è·¯å¾„çš„

![deepseek_mermaid_20250515_819528.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/ae553acf6a1bbd1f69f9d7b678e6e643.png)

**å¦å¤–ä¸€ä¸ªå…³é”®ç‚¹**
- **Order-only ä¾èµ–**Â (`|`) ç”¨äºç¡®ä¿æ„å»ºå‰æ¡ä»¶æ»¡è¶³ï¼Œä½†é¿å…ä¸å¿…è¦çš„é‡æ–°ç¼–è¯‘
- åœ¨ç¼–è¯‘è§„åˆ™ä¸­ï¼Œ`create_build`Â çš„ä½œç”¨æ˜¯ï¼š
    1. **ä¿è¯ç›®å½•å­˜åœ¨**ï¼šç¼–è¯‘å‰åˆ›å»ºæ„å»ºç›®å½•
    2. **éš”ç¦»ç›®å½•å˜æ›´å½±å“**ï¼šç›®å½•æœ¬èº«çš„æ›´æ–°ä¸ä¼šè§¦å‘é‡æ–°ç¼–è¯‘
## 2 é©±åŠ¨å¼€å‘


## 3 å’ŒCMakeListçš„åŒºåˆ«

|æ–¹é¢|Makefile|CMakeLists.txt|
|---|---|---|
|å·¥å…·|Make å·¥å…·ï¼ˆå¦‚ GNU Makeï¼‰|CMake å·¥å…·|
|æ–‡ä»¶ç±»å‹|æ„å»ºè§„åˆ™è„šæœ¬æ–‡ä»¶|CMake é…ç½®è„šæœ¬æ–‡ä»¶|
|ä½œç”¨|æŒ‡å®šå¦‚ä½•ç¼–è¯‘ã€é“¾æ¥æºä»£ç æ–‡ä»¶ä¸ºç›®æ ‡ç¨‹åº|ç”Ÿæˆ Makefile æˆ–å…¶ä»–å·¥ç¨‹æ–‡ä»¶ï¼Œè·¨å¹³å°å’Œæ„å»ºç³»ç»Ÿçš„æŠ½è±¡|
|è¯­æ³•|å…·æœ‰ç‰¹å®šçš„ Make è¯­æ³•ï¼ŒåŸºäºè§„åˆ™å’Œä¾èµ–å…³ç³»|CMake è‡ªæœ‰ scripting è¯­è¨€ï¼Œæ›´é«˜çº§ï¼Œæ›´çµæ´»|
|å¯ç§»æ¤æ€§|ä¾èµ–äºç³»ç»Ÿçš„ Make å·¥å…·åŠå†™æ³•ï¼Œå¯èƒ½ä¸ä¾¿ç§»æ¤|æ”¯æŒç”Ÿæˆå¤šå¹³å°å¤šç§æ„å»ºç³»ç»Ÿæ–‡ä»¶ï¼Œè·¨å¹³å°æ”¯æŒå¥½|
|å¤æ‚æ€§|å¯¹å¤§å‹é¡¹ç›®ï¼ŒMakefile ç»´æŠ¤ç¹çä¸”å®¹æ˜“å‡ºé”™|èƒ½ç®¡ç†å¤§å‹å¤æ‚é¡¹ç›®ï¼Œæ”¯æŒæ¨¡å—å’Œå¤–éƒ¨åŒ…æŸ¥æ‰¾ç­‰å¤šåŠŸèƒ½|
**åº”ç”¨**

|Makefile|CMakeLists.txt|
|---|---|
|å°å‹é¡¹ç›®ï¼ŒLinux/Unix å¹³å°å¸¸è§|è·¨å¹³å°é¡¹ç›®ï¼ŒåŒ…å« Windows/macOS/Linux ç­‰å¤šå¹³å°|
|ç®€å•çš„è‡ªåŠ¨åŒ–æ„å»º|åŒ…å«å¤æ‚ä¾èµ–ç®¡ç†ï¼Œå¤§å‹é¡¹ç›®ï¼Œä¾èµ–åº“æŸ¥æ‰¾ç­‰|
|åªä½¿ç”¨ Unix Make|æ”¯æŒå¤šç§ç”Ÿæˆå™¨ï¼ˆMakeï¼ŒNinja, VS, Xcode ç­‰ï¼‰|
|ç”¨æˆ·ç›´æ¥æ§åˆ¶ç¼–è¯‘ç»†èŠ‚|é€šè¿‡æŠ½è±¡å±‚ç®€åŒ–ç®¡ç†ï¼Œæå‡çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§|
**æ€»ç»“**

|è§’åº¦|Makefile|CMakeLists.txt|
|---|---|---|
|åŠŸèƒ½å±‚çº§|ä½çº§ï¼Œå…·ä½“ç¼–è¯‘è§„åˆ™å’Œå‘½ä»¤|é«˜çº§ï¼ŒæŠ½è±¡å‡ºé¡¹ç›®å’Œå¹³å°æ— å…³çš„æ„å»ºå®šä¹‰|
|ç»´æŠ¤éš¾åº¦|å¤§é¡¹ç›®ä¸­ç»´æŠ¤ç¹çä¸”æ˜“é”™|ç®€åŒ–é…ç½®ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤|
|è·¨å¹³å°æ”¯æŒ|ä¸å¤Ÿå¥½ï¼Œå¯èƒ½éœ€è¦é’ˆå¯¹å¹³å°å†™å¤šä¸ªMakefile|ä¸€å¥—é…ç½®æ”¯æŒå¤šç§ç³»ç»Ÿå’Œæ„å»ºå·¥å…·|
|å¼€å‘æ•ˆç‡|éœ€è¦æ‰‹å†™è¯¦ç»†è§„åˆ™|çœåŠ›ï¼ŒCMakeå¯è‡ªåŠ¨å®Œæˆè¯¸å¤šé‡å¤å·¥ä½œ|