---
文章标题: "[[1_设备树的引进和体验]]"
文章作者: Dakkk
文章概要: |
  介绍Linux驱动开发的三种方法，从传统写法到总线设备驱动模型再到设备树，重点讲解如何通过不同方式指定硬件资源，强调设备树的优势
tags:
  - Linux驱动开发
  - 字符设备驱动
  - 设备树
  - platform总线
  - 驱动编程
  - 硬件资源配置
  - 内核开发
  - 嵌入式系统
相关文章:
  - "[[01_Linux系统构成简单介绍]]"
  - "[[04_补充：extboot分区解释说明]]"
  - "[[06_U-boot的修改与编译]]"
  - "[[../../../02-💾 Lubancat-RK3568/4_Linux驱动开发实战/1_Linux驱动基础知识(重点)/1_驱动章节实验环境搭建]]"
  - "[[1_单片机介绍]]"
文章分类: 🐧 Linux系统
文章路径: 06-🐧 Linux系统/04-🔌 驱动开发/01-📝 训练营笔记/_Linux之设备树详解/2_韦东山课程/1_设备树的引进和体验.md
文章难度: 中级 🌳
目前阶段: ✅ 已完成
重要性: ⭐⭐⭐⭐ 核心能力
创建时间: 2025-04-20 14:54:21
修改时间: 2025-05-28 00:19:51
---

## 1 字符设备驱动程序的三种写法

**如何写驱动程序？**
- **看原理图**
	- 确定使用的引脚
	- 看芯片（soc）手册，确定如何操作引脚（一般是设置寄存器）
- **写驱动：** 给上层应用程序标准的接口，起到封装的作用
	- 上层需要open，read，write，ioctl
	- 那么驱动就给他们这些接口：drv_open，drv_read，drv_write，drv_ioctl
		- `分配`结构体file_operations
		- `设置`成员为某个函数： .open=led_open .write=led_write
			- led_open函数配置led引脚为输出引脚
			- led_write函数根据应用程序传入的值，设置引脚状态
		- `注册`（告诉内核（有个数组）有标准的接口register_chrdev和unregister_chrdev）
			- register_chrdev(主设备号/数组的位置，结构体，name)
		- `提供`入口和出口函数，来调用接口
- **写测试程序**

**问题来了，在驱动中如何确定引脚？**
- 传统方法：代码里面写死
- 总线设备驱动模型：
	- led_drv.c：实现分配、设置、注册、入口、出口等功能
	- led_dev.c：指定引脚
- 使用`设备树`！指明引脚
	- led_drv.c：实现分配、设置、注册、入口、出口等功能
	- 设备树：xxxx.dts 指定引脚

**即驱动的写法核心不变，区别在于如何指定硬件资源**

**三种方法的优缺点：**
- 例子：两款产品都需要控制LED，一个用的是Pin1，一个用的是Pin2

- **传统方法：**
	- 代码写死，各自控制各自的Pin
	- 优点-简单，缺点-不易扩展，需要重新编译

- **总线设备驱动模型**
	- led_dev.c和led_drv.c都挂在同一个platform总线上
		- dev用于指定资源（分配、设置、注册一个platform_device），`platform_device用于指明引脚`，即对不同的产品由不同的dev.c文件来指定不同的Pin
		- drv（分配、设置、注册一个platform_driver）
	- 优点-易扩展，缺点-冗余代码太多（`通过c文件指定资源`），需要重新编译

- **设备树**
	- led_drv.c：实现分配、设置、注册、入口、出口等功能 （这里不变，同总线设备）
	- 通过dts来指定资源，dts会变成dtb文件，给内核构建platform_device，**资源更换的时候，不需要更换代码，只需要更换dtb文件即可**
	- 优点-易拓展、不需要重编内核或驱动（只要dts）、无冗余，缺点-稍复杂

![第01节_字符设备驱动程序的三种写法.jpg|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/05/ecedb27ba24667b7cdc5348f89348032.jpg)

## 2 字符设备驱动的传统写法

 
## 3 字符设备驱动的编译测试

## 4 总线设备驱动模型

## 5 使用设备树时对应的驱动编程

## 6 只想使用设备树不想深入研究的办法