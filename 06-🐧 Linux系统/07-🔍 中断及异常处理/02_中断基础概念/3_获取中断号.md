---
åˆ›å»ºæ—¶é—´: 2025-06-13 15:46:26
ä¿®æ”¹æ—¶é—´: 2025-06-13 22:53:43
---

åœ¨å‰é¢å­¦ä¹ äº†[2_å¼‚å¸¸](2_å¼‚å¸¸.md)ä¹‹åï¼Œæˆ‘ä»¬äº†è§£äº†ARM64çš„å¼‚å¸¸åˆ†ç±»å’Œå‘é‡è¡¨ã€‚ç°åœ¨æˆ‘ä»¬è¦å­¦ä¹ ä¸€ä¸ªå®é™…ç¼–ç¨‹ä¸­çš„é‡è¦é—®é¢˜ï¼š**å¦‚ä½•è·å–ä¸­æ–­å·ï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œ**ä¸­æ–­å·**å°±åƒæ˜¯æ¯ä¸ªä¸­æ–­æºçš„"èº«ä»½è¯å·ç "ï¼ŒCPUéœ€è¦é€šè¿‡è¿™ä¸ªå·ç æ¥è¯†åˆ«æ˜¯å“ªä¸ªè®¾å¤‡äº§ç”Ÿçš„ä¸­æ–­ã€‚åœ¨é©±åŠ¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆè·å–åˆ°æ­£ç¡®çš„ä¸­æ–­å·ï¼Œæ‰èƒ½æ³¨å†Œä¸­æ–­å¤„ç†ç¨‹åºã€‚

> [!note]+ é‡è¦ç¬”è®°
> 
> ä¸­æ–­å·æ˜¯è½¯ä»¶å±‚é¢çš„æ¦‚å¿µï¼Œå®ƒå°†`ç¡¬ä»¶ä¸­æ–­æº`æ˜ å°„ä¸º`è½¯ä»¶å¯ä»¥è¯†åˆ«çš„æ•°å­—æ ‡è¯†`ã€‚ä¸åŒçš„è·å–æ–¹æ³•é€‚ç”¨äºä¸åŒçš„ç¡¬ä»¶é…ç½®åœºæ™¯ã€‚

## 1 ä¸­æ–­å·çš„æ¦‚å¿µå’Œé‡è¦æ€§

### 1.1 ä»€ä¹ˆæ˜¯ä¸­æ–­å·

**ä¸­æ–­å·**æ˜¯Linuxå†…æ ¸ä¸ºæ¯ä¸ªä¸­æ–­æºï¼ˆè®¾å¤‡ï¼‰åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚å½“ç¡¬ä»¶è®¾å¤‡äº§ç”Ÿä¸­æ–­æ—¶ï¼Œä¸­æ–­æ§åˆ¶å™¨ä¼šå°†ç¡¬ä»¶ä¸­æ–­ä¿¡å·è½¬æ¢ä¸ºå¯¹åº”çš„ä¸­æ–­å·ï¼Œç„¶åé€šçŸ¥CPUå¤„ç†ã€‚

> [!example]+ ç¤ºä¾‹
> 
> å°±åƒæ¯ä¸ªäººéƒ½æœ‰èº«ä»½è¯å·ä¸€æ ·ï¼Œæ¯ä¸ªèƒ½äº§ç”Ÿä¸­æ–­çš„è®¾å¤‡éƒ½æœ‰è‡ªå·±çš„ä¸­æ–­å·ã€‚æ¯”å¦‚ï¼š
> 
> - ä¸²å£å¯èƒ½æ˜¯ä¸­æ–­å·25
> - ç½‘å¡å¯èƒ½æ˜¯ä¸­æ–­å·26
> - GPIOæŒ‰é”®å¯èƒ½æ˜¯ä¸­æ–­å·27

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è·å–ä¸­æ–­å·

åœ¨ç¼–å†™é©±åŠ¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
1. **æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°**ï¼šå‘Šè¯‰å†…æ ¸å½“æŸä¸ªä¸­æ–­å‘ç”Ÿæ—¶è°ƒç”¨æˆ‘ä»¬çš„å¤„ç†å‡½æ•°
2. **åŒºåˆ†ä¸åŒè®¾å¤‡**ï¼šåŒä¸€ç±»å‹çš„å¤šä¸ªè®¾å¤‡å¯èƒ½æœ‰ä¸åŒçš„ä¸­æ–­å·
3. **åŠ¨æ€é…ç½®**ï¼šä¸åŒç¡¬ä»¶å¹³å°å¯èƒ½ä½¿ç”¨ä¸åŒçš„ä¸­æ–­å·

> [!tip]+ é‡è¦æç¤º
> 
> ä¸­æ–­å·ä¸æ˜¯å›ºå®šçš„ï¼Œå®ƒå–å†³äºç¡¬ä»¶è®¾è®¡å’Œç³»ç»Ÿé…ç½®ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ç¼–ç¨‹æ–¹å¼åŠ¨æ€è·å–ï¼Œè€Œä¸èƒ½ç¡¬ç¼–ç ã€‚

### 1.3 ä¸­æ–­å·çš„æ¥æº

ç°ä»£Linuxç³»ç»Ÿä¸­ï¼Œä¸­æ–­ä¿¡æ¯ä¸»è¦æ¥è‡ªä¸¤ä¸ªåœ°æ–¹

**è®¾å¤‡æ ‘ï¼ˆDevice Treeï¼‰**ï¼š[15_ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘å’Œå†…æ ¸å¤„ç†è§£æ](../../09-ğŸ—ï¸%20Linuxè®¾å¤‡æ¨¡å‹ä¸è®¾å¤‡æ ‘(é‡ç‚¹)/3_è®¾å¤‡æ ‘åŸºç¡€/15_ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘å’Œå†…æ ¸å¤„ç†è§£æ.md)
- æè¿°ç¡¬ä»¶é…ç½®çš„æ•°æ®ç»“æ„
- åŒ…å«äº†å„ä¸ªè®¾å¤‡çš„ä¸­æ–­ä¿¡æ¯
- æ˜¯ä¸»æµçš„ç¡¬ä»¶æè¿°æ–¹æ³•

**GPIOå­ç³»ç»Ÿ**
- æŸäº›GPIOå¼•è„šå¯ä»¥é…ç½®ä¸ºä¸­æ–­æº
- éœ€è¦å°†GPIOç¼–å·è½¬æ¢ä¸ºä¸­æ–­å·

## 2 ä»è®¾å¤‡æ ‘è·å–ä¸­æ–­å·

### 2.1 irq_of_parse_and_mapå‡½æ•°

ç¼–å†™é©±åŠ¨çš„æ—¶å€™éœ€è¦ç”¨åˆ°ä¸­æ–­å·ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„ä¸­æ–­å·å’Œä¸­æ–­ä¿¡æ¯å·²ç»å†™åˆ°äº†è®¾å¤‡æ ‘é‡Œé¢ï¼Œå› æ­¤å¯ä»¥é€šè¿‡`irq_of_parse_and_map`å‡½æ•°ä»`interrupts`å±æ€§ä¸­æå–åˆ°å¯¹åº”çš„ä¸­æ–­å·

**å‡½æ•°åŸå‹**
```c
unsigned int irq_of_parse_and_map(struct device_node *dev, int index);
```
- `dev`ï¼šæŒ‡å‘è®¾å¤‡æ ‘ä¸­çš„è®¾å¤‡èŠ‚ç‚¹
- `index`ï¼šç´¢å¼•å·ï¼Œ`interrupts`å±æ€§å¯èƒ½åŒ…å«å¤šæ¡ä¸­æ–­ä¿¡æ¯ï¼Œé€šè¿‡indexæŒ‡å®šï¼Œä»0å¼€å§‹
- è¿”å›å€¼ï¼š
	- æˆåŠŸï¼šå¯¹åº”çš„ä¸­æ–­å·ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰
	- å¤±è´¥ï¼šè¿”å›0


> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> è¿”å›å€¼ä¸º0è¡¨ç¤ºè·å–å¤±è´¥ï¼Œåœ¨ä½¿ç”¨å‰å¿…é¡»æ£€æŸ¥è¿”å›å€¼çš„æœ‰æ•ˆæ€§ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ³¨å†Œä¸­æ–­å¤±è´¥ã€‚

### 2.2 è®¾å¤‡æ ‘ä¸­ä¸­æ–­é…ç½®ç¤ºä¾‹

```dts
uart0: serial@12345678 {
    compatible = "example,uart";
    reg = <0x12345678 0x1000>;
    interrupts = <0 25 4>;  // ç¬¬ä¸€ä¸ªä¸­æ–­
    interrupt-parent = <&gic>;
    status = "okay";
};

gpio_keys: gpio-keys {
    compatible = "gpio-keys";
    interrupts = <0 30 4>,  // ç¬¬ä¸€ä¸ªä¸­æ–­ï¼šindex=0
                 <0 31 4>;  // ç¬¬äºŒä¸ªä¸­æ–­ï¼šindex=1
    interrupt-parent = <&gic>;
};
```

**è·å–ä¸­æ–­å·çš„ä»£ç ç¤ºä¾‹ï¼š**
```c
struct device_node *node;
unsigned int irq_num;

//æŸ¥æ‰¾è®¾å¤‡èŠ‚ç‚¹
node = of_find_node_by_name(NULL, "serial");
if(!node){
	printk("find node fail\n");
	return -ENODEV;
}

//è·å–ç¬¬ä¸€ä¸ªä¸­æ–­å·(index = 0)
irq_num = irq_of_parse_and_map(node, 0);
if(irq_num == 0){
	printk("get irq fail!\n");
	of_node_put(node);
	return -EINVAL;
}

printk("irq_num = %d\n",irq_num);
of_node_put(node);
```

> [!example]+ ç¤ºä¾‹
> 
> åœ¨ä¸Šé¢çš„gpio_keysä¾‹å­ä¸­ï¼Œå¦‚æœè¦è·å–ç¬¬äºŒä¸ªæŒ‰é”®çš„ä¸­æ–­å·ï¼Œå°±éœ€è¦ä½¿ç”¨`irq_of_parse_and_map(node, 1)`ï¼Œå…¶ä¸­index=1è¡¨ç¤ºç¬¬äºŒä¸ªä¸­æ–­

## 3 ä»GPIOè·å–ä¸­æ–­å·

### 3.1 gpio_to_irqå‡½æ•°

**gpio_to_irq**å‡½æ•°ç”¨äºå°†GPIOå¼•è„šçš„ç¼–å·ï¼ˆGPIO pin numberï¼‰è½¬æ¢ä¸ºå¯¹åº”çš„ä¸­æ–­è¯·æ±‚å·ï¼ˆinterrupt request numberï¼‰

```c
// linux/gpio.h
unsigned int gpio_to_irq(unsigned int gpio);
```

**åŠŸèƒ½æè¿°**ï¼š gpio_to_irqæ˜¯ä¸€ä¸ªç”¨äºå°†GPIOå¼•è„šæ˜ å°„åˆ°å¯¹åº”ä¸­æ–­å·çš„å‡½æ•°ã€‚å…¶ä½œç”¨æ˜¯æ ¹æ®æŒ‡å®šçš„GPIOå¼•è„šå·ï¼Œè·å–ä¸ä¹‹å…³è”çš„ä¸­æ–­å·ã€‚

**å‚æ•°è¯´æ˜**ï¼š
- **gpio**ï¼šè¦æ˜ å°„çš„GPIOå¼•è„šå·

**è¿”å›å€¼**ï¼š
- æˆåŠŸï¼šè¿”å›å€¼ä¸ºè¯¥GPIOå¼•è„šæ‰€å¯¹åº”çš„ä¸­æ–­å·
- å¤±è´¥ï¼šè¿”å›å€¼ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºæ˜ å°„å¤±è´¥æˆ–æ— æ•ˆçš„GPIOå¼•è„šå·

> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> ä¸æ˜¯æ‰€æœ‰çš„GPIOéƒ½æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä½¿ç”¨å‰éœ€è¦ç¡®è®¤ç¡¬ä»¶æ˜¯å¦æ”¯æŒï¼Œå¹¶æ£€æŸ¥è¿”å›å€¼çš„æœ‰æ•ˆæ€§ã€‚


### 3.2 GPIOä¸­æ–­ä½¿ç”¨ç¤ºä¾‹

**å…¸å‹çš„GPIOä¸­æ–­é…ç½®æµç¨‹**
```c
#include <linux/gpio.h>
#include <linux/interrupt.h>

static int gpio_pin = 123; //gpioç¼–å·
static int irq_num;

static int __init gpio_irq_init(void){
	int ret;

	//1. ç”³è¯·GPIO
	ret = gpio_request(gpio_pin, "my_gpio_irq");
	if(ret){
		printk("register gpio fail! ret = %d\n",ret);
		return ret;
	}

	//2. é…ç½®GPIOä¸ºè¾“å…¥æ¨¡å¼
	ret = gpio_direction_input(gpio_pin);
	if(ret){
		printk("set gpio input fail! ret = %d\n",ret);
		gpio_free(gpio_pin);
		return ret;
	}

	//3. è·å–GPIOå¯¹åº”çš„ä¸­æ–­å·
	irq_num = gpio_to_irq(gpio_pin);
	if(irq_num < 0){
		printk("è·å–GPIOä¸­æ–­å·å¤±è´¥: %d\n", irq_num);
        gpio_free(gpio_pin);
        return irq_num;
	}
	printk("GPIO %d å¯¹åº”çš„ä¸­æ–­å·: %d\n", gpio_pin, irq_num);

	//4. æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆåç»­ç« èŠ‚ä¼šå­¦ä¹ ï¼‰
	ret = request_irq(irq_num, my_irq_handler, IRQF_TRIGGER_RISING, "my_gpio_irq", NULL);

	return 0;
}

static void __exit gpio_irq_exit(void){
	if(irq_num >0){
		free_irq(irq_num,NULL);  //é‡Šæ”¾ä¸­æ–­
	}
	gpio_free(gpio_pin);  //é‡Šæ”¾gpio
}
```

### 3.3 GPIOä¸­æ–­çš„åº”ç”¨åœºæ™¯

**æŒ‰é”®æ£€æµ‹**ï¼š
- GPIOè¿æ¥ç‰©ç†æŒ‰é”®
- æŒ‰é”®æŒ‰ä¸‹æ—¶äº§ç”Ÿä¸­æ–­
- é¿å…è½®è¯¢æ£€æµ‹ï¼ŒèŠ‚çœCPUèµ„æº

**å¤–éƒ¨äº‹ä»¶æ£€æµ‹**ï¼š
- ä¼ æ„Ÿå™¨æ•°æ®å‡†å¤‡å°±ç»ªä¿¡å·
- å¤–éƒ¨è®¾å¤‡çŠ¶æ€å˜åŒ–é€šçŸ¥
- å®æ—¶å“åº”å¤–éƒ¨å˜åŒ–

> [!example]+ ç¤ºä¾‹
> 
> åœ¨æ™ºèƒ½å®¶å±…ç³»ç»Ÿä¸­ï¼Œé—¨ç£ä¼ æ„Ÿå™¨è¿æ¥åˆ°GPIOï¼Œå½“é—¨å¼€å…³æ—¶äº§ç”Ÿä¸­æ–­ï¼Œç³»ç»Ÿç«‹å³å“åº”å¹¶è®°å½•äº‹ä»¶ï¼Œæ¯”è½®è¯¢æ–¹å¼æ›´åŠæ—¶ã€æ›´çœç”µã€‚

## 4 å®é™…åº”ç”¨å’Œæœ€ä½³å®è·µ

### 4.1 é€‰æ‹©åˆé€‚çš„è·å–æ–¹æ³•

**ä½¿ç”¨irq_of_parse_and_mapçš„åœºæ™¯**ï¼š
- ä¸­æ–­ä¿¡æ¯å·²åœ¨è®¾å¤‡æ ‘ä¸­å®šä¹‰
- éœ€è¦è·å–å¤æ‚è®¾å¤‡çš„å¤šä¸ªä¸­æ–­
- éµå¾ªè®¾å¤‡æ ‘æ ‡å‡†çš„é©±åŠ¨å¼€å‘

**ä½¿ç”¨gpio_to_irqçš„åœºæ™¯**ï¼š
- ç®€å•çš„GPIOä¸­æ–­åº”ç”¨
- åŠ¨æ€é…ç½®GPIOä¸ºä¸­æ–­æº
- éœ€è¦çµæ´»æ§åˆ¶GPIOåŠŸèƒ½

> [!warning]+ è­¦å‘Šæˆ–æ³¨æ„
> 
> è¿™ä¸¤ç§æ–¹æ³•ä¸èƒ½æ··ç”¨ã€‚å¦‚æœè®¾å¤‡æ ‘ä¸­å·²ç»å®šä¹‰äº†GPIOä¸­æ–­ï¼Œåº”è¯¥ä½¿ç”¨`irq_of_parse_and_map`ï¼›å¦‚æœæ˜¯çº¯GPIOæ“ä½œï¼Œåˆ™ä½¿ç”¨`gpio_to_irq`ã€‚

### 4.2 é”™è¯¯å¤„ç†å’Œè°ƒè¯•

**è·å–ä¸­æ–­å·å¤±è´¥**ï¼š
```c
irq_num = irq_of_parse_and_map(node, 0);
if (irq_num == 0) {
    printk(KERN_ERR "æ— æ³•è·å–ä¸­æ–­å·ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ ‘é…ç½®\n");
    return -EINVAL;
}
```

**GPIOä¸­æ–­è·å–å¤±è´¥**ï¼š
```c
irq_num = gpio_to_irq(gpio_pin);
if (irq_num < 0) {
    printk(KERN_ERR "GPIO %d ä¸æ”¯æŒä¸­æ–­åŠŸèƒ½\n", gpio_pin);
    return irq_num;
}
```

**è°ƒè¯•æŠ€å·§**ï¼š
- ä½¿ç”¨`cat /proc/interrupts`æŸ¥çœ‹ç³»ç»Ÿä¸­å·²æ³¨å†Œçš„ä¸­æ–­
- æ£€æŸ¥è®¾å¤‡æ ‘ä¸­çš„`interrupts`å±æ€§é…ç½®
- ç¡®è®¤GPIOæ˜¯å¦æ”¯æŒä¸­æ–­åŠŸèƒ½

> [!tip]+ é‡è¦æç¤º
> 
> åœ¨è°ƒè¯•ä¸­æ–­é—®é¢˜æ—¶ï¼Œ`/proc/interrupts`æ–‡ä»¶æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒæ˜¾ç¤ºäº†æ‰€æœ‰å·²æ³¨å†Œçš„ä¸­æ–­åŠå…¶ä½¿ç”¨æƒ…å†µã€‚

## 5 æ€»ç»“

é€šè¿‡è¿™ä¸ªç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æŒæ¡äº†è·å–ä¸­æ–­å·çš„ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼š

> [!abstract]+ æ‘˜è¦æˆ–æ€»ç»“
> 
> **æ ¸å¿ƒæŠ€èƒ½æŒæ¡**ï¼š
> 
> - ç†è§£äº†ä¸­æ–­å·åœ¨é©±åŠ¨å¼€å‘ä¸­çš„é‡è¦ä½œç”¨
> - æŒæ¡äº†ä»è®¾å¤‡æ ‘è·å–ä¸­æ–­å·çš„æ–¹æ³•å’Œå‚æ•°é…ç½®
> - å­¦ä¼šäº†å°†GPIOç¼–å·è½¬æ¢ä¸ºä¸­æ–­å·çš„æŠ€æœ¯
> - äº†è§£äº†ä¸¤ç§æ–¹æ³•çš„é€‚ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µ

è·å–ä¸­æ–­å·æ˜¯ä¸­æ–­é©±åŠ¨å¼€å‘çš„ç¬¬ä¸€æ­¥ï¼Œåªæœ‰æ­£ç¡®è·å–äº†ä¸­æ–­å·ï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„ä¸­æ–­æ³¨å†Œå’Œå¤„ç†ã€‚åœ¨ä¸‹ä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸­æ–­æ§åˆ¶å™¨çš„å·¥ä½œåŸç†ï¼Œæ·±å…¥ç†è§£ç¡¬ä»¶æ˜¯å¦‚ä½•ç®¡ç†è¿™äº›ä¸­æ–­å·çš„ã€‚

> [!question]+ å¸¸è§é—®é¢˜
> 
> **Q**: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™GPIOè½¬ä¸­æ–­å·ä¼šå¤±è´¥ï¼Ÿ 
> **A**: ä¸»è¦åŸå› æ˜¯è¯¥GPIOä¸æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œæˆ–è€…å·²ç»è¢«å…¶ä»–é©±åŠ¨å ç”¨ã€‚éœ€è¦æ£€æŸ¥ç¡¬ä»¶è®¾è®¡å’Œé©±åŠ¨é…ç½®ã€‚

