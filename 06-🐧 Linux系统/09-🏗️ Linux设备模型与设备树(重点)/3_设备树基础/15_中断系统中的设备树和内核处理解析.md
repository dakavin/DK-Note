
åœ¨Linuxå†…æ ¸å¼€å‘ä¸­ï¼Œ**ä¸­æ–­ç³»ç»Ÿ** æ˜¯ç¡¬ä»¶ä¸è½¯ä»¶äº¤äº’çš„é‡è¦æ¡¥æ¢ï¼Œè€Œ **è®¾å¤‡æ ‘** åˆ™æ˜¯æè¿°ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯çš„æ ‡å‡†åŒ–æ–¹å¼ã€‚æœ¬æ–‡å°†æ·±å…¥ä»‹ç»å¦‚ä½•åœ¨è®¾å¤‡æ ‘ä¸­æè¿°ä¸­æ–­ä¿¡æ¯ï¼Œä»¥åŠå†…æ ¸å¦‚ä½•å¤„ç†è¿™äº›ä¿¡æ¯çš„å®Œæ•´æµç¨‹ã€‚

> [!info]+ ä¸­æ–­ç›¸å…³å‰ç½®çŸ¥è¯†
> - [1_ä¸­æ–­æ¦‚å¿µçš„å¼•å…¥ä¸å¤„ç†æµç¨‹](../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/1_ä¸­æ–­æ¦‚å¿µçš„å¼•å…¥ä¸å¤„ç†æµç¨‹.md)
> - [2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°](../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°.md)
> - [3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain](../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain.md)

## 1 è®¾å¤‡æ ‘ä¸­æ–­ç³»ç»Ÿæ¦‚è¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** åœ¨ç°ä»£Linuxå†…æ ¸ä¸­ï¼Œä¸­æ–­ç³»ç»Ÿé‡‡ç”¨äº† **irq_domain** æœºåˆ¶ï¼Œå°†ç¡¬ä»¶ä¸­æ–­å·ï¼ˆhwirqï¼‰æ˜ å°„ä¸ºè™šæ‹Ÿä¸­æ–­å·ï¼ˆvirqï¼‰ã€‚è®¾å¤‡æ ‘æ­£æ˜¯æè¿°è¿™ç§æ˜ å°„å…³ç³»çš„é‡è¦è½½ä½“ã€‚

**å·¥ä½œåŸç†ï¼š**
- **ç¡¬ä»¶å±‚é¢ï¼š** ä¸­æ–­æ§åˆ¶å™¨ç®¡ç†å„ç§ä¸­æ–­æº
- **è½¯ä»¶å±‚é¢ï¼š** è®¾å¤‡æ ‘æè¿°ä¸­æ–­ä¿¡æ¯ï¼Œå†…æ ¸è§£æå¹¶å»ºç«‹æ˜ å°„å…³ç³»
- **é©±åŠ¨å±‚é¢ï¼š** é©±åŠ¨ç¨‹åºé€šè¿‡OFå‡½æ•°è·å–ä¸­æ–­å·å¹¶æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°

## 2 S3C2440ä¸­æ–­ç³»ç»Ÿåœ¨è®¾å¤‡æ ‘ä¸­çš„åº”ç”¨

### 2.1 ä¸­æ–­ä½¿ç”¨æ–¹å¼çš„å˜åŒ–å¯¹æ¯”

è®©æˆ‘ä»¬é€šè¿‡å®é™…ä¾‹å­æ¥ç†è§£è®¾å¤‡æ ‘å¯¹ä¸­æ–­ç³»ç»Ÿçš„æ”¹è¿›ï¼š

> [!example]+ æ–°æ—§å†…æ ¸ä¸­æ–­ä¿¡æ¯å¯¹æ¯” 
> **è€å†…æ ¸ä¸­æ–­ä¿¡æ¯ï¼š**
> 
> ```shell
> / # cat /proc/interrupts
>            CPU0
>  29:      17593       s3c  13 Edge      samsung_time_irq
>  42:          0       s3c  26 Edge      ohci_hcd:usb1
>  43:          0       s3c  27 Edge      s3c2440-i2c.0
>  74:         86  s3c-level   0 Edge      s3c2440-uart
>  75:        561  s3c-level   1 Edge      s3c2440-uart
>  83:          0  s3c-level   9 Edge      ts_pen
>  84:          0  s3c-level  10 Edge      adc
>  87:          0  s3c-level  13 Edge      s3c2410-wdt
> ```
> 
> **æ–°å†…æ ¸ä¸­æ–­ä¿¡æ¯ï¼š**
> 
> ```shell
> / # cat /proc/interrupts
>            CPU0
>   8:          0       s3c   8 Edge      s3c2410-rtc tick
>  13:        936       s3c  13 Edge      samsung_time_irq
>  30:          0       s3c  30 Edge      s3c2410-rtc alarm
>  32:         15  s3c-level  32 Level     50000000.serial
>  33:         60  s3c-level  33 Level     50000000.serial
>  59:          0  s3c-level  59 Edge      53000000.watchdog
> ```

**å…³é”®å˜åŒ–ï¼š** å¯ä»¥çœ‹åˆ°`è™šæ‹Ÿä¸­æ–­å·ï¼ˆvirqï¼‰å‘ç”Ÿäº†å˜åŒ–`ï¼Œæˆ‘ä»¬ä¸èƒ½å†åƒä»¥å‰é‚£æ ·äº‹å…ˆç¡®å®šç¡¬ä»¶ä¸­æ–­çš„ä¸­æ–­å·ã€‚ç°åœ¨åªèƒ½åœ¨è®¾å¤‡æ ‘é‡Œæè¿°è®¾å¤‡ä½¿ç”¨äº†å“ªä¸ªç¡¬ä»¶ä¸­æ–­å·ã€‚

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/21118650c2fd38af0c9bf83bad4ebd16.png)

### 2.2 è®¾å¤‡æ ‘ä¸­æ–­æè¿°çš„æ ¸å¿ƒæœºåˆ¶

**ç¡¬ä»¶æ¶æ„ç†è§£ï¼š** å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒCPUè¿æ¥æ€»çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œä¸‹é¢æœ‰å­ä¸­æ–­æ§åˆ¶å™¨å’ŒGPIOæ§åˆ¶å™¨ï¼ˆè½¯ä»¶å±‚é¢é…ç½®æˆä¸­æ–­æ§åˆ¶å™¨ï¼‰ï¼š

![image.png|300](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/caaa4ed7c15fc4414a1a2a48e4afcabd.png)

**æè¿°åŸåˆ™ï¼š** åŒä¸€ä¸ªæ•°å­—ï¼ˆå¦‚0ï¼‰åœ¨ä¸åŒçš„æ§åˆ¶å™¨ä¸­ä»£è¡¨ä¸åŒçš„ä¸­æ–­ï¼Œå› æ­¤æè¿°ä¸€ä¸ªä¸­æ–­éœ€è¦æ˜ç¡®ï¼š
- **å“ªä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨**
- **è¯¥æ§åˆ¶å™¨ä¸­çš„å“ªä¸€ä¸ªä¸­æ–­ï¼ˆhwirqï¼‰**

> [!tip]+ è®¾å¤‡æ ‘ä¸­æ–­æè¿°æ ¼å¼ 
> **è®¾å¤‡ç«¯éœ€è¦çš„å±æ€§ï¼š**
> 
> - `interrupts`ï¼šè¡¨ç¤ºè¦ä½¿ç”¨å“ªä¸€ä¸ªä¸­æ–­ï¼Œä¸­æ–­çš„è§¦å‘ç±»å‹ç­‰
> - `interrupt-parent`ï¼šæŒ‡å®šçˆ¶ä¸­æ–­æ§åˆ¶å™¨æ˜¯è°
> 
> **ä¸­æ–­æ§åˆ¶å™¨ç«¯éœ€è¦çš„å±æ€§ï¼š**
> 
> - `interrupt-controller;`ï¼šå£°æ˜è‡ªå·±æ˜¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨
> - `#interrupt-cells`ï¼šæŒ‡å®šå­è®¾å¤‡ç”¨å‡ ä¸ªu32æ•°æ®æ¥æè¿°ä¸­æ–­

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**
```dts
ethernet@20000000 {
    compatible = "davicom,dm9000";
    reg = <0x20000000 0x2 0x20000004 0x2>;
    interrupt-parent = <&gpf>;
    interrupts = <7 IRQ_TYPE_EDGE_RISING>;
    local-mac-address = [00 00 de ad be ef];
    davicom,no-eeprom;
};
```
- æŒ‡å‘gpfè¿™ä¸ªä¸­æ–­æ§åˆ¶å™¨
- ä½¿ç”¨gpfä¸­æ–­æ§åˆ¶å™¨çš„ç¬¬7å·ä¸­æ–­
- ä¸­æ–­è§¦å‘æ–¹å¼æ˜¯ä¸Šå‡æ²¿è§¦å‘ï¼ˆIRQ_TYPE_EDGE_RISINGï¼‰

## 3 æŒ‰é”®ä¸­æ–­çš„è®¾å¤‡æ ‘å®ç°æ¡ˆä¾‹

### 3.1 ç¡¬ä»¶è¿æ¥åˆ†æ

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7339e6bbd182d7dd618881c100898a17.png)
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/0d9746f186ddcd30cc8572032ffc1926.png)

**ç¡¬ä»¶é…ç½®ï¼š** å¼€å‘æ¿ä¸Šæœ‰4ä¸ªæŒ‰é”®ï¼Œåˆ†åˆ«è¿æ¥åˆ°ä¸åŒçš„GPIOå¼•è„šï¼Œæ¯ä¸ªæŒ‰é”®éƒ½å¯ä»¥äº§ç”Ÿä¸­æ–­ä¿¡å·ã€‚

### 3.2 è®¾å¤‡æ ‘èŠ‚ç‚¹å®šä¹‰

```dts
buttons {
    compatible = "jz2440_button";
    eint-pins = <&gpf 0 0>, <&gpf 2 0>, <&gpf 3 0>, <&gpf 11 0>;
    interrupts-extended = <&intc 0 0 0 3>,
                          <&intc 0 0 2 3>,
                          <&gpg 3 3>,
                          <&gpg 11 3>;
};
```

> [!info]+ interrupts-extendedå±æ€§è¯´æ˜ 
> **ä¸­æ–­æ‹“å±•å±æ€§ï¼Œå¯ä»¥å†™å¤šä¸ªinterrupts**
> 
> **intcä¸­æ–­æ§åˆ¶å™¨çš„å‚æ•°æ ¼å¼ï¼š**
> - å‚è€ƒæ–‡æ¡£ï¼š`å†…æ ¸æºç /Documentation/devicetree/bindings/interrupt-controller/samsung,s3c24xx-irq.txt`
> - `ctrl_num`ï¼šä¸­æ–­ä¿¡å·å‘é€ç»™ä¸»/å­ï¼Œ0è¡¨ç¤ºä¸»æ§åˆ¶å™¨ï¼Œ1è¡¨ç¤ºå­æ§åˆ¶å™¨
> - `parent_irq`ï¼šå­å‘ç»™ä¸»ï¼Œè¿™é‡Œç›´æ¥è¿æ¥ä¸»æ§åˆ¶å™¨ï¼Œæ‰€ä»¥å†™0
> - `ctrl_irq`ï¼šè¡¨ç¤ºä½¿ç”¨ä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸€ä¸ªä¸­æ–­ï¼Œåˆ†åˆ«å†™0å’Œ2
> - `type`ï¼šä¸­æ–­çš„è§¦å‘æ–¹å¼ï¼Œè¿™é‡Œé€‰æ‹©3è¡¨ç¤ºä¸Šå‡æ²¿å’Œä¸‹é™æ²¿å…±åŒè§¦å‘
> 
> **gpgä¸­æ–­æ§åˆ¶å™¨çš„å‚æ•°æ ¼å¼ï¼š**
> - å‚è€ƒæ–‡æ¡£ï¼š`å†…æ ¸æºç /Documentation/devicetree/bindings/pinctrl/samsung-pinctrl.txt`
> - ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºgpgä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸ªä¸­æ–­ï¼Œåˆ†åˆ«å†™3å’Œ11
> - ç¬¬äºŒä¸ªå€¼ä»£è¡¨ä¸­æ–­çš„è§¦å‘ç±»å‹ï¼ŒåŒæ ·é€‰æ‹©3

### 3.3 é©±åŠ¨ç¨‹åºå®ç°

**1. å®šä¹‰è®¾å¤‡åŒ¹é…è¡¨ï¼š**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/14c14650dda83952fda373d25e12a029.png)

**2. probeå‡½æ•°ä¸­è·å–ä¸­æ–­èµ„æºï¼š**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/856b58fd086374c98c6beb4c3658186a.png)

**å®ç°è¦ç‚¹ï¼š**
- ä»pdevçš„resourceä¸­è·å–ä¸­æ–­èµ„æºï¼Œå°†ä¸­æ–­ä¿¡æ¯ä¿å­˜åœ¨è‡ªå®šä¹‰ç»“æ„ä½“`pins_desc`ä¸­
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/aab885a70b4ee457cc5ccbd1488a2aeb.png)
- åœ¨of_get_named_gpioä¸­æŒ‡å®šä¸­æ–­çš„å¼•è„šï¼ˆæš‚æ—¶ä¸æ˜¯é‡ç‚¹ï¼‰
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/24f75a408e8ce13ae5c707727c22bbdb.png)

## 4 OFå‡½æ•°è·å–ä¸­æ–­èµ„æºè¯¦è§£

å…³äºåŸºç¡€OFå‡½æ•°çš„æ¦‚å¿µå’Œä½¿ç”¨ï¼Œè¯·å‚è€ƒ[13_OFå‡½æ•°è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹å’Œæºç ç®€æ](13_OFå‡½æ•°è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹å’Œæºç ç®€æ.md) å’Œ [14_OFå‡½æ•°è·å–èŠ‚ç‚¹å±æ€§](14_OFå‡½æ•°è·å–èŠ‚ç‚¹å±æ€§.md)ã€‚

è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»ä¸­æ–­ç›¸å…³çš„OFå‡½æ•°ã€‚

### 4.1 irq_of_parse_and_map å‡½æ•°

```c
// arch/sparc/kernel/of_device_common.c
// linux/of_irq.h
unsigned int irq_of_parse_and_map(struct device_node *node, int index){
	struct platform_device *op = of_finde_device_by_node(node);
	if(!op || index >= op->archdata.num_irqs)
		return 0;
	return op->archdata.irqs[index];
}
EXPORT_SYSBOL(irq_of_parse_and_map);
```
- **node**ï¼šè¦è§£æä¸­æ–­ä¿¡æ¯çš„è®¾å¤‡èŠ‚ç‚¹
- **index**ï¼šè¦è·å–çš„ä¸­æ–­å·åœ¨è®¾å¤‡èŠ‚ç‚¹ä¸­ï¼Œä¸­æ–­æ•°ç»„çš„ä½ç½®
- **è¿”å›å€¼**ï¼š
	- æˆåŠŸï¼šè¿”å›å¯¹åº”çš„ä¸­æ–­å·
	- å¤±è´¥ï¼šè¿”å›0

**åŠŸèƒ½è¯´æ˜ï¼š** è¯¥å‡½æ•°æ˜¯è·å–è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯çš„æ ¸å¿ƒå‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è§£æè®¾å¤‡èŠ‚ç‚¹çš„"interrupts"å±æ€§ï¼Œå¹¶å°†å¯¹åº”çš„ä¸­æ–­å·æ˜ å°„åˆ°ç³»ç»Ÿçš„ä¸­æ–­å·ã€‚

**å·¥ä½œåŸç†ï¼š**
- "interrupts"å±æ€§é€šå¸¸ä»¥ç‰¹å®šæ ¼å¼è¡¨ç¤ºï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­å·
- é€šè¿‡æä¾›ç´¢å¼•å·ï¼Œå¯ä»¥è·å–å¯¹åº”çš„ä¸­æ–­å·
- å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨irq_domainç›¸å…³æœºåˆ¶è¿›è¡Œç¡¬ä»¶ä¸­æ–­å·åˆ°è™šæ‹Ÿä¸­æ–­å·çš„æ˜ å°„

### 4.2 ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/d214db99ad8e7b37f08af07f00020a13.png)

> [!note]+ postcore_initcallæœºåˆ¶ 
> `postcore_initcall` æ˜¯Linuxå†…æ ¸ä¸­çš„åˆå§‹åŒ–æœºåˆ¶ï¼Œåœ¨å†…æ ¸å¯åŠ¨çš„æ—©æœŸé˜¶æ®µæ‰§è¡Œã€‚è¿™äº›åˆå§‹åŒ–å‡½æ•°æŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿ç³»ç»Ÿå„ä¸ªéƒ¨åˆ†èƒ½å¤Ÿæ­£ç¡®åœ°åˆå§‹åŒ–å’Œäº¤äº’ã€‚

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/b3a749a65614147093348a234af2aee4.png)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/bd809a89a679ca8474b155b1c8289627.png)

### 4.3 irq_get_trigger_type å‡½æ•°

```c
// linux/irq.h
u32 irqd_get_trigger_type(struct irq_data *d);
```
- **d**ï¼šä¸­æ–­æ•°æ®ç»“æ„ï¼ˆirq_dataï¼‰ï¼Œè¡¨ç¤ºè¦è·å–ä¸­æ–­è§¦å‘ç±»å‹çš„ä¸­æ–­
- **è¿”å›å€¼**ï¼šæ— ç¬¦å·32ä½æ•´å‹ï¼Œè¡¨ç¤ºæˆåŠŸè·å–çš„ä¸­æ–­è§¦å‘ç±»å‹

**åŠŸèƒ½è¯´æ˜ï¼š** è¯¥å‡½æ•°ä¸»è¦åŠŸèƒ½æ˜¯ä»ç»™å®šçš„ä¸­æ–­æ•°æ®ç»“æ„ä¸­æå–ä¸­æ–­è§¦å‘ç±»å‹ã€‚

**è§¦å‘ç±»å‹åˆ†ç±»ï¼š**
- **è¾¹æ²¿è§¦å‘ï¼ˆedge-triggeredï¼‰**ï¼šåœ¨ä¿¡å·è¾¹æ²¿å˜åŒ–æ—¶è§¦å‘
- **ç”µå¹³è§¦å‘ï¼ˆlevel-triggeredï¼‰**ï¼šåœ¨ç‰¹å®šç”µå¹³çŠ¶æ€æ—¶æŒç»­è§¦å‘

### 4.4 å®é™…ä»£ç åº”ç”¨æ¡ˆä¾‹

**è®¾å¤‡æ ‘ç¤ºä¾‹**
```d
fiq-debugger {
	compatible = "rockchip,fiq-debugger";
	rockchip,serial-id = <2>;
	rockchip,wake-irq = <0>;
	/* If enable uart uses irq instead of fiq */
	rockchip,irq-mode-enable = <1>;
	rockchip,baudrate = <1500000>;  /* Only 115200 and 1500000 */
	interrupts = <GIC_SPI 252 IRQ_TYPE_LEVEL_LOW>;
	pinctrl-names = "default";
	pinctrl-0 = <&uart2m0_xfer>;
	status = "okay";
};
```

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/80143e9986e140fc863592e29a51f684.png)

**1ã€ä¸­æ–­èµ„æºçš„è·å–**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/be0ca8065c71468eb92d55e13cb7c483.png)

**2ã€ä¸­æ–­çš„ä½¿ç”¨**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/6adb811b28bfc1479814f9988b265a11.png)

> [!tip]+ å®é™…å¼€å‘å»ºè®® 
> åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå»ºè®®ä½¿ç”¨å¹³å°æ— å…³çš„OFå‡½æ•°æ¥è·å–ä¸­æ–­èµ„æºï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ä»£ç åœ¨ä¸åŒå¹³å°ä¸Šçš„å¯ç§»æ¤æ€§

## 5 å†…æ ¸å¯¹è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯çš„å¤„ç†è¿‡ç¨‹

### 5.1 æ•´ä½“æ¶æ„åˆ†æ

**åŒé‡ç»´åº¦ç†è§£ï¼š**

> [!abstract]+ ç³»ç»Ÿæ¶æ„ 
> **ç¡¬ä»¶ç»“æ„å±‚é¢ï¼ˆä¸Šä¸‹ä¸¤å±‚ï¼‰ï¼š**
> 
> - **ä¸­æ–­æ§åˆ¶å™¨å±‚**ï¼šè´Ÿè´£ç®¡ç†å’Œåˆ†å‘ä¸­æ–­
> - **ä½¿ç”¨ä¸­æ–­çš„è®¾å¤‡å±‚**ï¼šå…·ä½“çš„å¤–è®¾è®¾å¤‡
> 
> **è½¯ä»¶ç»“æ„å±‚é¢ï¼ˆå·¦å³ä¸¤éƒ¨åˆ†ï¼‰ï¼š**
> 
> - **è®¾å¤‡æ ‘æè¿°**ï¼šåœ¨è®¾å¤‡æ ‘ä¸­æè¿°ä¸­æ–­ä¿¡æ¯
> - **é©±åŠ¨å¤„ç†**ï¼šåœ¨é©±åŠ¨ç¨‹åºä¸­å¤„ç†è®¾å¤‡æ ‘ä¿¡æ¯

### 5.2 IRQ Domainæ ¸å¿ƒæœºåˆ¶

**irq_domainæ˜¯æ•´ä¸ªä¸­æ–­å¤„ç†çš„æ ¸å¿ƒï¼š**

1. **æ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨éƒ½æœ‰ä¸€ä¸ªirq_domain**
2. **å¯¹è®¾å¤‡ä¸­æ–­ä¿¡æ¯çš„è§£æè¿‡ç¨‹ï¼š**
    - è°ƒç”¨ `irq_domain->ops->xlate`è§£æè®¾å¤‡æ ‘ï¼Œè·å¾—hwirqå’Œtype
    - è·å–`irq_desc`æ•°ç»„ä¸­æœªä½¿ç”¨çš„virqï¼Œä¿å­˜æ˜ å°„å…³ç³»`irq_domain->linear_revmap[hwirq] = virq`
    - åœ¨hwirqå’Œvirqä¹‹é—´å»ºç«‹è”ç³»

> [!warning]+ é‡è¦æœºåˆ¶ **æ˜ å°„å…³ç³»å»ºç«‹ï¼š**
> 
> - è°ƒç”¨ `irq_domain->ops->map`ï¼Œæ ¹æ®hwirqå±æ€§è®¾ç½®virqçš„ä¸­æ–­å¤„ç†å‡½æ•°
> - è®¾ç½®`irq_desc[virq].handle_irq = å¸¸è§„å¤„ç†å‡½æ•°`
> - å¦‚æœhwirqæœ‰ä¸Šä¸€çº§ä¸­æ–­ï¼Œè¿˜è¦è®¾ç½®åˆ†å‘å‡½æ•°æ¥å¤„ç†ä¸­æ–­é“¾

### 5.3 S3C2440è®¾å¤‡æ ‘ä¸­æ–­å¤„ç†è°ƒç”¨å…³ç³»

**æ•´ä½“å¤„ç†é“¾è·¯ï¼š**

```txt
è®¾å¤‡æ ‘æè¿° â†’ ä¸­æ–­æ§åˆ¶å™¨åˆå§‹åŒ– â†’ irq_domainåˆ›å»º â†’ è®¾å¤‡èŠ‚ç‚¹è§£æ â†’ platform_deviceç”Ÿæˆ â†’ é©±åŠ¨ç¨‹åºä½¿ç”¨
```

#### 5.3.1 ç³»ç»Ÿå¯åŠ¨æ—¶çš„ä¸­æ–­åˆå§‹åŒ–

**1. å†…æ ¸å¯åŠ¨å…¥å£ï¼š**
```c
start_kernel // init/main.c
    init_IRQ();
        if(IS_ENABLED(CONFIG_OF) && !machine_desc->init_irq)
            irqchip_init();  // ä¸€èˆ¬ä½¿ç”¨å®ƒ
        else
            machine_desc->init_irq();
```

**2. è®¾å¤‡æ ‘ä¸­æ–­æ§åˆ¶å™¨å¤„ç†ï¼š**
```c
irqchip_init  // drivers/irqchip/irqchip.c
    of_irq_init(__irqchip_of_table);   // å¯¹è®¾å¤‡æ ‘æ–‡ä»¶ä¸­æ¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œè°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
        for_each_matching_node_and_match(np, matches, &match)  // å¤„ç†ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹
```

#### 5.3.2 Root IRQ Controllerçš„é©±åŠ¨å®ç°

**1. å¤„ç†å‡½æ•°å®šä¹‰ï¼š**
```c
//drivers/irqchip/irq-s3c24xx.c
IRQCHIP_DECLARE(s3c2410_irq, "samsung,s3c2410-irq", s3c2410_init_intc_of);
```

**å®å±•å¼€è§£æï¼š**
```c
#define IRQCHIP_DECLARE(name, compat, fn) OF_DECLARE_2(irqchip, name, compat, fn)
// æœ€ç»ˆå±•å¼€ä¸ºï¼š
static const struct of_device_id __of_table_s3c2410_irq     \
    __used __section("__irqchip_of_table")          \
     = { .compatible = "samsung,s3c2410-irq",               \
         .data = s3c2410_init_intc_of  }
```

**2. åˆå§‹åŒ–è¿‡ç¨‹ï¼š**
```c
s3c2410_init_intc_of  // drivers/irqchip/irq-s3c24xx.c
    // åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨: intc, subintc
    s3c_init_intc_of(np, interrupt_parent, s3c2410_ctrl, ARRAY_SIZE(s3c2410_ctrl));
        // ä¸ºä¸­æ–­æ§åˆ¶å™¨åˆ›å»ºirq_domainï¼ï¼!
        domain = irq_domain_add_linear(np, num_ctrl * 32,
                                 &s3c24xx_irq_ops_of, NULL);
        intc->domain = domain;
        // è®¾ç½®handle_arch_irq, å³ä¸­æ–­å¤„ç†çš„Cè¯­è¨€æ€»å…¥å£å‡½æ•°
        set_handle_irq(s3c24xx_handle_irq);
```

#### 5.3.3 Pinctrlç³»ç»Ÿä¸­çš„GPIOä¸­æ–­æ§åˆ¶å™¨

**1. å¹³å°é©±åŠ¨æ³¨å†Œï¼š**
```c
static struct platform_driver samsung_pinctrl_driver = {
    .probe      = samsung_pinctrl_probe,
    .driver = {
        .name   = "samsung-pinctrl",
        .of_match_table = samsung_pinctrl_dt_match, 
        // å«æœ‰ { .compatible = "samsung,s3c2440-pinctrl", .data = &s3c2440_of_data },
    },
};
```

**2. ä¸­æ–­åŸŸåˆ›å»ºè¿‡ç¨‹ï¼š**
```c
samsung_pinctrl_probe  // drivers/pinctrl/samsung/pinctrl-samsung.c
    æœ€ç»ˆä¼šè°ƒç”¨åˆ° s3c24xx_eint_init // drivers/pinctrl/samsung/pinctrl-s3c24xx.c
        // ä¸ºGPFã€GPGè®¾ç½®irq_domainï¼ï¼ï¼ï¼
        for (i = 0; i < d->nr_banks; ++i, ++bank) {
            ops = (bank->eint_offset == 0) ? &s3c24xx_gpf_irq_ops
                               : &s3c24xx_gpg_irq_ops;
            bank->irq_domain = irq_domain_add_linear(bank->of_node, bank->nr_pins, ops, ddata);
        }
```

#### 5.3.4 è®¾å¤‡èŠ‚ç‚¹åˆ°platform_deviceçš„è½¬æ¢

**1. ä¸­æ–­ä¿¡æ¯è½¬æ¢è¿‡ç¨‹ï¼š**
```c
of_device_alloc (drivers/of/platform.c)
    // åˆ†é… platform_device
    dev = platform_device_alloc("", PLATFORM_DEVID_NONE);  
    // è®¡ç®—ä¸­æ–­æ•°
    num_irq = of_irq_count(np);  
    // æ ¹æ®è®¾å¤‡èŠ‚ç‚¹ä¸­çš„ä¸­æ–­ä¿¡æ¯, æ„é€ ä¸­æ–­èµ„æº
    of_irq_to_resource_table(np, res, num_irq) 
        of_irq_to_resource
            // è·å¾—virq, ä¸­æ–­å·
            int irq = of_irq_get(dev, index);
```

**2. å…³é”®å‡½æ•°è°ƒç”¨é“¾ï¼š**
```c
of_irq_get
    // è§£æè®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­ä¿¡æ¯
    rc = of_irq_parse_one(dev, index, &oirq); 
    // æŸ¥æ‰¾irq_domain
    domain = irq_find_host(oirq.np);   
    // åˆ›å»ºvirqå’Œä¸­æ–­ä¿¡æ¯çš„æ˜ å°„
    irq_create_of_mapping(&oirq);
        irq_create_fwspec_mapping(&fwspec);
            // è°ƒç”¨irq_domain->ops->xlate, è§£æä¸­æ–­ä¿¡æ¯ä¸ºhwirq, type
            irq_domain_translate(domain, fwspec, &hwirq, &type) 
            // æ£€æŸ¥hwirqæ˜¯å¦å·²ç»æ˜ å°„
            virq = irq_find_mapping(domain, hwirq); 
            // å¦åˆ™åˆ›å»ºæ˜ å°„
            virq = irq_create_mapping(domain, hwirq); 
                // è¿”å›æœªå ç”¨çš„virq
                virq = irq_domain_alloc_descs(-1, 1, hwirq, of_node_to_nid(of_node), NULL);  
                // è°ƒç”¨irq_domain->ops->mapåšç¡¬ä»¶è®¾ç½®
                irq_domain_associate(domain, virq, hwirq)
```

### 5.4 è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯å¤„ç†æµç¨‹å›¾

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/0b6db74ff3bad291a406aa405ef32934.png)

> [!success]+ å®Œæ•´å¤„ç†æµç¨‹æ€»ç»“ 
> **1. åˆå§‹åŒ–é˜¶æ®µï¼š**
> 
> - å†…æ ¸å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨
> - åˆ›å»ºå¯¹åº”çš„irq_domain
> 
> **2. è®¾å¤‡æ ‘è§£æé˜¶æ®µï¼š**
> 
> - è§£æè®¾å¤‡èŠ‚ç‚¹ä¸­çš„ä¸­æ–­ä¿¡æ¯
> - è½¬æ¢ä¸ºplatform_deviceçš„ä¸­æ–­èµ„æº
> 
> **3. é©±åŠ¨ä½¿ç”¨é˜¶æ®µï¼š**
> 
> - é©±åŠ¨ç¨‹åºä»platform_deviceè·å–ä¸­æ–­å·
> - è°ƒç”¨request_irqæ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°

## 6 å®è·µå¼€å‘è¦ç‚¹

> [!tip]+ å¼€å‘å»ºè®® 
> **1. è®¾å¤‡æ ‘ç¼–å†™è¦ç‚¹ï¼š**
> 
> - æ˜ç¡®æŒ‡å®šinterrupt-parentå’Œinterruptså±æ€§
> - æ³¨æ„ä¸­æ–­è§¦å‘ç±»å‹çš„æ­£ç¡®é…ç½®
> - ç¡®ä¿ä¸­æ–­æ§åˆ¶å™¨çš„#interrupt-cellså±æ€§æ­£ç¡®
> 
> **2. é©±åŠ¨å¼€å‘è¦ç‚¹ï¼š**
> 
> - ä½¿ç”¨OFå‡½æ•°è·å–ä¸­æ–­èµ„æºï¼Œæé«˜ä»£ç å¯ç§»æ¤æ€§
> - æ­£ç¡®å¤„ç†ä¸­æ–­èµ„æºçš„è·å–å’Œé‡Šæ”¾
> - æ³¨æ„ä¸­æ–­å…±äº«å’Œä¸­æ–­åµŒå¥—çš„å¤„ç†
> 
> **3. è°ƒè¯•æŠ€å·§ï¼š**
> 
> - ä½¿ç”¨`cat /proc/interrupts`æŸ¥çœ‹ç³»ç»Ÿä¸­æ–­ä¿¡æ¯
> - é€šè¿‡è®¾å¤‡æ ‘è°ƒè¯•å·¥å…·éªŒè¯ä¸­æ–­æè¿°çš„æ­£ç¡®æ€§
> - åˆ©ç”¨å†…æ ¸æ—¥å¿—åˆ†æä¸­æ–­æ³¨å†Œå’Œå¤„ç†è¿‡ç¨‹

**æ€»ç»“ï¼š** è®¾å¤‡æ ‘ä¸­æ–­ç³»ç»Ÿæ˜¯Linuxå†…æ ¸ä¸­å¤æ‚è€Œé‡è¦çš„æœºåˆ¶ï¼Œå®ƒé€šè¿‡æ ‡å‡†åŒ–çš„æè¿°æ–¹å¼å’Œirq_domainæ˜ å°„æœºåˆ¶ï¼Œå®ç°äº†ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯ä»è®¾å¤‡æ ‘åˆ°é©±åŠ¨ç¨‹åºçš„å®Œæ•´ä¼ é€’é“¾è·¯ã€‚ç†è§£è¿™ä¸ªè¿‡ç¨‹å¯¹äºåµŒå…¥å¼Linuxé©±åŠ¨å¼€å‘è‡³å…³é‡è¦ã€‚