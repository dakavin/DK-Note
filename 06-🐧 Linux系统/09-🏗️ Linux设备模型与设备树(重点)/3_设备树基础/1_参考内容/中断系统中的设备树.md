---
æ–‡ç« æ ‡é¢˜: "[[ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘]]"
æ–‡ç« ä½œè€…: Dakkk
æ–‡ç« æ¦‚è¦: |
  ä»‹ç»Linuxå†…æ ¸ä¸­è®¾å¤‡æ ‘æè¿°ä¸­æ–­ç³»ç»Ÿçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ä¸­æ–­æ§åˆ¶å™¨é…ç½®ã€è®¾å¤‡ä¸­æ–­æè¿°æ ¼å¼ä»¥åŠå†…æ ¸å¤„ç†ä¸­æ–­ä¿¡æ¯çš„å®Œæ•´æµç¨‹å’Œä»£ç åˆ†æ
tags:
  - è®¾å¤‡æ ‘
  - ä¸­æ–­ç³»ç»Ÿ
  - irq_domain
  - ä¸­æ–­æ§åˆ¶å™¨
  - platform_device
  - Linuxå†…æ ¸
  - S3C2440
  - GPIOä¸­æ–­
ç›¸å…³æ–‡ç« :
  - "[[../../../../07-ğŸ” ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain]]"
  - "[[å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†]]"
  - "[[../02_è®¾å¤‡æ ‘ï¼ˆdevice Treeï¼‰çš„ç”±æ¥]]"
  - "[[../03_å›¾è§£Kernel Device Tree(è®¾å¤‡æ ‘)çš„ä½¿ç”¨]]"
  - "[[../04_è®¾å¤‡æ ‘ä¸­CPUæè¿° (ä¸éœ€è¦æ”¹)]]"
æ–‡ç« åˆ†ç±»: ğŸ§ Linuxç³»ç»Ÿ
æ–‡ç« è·¯å¾„: 06-ğŸ§ Linuxç³»ç»Ÿ/07-ğŸš— Linuxé©±åŠ¨å¼€å‘æ ¸å¿ƒ(é‡è¦!!!)/05-ğŸš— Linuxé©±åŠ¨ç›¸å…³å­ç³»ç»Ÿ (é‡ç‚¹)/3_è®¾å¤‡æ ‘/2_Linuxè®¾å¤‡æ ‘è¯¦è§£ï¼ˆéŸ¦ä¸œå±±ï¼‰/5_ä¸­æ–­ç³»ç»Ÿä¸­çš„è®¾å¤‡æ ‘.md
æ–‡ç« éš¾åº¦: é«˜çº§ ğŸ”¥
ç›®å‰é˜¶æ®µ: âœ… å·²å®Œæˆ
é‡è¦æ€§: â­â­â­â­â­ ç²¾é€šå¿…å¤‡
åˆ›å»ºæ—¶é—´: 2025-06-10 20:34:00
ä¿®æ”¹æ—¶é—´: 2025-06-11 13:51:37
---

## 1 å‰ç½®å†…å®¹

- [1_ä¸­æ–­æ¦‚å¿µçš„å¼•å…¥ä¸å¤„ç†æµç¨‹](../../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/1_ä¸­æ–­æ¦‚å¿µçš„å¼•å…¥ä¸å¤„ç†æµç¨‹.md)
- [2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°](../../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/2_Linuxå¯¹ä¸­æ–­å¤„ç†çš„æ¡†æ¶åŠä»£ç æµç¨‹ç®€è¿°.md)
- [3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain](../../../../07-ğŸ”%20ä¸­æ–­åŠå¼‚å¸¸å¤„ç†/01_åŸºäºéŸ¦ç¥è®¾å¤‡æ ‘è¯¾ç¨‹/3_ä¸­æ–­å·çš„æ¼”å˜ä¸irq_domain.md)

## 2 åœ¨S3C2440ä¸Šä½¿ç”¨è®¾å¤‡æ ‘æè¿°ä¸­æ–­ä½“éªŒ(ç¤ºä¾‹)

å…·ä½“ç¤ºä¾‹ï¼Œå› ä¸ºæ²¡æœ‰æ¿å¡ä¸åšæ¼”ç¤ºï¼Œåªåˆ—å‡ºå®é™…åº”ç”¨çš„å†…å®¹

å¯ä»¥ä½¿ç”¨å‘½ä»¤`cat /proc/interrupts`æ¥æŸ¥çœ‹ç³»ç»Ÿä¸­çš„ä¸­æ–­ä¿¡æ¯
![image.png|500|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/f3c7d70401045f58371c3878926e5b29.png)

### 2.1 ä¸­æ–­ä½¿ç”¨å¯¹æ¯”

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/21118650c2fd38af0c9bf83bad4ebd16.png)


**---------------è€å†…æ ¸ä¸­æ–­ä¿¡æ¯---------------**
```shell
/ # cat /proc/interrupts
           CPU0
 29:      17593       s3c  13 Edge      samsung_time_irq
 42:          0       s3c  26 Edge      ohci_hcd:usb1
 43:          0       s3c  27 Edge      s3c2440-i2c.0
 74:         86  s3c-level   0 Edge      s3c2440-uart
 75:        561  s3c-level   1 Edge      s3c2440-uart
 83:          0  s3c-level   9 Edge      ts_pen
 84:          0  s3c-level  10 Edge      adc
 87:          0  s3c-level  13 Edge      s3c2410-wdt
```
- samsung_time_irqï¼šå®šæ—¶å™¨ä¸­æ–­ï¼Œä¸­æ–­å·æ˜¯29ï¼Œå¯¹åº”ä¸Šå›¾çš„`IRQ_TIMER3`ï¼Œå³16+13 = 29
- adcï¼šä¸­æ–­å·çš„84ï¼Œ10+58+16 = 84
- å³å¯ä»¥åœ¨ä»£ç é‡Œé¢ç»™æŸä¸ªç¡¬ä»¶ä¸­æ–­ï¼ŒæŒ‡å®šå®ƒçš„ç¡¬ä»¶ä¸­æ–­å·
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/98200c987c496c60f9d5ebf332adbf25.png)

**---------------æ–°å†…æ ¸ä¸­æ–­ä¿¡æ¯---------------**
```shell
/ # cat /proc/interrupts
           CPU0
  8:          0       s3c   8 Edge      s3c2410-rtc tick
 13:        936       s3c  13 Edge      samsung_time_irq
 30:          0       s3c  30 Edge      s3c2410-rtc alarm
 32:         15  s3c-level  32 Level     50000000.serial
 33:         60  s3c-level  33 Level     50000000.serial
 59:          0  s3c-level  59 Edge      53000000.watchdog
```
- å¯ä»¥çœ‹åˆ°virqå‘ç”Ÿäº†å˜åŒ–ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½åƒä»¥å‰é‚£æ ·äº‹å…ˆç¡®å®šç¡¬ä»¶ä¸­æ–­çš„ä¸­æ–­å·
- ç°åœ¨ï¼Œåªèƒ½åœ¨è®¾å¤‡æ ‘é‡Œé¢ï¼Œæè¿°è¿™ä¸ªè®¾å¤‡ç”¨åˆ°äº†é‚£ä¸ªç¡¬ä»¶ä¸­æ–­å·

### 2.2 ä½¿ç”¨è®¾å¤‡æ ‘æè¿°ç¡¬ä»¶ä¸­æ–­ä¿¡æ¯

**é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åœ¨è®¾å¤‡æ ‘ä¸­æè¿°è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿ**
- å¦‚ä¸‹å›¾ï¼ŒCPUå¯¹æ¥çš„æ˜¯æ€»çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œä¸‹é¢æœ‰å­ä¸­æ–­æ§åˆ¶å™¨å’ŒGPIOæ§åˆ¶å™¨ï¼ˆè½¯ä»¶å±‚é¢è°ƒæˆä¸­æ–­æ§åˆ¶å™¨ï¼‰
  ![image.png|300](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/caaa4ed7c15fc4414a1a2a48e4afcabd.png)
- ç„¶åå¯ä»¥ä½¿ç”¨hwirqï¼ˆæŸä¸ªæ•°å­—ï¼‰æ¥è¡¨ç¤ºæŸä¸ªä¸­æ–­ï¼Œä½†æ˜¯å¯¹äºåŒä¸€ä¸ªæ•°å­—ï¼ˆå¦‚0ï¼‰ï¼Œåœ¨ä¸åŒçš„æ§åˆ¶å™¨æ˜¯ä¸ä¸€æ ·çš„
- æ‰€ä»¥æè¿°ä¸€ä¸ªä¸­æ–­å¯ä»¥è¿™ä¹ˆæè¿°
	- å“ªä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨
	- é‡Œé¢çš„å“ªä¸€ä¸ªä¸­æ–­ï¼ˆhwirqï¼‰

**ä¸¾ä¾‹1ï¼šå‡è®¾æœ‰ä¸€ä¸ªç½‘å¡ï¼Œç½‘å¡æœ‰æ•°æ®çš„æ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œè¿™ä¸ªä¸­æ–­æ¥åˆ°GPIOæ§åˆ¶å™¨å»**ï¼Œå¦‚ä½•æè¿°è¿™ä¸ªç½‘å¡çš„ä¸­æ–­ä¿¡æ¯å‘¢ï¼Ÿ
- æŒ‡å®šå®ƒçš„ä¸­æ–­æ§åˆ¶å™¨æ˜¯è° -> interrupt-parent = ?
- ä½¿ç”¨äº†è¿™ä¸ªä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸€ä¸ªä¸­æ–­ -> interrupts = <? ? ?>
- ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­
	```dts
	ethernet@20000000 {
		compatible = "davicom,dm9000";
		reg = <0x20000000 0x2 0x20000004 0x2>;
		interrupt-parent = <&gpf>;
		interrupts = <7 IRQ_TYPE_EDGE_RISING>;
		local-mac-address = [00 00 de ad be ef];
		davicom,no-eeprom;
	};
	```
	- æŒ‡å‘gpfè¿™ä¸ªä¸­æ–­æ§åˆ¶å™¨
	- ä½¿ç”¨gpfä¸­æ–­æ§åˆ¶å™¨çš„ç¬¬7å·ä¸­æ–­ï¼Œä¸­æ–­è§¦å‘æ–¹å¼æ˜¯IRQ_TYPE_EDGE_RISING
		- å…·ä½“ä¿¡æ¯è¿˜æ˜¯ç”±gpfä¸­æ–­æ§åˆ¶å™¨æ¥æŒ‡å®šçš„

**ä¸¾ä¾‹2ï¼šä¸­æ–­æ§åˆ¶å™¨**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/59fb8a84e97caea0dd08d5d076030e84.png)
- å¦‚ä½•ç¡®å®šinterrupt-controllerã€gpfå’Œgpgçš„å…³ç³»å‘¢ï¼Ÿ
	- interrupt-controllerå¾ˆæ˜æ˜¾æ˜¯é¡¶å±‚çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œä¸”æ˜¯æ ¹èŠ‚ç‚¹ä¸‹é¢çš„å­èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨phandle = 1è¿›è¡Œäº†å¼•ç”¨
	- gpfå’Œgpgå¯ä»¥ä¸€å±‚å±‚å‘ä¸Šæ‰¾åˆ°`interrupt-parent`è¿™ä¸ªå±æ€§ï¼Œå®ƒæŒ‡å®šäº†å®ƒä»¬çš„çˆ¶ä¸­æ–­æ§åˆ¶å™¨
	  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/e517bf4b368b464906f585806606a32b.png)
	- æŸ¥çœ‹ä¸Šå›¾ï¼Œå¯ä»¥çŸ¥é“å¼•ç”¨äº†interrupt-controllerä¸ºgpfå’Œgpgçš„çˆ¶ä¸­æ–­æ§åˆ¶å™¨
- å¯ä»¥çœ‹åˆ°è®¾å¤‡æ ‘ä¸Šï¼Œæˆ‘ä»¬å®šä¹‰äº†3ä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Œä½†æ˜¯åœ¨ç¡¬ä»¶ä¸Šé¢åº”è¯¥è¿˜æœ‰ä¸€ä¸ª`sub intc(å­ä¸­æ–­æ§åˆ¶å™¨)`
	- å®é™…ä¸Šï¼Œåœ¨è®¾å¤‡é‡Œé¢ä½¿ç”¨ä¸€ä¸ªèŠ‚ç‚¹æ¥æè¿°`interrupt-controller(ä¸»ä¸­æ–­æ§åˆ¶å™¨)`å’Œ`sub intc(å­ä¸­æ–­æ§åˆ¶å™¨)`
	- åœ¨interrupt-controllerçš„interrupt-cellsæœ‰4ä¸ªu32æ•°æ®ï¼Œå…¶ä¸­æœ‰1ä¸ªæ•°æ®æ¥è¡¨ç¤ºä¸­æ–­æ˜¯ä¸»ä¸­æ–­è¿˜æ˜¯å­ä¸­æ–­

### 2.3 è®¾å¤‡æ ‘ä¸­æ–­æè¿°æ€»ç»“

å½“ä¸€ä¸ªè®¾å¤‡éœ€è¦ä½¿ç”¨ä¸­æ–­æ—¶ï¼Œå¿…é¡»åœ¨è®¾å¤‡ä¸­æ˜ç¡®æè¿°ï¼š
- ä½¿ç”¨é‚£ä¸ªä¸­æ–­ï¼Ÿ
- è¿™ä¸ªä¸­æ–­è¿æ¥åˆ°å“ªä¸ªä¸­æ–­æ§åˆ¶å™¨ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜**ï¼šä½¿ç”¨å“ªä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸€ä¸ªä¸­æ–­ï¼Ÿ

**---------------è®¾å¤‡æ ‘ä¸­æè¿°ä¸­æ–­---------------**
1. **è®¾å¤‡ç«¯éœ€è¦çš„å±æ€§**
```dts
interrupts        // è¡¨ç¤ºè¦ä½¿ç”¨å“ªä¸€ä¸ªä¸­æ–­ï¼Œä¸­æ–­çš„è§¦å‘ç±»å‹ç­‰
interrupt-parent  // æŒ‡å®šçˆ¶ä¸­æ–­æ§åˆ¶å™¨æ˜¯è°
```
2. **ä¸­æ–­æ§åˆ¶å™¨ç«¯éœ€è¦çš„å±æ€§**
```dts
interrupt-controller;   // å£°æ˜è‡ªå·±æ˜¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨
#interrupt-cells       // æŒ‡å®šå­è®¾å¤‡ç”¨å‡ ä¸ªu32æ•°æ®æ¥æè¿°ä¸­æ–­
```

**---------------å·¥ä½œæœºåˆ¶---------------**
- `interrupts`å±æ€§ä½¿ç”¨å¤šå°‘ä¸ªu32æ¥è¡¨ç¤ºï¼Œå®Œå…¨ç”±å…¶çˆ¶ä¸­æ–­æ§åˆ¶å™¨æ¥å†³å®š
- çˆ¶ä¸­æ–­æ§åˆ¶å™¨é€šè¿‡ `#interrupe-cells`å±æ€§æ¥è§„å®šå­è®¾å¤‡çš„ä¸­æ–­æè¿°æ ¼å¼
- è¿™ç§è®¾è®¡ä¿è¯äº†ä¸­æ–­æè¿°çš„ç»Ÿä¸€æ€§å’Œå¯æ‰©å±•æ€§

## 3 ä½¿ç”¨è®¾å¤‡æ ‘æè¿°æŒ‰é”®ä¸­æ–­(ç¤ºä¾‹)

### 3.1 æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/7339e6bbd182d7dd618881c100898a17.png)
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/0d9746f186ddcd30cc8572032ffc1926.png)
- é‡Œé¢æœ‰4ä¸ªæŒ‰é”®ï¼Œåˆ†åˆ«æ¥å…¥åˆ°ä¸åŒçš„å¼•è„š


### 3.2 è®¾å¤‡æ ‘æ·»åŠ è®¾å¤‡ä¿¡æ¯

```dts
buttons {
	compatible = "jz2440_button";
	eint-pins = <&gpf 0 0>, <&gpf 2 0>, <&gpf 3 0>, <&gpf 11 0>;
	interrupts-extended = <&intc 0 0 0 3>,
	                      <&intc 0 0 2 3>,
	                      <&gpg 3 3>,
	                      <&gpg 11 3>;
};
```
- interrupts-extendedï¼šä¸­æ–­æ‹“å±•å±æ€§ï¼Œå¯ä»¥å†™å¤šä¸ªinterrupts
	- intcè¡¨ç¤ºå¼•ç”¨çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œåº”ç”¨äº†interrupt-controllerï¼Œåé¢çš„å€¼å¯ä»¥å‚è€ƒæ–‡æ¡£`å†…æ ¸æºç /Documentation/devicetree/bindings/interrupt-controller/samsung,s3c24xx-irq.txt`
	  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/704f89476b68960c256544788fef186a.png)
		- ctrl_numï¼šä¸­æ–­ä¿¡å·å‘é€ç»™ä¸»/å­ï¼Œ0è¡¨ç¤ºä¸»æ§åˆ¶å™¨ï¼Œ1è¡¨ç¤ºå­æ§åˆ¶å™¨ï¼Œ**å†™0**
		- parent_irqï¼šå­å‘ç»™ä¸»ï¼Œè¿™é‡Œæ˜¯ç›´æ¥è¿æ¥ä¸»æ§åˆ¶å™¨ï¼Œæ²¡æœ‰é€šè¿‡å­å‘ç»™ä¸»ï¼Œæ‰€ä»¥**å†™0**
		- ctrl_irqï¼šè¡¨ç¤ºä½¿ç”¨ä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸€ä¸ªä¸­æ–­ï¼Œåˆ†åˆ«**å†™ 0 å’Œ 2**
		- typeï¼šä¸­æ–­çš„è§¦å‘æ–¹å¼ï¼Œåœ¨`å†…æ ¸æºç /Documentation/devicetree/bindings/pinctrl/samsung-pinctrl.txt`ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œ**é€‰æ‹©3**-ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿å…±åŒè§¦å‘
		  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/1a9048761d6ff53571160c9d81909a34.png)
	- gpgè¡¨ç¤ºgpgä¸­æ–­æ§åˆ¶å™¨ï¼Œåé¢çš„å€¼å¯ä»¥ä¸Šé¢çš„pinctrlæ–‡æ¡£ï¼Œå–ä¸¤ä¸ªu32æ˜¯åœ¨gpgè‡ªå·±çš„interrupt-cellsä¸­è§„å®šçš„
		- ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºæ˜¯gpgä¸­æ–­æ§åˆ¶å™¨çš„é‚£ä¸ªä¸­æ–­ï¼Œåˆ†åˆ«**å†™3å’Œ11**
		- ç¬¬äºŒåªä»£è¡¨ä¸­æ–­çš„è§¦å‘ç±»å‹ï¼ŒåŒä¸Š

### 3.3 è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯å¦‚ä½•è½¬æ¢ä¸ºä¸­æ–­å·

å‚è€ƒè®¾å¤‡æ ‘æ˜¯å¦‚ä½•è½¬æ¢ä¸ºplatform_deviceçš„ï¼š[6 device_nodeè½¬æ¢ä¸ºplatform_device](3_å†…æ ¸å¯¹è®¾å¤‡æ ‘çš„å¤„ç†.md#6%20device_nodeè½¬æ¢ä¸ºplatform_device)

![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/0b6db74ff3bad291a406aa405ef32934.png)

è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚è¯¾æ¥è®²è§£

### 3.4 é©±åŠ¨ç¨‹åºçš„ç¼–å†™

**1ã€å®šä¹‰ä¸€ä¸ªof_match_tableï¼Œè¡¨ç¤ºé©±åŠ¨æ”¯æŒbuttonè¿™ä¸ªè®¾å¤‡èŠ‚ç‚¹**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/14c14650dda83952fda373d25e12a029.png)

**2ã€åŒ¹é…æˆåŠŸåï¼Œä¼šè°ƒç”¨probeå‡½æ•°**
![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/856b58fd086374c98c6beb4c3658186a.png)
- ä»pdevçš„resourceä¸­è·å–ä¸­æ–­èµ„æºï¼Œå°†å…¶ä¿å­˜åœ¨è‡ªå®šä¹‰ç»“æ„ä½“`pins_desc`é‡Œé¢
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/aab885a70b4ee457cc5ccbd1488a2aeb.png)
- åœ¨of_get_named_gpioä¸­æŒ‡å®šä¸­æ–­çš„å¼•è„šï¼ˆæš‚æ—¶ä¸æ˜¯é‡ç‚¹ï¼‰
  ![image.png|500](https://my-obsidian-image.oss-cn-guangzhou.aliyuncs.com/2025/06/24f75a408e8ce13ae5c707727c22bbdb.png)

## 4 ğŸ“•å†…æ ¸å¯¹è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯çš„å¤„ç†è¿‡ç¨‹ï¼ˆé‡è¦ï¼‰

### 4.1 æ•´ä½“æ¶æ„åˆ†æ

ä»å¤„ç†å™¨å±‚é¢æ¥çœ‹ï¼Œå†…æ ¸å¯¹è®¾å¤‡æ ‘ä¸­æ–­ä¿¡æ¯çš„å¤„ç†åˆ†ä¸ºä¸¤ä¸ªç»´åº¦ï¼š
**---------------ç¡¬ä»¶ç»“æ„å±‚é¢ï¼ˆä¸Šä¸‹ä¸¤å±‚ï¼‰---------------**
- **ä¸­æ–­æ§åˆ¶å™¨å±‚**ï¼šè´Ÿè´£ç®¡ç†å’Œåˆ†å‘ä¸­æ–­
- **ä½¿ç”¨ä¸­æ–­çš„è®¾å¤‡å±‚**ï¼šå…·ä½“çš„å¤–è®¾è®¾å¤‡
**---------------è½¯ä»¶ç»“æ„å±‚é¢ï¼ˆå·¦å³ä¸¤éƒ¨åˆ†ï¼‰---------------**
- **è®¾å¤‡æ ‘æè¿°**ï¼šåœ¨è®¾å¤‡æ ‘ä¸­æè¿°ä¸­æ–­ä¿¡æ¯
- **é©±åŠ¨å¤„ç†**ï¼šåœ¨é©±åŠ¨ç¨‹åºä¸­å¤„ç†è®¾å¤‡æ ‘ä¿¡æ¯

### 4.2 ä¸­æ–­æ§åˆ¶å™¨å’Œè®¾å¤‡ä¸­æ–­çš„å¤„ç†

**---------------ä¸­æ–­æ§åˆ¶å™¨---------------**
1. **Root IRQ Controllerï¼ˆæ ¹ä¸­æ–­æ§åˆ¶å™¨ï¼‰**
	- **åœ¨è®¾å¤‡æ ‘ä¸­çš„æè¿°**ï¼šæ ¹ä¸­æ–­æ§åˆ¶å™¨æ˜¯æ•´ä¸ªä¸­æ–­ä½“ç³»çš„æ ¸å¿ƒï¼Œè´Ÿè´£å¤„ç†ä¸»è¦çš„ä¸­æ–­æº
	- **åœ¨å†…æ ¸ä¸­çš„é©±åŠ¨**ï¼šå†…æ ¸ä¸­æœ‰ä¸“é—¨çš„é©±åŠ¨ç¨‹åºæ¥å¤„ç†æ ¹ä¸­æ–­æ§åˆ¶å™¨

2. **GPF/GPG IRQ Controllerï¼ˆGPIOä¸­æ–­æ§åˆ¶å™¨ï¼‰**
	- **åœ¨è®¾å¤‡æ ‘ä¸­çš„æè¿°ï¼ˆåœ¨pinctrlèŠ‚ç‚¹é‡Œï¼‰**ï¼šå¯¹äºS3C2440ï¼Œè¿˜å­˜åœ¨GPF/GPGä¸­æ–­æ§åˆ¶å™¨ï¼Œå®ƒä»¬çš„æè¿°åŒ…å«åœ¨pinctrlèŠ‚ç‚¹ä¸­
	- **åœ¨å†…æ ¸ä¸­çš„é©±åŠ¨ï¼ˆåœ¨pinctrlé©±åŠ¨ä¸­ï¼‰**ï¼šè¿™äº›GPIOä¸­æ–­æ§åˆ¶å™¨çš„å¤„ç†é€»è¾‘é›†æˆåœ¨pinctrlé©±åŠ¨ä¸­

**---------------è®¾å¤‡ä¸­æ–­---------------**
1. **åœ¨è®¾å¤‡èŠ‚ç‚¹ä¸­æè¿°**ï¼šè®¾å¤‡éœ€è¦æ˜ç¡®è¡¨æ˜ä½¿ç”¨â€œå“ªä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨çš„å“ªä¸€ä¸ªä¸­æ–­ï¼ŒåŠä¸­æ–­è§¦å‘æ–¹å¼â€
2. **åœ¨å†…æ ¸é©±åŠ¨ä¸­çš„å¤„ç†**ï¼šåœ¨platform_driverçš„probeå‡½æ•°ä¸­è·å¾—IRQèµ„æºï¼Œå³å…·ä½“çš„ä¸­æ–­å·

### 4.3 IRQ Domainæ ¸å¿ƒæœºåˆ¶

**irq_domainæ˜¯æ•´ä¸ªä¸­æ–­å¤„ç†çš„æ ¸å¿ƒ**ï¼š
1. **æ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨éƒ½æœ‰ä¸€ä¸ªirq_domain**
2. **å¯¹è®¾å¤‡ä¸­æ–­ä¿¡æ¯çš„è§£æè¿‡ç¨‹**ï¼š
	- è°ƒç”¨ `irq_domain->ops->xlate`è§£æè®¾å¤‡æ ‘ï¼Œè·å¾—hwirqå’Œtype
	- è·å–`irq_desc`æ•°ç»„ä¸­æœªä½¿ç”¨çš„virqï¼Œä¿å­˜æ˜ å°„å…³ç³»`irq_domain->linear_revmap[hwirq] = virq`
	- åœ¨hwirqå’Œvirqä¹‹é—´å»ºç«‹è”ç³»
		- è°ƒç”¨ `irq_domain->ops->map`ï¼Œæ ¹æ®hwirqå±æ€§è®¾ç½®virqçš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œå³è®¾ç½®`irq_desc[virq].handle_irq = å¸¸è§„å¤„ç†å‡½æ•°`
		- å¦‚æœ hwirq æœ‰ä¸Šä¸€çº§ä¸­æ–­ï¼ˆå‡è®¾ä¸­æ–­å·ä¸º `virq'`ï¼‰ï¼Œè¿˜è¦è®¾ç½® `irq_desc[virq'].handle_irq = ä¸­æ–­åˆ†å‘å‡½æ•°`ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å¾—åˆ°`irq_desc[virq].handle_irq = å¸¸è§„å¤„ç†å‡½æ•°`

### 4.4 S3C2440è®¾å¤‡æ ‘ä¸­æ–­ç›¸å…³ä»£ç è°ƒç”¨å…³ç³»ï¼ˆç¤ºä¾‹&ç†è§£ï¼‰

æ•´ä½“é“¾è·¯ï¼š
```txt
ä»è®¾å¤‡æ ‘æè¿° â†’ ä¸­æ–­æ§åˆ¶å™¨åˆå§‹åŒ– â†’ irq_domainåˆ›å»º â†’ è®¾å¤‡èŠ‚ç‚¹è§£æ â†’ platform_deviceç”Ÿæˆ â†’ é©±åŠ¨ç¨‹åºä½¿ç”¨
```

#### 4.4.1 å¤„ç†è¿‡ç¨‹çš„è§¦å‘æœºåˆ¶

1. **å†…æ ¸å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸­æ–­çš„å…¥å£**ï¼š
```c
start_kernel // init/main.c
	init_IRQ();
		if(IS_ENABLED(CONFIG_OF) && !machine_desc->init_irq)
			irqchip_init();  //ä¸€èˆ¬ä½¿ç”¨å®ƒ
		else
			machine_desc->init_irq();
```
- ä½¿èƒ½è®¾å¤‡æ ‘ å¹¶ä¸” æœºå™¨æè¿°ç¬¦ä¸­æ²¡æœ‰init_irq


2. **è®¾å¤‡æ ‘ä¸­æ–­æ§åˆ¶å™¨çš„å¤„ç†å…¥å£**ï¼š
```c
irqchip_init  // drivers/irqchip/irqchip.c
	of_irq_init(__irqchip_of_table);   // å¯¹è®¾å¤‡æ ‘æ–‡ä»¶ä¸­æ¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹ï¼Œè°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
		for_each_matchint_node_and_match(np, matches, &match)  // å¤„ç†ä¸­æ–­æ§åˆ¶å™¨èŠ‚ç‚¹
```
- ä¸ºæ¯ä¸€ä¸ªç¬¦åˆçš„"interrupt-controller"èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªof_intc_descç»“æ„ä½“
- `desc->irq_init_cb = match->data;` // ç­‰äºIRQCHIP_DECLAREä¸­ä¼ å…¥çš„å‡½æ•°
- æŒ‰å±‚æ¬¡è°ƒç”¨å¤„ç†å‡½æ•°ï¼ˆå…ˆè°ƒç”¨æ ¹ä¸­æ–­æ§åˆ¶å™¨ï¼Œå†è°ƒç”¨å­æ§åˆ¶å™¨ï¼Œç„¶åæ˜¯æ›´ä¸‹çº§çš„æ§åˆ¶å™¨ï¼‰

#### 4.4.2 Root IRQ Controllerçš„é©±åŠ¨è°ƒç”¨è¿‡ç¨‹

1. **ä¸ºroot irq controllerå®šä¹‰å¤„ç†å‡½æ•°**ï¼š
```c
//drivers/irqchip/irq-s3c24xx.c
IRQCHIP_DECLARE(s3c2410_irq, "samsung,s3c2410-irq", s3c2410_init_intc_of);  
```
- IRQCHIP_DECLAREç”¨æ¥å£°æ˜è®¾å¤‡æ ‘ä¸­ä¸­æ–­æ§åˆ¶å™¨çš„å¤„ç†å‡½æ•°
- å®å±•å¼€è¿‡ç¨‹
```c
#define IRQCHIP_DECLARE(name, compat, fn) OF_DECLARE_2(irqchip, name, compat, fn)
#define OF_DECLARE_2(table, name, compat, fn) \
        _OF_DECLARE(table, name, compat, fn, of_init_fn_2)
#define _OF_DECLARE(table, name, compat, fn, fn_type)           \
    static const struct of_device_id __of_table_##name      \
        __used __section(__##table##_of_table)          \
         = { .compatible = compat,              \
             .data = (fn == (fn_type)NULL) ? fn : fn  }
```
- æœ€ç»ˆå±•å¼€ä¸º
```c
static const struct of_device_id __of_table_s3c2410_irq     \
    __used __section("__irqchip_of_table")          \
     = { .compatible = "samsung,s3c2410-irq",               \
         .data = s3c2410_init_intc_of  }
```
- å®šä¹‰ç±»ä¸€ä¸ªof_device_idç»“æ„ä½“ï¼Œæ®µå±æ€§ä¸º `__irqchip_of_table`
- ç¼–è¯‘æ—¶è¿™äº›æ®µæ”¾åœ¨`__irqchip_of_table`åœ°å€å¤„
- è®¾å¤‡æ ‘ä¸­çš„è®¾å¤‡èŠ‚ç‚¹å¦‚æœcompatibleç›¸åŒï¼Œä¸”æœ‰`interrupt-controller`å±æ€§ï¼Œåˆ™è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°

2. **root irq controllerå¤„ç†å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹**ï¼š
```c
s3c2410_init_intc_of  // drivers/irqchip/irq-s3c24xx.c
    // åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨: intc, subintc
    s3c_init_intc_of(np, interrupt_parent, s3c2410_ctrl, ARRAY_SIZE(s3c2410_ctrl));
                
        // ä¸ºä¸­æ–­æ§åˆ¶å™¨åˆ›å»ºirq_domainï¼ï¼!
        domain = irq_domain_add_linear(np, num_ctrl * 32,
                                 &s3c24xx_irq_ops_of, NULL);

        intc->domain = domain;

        // è®¾ç½®handle_arch_irq, å³ä¸­æ–­å¤„ç†çš„Cè¯­è¨€æ€»å…¥å£å‡½æ•°
        set_handle_irq(s3c24xx_handle_irq);
```

#### 4.4.3 Pinctrlç³»ç»Ÿä¸­GPF/GPG IRQ Controllerçš„é©±åŠ¨è°ƒç”¨è¿‡ç¨‹

1. **pinctrlç³»ç»Ÿçš„é©±åŠ¨ç¨‹åº**ï¼š
- æºä»£ç ï¼š`drivers/pinctrl/samsung/pinctrl-samsung.c`
- å…ˆæ³¨å†Œäº†ä¸€ä¸ªå¹³å°é©±åŠ¨è®¾å¤‡
```c
static struct platform_driver samsung_pinctrl_driver = {
    .probe      = samsung_pinctrl_probe,
    .driver = {
        .name   = "samsung-pinctrl",
        .of_match_table = samsung_pinctrl_dt_match, 
        // å«æœ‰ { .compatible = "samsung,s3c2440-pinctrl", .data = &s3c2440_of_data },
        .suppress_bind_attrs = true,
        .pm = &samsung_pinctrl_pm_ops,
    },
};
```
- åŒ¹é…è®¾å¤‡æ ‘ä¸­compatibleå±æ€§ï¼š
```dts
pinctrl@56000000 {
    reg = <0x56000000 0x1000>;
    compatible = "samsung,s3c2440-pinctrl";  // æ®æ­¤æ‰¾åˆ°é©±åŠ¨
```
- å¹³å°é©±åŠ¨ä¸­probeå‡½æ•°çš„æ“ä½œï¼šå¤„ç†å­èŠ‚ç‚¹
```c
samsung_pinctrl_probe  // drivers/pinctrl/samsung/pinctrl-samsung.c
    æœ€ç»ˆä¼šè°ƒç”¨åˆ° s3c24xx_eint_init // drivers/pinctrl/samsung/pinctrl-s3c24xx.c
    
        // eint0,1,2,3çš„å¤„ç†å‡½æ•°åœ¨å¤„ç†root irq controlleræ—¶å·²ç»è®¾ç½®; 
        // è®¾ç½®eint4_7, eint8_23çš„å¤„ç†å‡½æ•°(å®ƒä»¬æ˜¯åˆ†å‘å‡½æ•°)
        for (i = 0; i < NUM_EINT_IRQ; ++i) {
            unsigned int irq;

            if (handlers[i]) /* ä¸å†è®¾ç½®eint0,1,2,3çš„å¤„ç†å‡½æ•° */
            {
                irq = irq_of_parse_and_map(eint_np, i);
                if (!irq) {
                    dev_err(dev, "failed to get wakeup EINT IRQ %d\n", i);
                    return -ENXIO;
                }

                eint_data->parents[i] = irq;
                irq_set_chained_handler_and_data(irq, handlers[i], eint_data);
            }
        }

        // ä¸ºGPFã€GPGè®¾ç½®irq_domainï¼ï¼ï¼ï¼
        for (i = 0; i < d->nr_banks; ++i, ++bank) {
        
            ops = (bank->eint_offset == 0) ? &s3c24xx_gpf_irq_ops
                               : &s3c24xx_gpg_irq_ops;

            bank->irq_domain = irq_domain_add_linear(bank->of_node, bank->nr_pins, ops, ddata);
        }
```

#### 4.4.4 ä½¿ç”¨ä¸­æ–­çš„é©±åŠ¨è°ƒç”¨è¿‡ç¨‹

1. **åœ¨è®¾å¤‡èŠ‚ç‚¹ä¸­æè¿°ï¼ˆè¡¨æ˜ä½¿ç”¨"å“ªä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨é‡Œçš„å“ªä¸€ä¸ªä¸­æ–­ï¼ŒåŠä¸­æ–­è§¦å‘æ–¹å¼"ï¼‰**
```dts file:ä¸¾ä¾‹
buttons {
    compatible = "jz2440_button";
    eint-pins  = <&gpf 0 0>, <&gpf 2 0>, <&gpg 3 0>, <&gpg 11 0>;
    interrupts-extended = <&intc 0 0 0 3>,
                          <&intc 0 0 2 3>,
                          <&gpg 3 3>,
                          <&gpg 11 3>;
};
```

2. **è®¾å¤‡èŠ‚ç‚¹è½¬æ¢ä¸ºplatform_deviceçš„è¿‡ç¨‹**
- è®¾å¤‡èŠ‚ç‚¹ä¼šè¢«è½¬æ¢ä¸ºplatform_deviceï¼Œ"ä¸­æ–­çš„ç¡¬ä»¶ä¿¡æ¯"ä¼šè½¬æ¢ä¸º"ä¸­æ–­å·"ï¼Œä¿å­˜åœ¨platform_deviceçš„"ä¸­æ–­èµ„æº"é‡Œ
```c
of_device_alloc (drivers/of/platform.c)
	// åˆ†é… platform_device
    dev = platform_device_alloc("", PLATFORM_DEVID_NONE);  
    // è®¡ç®—ä¸­æ–­æ•°
    num_irq = of_irq_count(np);  
    // drivers/of/irq.c, æ ¹æ®è®¾å¤‡èŠ‚ç‚¹ä¸­çš„ä¸­æ–­ä¿¡æ¯, æ„é€ ä¸­æ–­èµ„æº
    of_irq_to_resource_table(np, res, num_irq) 
        of_irq_to_resource
	        // è·å¾—virq, ä¸­æ–­å·
            int irq = of_irq_get(dev, index);  
	            // drivers/of/irq.c, è§£æè®¾å¤‡æ ‘ä¸­çš„ä¸­æ–­ä¿¡æ¯, ä¿å­˜åœ¨of_phandle_argsç»“æ„ä½“ä¸­
				rc = of_irq_parse_one(dev, index, &oirq); 
				// æŸ¥æ‰¾irq_domain, æ¯ä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨éƒ½å¯¹åº”ä¸€ä¸ªirq_domain
				domain = irq_find_host(oirq.np);   
				// kernel/irq/irqdomain.c, åˆ›å»ºvirqå’Œä¸­æ–­ä¿¡æ¯çš„æ˜ å°„
				irq_create_of_mapping(&oirq);             
					irq_create_fwspec_mapping(&fwspec);
						irq_create_fwspec_mapping(&fwspec);
							// è°ƒç”¨irq_domain->ops->xlate, æŠŠè®¾å¤‡èŠ‚ç‚¹é‡Œçš„ä¸­æ–­ä¿¡æ¯è§£æä¸ºhwirq, type
							irq_domain_translate(domain, fwspec, &hwirq, &type) 
							// çœ‹çœ‹è¿™ä¸ªhwirqæ˜¯å¦å·²ç»æ˜ å°„, å¦‚æœvirqé0å°±ç›´æ¥è¿”å›
							virq = irq_find_mapping(domain, hwirq); 
							// å¦åˆ™åˆ›å»ºæ˜ å°„
							virq = irq_create_mapping(domain, hwirq); 
								// è¿”å›æœªå ç”¨çš„virq
								virq = irq_domain_alloc_descs(-1, 1, hwirq, of_node_to_nid(of_node), NULL);  
								// è°ƒç”¨irq_domain->ops->map(domain, virq, hwirq), åšå¿…è¦çš„ç¡¬ä»¶è®¾ç½®
								irq_domain_associate(domain, virq, hwirq) 
```

3. **é©±åŠ¨ç¨‹åºçš„æœ€ç»ˆä½¿ç”¨**
- é©±åŠ¨ç¨‹åºä»platform_deviceçš„"ä¸­æ–­èµ„æº"ä¸­å–å‡ºä¸­æ–­å·ï¼Œå°±å¯ä»¥è°ƒç”¨request_irqäº†





