---
文章标题: "[[4_内存淘汰面试与分析]]" 
文章作者: Dakkk
文章概要: |
  文章深入分析了Redis的内存淘汰策略，涵盖了8种主要策略、触发机制、LRU和LFU算法原理。重点阐述了Redis近似LRU的实现细节（如采样、淘汰池优化）及其引入LFU的原因，解释了Redis如何高效管理内存。
文章标签:
- "Redis"
- "内存淘汰"
- "LRU"
- "LFU"
- "内存管理"
- "缓存策略"
- "面试"
相关文章:
- "[[6_内存满了怎么办]]"
- "[[7_内存淘汰算法LRU和LFU]]"
- "[[1_Redis内存面试与分析]]"
- "[[1_String面试与分析]]"
- "[[11_对象过期时间]]"
文章分类: "🎉 面试"
文章路径: "11-🎉 面试/3_训练营/8_Redis面试题/2_Redis运作/4_内存淘汰面试与分析.md"
文章难度: 中级 🌳
目前阶段: ✅ 已完成
重要性: ⭐⭐⭐⭐ 核心能力
创建时间: 2024-08-11 18:15:12
修改时间: 2024-08-11 18:15:12
---

## 1 Redis有几种内存回收策略

分析：
- 太多了，有8种，建议如图所示，分类阐述

回答：
- 一种是不开启淘汰策略，此时如果内存满了，写入操作失败，但是不会淘汰已有数据
- 一种是开启淘汰策略，这时候有两个大的分支，一个是基于有过期时间的数据淘汰，一个是基于所有数据，他们都支持LRU、LFU、RANDOM算法，过期时间还支持按ttl大小淘汰

## 2 内存回收是什么时候发起的?

分析：
- 知道触发机制即可，实际上，每次进行读写的时候，都会调用processCommand函数，processCommand函数又会调用freememoryIfNeeded，这个时候就会  尝试释放一定的内存。`函数名不需要去记。`

回答：
- 实际上，每次进行读写的时候，都会去检查是否需要释放内存，如果需要（大于maxmemory）则会触发。

## 3 介绍下Redis LRU算法

分析：
- 谈谈LRU概率，这里问题是Redis的LRU算法，可以提一下是近似的。

回答：
- LRU，即最近最久未使用，记录每个key的最近访问时间，淘汰最久未被访问的数据。
- 但是Redis并不是标准的LRU算法，而是做了优化
- 这块我可以展开讲讲吗？（PS：面试官说可以的话，也就是第四题的回答）

## 4 Redis LRU算法是标准的吗？为什么不用标准的

分析：
- 关键点在近似LRU，以及内存池优化

回答：
- `标准LRU需要维护双向链表，内存成本巨大`，所以Redis采用近似LRU采样来淘汰，具体步骤是随机采用n个key，这个采用个数默认是5个，然后根据事件戳淘汰最旧的key，如果淘汰后内存还是不足，就继续随机采样来淘汰。
- 在`3.0`之后，Redis还针对近似LRU算法做了淘汰池优化，也就是维护一个淘汰池，池中的数据根据访问时间进行排序。第一次随机选取key都会放入池中，然后淘汰最久未访问的，比如第一次选了5个，淘汰了1个，剩下4个继续留在池子里
- 随后每次选取的key只有活性比池中活性最小的key还小的才放入池中，当池子满了，如果有新的key需要放入，则将池中活性最大的key移除。

## 5 什么是LFU算法，为什么Redis要引入LFU算法？

分析：
- LRU的一个弊端就是只看最近访问时间，而忽略了频率

回答：
- LFU，即将访问频率也加入到影响因素中，具体而言，LFU下同时记录了上次访问时间戳和访问计数，访问计数就表示活性大小，`访问计数同时受上一次访问时间和访问频率的影响`，因为每次访问都可能会增加计数。

